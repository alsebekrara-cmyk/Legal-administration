<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تطبيق الإدارة القانونية</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-blue: #3b82f6;
            --primary-blue-dark: #2563eb;
            --primary-blue-light: #dbeafe;
            --success-green: #10b981;
            --success-green-light: #d1fae5;
            --warning-yellow: #f59e0b;
            --warning-yellow-light: #fef3c7;
            --error-red: #ef4444;
            --error-red-light: #fee2e2;
            --purple: #8b5cf6;
            --purple-light: #ede9fe;
            --indigo: #6366f1;
            --indigo-light: #e0e7ff;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --gradient-primary: linear-gradient(135deg, var(--primary-blue), var(--indigo));
            --gradient-success: linear-gradient(135deg, var(--success-green), #059669);
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        body {
            font-family: 'Segoe UI', 'Tahoma', 'Arial', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            color: var(--gray-900);
            direction: rtl;
            line-height: 1.6;
            min-height: 100vh;
        }

        .hidden {
            display: none !important;
        }

        /* Custom Window Controls */
        .window-controls {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 35px;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            z-index: 1001;
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--indigo) 100%);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.15);
            -webkit-app-region: drag;
            padding: 0 5px;
        }

        .window-control {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 45px;
            height: 30px;
            margin: 0 1px;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.85rem;
            position: relative;
            border-radius: 4px;
            -webkit-app-region: no-drag;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .window-control:active {
            transform: scale(0.95);
            transition: transform 0.1s ease;
        }

        .window-control i {
            transition: all 0.25s ease;
        }

        .window-control:hover i {
            transform: scale(1.1);
        }

        .window-control.minimize {
            background: rgba(255, 193, 7, 0.1);
        }

        .window-control.minimize:hover {
            background: rgba(255, 193, 7, 0.25);
            color: #fff;
            box-shadow: 0 2px 10px rgba(255, 193, 7, 0.3);
        }

        .window-control.maximize {
            background: rgba(40, 167, 69, 0.1);
        }

        .window-control.maximize:hover {
            background: rgba(40, 167, 69, 0.25);
            color: #fff;
            box-shadow: 0 2px 10px rgba(40, 167, 69, 0.3);
        }

        .window-control.close {
            background: rgba(220, 53, 69, 0.1);
        }

        .window-control.close:hover {
            background: rgba(220, 53, 69, 0.25);
            color: #fff;
            box-shadow: 0 2px 10px rgba(220, 53, 69, 0.3);
        }

        /* أزرار تحديد الواجهة والتطبيق */
        .window-control.theme {
            background: rgba(156, 39, 176, 0.1);
            margin-left: 10px;
        }

        .window-control.theme:hover {
            background: rgba(156, 39, 176, 0.25);
            color: #fff;
            box-shadow: 0 2px 10px rgba(156, 39, 176, 0.3);
        }

        .window-control.update {
            background: rgba(33, 150, 243, 0.1);
        }

        .window-control.update:hover {
            background: rgba(33, 150, 243, 0.25);
            color: #fff;
            box-shadow: 0 2px 10px rgba(33, 150, 243, 0.3);
        }

        .window-control.refresh {
            background: rgba(76, 175, 80, 0.1);
        }

        .window-control.refresh:hover {
            background: rgba(76, 175, 80, 0.25);
            color: #fff;
            box-shadow: 0 2px 10px rgba(76, 175, 80, 0.3);
        }

        /* قائمة تحديد الثيم المنسدلة */
        .theme-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            min-width: 200px;
            z-index: 1002;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }

        .theme-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .theme-option {
            padding: 12px 16px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #333;
        }

        .theme-option:last-child {
            border-bottom: none;
        }

        .theme-option:hover {
            background-color: #f8f9fa;
        }

        .theme-option.active {
            background-color: #e3f2fd;
            color: #1976d2;
            font-weight: 500;
        }

        .theme-option i {
            width: 20px;
            text-align: center;
        }

        /* تحديثات تصميم الأزرار الوظيفية */
        .title-bar-center {
            display: flex;
            align-items: center;
            gap: 5px;
            -webkit-app-region: no-drag;
        }

        .title-bar-left {
            display: flex;
            align-items: center;
            flex-grow: 1;
            -webkit-app-region: drag;
            padding: 0 15px;
            user-select: none;
        }

        .title-bar-right {
            display: flex;
            align-items: center;
            -webkit-app-region: no-drag;
        }

        /* Header - تصميم محسن وجذاب */
        .header {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            box-shadow: 0 4px 25px rgba(0, 0, 0, 0.08);
            border-bottom: 1px solid var(--gray-200);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(15px);
            margin-top: 35px;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0.75rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1.5rem;
            min-height: 70px;
        }

        /* Logo Section */
        .header-logo-section {
            flex-shrink: 0;
        }

        .header-logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-icon {
            width: 45px;
            height: 45px;
            background: var(--gradient-primary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.25);
        }

        .logo-icon i {
            font-size: 1.5rem;
            color: white;
        }

        /* قائمة النقر الأيمن - Context Menu */
        .context-menu {
            position: fixed;
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            z-index: 9999;
            min-width: 200px;
            max-width: 250px;
            padding: 8px 0;
            font-size: 14px;
            display: none;
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }

        .context-menu-item {
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #374151;
            transition: all 0.2s ease;
            border: none;
            background: none;
            width: 100%;
            text-align: right;
            font-family: inherit;
        }

        .context-menu-item:hover {
            background: #f8fafc;
            color: #1e40af;
        }

        .context-menu-item:disabled {
            color: #9ca3af;
            cursor: not-allowed;
        }

        .context-menu-item:disabled:hover {
            background: transparent;
            color: #9ca3af;
        }

        .context-menu-item i {
            width: 16px;
            text-align: center;
            font-size: 14px;
        }

        .context-menu-separator {
            height: 1px;
            background: #e5e7eb;
            margin: 4px 0;
        }

        /* تحسين تصميم الحقول للتنقل بـ Enter */
        .form-control:focus,
        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="password"]:focus,
        input[type="number"]:focus,
        input[type="date"]:focus,
        input[type="tel"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            transform: translateY(-1px);
        }

        .form-control.next-field,
        input.next-field,
        textarea.next-field,
        select.next-field {
            border-color: var(--success-green);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .field-navigation-hint {
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .field-navigation-hint i {
            font-size: 10px;
        }

        /* تأثيرات بصرية للتنقل */
        .field-focus-indicator {
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border: 2px solid var(--primary-blue);
            border-radius: 6px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }

        .form-control.navigating .field-focus-indicator {
            opacity: 1;
        }

        /* تحسينات إضافية للتنقل والقائمة السياقية */
        .enhanced-input-container {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .input-enhancement-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            color: #6b7280;
            margin-top: 2px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .enhanced-input-container:focus-within .input-enhancement-bar {
            opacity: 1;
        }

        .keyboard-shortcut-hint {
            background: rgba(59, 130, 246, 0.1);
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            color: var(--primary-blue);
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .field-counter {
            background: rgba(107, 114, 128, 0.1);
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
        }

        /* تحسين تجربة النماذج الطويلة */
        .form-progress-indicator {
            position: sticky;
            top: 70px;
            background: white;
            padding: 10px;
            border-bottom: 1px solid #e5e7eb;
            z-index: 50;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .form-progress-bar {
            width: 100%;
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
        }

        .form-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-blue), var(--success-green));
            transition: width 0.3s ease;
            border-radius: 2px;
        }

        .form-progress-text {
            font-size: 12px;
            color: #6b7280;
            margin-top: 5px;
            text-align: center;
        }

        /* تحسين تصميم الأزرار المساعدة */
        .field-action-buttons {
            display: flex;
            gap: 5px;
            margin-top: 5px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .enhanced-input-container:focus-within .field-action-buttons {
            opacity: 1;
        }

        .field-action-btn {
            background: none;
            border: 1px solid #d1d5db;
            color: #6b7280;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s ease;
        }

        .field-action-btn:hover {
            background: #f3f4f6;
            border-color: var(--primary-blue);
            color: var(--primary-blue);
        }

        .field-action-btn.clear {
            border-color: #fca5a5;
            color: #ef4444;
        }

        .field-action-btn.clear:hover {
            background: #fef2f2;
            border-color: #ef4444;
        }

        /* تحسين تجربة الحقول المتقدمة */
        .smart-field-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e5e7eb;
            border-top: none;
            border-radius: 0 0 6px 6px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 100;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        .smart-suggestion-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            font-size: 13px;
            color: #374151;
            transition: background-color 0.15s ease;
        }

        .smart-suggestion-item:hover {
            background: #f8fafc;
        }

        .smart-suggestion-item:last-child {
            border-bottom: none;
        }

        .smart-suggestion-item.highlighted {
            background: var(--primary-blue-light);
            color: var(--primary-blue);
        }

        /* تحسين القائمة السياقية */
        .context-menu.enhanced {
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(229, 231, 235, 0.8);
        }

        .context-menu-item.with-shortcut {
            justify-content: space-between;
        }

        .context-menu-shortcut {
            font-size: 11px;
            color: #9ca3af;
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }

        /* تحسينات الإمكانية الوصول */
        .accessibility-focus {
            outline: 2px solid var(--primary-blue);
            outline-offset: 2px;
        }

        .screen-reader-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* تحسين التجاوب للأجهزة المحمولة */
        @media (max-width: 768px) {
            .context-menu {
                min-width: 180px;
                font-size: 16px;
            }
            
            .context-menu-item {
                padding: 16px 20px;
            }
            
            .field-navigation-hint {
                font-size: 14px;
                padding: 12px;
            }
            
            .keyboard-shortcut-hint {
                display: none;
            }
        }

        /* تحسين تجربة الطباعة */
        @media print {
            .context-menu,
            .field-navigation-hint,
            .form-navigation-info,
            .field-action-buttons,
            .template-modal-header,
            .template-modal-footer {
                display: none !important;
            }
            
            .template-modal {
                width: 100% !important;
                height: 100% !important;
                box-shadow: none !important;
                border-radius: 0 !important;
                margin: 0 !important;
            }
            
            .template-modal-body {
                padding: 0 !important;
            }
            
            .print-preview {
                font-family: 'Times New Roman', serif !important;
                font-size: 16pt !important;
                line-height: 1.8 !important;
                color: #000 !important;
                background: white !important;
            }
            
            .print-preview strong {
                font-weight: 900 !important;
                font-size: 18pt !important;
                color: #000 !important;
            }
            
            /* إخفاء جميع العناصر الأخرى أثناء الطباعة */
            body * {
                visibility: hidden;
            }
            
            #print-modal, 
            #print-modal * {
                visibility: visible;
            }
            
            #print-modal {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
            }
        }

        /* تحسينات إضافية للقالب الاحترافي عند الطباعة */
        @media print {
            @page {
                size: A4;
                margin: 3cm 2.5cm 3cm 2.5cm;
            }
            
            .professional-template {
                font-family: 'Times New Roman', serif !important;
                font-size: 14pt !important;
                line-height: 1.8 !important;
                color: #000 !important;
                background: white !important;
                direction: rtl !important;
                text-align: right !important;
                page-break-inside: avoid;
            }
            
            .professional-template .header-row {
                display: flex !important;
                justify-content: space-between !important;
                align-items: center !important;
                margin-bottom: 2cm !important;
            }
            
            .professional-template .plaintiff-info,
            .professional-template .defendant-info {
                font-size: 16pt !important;
                font-weight: 900 !important;
                margin-bottom: 1cm !important;
                text-align: right !important;
            }
            
            .professional-template .case-claim-title {
                font-size: 16pt !important;
                font-weight: 900 !important;
                margin-bottom: 1cm !important;
                text-align: right !important;
            }
            
            .professional-template .case-claim-content {
                font-size: 14pt !important;
                line-height: 2 !important;
                text-align: justify !important;
                text-indent: 1cm !important;
                margin-bottom: 2cm !important;
            }
            
            .professional-template .thanks-section {
                text-align: center !important;
                margin: 2cm 0 !important;
                font-size: 14pt !important;
            }
            
            .professional-template .evidence-section {
                text-align: right !important;
                margin-bottom: 3cm !important;
            }
            
            .professional-template .evidence-title {
                font-weight: 900 !important;
                font-size: 14pt !important;
                margin-bottom: 0.5cm !important;
            }
            
            .professional-template .lawyer-section {
                text-align: left !important;
                margin-top: 3cm !important;
                font-size: 14pt !important;
                font-weight: 900 !important;
            }
        }

        /* مؤشرات حالة المشاهدة في الدردشة - نمط WhatsApp */
        .read-status {
            display: inline-flex;
            align-items: center;
            margin-left: 4px;
        }

        .read-status i {
            font-size: 12px;
        }

        .message.sent:hover .read-status {
            opacity: 1;
        }

        .read-indicator {
            display: flex;
            align-items: center;
            font-size: 11px;
            color: var(--primary-blue);
            margin-left: 5px;
        }

        .read-indicator i {
            margin-left: 2px;
        }

        .unread-count {
            background: var(--error-red);
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 11px;
            min-width: 16px;
            text-align: center;
            font-weight: bold;
        }

        .message-status {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 3px;
            font-size: 11px;
            color: var(--gray-500);
        }

        .delivery-status {
            color: #999;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
        }

        .delivery-status.sending {
            color: #999;
            animation: pulse 1.5s infinite;
        }

        .delivery-status.delivered {
            color: #4fc3f7; /* أزرق فاتح للتسليم */
        }

        .delivery-status.read {
            color: #34c759; /* أخضر للمشاهدة */
        }

        .delivery-status.failed {
            color: #ff5252; /* أحمر للفشل */
        }

        /* أيقونات المشاهدة بنمط WhatsApp */
        .whatsapp-check {
            position: relative;
            display: inline-block;
            width: 16px;
            height: 12px;
        }

        .whatsapp-check::before,
        .whatsapp-check::after {
            content: '';
            position: absolute;
            width: 6px;
            height: 3px;
            border-bottom: 2px solid currentColor;
            border-right: 2px solid currentColor;
            transform: rotate(45deg);
        }

        .whatsapp-check::before {
            left: 0;
            top: 2px;
        }

        .whatsapp-check.double::after {
            left: 3px;
            top: 2px;
        }

        /* Container للرسائل مثل WhatsApp */
        .messages-container {
            background: linear-gradient(to bottom, 
                #e3ddd7 0%, 
                #d9d5c7 100%);
            background-image: 
                radial-gradient(circle at 1px 1px, rgba(255,255,255,0.3) 1px, transparent 0);
            background-size: 20px 20px;
            padding: 15px 10px;
            overflow-y: auto;
            flex: 1;
            position: relative;
            min-height: 400px;
        }

        body.dark-mode .messages-container {
            background: linear-gradient(to bottom, 
                #1a1a1a 0%, 
                #0d1117 100%);
            background-image: 
                radial-gradient(circle at 1px 1px, rgba(255,255,255,0.1) 1px, transparent 0);
        }

        /* تحسين الرؤية في الوضع الليلي */
        body.dark-mode .message.sent .message-content {
            background: #005c4b;
            color: #ffffff;
        }

        body.dark-mode .message.sent .message-content::after {
            border-left-color: #005c4b;
        }

        body.dark-mode .message.received .message-content {
            background: #262d31;
            color: #e9edef;
        }

        body.dark-mode .message.received .message-content::after {
            border-right-color: #262d31;
        }

        /* تأثير التمرير السلس */
        .messages-container::-webkit-scrollbar {
            width: 8px;
        }

        .messages-container::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 4px;
        }

        .messages-container::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        .messages-container::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        /* تأثير hover للرسائل */
        .message:hover {
            transform: translateY(-1px);
            transition: transform 0.2s ease;
        }

        .message.sent:hover .message-content {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .message.received:hover .message-content {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        /* مساحة إضافية بين مجموعات الرسائل */
        .message + .message {
            margin-top: 2px;
        }

        .message.sent + .message.received,
        .message.received + .message.sent {
            margin-top: 12px;
        }

        /* تجميع الرسائل المتتالية من نفس المرسل */
        .message.sent + .message.sent .message-content::after,
        .message.received + .message.received .message-content::after {
            display: none;
        }

        .message.sent + .message.sent .message-content {
            border-bottom-right-radius: 18px;
        }

        .message.received + .message.received .message-content {
            border-bottom-left-radius: 18px;
        }

        .message.sent:not(:has(+ .message.sent)) .message-content::after,
        .message.received:not(:has(+ .message.received)) .message-content::after {
            display: block;
        }

        .message.sent:not(:has(+ .message.sent)) .message-content {
            border-bottom-right-radius: 6px;
        }

        .message.received:not(:has(+ .message.received)) .message-content {
            border-bottom-left-radius: 6px;
        }

        /* تأثيرات تفاعلية محسنة */
        .message-content {
            transition: all 0.2s ease;
        }

        .message.sent .message-content:hover {
            background: #d1f2cb;
        }

        .message.received .message-content:hover {
            background: #f8f9fa;
        }

        /* إصلاح التداخل */
        .message::after {
            content: '';
            display: table;
            clear: both;
        }

        /* تحسينات إضافية للوضع الليلي */
        body.dark-mode .message.sent .message-content {
            background: #005c4b; /* أخضر داكن للوضع الليلي */
            color: #ffffff;
        }

        body.dark-mode .message.sent .message-content::after {
            border-left-color: #005c4b;
        }

        body.dark-mode .message.received .message-content {
            background: #262d31;
            color: #e9edef;
        }

        body.dark-mode .message.received .message-content::after {
            border-right-color: #262d31;
        }

        /* تحسين شريط إدخال الرسائل */
        .message-input-container {
            background: white;
            padding: 12px 16px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            align-items: flex-end;
            gap: 12px;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }

        .message-input {
            flex: 1;
            border: 1px solid #e0e0e0;
            border-radius: 25px;
            padding: 10px 18px;
            resize: none;
            outline: none;
            font-size: 15px;
            line-height: 1.4;
            max-height: 120px;
            min-height: 44px;
            font-family: inherit;
        }

        .message-input:focus {
            border-color: #00a884;
            box-shadow: 0 0 0 2px rgba(0, 168, 132, 0.1);
        }

        .send-button {
            background: #00a884;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 16px;
        }

        .send-button:hover {
            background: #008f72;
            transform: scale(1.05);
        }

        .send-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 10px 15px;
            background: var(--gray-100);
            border-radius: 15px;
            margin: 10px 0;
            font-size: 13px;
            color: var(--gray-600);
            animation: pulse 1.5s infinite;
        }

        .typing-indicator .dots {
            display: flex;
            gap: 2px;
        }

        .typing-indicator .dot {
            width: 4px;
            height: 4px;
            background: var(--primary-blue);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }

        .typing-indicator .dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator .dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* تحسين مظهر حالة المشاهدة في قائمة المحادثات */
        .lawyer-item .lawyer-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }

        .lawyer-item .lawyer-details {
            flex: 1;
        }

        .lawyer-item .conversation-status {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 2px;
        }

        .last-message-time {
            font-size: 11px;
            color: var(--gray-400);
        }

        .conversation-indicators {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .header-title {
            display: flex;
            flex-direction: column;
        }

        .header-title h1 {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--gray-900);
            margin: 0;
            line-height: 1.2;
        }

        .header-title p {
            font-size: 0.75rem;
            color: var(--gray-500);
            margin: 0;
            font-weight: 500;
        }

        /* Navigation Section */
        .header-navigation {
            flex: 1;
            display: flex;
            justify-content: center;
        }

        .nav-tabs {
            display: flex;
            gap: 0.25rem;
            background: var(--gray-100);
            padding: 0.375rem;
            border-radius: 12px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.06);
        }

        .nav-tab {
            padding: 0.625rem 1rem;
            border-radius: 8px;
            border: none;
            background: transparent;
            color: var(--gray-600);
            font-weight: 600;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            overflow: hidden;
            white-space: nowrap;
        }

        .nav-tab i {
            font-size: 0.875rem;
            flex-shrink: 0;
        }

        .nav-tab span {
            font-size: 0.8rem;
        }

        .nav-tab:hover {
            color: var(--primary-blue);
            background: rgba(59, 130, 246, 0.08);
            transform: translateY(-1px);
        }

        .nav-tab.active {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 3px 12px rgba(59, 130, 246, 0.3);
            transform: translateY(-1px);
        }

        .nav-tab.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1), transparent);
            animation: shimmer 3s infinite;
        }

        /* User Section */
        .header-user-section {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-shrink: 0;
        }

        .notification-area {
            position: relative;
        }

        .notification-btn {
            background: var(--gray-100);
            border: none;
            border-radius: 10px;
            padding: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notification-btn:hover {
            background: var(--primary-blue-light);
            transform: scale(1.05);
        }

        .notification-btn i {
            font-size: 1.125rem;
            color: var(--gray-600);
            transition: color 0.3s ease;
        }

        .notification-btn:hover i {
            color: var(--primary-blue);
        }

        .notification-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            background: var(--error-red);
            color: white;
            font-size: 0.625rem;
            font-weight: 700;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
            border: 2px solid white;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 1rem;
            border-radius: 12px;
            background: var(--gray-50);
            transition: all 0.3s ease;
            cursor: pointer;
            border: 1px solid var(--gray-200);
        }

        .user-profile:hover {
            background: var(--primary-blue-light);
            border-color: var(--primary-blue);
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.15);
        }

        .user-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            text-align: right;
        }

        .user-greeting {
            font-size: 0.7rem;
            color: var(--gray-500);
            font-weight: 500;
            margin-bottom: 0.125rem;
        }

        .user-name {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--gray-700);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: var(--gradient-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1rem;
            box-shadow: 0 3px 12px rgba(59, 130, 246, 0.3);
            border: 2px solid white;
        }

        .user-avatar span {
            font-size: 1rem;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 0.5rem;
            background: var(--gray-100);
            padding: 0.5rem;
            border-radius: 0.75rem;
        }

        .nav-tab {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            border: none;
            background: transparent;
            color: var(--gray-600);
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            overflow: hidden;
        }

        .nav-tab:hover {
            color: var(--primary-blue);
            background: white;
            transform: translateY(-1px);
        }

        .nav-tab.active {
            background: var(--gradient-primary);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .nav-tab.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.1);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* Header Right */
        .header-right {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .notification-bell {
            position: relative;
            cursor: pointer;
            padding: 0.75rem;
            border-radius: 50%;
            transition: all 0.3s ease;
            background: var(--gray-100);
            order: 2;
        }

        .notification-bell:hover {
            background: var(--primary-blue-light);
            transform: scale(1.1);
        }

        .notification-bell i {
            font-size: 1.25rem;
            color: var(--gray-600);
        }

        .notification-bell:hover i {
            color: var(--primary-blue);
        }

        .notification-badge {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: var(--error-red);
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 50%;
            width: 1.125rem;
            height: 1.125rem;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* إشعارات المحامين المخصصة */
        .lawyer-notification {
            background: linear-gradient(135deg, #e0e7ff, #c7d2fe) !important;
            border-left: 4px solid #6366f1 !important;
            animation: newNotification 0.5s ease-out;
        }

        .direct-update-notification {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0) !important;
            border-left: 4px solid #10b981 !important;
            animation: newNotification 0.5s ease-out;
        }

        @keyframes newNotification {
            0% {
                opacity: 0;
                transform: translateX(100%);
            }
            100% {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* أيقونة الإشعارات المحسنة */
        .notification-btn {
            position: relative;
            overflow: hidden;
        }

        .notification-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: translateX(-100%);
            transition: transform 0.6s;
        }

        .notification-btn:hover::before {
            transform: translateX(100%);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            background: var(--gray-50);
            transition: all 0.3s ease;
            cursor: pointer;
            order: 1;
        }

        .user-info:hover {
            background: var(--primary-blue-light);
        }

        .user-name {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--gray-700);
            order: 1;
        }

        .user-avatar {
            width: 2.5rem;
            height: 2.5rem;
            background: var(--gradient-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1.125rem;
            box-shadow: var(--shadow-md);
            order: 2;
        }

        /* تحسينات للتصميم الجديد للهيدر */
        @media (max-width: 1200px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }
            
            .header-logo-section {
                order: 1;
            }
            
            .header-navigation {
                order: 2;
                width: 100%;
            }
            
            .header-user-section {
                order: 3;
            }
            
            .nav-tabs {
                justify-content: center;
                overflow-x: auto;
                padding: 0.5rem;
            }
            
            .nav-tab {
                flex-shrink: 0;
                padding: 0.625rem 1rem;
            }
            
            .nav-tab span {
                display: none;
            }
            
            .nav-tab i {
                font-size: 1rem;
            }
        }

        @media (max-width: 768px) {
            .header-title h1 {
                font-size: 1rem;
            }
            
            .header-title p {
                font-size: 0.7rem;
            }
            
            .logo-icon {
                width: 35px;
                height: 35px;
            }
            
            .logo-icon i {
                font-size: 1.25rem;
            }
            
            .user-info {
                font-size: 0.8rem;
            }
            
            .user-greeting {
                display: none;
            }
            
            .nav-tab {
                padding: 0.5rem;
            }
        }

        /* Main Content */
        .main-content {
            width: 100%;
            padding: 1.5rem;
            min-height: calc(100vh - 73px);
        }

        .full-width-container {
            width: 100%;
            max-width: none;
            margin: 0;
            padding: 0 1rem;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: var(--shadow-md);
            padding: 2rem;
            border: 1px solid var(--gray-200);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-xl);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }

        .card h3 {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: var(--gray-900);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .stat-card {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
        }

        .stat-card.blue::before { background: var(--gradient-primary); }
        .stat-card.yellow::before { background: linear-gradient(135deg, var(--warning-yellow), #d97706); }
        .stat-card.green::before { background: var(--gradient-success); }
        .stat-card.purple::before { background: linear-gradient(135deg, var(--purple), #7c3aed); }

        .stat-info p:first-child {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--gray-600);
        }

        .stat-info p:last-child {
            font-size: 2.25rem;
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-card.yellow .stat-info p:last-child {
            background: linear-gradient(135deg, var(--warning-yellow), #d97706);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-card.green .stat-info p:last-child {
            background: var(--gradient-success);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-card.purple .stat-info p:last-child {
            background: linear-gradient(135deg, var(--purple), #7c3aed);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-icon {
            font-size: 3rem;
            opacity: 0.8;
            padding: 1rem;
            border-radius: 1rem;
            background: var(--gray-50);
        }

        .blue .stat-icon { color: var(--primary-blue); }
        .yellow .stat-icon { color: var(--warning-yellow); }
        .green .stat-icon { color: var(--success-green); }
        .purple .stat-icon { color: var(--purple); }

        /* Grid Layouts */
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 2rem;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
        }

        .grid-full {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
            width: 100%;
        }

        /* Content Header */
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .content-title {
            font-size: 2rem;
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .content-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        /* Buttons */
        .btn {
            padding: 0.875rem 1.75rem;
            border-radius: 0.75rem;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.875rem;
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
            transform: translate(-50%, -50%);
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--gray-600), var(--gray-700));
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-secondary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-success {
            background: var(--gradient-success);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--error-red), #dc2626);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-danger:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* Table Styles */
        .table-container {
            background: white;
            border-radius: 1rem;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            border: 1px solid var(--gray-200);
        }

        .table-header {
            padding: 2rem;
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
        }

        .search-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 300px;
            padding: 0.875rem 1.25rem;
            border: 2px solid var(--gray-300);
            border-radius: 0.75rem;
            font-size: 0.875rem;
            transition: all 0.3s ease;
            background: white;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            transform: translateY(-1px);
        }

        .table-wrapper {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        thead {
            background: linear-gradient(135deg, var(--gray-50), var(--gray-100));
        }

        th {
            padding: 1.25rem 1.5rem;
            text-align: right;
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--gray-700);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 2px solid var(--gray-200);
            position: relative;
        }

        th::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--gradient-primary);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        th:hover::after {
            transform: scaleX(1);
        }

        td {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            vertical-align: middle;
        }

        tbody tr {
            transition: all 0.3s ease;
        }

        tbody tr:hover {
            background: var(--gray-50);
            transform: scale(1.01);
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        .client-info {
            display: flex;
            flex-direction: column;
        }

        .client-name {
            font-size: 0.875rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 0.5rem;
        }

        .client-update {
            font-size: 0.75rem;
            color: var(--gray-500);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .client-update i {
            color: var(--primary-blue);
        }

        /* Status Badges */
        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            overflow: hidden;
        }

        .status-badge::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }

        .status-badge:hover::before {
            left: 100%;
        }

        .status-under-trial {
            background: var(--warning-yellow-light);
            color: #92400e;
            border: 1px solid var(--warning-yellow);
        }

        .status-judgment-issued {
            background: var(--success-green-light);
            color: #166534;
            border: 1px solid var(--success-green);
        }

        .status-notification-issued {
            background: var(--primary-blue-light);
            color: #1e40af;
            border: 1px solid var(--primary-blue);
        }

        .status-execution {
            background: var(--purple-light);
            color: #6b21a8;
            border: 1px solid var(--purple);
        }

        /* Action Buttons */
        .actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .action-btn {
            padding: 0.75rem;
            border: none;
            background: none;
            cursor: pointer;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .action-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            transition: all 0.3s ease;
            transform: translate(-50%, -50%);
        }

        .action-btn:hover::before {
            width: 100px;
            height: 100px;
        }

        .action-btn:hover {
            transform: scale(1.1);
        }

        .action-btn.view { color: var(--primary-blue); }
        .action-btn.view:hover::before { background: var(--primary-blue-light); }

        .action-btn.edit { color: var(--success-green); }
        .action-btn.edit:hover::before { background: var(--success-green-light); }

        .action-btn.delete { color: var(--error-red); }
        .action-btn.delete:hover::before { background: var(--error-red-light); }

        .action-btn i {
            font-size: 1rem;
            position: relative;
            z-index: 1;
        }

        /* Forms */
        .form-container {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: var(--shadow-lg);
            max-width: 600px;
            margin: 0 auto;
        }

        .form-field {
            margin-bottom: 2rem;
        }

        .form-field:last-child {
            margin-bottom: 0;
        }

        .form-field label {
            display: block;
            font-size: 0.875rem;
            font-weight: 700;
            color: var(--gray-700);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-field label i {
            color: var(--primary-blue);
        }

        .form-field input,
        .form-field textarea,
        .form-field select {
            width: 100%;
            padding: 1rem 1.25rem;
            border: 2px solid var(--gray-300);
            border-radius: 0.75rem;
            font-size: 0.875rem;
            transition: all 0.3s ease;
            background: white;
        }

        .form-field input:focus,
        .form-field textarea:focus,
        .form-field select:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            transform: translateY(-1px);
        }

        .form-field textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Enhanced Form Fields */
        .case-form-sections {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            width: 100%;
        }

        .case-section {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            border: 1px solid var(--gray-200);
            box-shadow: var(--shadow-sm);
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: var(--gray-900);
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--gray-200);
        }

        .section-title i {
            color: var(--primary-blue);
            font-size: 1.5rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-field-full {
            grid-column: 1 / -1;
        }

        .form-field.required label::after {
            content: ' *';
            color: var(--error-red);
            font-weight: bold;
        }

        /* File Upload Styles */
        .file-upload-area {
            border: 2px dashed var(--gray-300);
            border-radius: 0.75rem;
            padding: 2rem;
            text-align: center;
            background: var(--gray-50);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-upload-area:hover {
            border-color: var(--primary-blue);
            background: var(--primary-blue-light);
        }

        .file-upload-area.active {
            border-color: var(--primary-blue);
            background: var(--primary-blue-light);
        }

        .file-upload-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .file-upload-icon {
            font-size: 3rem;
            color: var(--gray-400);
        }

        .file-upload-area:hover .file-upload-icon {
            color: var(--primary-blue);
        }

        .file-upload-text {
            color: var(--gray-600);
            font-weight: 600;
        }

        .file-upload-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .uploaded-files {
            margin-top: 1rem;
        }

        .uploaded-file {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .file-icon {
            font-size: 1.5rem;
            color: var(--primary-blue);
        }

        .file-details {
            display: flex;
            flex-direction: column;
        }

        .file-name {
            font-weight: 600;
            color: var(--gray-900);
        }

        .file-size {
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        .file-actions {
            display: flex;
            gap: 0.5rem;
        }

        .file-action-btn {
            padding: 0.5rem;
            border: none;
            background: none;
            cursor: pointer;
            border-radius: 0.25rem;
            transition: all 0.3s ease;
        }

        .file-action-btn:hover {
            background: var(--gray-100);
        }

        .file-action-btn.delete {
            color: var(--error-red);
        }

        .file-action-btn.view {
            color: var(--primary-blue);
        }

        /* Execution Options */
        .execution-options {
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            background: var(--indigo-light);
            border-radius: 0.75rem;
            border: 1px solid var(--indigo);
        }

        .execution-options.show {
            display: block;
        }

        .execution-option {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: white;
            border-radius: 0.5rem;
            border: 1px solid var(--gray-200);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .execution-option:hover {
            background: var(--gray-50);
            transform: translateX(-2px);
        }

        .execution-option input[type="checkbox"] {
            width: 1.25rem;
            height: 1.25rem;
            accent-color: var(--primary-blue);
        }

        .execution-option-label {
            font-weight: 600;
            color: var(--gray-900);
        }

        /* Deduction Table Styles */
        .deduction-summary {
            background: var(--success-green-light);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid var(--success-green);
        }

        .deduction-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .deduction-summary-item {
            text-align: center;
        }

        .deduction-summary-value {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--success-green);
            margin-bottom: 0.25rem;
        }

        .deduction-summary-label {
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        /* Remaining Amount Display */
        .remaining-amount {
            background: var(--error-red-light);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid var(--error-red);
        }

        .remaining-amount-value {
            font-size: 1.25rem;
            font-weight: 800;
            color: var(--error-red);
            text-align: center;
        }

        .remaining-amount-label {
            font-size: 0.875rem;
            color: var(--gray-600);
            text-align: center;
            margin-bottom: 0.5rem;
        }

        /* Global Search */
        .global-search-container {
            background: white;
            padding: 1rem 1.5rem;
            border-radius: 1rem;
            box-shadow: var(--shadow-md);
            margin-bottom: 1.5rem;
            margin-top: 2rem;
            border: 1px solid var(--gray-200);
        }

        .global-search-wrapper {
            position: relative;
            max-width: 600px;
            margin: 0 auto;
        }

        .global-search-input {
            width: 100%;
            padding: 1rem 1.5rem 1rem 3.5rem;
            border: 2px solid var(--gray-300);
            border-radius: 0.75rem;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
            box-shadow: var(--shadow-sm);
        }

        .global-search-input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15);
            transform: translateY(-1px);
        }

        .global-search-icon {
            position: absolute;
            left: 1.25rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-400);
            font-size: 1.125rem;
            transition: color 0.3s ease;
        }

        .global-search-input:focus + .global-search-icon {
            color: var(--primary-blue);
        }

        .global-search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--gray-300);
            border-radius: 0.75rem;
            box-shadow: var(--shadow-xl);
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            margin-top: 0.5rem;
            display: none;
        }

        .global-search-results.show {
            display: block;
        }

        .search-result-item {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .search-result-item:hover {
            background: var(--gray-50);
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-type {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--primary-blue);
            margin-bottom: 0.25rem;
            text-transform: uppercase;
        }

        .search-result-title {
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 0.25rem;
        }

        .search-result-description {
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        .search-no-results {
            padding: 2rem;
            text-align: center;
            color: var(--gray-500);
        }

        /* Filters Panel */
        .filters-panel {
            background: white;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            box-shadow: var(--shadow-sm);
            margin-bottom: 1rem;
            border: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
            min-height: 45px;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-group label {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--gray-700);
            white-space: nowrap;
        }

        .filter-group select,
        .filter-group input {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            min-width: 150px;
        }

        /* Progress Steps */
        .progress-container {
            margin-bottom: 2rem;
        }

        .progress-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 2rem;
            color: var(--gray-900);
            text-align: center;
        }

        .progress-steps {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
            padding: 2rem;
            background: var(--gray-50);
            border-radius: 1rem;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
            position: relative;
        }

        .step-circle {
            width: 3.5rem;
            height: 3.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: 700;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .step-circle::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 50%;
            background: linear-gradient(45deg, rgba(255,255,255,0.3), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .step-circle:hover::before {
            opacity: 1;
        }

        .step-circle.completed {
            background: var(--gradient-success);
            color: white;
            box-shadow: var(--shadow-md);
            animation: completedPulse 2s infinite;
        }

        @keyframes completedPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .step-circle.pending {
            background: var(--gray-200);
            color: var(--gray-600);
            border: 2px solid var(--gray-300);
        }

        .step-name {
            font-size: 0.875rem;
            font-weight: 600;
            white-space: nowrap;
            text-align: center;
            max-width: 120px;
        }

        .step-name.completed {
            color: var(--success-green);
            font-weight: 700;
        }

        .step-name.pending {
            color: var(--gray-500);
        }

        .step-connector {
            position: absolute;
            top: 1.75rem;
            right: -2rem;
            width: 3rem;
            height: 0.25rem;
            border-radius: 0.125rem;
            transition: background-color 0.3s ease;
        }

        .step-connector.completed {
            background: var(--gradient-success);
        }

        .step-connector.pending {
            background: var(--gray-200);
        }

        /* Case Details */
        .case-details-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
        }

        .case-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .info-field {
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
            background: var(--gray-50);
            border-radius: 0.75rem;
            border: 1px solid var(--gray-200);
            transition: all 0.3s ease;
        }

        .info-field:hover {
            background: white;
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }

        .info-field label {
            font-size: 0.875rem;
            font-weight: 700;
            color: var(--gray-700);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .info-field label i {
            color: var(--primary-blue);
        }

        .info-field p {
            color: var(--gray-900);
            font-weight: 600;
            font-size: 1rem;
        }

        .info-field.highlight p {
            color: var(--success-green);
            font-weight: 800;
            font-size: 1.25rem;
        }

        /* Timeline */
        .timeline {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            position: relative;
        }

        .timeline::before {
            content: '';
            position: absolute;
            right: 1rem;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--gradient-primary);
            border-radius: 2px;
        }

        .timeline-item {
            padding: 1.5rem 2rem 1.5rem 1.5rem;
            background: white;
            border-radius: 1rem;
            position: relative;
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
        }

        .timeline-item:hover {
            transform: translateX(-5px);
            box-shadow: var(--shadow-lg);
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            right: -0.5rem;
            top: 1.5rem;
            width: 1rem;
            height: 1rem;
            border-radius: 50%;
            background: white;
            border: 4px solid var(--primary-blue);
        }

        .timeline-item.blue::before { border-color: var(--primary-blue); }
        .timeline-item.yellow::before { border-color: var(--warning-yellow); }
        .timeline-item.green::before { border-color: var(--success-green); }

        .timeline-title {
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--gray-900);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .timeline-title i {
            color: var(--primary-blue);
        }

        .timeline-desc {
            font-size: 0.875rem;
            color: var(--gray-600);
            line-height: 1.6;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            transform: scale(0.9);
            transition: all 0.3s ease;
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--gray-200);
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-900);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray-500);
            transition: all 0.3s ease;
            padding: 0.5rem;
            border-radius: 50%;
        }

        .modal-close:hover {
            color: var(--error-red);
            background: var(--error-red-light);
            transform: rotate(90deg);
        }

        /* Firebase Status Bar */
        .firebase-status-bar {
            position: fixed;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            margin: -2rem -2rem 2rem -2rem;
            padding: 1.5rem 2rem;
            border-radius: 1rem 1rem 0 0;
        }

        #db-admin-login-modal .modal-header h3 {
            margin: 0;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        #db-admin-login-modal .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        #db-admin-login-modal .close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }

        .warning-message {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 2px solid #f39c12;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .warning-message i {
            color: #f39c12;
            margin-top: 0.1rem;
            font-size: 1.1rem;
        }

        .login-help {
            margin-top: 1rem;
            padding: 0.75rem;
            background: #e3f2fd;
            border-radius: 0.5rem;
            border-left: 4px solid #2196f3;
        }

        .login-help i {
            color: #2196f3;
            margin-right: 0.5rem;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            user-select: none;
        }

        .checkbox-label .checkmark {
            width: 20px;
            height: 20px;
            border: 2px solid #ddd;
            border-radius: 4px;
            position: relative;
            transition: all 0.3s ease;
        }

        .checkbox-label input[type="checkbox"] {
            display: none;
        }

        .checkbox-label input[type="checkbox"]:checked + .checkmark {
            background: #e74c3c;
            border-color: #e74c3c;
        }

        .checkbox-label input[type="checkbox"]:checked + .checkmark::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        /* Firebase Status Bar */
        .firebase-status-bar {
            position: fixed;
            padding: 0.5rem 1rem; /* تقليل المسافة الداخلية */
            margin-bottom: 0.5rem; /* تقليل المسافة السفلية */
            background: white;
            border-radius: 0.5rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid #e0e0e0;
        }

        .admin-warning {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            border: 2px solid #f44336;
            border-radius: 0.5rem;
            padding: 0.5rem; /* تقليل المسافة الداخلية */
            margin-bottom: 0.5rem; /* تقليل المسافة السفلية */
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            color: #d32f2f;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.15);
        }

        .admin-warning i {
            font-size: 1.1rem;
            color: #f44336;
            margin-top: 0.1rem;
        }

        .section-subtitle {
            color: var(--gray-600);
            font-size: 0.9rem;
            margin: 0.25rem 0 0 0;
            font-weight: 400;
        }

        .header-left h2 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--gray-800);
            font-size: 1.25rem;
        }

        /* Database Overview Stats */
        .db-overview {
            background: white;
            border-radius: 0.5rem;
            padding: 0.75rem; /* تقليل المسافة الداخلية */
            margin-bottom: 0.5rem; /* تقليل المسافة السفلية */
            box-shadow: var(--shadow-md);
            border: 1px solid #e0e0e0;
        }

        .db-overview h3 {
            margin-bottom: 0.5rem; /* تقليل المسافة السفلية */
            color: var(--gray-800);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 0.5rem;
        }

        .stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 0.5rem;
            padding: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            border: 2px solid #e0e0e0;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            min-height: 70px;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary-blue);
        }

        .stat-card.cases-stat::before {
            background: #3b82f6;
        }

        .stat-card.defendants-stat::before {
            background: #10b981;
        }

        .stat-card.lawyers-stat::before {
            background: #f59e0b;
        }

        .stat-card.deductions-stat::before {
            background: #ef4444;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border-color: var(--primary-blue);
        }

        .stat-icon {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            color: white;
            background: var(--primary-blue);
            flex-shrink: 0;
        }

        .cases-stat .stat-icon {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        .defendants-stat .stat-icon {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .lawyers-stat .stat-icon {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .deductions-stat .stat-icon {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .stat-content h4 {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
            color: var(--gray-800);
        }

        .stat-content p {
            margin: 0.25rem 0 0 0;
            color: var(--gray-600);
            font-size: 0.875rem;
            font-weight: 500;
        }

        .db-navigator {
            background: white;
            border-radius: 0.75rem;
            padding: 1.25rem;
            margin-bottom: 1rem;
            box-shadow: var(--shadow-md);
            border: 1px solid #e0e0e0;
        }

        .db-navigator h3 {
            margin-bottom: 1rem;
            color: var(--gray-800);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.1rem;
        }

        .table-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 0.75rem;
        }

        .table-btn {
            display: block;
            width: 100%;
            padding: 0;
            border: 2px solid #e0e0e0;
            border-radius: 0.75rem;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: right;
            overflow: hidden;
        }

        .table-btn:hover {
            border-color: var(--primary-blue);
            background: var(--primary-blue-light);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .table-btn.active {
            border-color: var(--primary-blue);
            background: var(--primary-blue);
            color: white;
        }

        .table-btn-content {
            padding: 1rem;
        }

        .table-btn-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .table-btn-header i {
            font-size: 1.1rem;
        }

        .table-btn-header span {
            font-weight: 700;
            font-size: 0.95rem;
        }

        .table-btn-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-description {
            font-size: 0.8rem;
            opacity: 0.8;
            flex: 1;
        }

        .record-count {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.2rem 0.6rem;
            border-radius: 1rem;
            font-size: 0.8rem;
            font-weight: 700;
            margin-right: 0.5rem;
        }

        .table-btn.active .record-count {
            background: rgba(255, 255, 255, 0.3);
        }

        .table-btn:not(.active) .record-count {
            background: var(--gray-100);
            color: var(--gray-700);
        }

        .db-content {
            background: white;
            border-radius: 0.5rem;
            padding: 1rem;
            box-shadow: var(--shadow-md);
            border: 1px solid #e0e0e0;
            margin-bottom: 0.5rem;
        }

        .db-table-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--gray-200);
        }

        .table-header-left h3 {
            margin: 0;
            color: var(--gray-800);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.1rem;
        }

        .table-info {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.25rem;
        }

        .current-table-count {
            color: var(--gray-600);
            font-size: 0.75rem;
            background: var(--gray-100);
            padding: 0.15rem 0.5rem;
            border-radius: 1rem;
            font-weight: 600;
        }

        .table-status {
            color: var(--success-green);
            font-size: 0.75rem;
            background: var(--success-green-light);
            padding: 0.15rem 0.5rem;
            border-radius: 1rem;
            font-weight: 600;
        }

        .table-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .search-container {
            position: relative;
            margin-bottom: 0.75rem;
        }

        .search-input-wrapper {
            position: relative;
        }

        .search-container input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border: 2px solid #e0e0e0;
            border-radius: 0.5rem;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            background: white;
        }

        .search-container input:focus {
            border-color: var(--primary-blue);
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-400);
            font-size: 0.9rem;
        }

        .search-results {
            margin-top: 0.5rem;
            color: var(--gray-600);
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .db-table-container {
            overflow-x: auto;
            margin-bottom: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #e0e0e0;
            max-height: 500px;
            overflow-y: auto;
        }

        .database-table {
            width: 100%;
            min-width: 800px;
        }

        .database-table table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        .database-table th,
        .database-table td {
            padding: 0.75rem 0.5rem;
            text-align: right;
            border-bottom: 1px solid #e0e0e0;
            vertical-align: middle;
            font-size: 0.85rem;
        }

        .database-table th {
            background: var(--gray-50);
            font-weight: 700;
            color: var(--gray-800);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
        }

        .database-table tr:hover {
            background: var(--gray-50);
        }

        .database-table .action-cell {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
        }

        .database-table .action-btn {
            padding: 0.25rem 0.5rem;
            border: none;
            border-radius: 0.25rem;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .database-table .view-btn {
            background: #2196f3;
            color: white;
        }

        .database-table .edit-btn {
            background: #4caf50;
            color: white;
        }

        .database-table .delete-btn {
            background: #f44336;
            color: white;
        }

        .database-table .action-btn:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-sm);
        }

        .loading-state,
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--gray-500);
        }

        .loading-state i,
        .empty-state i {
            font-size: 2.5rem;
            margin-bottom: 0.75rem;
            color: var(--gray-400);
        }

        .loading-state h3,
        .empty-state h3 {
            margin-bottom: 0.5rem;
            color: var(--gray-600);
            font-size: 1.1rem;
        }

        .loading-state p,
        .empty-state p {
            color: var(--gray-500);
            font-size: 0.9rem;
        }

        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.75rem;
            padding-bottom: 0.5rem;
        }

        .pagination-btn {
            padding: 0.5rem 0.75rem;
            border: 1px solid #e0e0e0;
            background: white;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .pagination-btn:hover:not(:disabled) {
            background: var(--primary-blue);
            color: white;
            border-color: var(--primary-blue);
        }

        .pagination-btn.active {
            background: var(--primary-blue);
            color: white;
            border-color: var(--primary-blue);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Database Record Details Modal */
        .record-details {
            max-width: 600px;
            width: 100%;
        }

        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--gray-200);
        }

        .record-header h3 {
            margin: 0;
            color: var(--gray-800);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .record-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
        }

        .record-content {
            max-height: 500px;
            overflow-y: auto;
            margin-bottom: 1rem;
        }

        .field-group {
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: var(--gray-50);
            border-radius: 0.5rem;
            border: 1px solid #e0e0e0;
        }

        .field-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--gray-700);
            font-size: 0.9rem;
        }

        .field-value {
            position: relative;
        }

        .field-value .view-mode {
            display: block;
            padding: 0.5rem;
            background: white;
            border-radius: 0.375rem;
            border: 1px solid #e0e0e0;
            min-height: 40px;
            word-break: break-word;
        }

        .field-value .edit-mode {
            width: 100%;
            padding: 0.5rem;
            border: 2px solid var(--primary-blue);
            border-radius: 0.375rem;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .field-value .edit-mode:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .record-footer {
            padding-top: 1rem;
            border-top: 2px solid var(--gray-200);
        }

        .edit-actions {
            display: flex;
            justify-content: center;
            gap: 1rem;
        }

        .hidden {
            display: none !important;
        }

        /* Add Record Form */
        .add-record-form {
            max-width: 500px;
            width: 100%;
        }

        .add-record-form h3 {
            margin-bottom: 1.5rem;
            color: var(--gray-800);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--gray-700);
            font-weight: 600;
        }

        .form-group .required {
            color: var(--error-red);
            margin-right: 0.25rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-actions {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 2px solid var(--gray-200);
        }

        @media (max-width: 1024px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }
            
            .table-list {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }

            .db-overview,
            .db-navigator,
            .db-content {
                margin-bottom: 0.75rem;
                padding: 1rem;
            }
        }

        @media (max-width: 768px) {
            #database-admin-content {
                padding: 50px 0.5rem 0.5rem 0.5rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            
            .db-table-header {
                flex-direction: column;
                gap: 0.5rem;
                align-items: stretch;
            }
            
            .table-actions {
                justify-content: center;
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            
            .search-container input {
                font-size: 16px; /* منع التكبير على iOS */
                padding: 0.75rem 1rem 0.75rem 2.5rem;
            }

            .db-overview,
            .db-navigator,
            .db-content {
                padding: 0.75rem;
                margin-bottom: 0.5rem;
            }

            .section-header {
                padding: 0.5rem;
                margin-bottom: 0.5rem;
            }

            .admin-warning {
                padding: 0.5rem;
                margin-bottom: 0.5rem;
            }
        }

        @media (max-width: 480px) {
            #database-admin-content {
                padding: 50px 0.25rem 0.25rem 0.25rem;
            }

            .stat-card {
                flex-direction: column;
                text-align: center;
                gap: 0.5rem;
                padding: 0.5rem;
                min-height: auto;
            }
            
            .table-btn-content {
                padding: 0.5rem;
            }
            
            .table-btn-meta {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.25rem;
            }

            .db-overview,
            .db-navigator,
            .db-content {
                padding: 0.5rem;
                margin-bottom: 0.25rem;
            }

            .section-header {
                padding: 0.5rem;
                margin-bottom: 0.25rem;
            }

            .admin-warning {
                padding: 0.5rem;
                margin-bottom: 0.25rem;
                font-size: 0.85rem;
            }

            .db-table-container {
                max-height: 300px;
            }

            .database-table th,
            .database-table td {
                padding: 0.5rem 0.25rem;
                font-size: 0.75rem;
            }

            .database-table .action-btn {
                padding: 0.2rem 0.4rem;
                font-size: 0.65rem;
            }
        }
        @media (max-width: 768px) {
            .table-list {
                grid-template-columns: 1fr;
            }
            
            .db-table-header {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }
            
            .table-actions {
                justify-content: center;
                flex-wrap: wrap;
            }
        }

        /* Notifications */
        #notification-container {
            position: fixed;
            top: 2rem;
            left: 2rem;
            z-index: 1002;
            max-width: 400px;
            pointer-events: none;
        }

        #notification-container .notification {
            pointer-events: all;
            margin-bottom: 1rem;
        }

        .notification {
            position: relative;
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: var(--shadow-xl);
            border-right: 4px solid var(--primary-blue);
            z-index: 1001;
            transform: translateX(-100%);
            transition: all 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-color: var(--success-green);
        }

        .notification.warning {
            border-color: var(--warning-yellow);
        }

        .notification.error {
            border-color: var(--error-red);
        }

        .notification-content {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
        }

        .notification-icon {
            font-size: 1.25rem;
            padding: 0.5rem;
            border-radius: 50%;
        }

        .notification.success .notification-icon {
            background: var(--success-green-light);
            color: var(--success-green);
        }

        .notification.warning .notification-icon {
            background: var(--warning-yellow-light);
            color: var(--warning-yellow);
        }

        .notification.error .notification-icon {
            background: var(--error-red-light);
            color: var(--error-red);
        }

        .notification-text {
            flex: 1;
        }

        .notification-title {
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--gray-900);
        }

        .notification-message {
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        .notification-close {
            background: none;
            border: none;
            padding: 0.5rem;
            margin-right: 0.5rem;
            border-radius: 50%;
            cursor: pointer;
            color: var(--gray-400);
            font-size: 0.875rem;
            transition: all 0.2s ease;
            min-width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notification-close:hover {
            background: var(--gray-100);
            color: var(--gray-600);
            transform: scale(1.1);
        }

        .notification.error .notification-close:hover {
            background: var(--error-red-light);
            color: var(--error-red);
        }

        .notification.warning .notification-close:hover {
            background: var(--warning-yellow-light);
            color: var(--warning-yellow);
        }

        .notification.success .notification-close:hover {
            background: var(--success-green-light);
            color: var(--success-green);
        }

        /* Templates Styles */
        .templates-summary {
            margin-bottom: 2rem;
        }

        .templates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .template-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.9));
            backdrop-filter: blur(20px);
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            transition: all 0.4s ease;
            cursor: pointer;
            text-align: center;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .template-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }

        .template-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 50px rgba(99, 102, 241, 0.15);
            border-color: var(--primary);
        }

        .template-card:hover::before {
            transform: translateY(0);
        }

        .template-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-light), rgba(139, 92, 246, 0.1));
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            transition: all 0.3s ease;
        }

        .template-icon.add-new {
            background: linear-gradient(135deg, var(--success), #059669);
        }

        .template-icon i {
            font-size: 2rem;
            color: var(--primary);
            transition: all 0.3s ease;
        }

        .template-icon.add-new i {
            color: white;
        }

        .template-card:hover .template-icon {
            transform: scale(1.1) rotate(5deg);
        }

        .template-card h3 {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
            color: var(--dark);
        }

        .template-card p {
            color: var(--gray);
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 1.5rem;
        }

        .template-actions {
            margin-top: auto;
        }

        .template-actions .btn {
            border-radius: 2rem;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .template-actions .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.3);
        }

        .recent-templates {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        }

        .recent-templates h3 {
            margin-bottom: 1.5rem;
            color: var(--dark);
            font-weight: 700;
        }

        /* Template Modal Styles */
        .template-modal {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-radius: 2rem;
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.3);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay[style*="flex"] {
            opacity: 1;
            visibility: visible;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 0.5rem;
            text-align: center;
        }

        .badge-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .badge-success {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
        }

        .badge-warning {
            background: linear-gradient(135deg, var(--warning), #f59e0b);
            color: white;
        }

        .template-modal-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .template-modal-header h3 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .template-modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .template-modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .template-modal-body {
            padding: 2rem;
            max-height: 70vh;
            overflow-y: auto;
        }

        .template-form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .template-form-group {
            margin-bottom: 1.5rem;
        }

        .template-form-group.full-width {
            grid-column: 1 / -1;
        }

        .template-form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--dark);
        }

        .template-form-group input,
        .template-form-group textarea,
        .template-form-group select {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--border);
            border-radius: 1rem;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
        }

        .template-form-group input:focus,
        .template-form-group textarea:focus,
        .template-form-group select:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .template-form-group textarea {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
            line-height: 1.6;
        }

        .template-preview {
            background: var(--gray-light);
            border-radius: 1rem;
            padding: 2rem;
            margin: 2rem 0;
            border: 2px dashed var(--border);
            font-family: 'Times New Roman', serif;
            line-height: 1.8;
            white-space: pre-wrap;
        }

        .template-modal-footer {
            background: var(--gray-light);
            padding: 1.5rem 2rem;
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .template-modal-footer .btn {
            border-radius: 1rem;
            padding: 0.875rem 2rem;
            font-weight: 600;
        }

        /* Print Styles */
        .print-preview {
            background: white;
            padding: 3rem;
            margin: 2rem 0;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.1);
            border-radius: 0.5rem;
            font-family: 'Times New Roman', serif;
            line-height: 2;
            font-size: 14px;
            color: #000;
        }

        @media print {
            .template-modal,
            .template-modal-header,
            .template-modal-footer {
                background: white !important;
                box-shadow: none !important;
                backdrop-filter: none !important;
            }
            
            .template-modal-header,
            .template-modal-footer,
            .btn {
                display: none !important;
            }
            
            .template-modal-body {
                padding: 0 !important;
                max-height: none !important;
                overflow: visible !important;
            }
            
            .print-preview {
                box-shadow: none !important;
                margin: 0 !important;
                padding: 0 !important;
            }
        }

        /* Chat Styles */
        .chat-container {
            display: flex;
            height: 600px;
            background: white;
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
        }

        .chat-sidebar {
            width: 300px;
            background: var(--gray-50);
            border-left: 1px solid var(--gray-200);
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 1.5rem;
            background: var(--primary-blue);
            color: white;
            text-align: center;
            font-weight: 700;
        }

        .lawyers-list {
            flex: 1;
            overflow-y: auto;
            padding: 1rem 0;
        }

        .lawyer-item {
            padding: 1rem 1.5rem;
            cursor: pointer;
            border-bottom: 1px solid var(--gray-200);
            transition: all 0.3s ease;
            position: relative;
        }

        .lawyer-item:hover {
            background: var(--primary-blue-light);
        }

        .lawyer-item.active {
            background: var(--primary-blue);
            color: white;
        }

        .lawyer-item.has-unread {
            background: var(--warning-yellow-light);
            border-right: 4px solid var(--warning-yellow);
        }

        .lawyer-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .lawyer-status {
            font-size: 0.75rem;
            opacity: 0.7;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--gray-400);
        }

        .status-indicator.online {
            background: var(--success-green);
            animation: pulse 2s infinite;
        }

        .unread-count {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            background: var(--error-red);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }

        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-conversation-header {
            padding: 1rem 1.5rem;
            background: white;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .conversation-info h3 {
            margin: 0;
            color: var(--gray-900);
            font-size: 1.125rem;
        }

        .conversation-info p {
            margin: 0;
            color: var(--gray-600);
            font-size: 0.875rem;
        }

        .chat-actions {
            display: flex;
            gap: 0.5rem;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background: var(--gray-50);
        }

        .message {
            margin-bottom: 8px;
            display: block;
            clear: both;
            position: relative;
        }

        .message.sent {
            text-align: right;
        }

        .message.sent .message-content {
            max-width: 70%;
            margin-right: 8px;
            float: right;
        }

        .message.received {
            text-align: left;
        }

        .message.received .message-content {
            max-width: 70%;
            margin-left: 8px;
            float: left;
        }

        .message-content {
            padding: 10px 14px;
            border-radius: 18px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            position: relative;
            word-wrap: break-word;
            min-width: 120px;
        }

        .message.sent .message-content {
            background: #dcf8c6; /* أخضر فاتح مثل WhatsApp */
            color: #303030;
            border-bottom-right-radius: 6px;
        }

        .message.sent .message-content::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: -8px;
            width: 0;
            height: 0;
            border-left: 8px solid #dcf8c6;
            border-bottom: 8px solid transparent;
        }

        .message.received .message-content {
            background: white;
            color: #303030;
            border-bottom-left-radius: 6px;
        }

        .message.received .message-content::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: -8px;
            width: 0;
            height: 0;
            border-right: 8px solid white;
            border-bottom: 8px solid transparent;
        }

        .message-text {
            margin-bottom: 8px;
            line-height: 1.4;
            font-size: 15px;
            word-break: break-word;
            text-align: right;
        }

        .message.received .message-text {
            text-align: left;
        }

        .message-time {
            font-size: 12px;
            opacity: 0.7;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 6px;
            margin-top: 4px;
            direction: ltr;
            text-align: right;
        }

        .message.received .message-time {
            justify-content: flex-start;
            text-align: left;
        }

        .message.sent .message-time {
            color: #667781;
        }

        .message.received .message-time {
            color: #8696a0;
        }

        .message-input-container {
            padding: 1rem 1.5rem;
            background: white;
            border-top: 1px solid var(--gray-200);
            display: flex;
            gap: 1rem;
            align-items: flex-end;
        }

        .message-input {
            flex: 1;
            border: 1px solid var(--gray-300);
            border-radius: 1.5rem;
            padding: 0.75rem 1rem;
            resize: none;
            max-height: 100px;
            min-height: 45px;
            font-family: inherit;
        }

        .message-input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px var(--primary-blue-light);
        }

        .send-button {
            background: var(--primary-blue);
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .send-button:hover {
            background: var(--primary-blue-dark);
            transform: scale(1.05);
        }

        .send-button:disabled {
            background: var(--gray-400);
            cursor: not-allowed;
            transform: none;
        }

        /* Message Options Menu */
        .message-options-menu {
            background: white;
            border-radius: 0.5rem;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--gray-200);
            padding: 0.5rem 0;
            min-width: 180px;
            z-index: 10000;
            animation: fadeInScale 0.2s ease;
        }

        .message-option {
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
            font-size: 0.875rem;
        }

        .message-option:hover {
            background: var(--gray-50);
        }

        .message-option.cancel {
            color: var(--gray-500);
            border-top: 1px solid var(--gray-200);
        }

        .message-option i {
            width: 16px;
            text-align: center;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Long press feedback */
        .message:active {
            transform: scale(0.98);
            transition: transform 0.1s ease;
        }

        .message {
            cursor: pointer;
            user-select: none;
        }

        .chat-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--gray-500);
            text-align: center;
        }

        .chat-placeholder i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .chat-badge {
            background: var(--error-red);
            color: white;
            border-radius: 50%;
            padding: 0.125rem 0.375rem;
            font-size: 0.75rem;
            margin-right: 0.5rem;
            font-weight: 700;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Loading Spinner */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 3rem;
        }

        .spinner {
            width: 3rem;
            height: 3rem;
            border: 4px solid var(--gray-200);
            border-top: 4px solid var(--primary-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* تحسينات للنوافذ المنبثقة */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-container {
            animation: fadeIn 0.3s ease-in-out;
        }

        /* تحسين شكل النافذة المنبثقة */
        .modal {
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        /* تحسين مظهر الحقول المطلوبة */
        .form-field label.required::after {
            content: ' *';
            color: var(--error-red);
            font-weight: bold;
        }

        .form-field input:focus,
        .form-field select:focus,
        .form-field textarea:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            transform: translateY(-1px);
        }

        /* تحسين أزرار الحفظ والإلغاء */
        .modal-footer .btn {
            min-width: 120px;
            transition: all 0.2s ease;
        }

        .modal-footer .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* تحسين تأثيرات الإغلاق */
        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: scale(1);
            }
            to {
                opacity: 0;
                transform: scale(0.9);
            }
        }

        /* تحسين حالة التحميل */
        .loading-state {
            opacity: 0.7;
            pointer-events: none;
        }

        .loading-state .fas.fa-spinner {
            animation: spin 1s linear infinite;
        }

        /* تحسين التركيز على الحقول */
        .form-field input:focus-visible,
        .form-field select:focus-visible,
        .form-field textarea:focus-visible {
            outline: 2px solid var(--primary-blue);
            outline-offset: 2px;
        }

        /* تحسين إظهار الأخطاء */
        .form-field input.error,
        .form-field select.error,
        .form-field textarea.error {
            border-color: var(--error-red) !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
        }

        /* تحسين الإرشادات في النوافذ */
        .modal-header .modal-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .modal-header .modal-title i {
            color: var(--primary-blue);
        }

        /* Firebase Status Bar */
        .firebase-status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 35px;
            background: linear-gradient(135deg, var(--gray-800) 0%, var(--gray-900) 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1rem;
            z-index: 1000;
            font-size: 0.875rem;
            border-top: 1px solid var(--gray-600);
        }

        .status-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-indicator i {
            font-size: 0.75rem;
            transition: color 0.3s ease;
        }

        .status-indicator.connected i {
            color: var(--success-green);
            animation: pulse-green 2s infinite;
        }

        .status-indicator.disconnected i {
            color: var(--error-red);
        }

        .status-indicator.connecting i {
            color: var(--warning-yellow);
            animation: pulse-yellow 1s infinite;
        }

        .sync-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .sync-count {
            background: var(--warning-yellow);
            color: var(--gray-900);
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-weight: bold;
            font-size: 0.75rem;
        }

        .hidden {
            display: none !important;
        }

        @keyframes pulse-green {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes pulse-yellow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Responsive Design */
        @media (max-width: 1400px) {
            .case-form-sections {
                grid-template-columns: 1fr;
            }
            
            .case-details-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 1024px) {
            .main-content {
                padding: 1rem;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .case-info-grid {
                grid-template-columns: 1fr 1fr;
            }

            .header-content {
                padding: 1rem;
            }
            
            .nav-tabs {
                overflow-x: auto;
                padding: 0.25rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }
            
            .header-left {
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .nav-tabs {
                justify-content: center;
            }
            
            .nav-tab {
                padding: 0.5rem 1rem;
                font-size: 0.75rem;
            }
            
            .user-name {
                display: none;
            }
            
            .main-content {
                padding: 1rem;
            }
            
            .content-title {
                font-size: 1.5rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .grid-2,
            .grid-3 {
                grid-template-columns: 1fr;
            }
            
            .case-info-grid {
                grid-template-columns: 1fr;
            }
            
            .progress-steps {
                flex-direction: column;
                gap: 2rem;
            }
            
            .step-connector {
                display: none;
            }
            
            .content-header {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }

            table {
                min-width: 600px;
            }
        }

        @media (max-width: 480px) {
            .main-content {
                padding: 0.75rem;
            }

            .card {
                padding: 1.5rem;
            }

            .stat-card {
                padding: 1.5rem;
                flex-direction: column;
                text-align: center;
                gap: 1rem;
            }

            .stat-info p:last-child {
                font-size: 2rem;
            }
            
            .form-container {
                padding: 1.5rem;
                margin: 1rem;
            }
            
            .modal {
                margin: 1rem;
                padding: 1.5rem;
            }
        }

        /* Print Styles */
        @media print {
            .header,
            .nav-tabs,
            .btn,
            .action-btn {
                display: none !important;
            }

            .main-content {
                padding: 0;
            }

            .card {
                box-shadow: none;
                border: 1px solid var(--gray-300);
                break-inside: avoid;
            }
        }

        /* Desktop Notification Styles */
        .notification-status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .notification-status.granted {
            background: var(--success-green-light);
            color: var(--success-green);
            border: 1px solid var(--success-green);
        }

        .notification-status.denied {
            background: var(--error-red-light);
            color: var(--error-red);
            border: 1px solid var(--error-red);
        }

        .notification-status.pending {
            background: var(--warning-yellow-light);
            color: var(--warning-yellow);
            border: 1px solid var(--warning-yellow);
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .notification-count {
            text-align: center;
            padding: 1rem;
            border-radius: 0.75rem;
            background: white;
            border: 2px solid var(--gray-200);
            transition: all 0.3s ease;
        }

        .notification-count:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .notification-count.high {
            border-color: var(--error-red);
            background: var(--error-red-light);
        }

        .notification-count.medium {
            border-color: var(--warning-yellow);
            background: var(--warning-yellow-light);
        }

        .notification-count.low {
            border-color: var(--primary-blue);
            background: var(--primary-blue-light);
        }

        /* Responsive adjustments for notification settings */
        @media (max-width: 768px) {
            .grid-3 {
                grid-template-columns: 1fr;
            }
        }

        /* Advanced Settings Styles */
        .settings-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--gray-200);
            overflow-x: auto;
            padding-bottom: 1rem;
        }

        .settings-tab {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: none;
            background: var(--gray-100);
            color: var(--gray-600);
            border-radius: 0.75rem 0.75rem 0 0;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            white-space: nowrap;
            border-bottom: 3px solid transparent;
        }

        .settings-tab.active {
            background: var(--primary-blue);
            color: white;
            border-bottom-color: var(--primary-blue-dark);
            transform: translateY(-2px);
        }

        .settings-tab:hover:not(.active) {
            background: var(--gray-200);
            color: var(--gray-800);
        }

        .settings-tab-content {
            min-height: 500px;
        }

        .settings-section {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
        }

        .settings-section h3 {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            color: var(--gray-900);
            font-size: 1.25rem;
            border-bottom: 2px solid var(--gray-100);
            padding-bottom: 0.75rem;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--gray-50);
            border-radius: 0.75rem;
            border: 1px solid var(--gray-200);
        }

        .setting-info label {
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 0.25rem;
        }

        .setting-info p {
            font-size: 0.875rem;
            color: var(--gray-600);
            margin: 0;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--gray-300);
            transition: 0.4s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--primary-blue);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .notification-status-card {
            background: linear-gradient(135deg, var(--primary-blue-light), var(--indigo-light));
            border-radius: 1rem;
            padding: 1.5rem;
            border: 1px solid var(--primary-blue);
        }

        .status-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .status-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .notifications-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            position: relative;
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
            border: 2px solid var(--gray-200);
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gray-300);
        }

        .stat-card.urgent::before {
            background: var(--error-red);
        }

        .stat-card.warning::before {
            background: var(--warning-yellow);
        }

        .stat-card.info::before {
            background: var(--primary-blue);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .stat-card.urgent .stat-number {
            color: var(--error-red);
        }

        .stat-card.warning .stat-number {
            color: var(--warning-yellow);
        }

        .stat-card.info .stat-number {
            color: var(--primary-blue);
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--gray-600);
            font-weight: 600;
        }

        .stat-card i {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            opacity: 0.3;
        }

        .notifications-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .backup-status-card {
            background: linear-gradient(135deg, var(--success-green-light), var(--primary-blue-light));
            border-radius: 1rem;
            padding: 2rem;
            border: 1px solid var(--success-green);
        }

        .backup-info {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .backup-icon {
            width: 4rem;
            height: 4rem;
            border-radius: 50%;
            background: var(--success-green);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .backup-details h4 {
            margin: 0 0 0.5rem 0;
            color: var(--gray-900);
        }

        .backup-details p {
            margin: 0 0 0.5rem 0;
            color: var(--gray-600);
        }

        .backup-size {
            font-size: 0.875rem;
            color: var(--gray-500);
        }

        .backup-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .backup-option {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1.5rem;
            border: 2px solid var(--gray-200);
            border-radius: 1rem;
            transition: all 0.3s ease;
        }

        .backup-option:hover {
            border-color: var(--primary-blue);
            background: var(--primary-blue-light);
        }

        .option-icon {
            width: 3rem;
            height: 3rem;
            border-radius: 0.75rem;
            background: var(--primary-blue);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .option-details {
            flex: 1;
        }

        .option-details h4 {
            margin: 0 0 0.25rem 0;
            color: var(--gray-900);
        }

        .option-details p {
            margin: 0;
            color: var(--gray-600);
            font-size: 0.875rem;
        }

        .restore-area {
            margin: 1rem 0;
        }

        .restore-upload {
            border: 2px dashed var(--gray-300);
            border-radius: 1rem;
            padding: 3rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .restore-upload:hover {
            border-color: var(--primary-blue);
            background: var(--primary-blue-light);
        }

        .restore-upload i {
            font-size: 3rem;
            color: var(--gray-400);
            margin-bottom: 1rem;
        }

        .restore-upload h4 {
            margin: 0 0 0.5rem 0;
            color: var(--gray-700);
        }

        .restore-upload p {
            margin: 0;
            color: var(--gray-500);
        }

        .auto-backup-settings {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .theme-preview {
            margin-top: 1rem;
        }

        .preview-card {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 0.75rem;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
        }

        .preview-content {
            padding: 1rem;
        }

        .preview-stats {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        .system-tools {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .tool-card {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1.5rem;
            border: 1px solid var(--gray-200);
            border-radius: 1rem;
            transition: all 0.3s ease;
        }

        .tool-card:hover {
            border-color: var(--primary-blue);
            box-shadow: var(--shadow-md);
        }

        .tool-icon {
            width: 3rem;
            height: 3rem;
            border-radius: 0.75rem;
            background: var(--indigo);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .tool-info {
            flex: 1;
        }

        .tool-info h4 {
            margin: 0 0 0.25rem 0;
            color: var(--gray-900);
        }

        .tool-info p {
            margin: 0;
            color: var(--gray-600);
            font-size: 0.875rem;
        }

        .data-management {
            background: var(--gray-50);
            border-radius: 0.75rem;
            padding: 1.5rem;
            border: 1px solid var(--gray-200);
        }

        .data-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .data-stats .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: white;
            border-radius: 0.5rem;
            border: 1px solid var(--gray-200);
        }

        .stat-label {
            font-weight: 600;
            color: var(--gray-700);
        }

        .stat-value {
            font-weight: 700;
            color: var(--primary-blue);
        }

        .danger-section {
            border: 2px solid var(--error-red);
            background: var(--error-red-light);
        }

        .danger-section h3 {
            color: var(--error-red);
            border-bottom-color: var(--error-red);
        }

        .danger-actions {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .danger-card {
            background: white;
            border: 2px solid var(--error-red);
            border-radius: 1rem;
            overflow: hidden;
        }

        .danger-content {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1.5rem;
        }

        .danger-icon {
            width: 3rem;
            height: 3rem;
            border-radius: 0.75rem;
            background: var(--error-red);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .danger-info {
            flex: 1;
        }

        .danger-info h4 {
            margin: 0 0 0.25rem 0;
            color: var(--error-red);
            font-weight: 700;
        }

        .danger-info p {
            margin: 0 0 0.5rem 0;
            color: var(--gray-600);
        }

        .warning-text {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--error-red);
            font-weight: 600;
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            .settings-section {
                background: var(--gray-800);
                border-color: var(--gray-700);
            }
            
            .preview-card {
                background: var(--gray-800);
                border-color: var(--gray-700);
            }
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .settings-tabs {
                flex-wrap: wrap;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }
            
            .backup-info {
                flex-direction: column;
                text-align: center;
            }
            
            .danger-content {
                flex-direction: column;
                text-align: center;
            }
        }

        /* Global Search Responsive */
        @media (max-width: 768px) {
            .global-search-container {
                padding: 0.75rem 1rem;
                margin-bottom: 1rem;
                margin-top: 1.5rem;
            }
            
            .global-search-input {
                padding: 0.875rem 1rem 0.875rem 3rem;
                font-size: 0.9rem;
            }
            
            .global-search-icon {
                left: 1rem;
                font-size: 1rem;
            }
        }

        @media (max-width: 480px) {
            .global-search-container {
                padding: 0.5rem 0.75rem;
                margin-top: 1rem;
            }
            
            .global-search-input {
                padding: 0.75rem 0.875rem 0.75rem 2.75rem;
                font-size: 0.85rem;
            }
            
            .global-search-icon {
                left: 0.875rem;
                font-size: 0.9rem;
            }
            
            .search-result-item {
                padding: 0.875rem 1rem;
            }
            
            .search-result-type {
                font-size: 0.7rem;
            }
            
            .search-result-title {
                font-size: 0.9rem;
            }
            
            .search-result-description {
                font-size: 0.8rem;
            }
        }

  /* ====================================================================== */
        /* شاشة الانتظار الرئيسية */
        /* ====================================================================== */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 0.8s ease-out, visibility 0.8s ease-out;
            opacity: 1;
            visibility: visible;
        }

        /* تأثير تحريك الخلفية */
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* حالة الإخفاء */
        #splash-screen.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        /* جزيئات متحركة في الخلفية */
        .particles {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            animation: float 15s infinite;
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0) translateX(0);
                opacity: 0;
            }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% {
                transform: translateY(-100vh) translateX(100px);
                opacity: 0;
            }
        }

        /* المحتوى الرئيسي */
        .splash-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 50px 60px;
            border-radius: 30px;
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.3),
                0 0 100px rgba(255, 255, 255, 0.1) inset;
            max-width: 600px;
            width: 90%;
            text-align: center;
            animation: fadeInUp 1s ease-out;
            position: relative;
            overflow: hidden;
        }

        /* تأثير الظهور من الأسفل */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* أيقونة التطبيق الرئيسية */
        .app-icon {
            width: 100px;
            height: 100px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
            animation: iconPulse 2s ease-in-out infinite;
        }

        .app-icon i {
            font-size: 50px;
            color: white;
        }

        @keyframes iconPulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 15px 40px rgba(102, 126, 234, 0.6);
            }
        }

        /* عنوان التطبيق */
        .app-title {
            font-size: 2.8em;
            font-weight: 900;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            animation: titleGlow 2s ease-in-out infinite;
        }

        @keyframes titleGlow {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.2); }
        }

        /* الشعار */
        .tagline {
            color: #6b7280;
            font-size: 1.3em;
            margin-bottom: 30px;
            font-weight: 500;
            animation: fadeIn 1.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* خط فاصل مزخرف */
        .divider {
            width: 80%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #667eea, transparent);
            margin: 25px auto;
            animation: expandWidth 1.5s ease-out;
        }

        @keyframes expandWidth {
            from { width: 0; }
            to { width: 80%; }
        }

        /* معلومات المبرمج */
        .developer-info {
            margin-top: 25px;
            animation: fadeIn 2s ease-out;
        }

        .developer-title {
            font-size: 1.1em;
            color: #374151;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .developer-name {
            font-size: 1.5em;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 10px;
        }

        .bio {
            font-size: 0.95em;
            color: #6b7280;
            margin-bottom: 25px;
            line-height: 1.6;
            padding: 0 10px;
        }

        /* أزرار التواصل */
        .contact-links {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .contact-item {
            text-decoration: none;
            padding: 12px 25px;
            border-radius: 15px;
            font-weight: 600;
            font-size: 1.05em;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .contact-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
            transition: left 0.3s ease;
        }

        .contact-item:hover::before {
            left: 100%;
        }

        .contact-item i {
            font-size: 1.2em;
        }

        .phone-link {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .phone-link:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 25px rgba(102, 126, 234, 0.4);
        }

        .whatsapp-link {
            background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);
            color: white;
        }

        .whatsapp-link:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 25px rgba(37, 211, 102, 0.4);
        }

        /* رابط فيسبوك */
        .social-link {
            margin-top: 25px;
            animation: fadeIn 2.5s ease-out;
        }

        .social-link a {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
            color: #667eea;
            font-weight: 700;
            font-size: 1.15em;
            padding: 12px 25px;
            border-radius: 15px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .social-link a:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2));
            border-color: #667eea;
            transform: scale(1.05);
        }

        .social-link img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid #667eea;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
        }

        .social-link a:hover img {
            transform: rotate(360deg);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        /* مؤشر التحميل الحديث */
        .loading-container {
            margin-top: 30px;
        }

        .loading-spinner {
            position: relative;
            width: 60px;
            height: 60px;
            margin: 0 auto;
        }

        .spinner-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 4px solid transparent;
            border-top-color: #667eea;
            animation: spin 1s linear infinite;
        }

        .spinner-ring:nth-child(2) {
            border-top-color: #764ba2;
            animation-duration: 1.5s;
            animation-direction: reverse;
        }

        .spinner-ring:nth-child(3) {
            border-top-color: #f093fb;
            animation-duration: 2s;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 15px;
            color: #667eea;
            font-weight: 600;
            font-size: 1.1em;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* النقاط المتحركة */
        .loading-dots {
            display: inline-block;
        }

        .loading-dots span {
            animation: blink 1.4s infinite;
            animation-fill-mode: both;
        }

        .loading-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .loading-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes blink {
            0%, 80%, 100% { opacity: 0; }
            40% { opacity: 1; }
        }

        /* تصميم متجاوب للشاشات الصغيرة */
        @media (max-width: 768px) {
            .splash-content {
                padding: 40px 30px;
                border-radius: 20px;
            }

            .app-icon {
                width: 80px;
                height: 80px;
            }

            .app-icon i {
                font-size: 40px;
            }

            .app-title {
                font-size: 2em;
            }

            .tagline {
                font-size: 1.1em;
            }

            .developer-name {
                font-size: 1.3em;
            }

            .contact-links {
                flex-direction: column;
                gap: 10px;
            }

            .contact-item {
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .splash-content {
                padding: 30px 20px;
            }

            .app-title {
                font-size: 1.7em;
            }

            .tagline {
                font-size: 1em;
            }

            .bio {
                font-size: 0.9em;
            }
        }

        /* حركات الإشعارات */
        @keyframes slideOutLeft {
            0% {
                transform: translateX(0);
                opacity: 1;
            }
            100% {
                transform: translateX(-100%);
                opacity: 0;
            }
        }

        @keyframes fadeOut {
            0% {
                opacity: 1;
                transform: scale(1);
            }
            100% {
                opacity: 0;
                transform: scale(0.9);
            }
        }

        @keyframes slideInRight {
            0% {
                transform: translateX(100%);
                opacity: 0;
            }
            100% {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
    </style>
</head>
<body>
    <!-- ملف الصوت للإشعارات -->
    <audio id="notification-sound" preload="auto">
        <source src="assets/رسائل-الايفون.mp3" type="audio/mpeg">
        <source src="assets/رسائل-الايفون.mp3" type="audio/mp3">
    </audio>

 <!-- شاشة الانتظار -->
    <div id="splash-screen">
        <!-- الجزيئات المتحركة -->
        <div class="particles" id="particles"></div>

        <!-- المحتوى الرئيسي -->
        <div class="splash-content">
            <!-- أيقونة التطبيق -->
            <div class="app-icon">
                <i class="fas fa-balance-scale"></i>
            </div>

            <!-- عنوان التطبيق -->
            <h1 class="app-title">تطبيق الإدارة القانونية</h1>
            
            <!-- الشعار -->
            <p class="tagline">نظام إدارة قانوني متكامل واحترافي</p>

            <!-- خط فاصل -->
            <div class="divider"></div>

            <!-- معلومات المبرمج -->
            <div class="developer-info">
                <p class="developer-title">تطوير وبرمجة</p>
                <p class="developer-name">السيد كرار السعبري</p>
                
                <p class="bio">
                    متخصص في برمجة تطبيقات الهاتف <strong>(أندرويد وآيفون)</strong>
                    <br>وتطبيقات سطح المكتب وصفحات الويب
                </p>

                <!-- روابط التواصل -->
                <div class="contact-links">
                    <a href="tel:+9647813798636" class="contact-item phone-link">
                        <i class="fas fa-phone-alt"></i>
                        <span>0781 379 8636</span>
                    </a>
                    <a href="https://wa.me/9647813798636" class="contact-item whatsapp-link" target="_blank">
                        <i class="fab fa-whatsapp"></i>
                        <span>واتساب</span>
                    </a>
                </div>

                <!-- صفحة فيسبوك -->
                <div class="social-link">
                    <a href="https://web.facebook.com/sma.alan.904627" target="_blank" aria-label="صفحة الفيسبوك">
                        <img src="https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/Gemini_Generated_Image_ipnr9aipnr9aipnr.png?alt=media&token=8e3b22ad-9270-4208-8237-9da5ecec7421" alt="صفحة الفيسبوك">
                        <span>صفحة الفيسبوك</span>
                    </a>
                </div>

                <!-- مؤشر التحميل -->
                <div class="loading-container">
                    <div class="loading-spinner">
                        <div class="spinner-ring"></div>
                        <div class="spinner-ring"></div>
                        <div class="spinner-ring"></div>
                    </div>
                    <p class="loading-text">
                        جاري التحميل<span class="loading-dots"><span>.</span><span>.</span><span>.</span></span>
                    </p>
                </div>
            </div>
        </div>
    </div>


    
    <!-- Custom Window Controls -->
    <div class="window-controls">
        <div class="title-bar-left">
            <i class="fas fa-gavel" style="color: rgba(255,255,255,0.9); margin-left: 15px; margin-right: 8px; font-size: 16px;"></i>
            <span style="color: rgba(255,255,255,0.9); font-size: 14px; font-weight: 500;">تطبيق الإدارة القانونية</span>
        </div>
        <div class="title-bar-center">
           
         
            <!-- زر إعادة تحميل التطبيق -->
            <div class="window-control refresh" onclick="refreshApp()" title="إعادة تحميل التطبيق&#10;يساعد في حل مشاكل التجمد والأخطاء&#10;الاختصار: Ctrl+R أو F5">
                <i class="fas fa-redo-alt" id="refresh-icon"></i>
            </div>
        </div>
        <div class="title-bar-right">
            <div class="window-control minimize" onclick="minimizeWindow()" title="تصغير">
                <i class="fas fa-window-minimize"></i>
            </div>
            <div class="window-control maximize" onclick="toggleMaximize()" title="تكبير/استعادة">
                <i class="fas fa-window-maximize" id="maximize-icon"></i>
            </div>
            <div class="window-control close" onclick="closeWindow()" title="إغلاق">
                <i class="fas fa-times"></i>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container"></div>

    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <!-- Logo Section -->
            <div class="header-logo-section">
                <div class="header-logo">
                    <div class="logo-icon">
                        <i class="fas fa-balance-scale"></i>
                    </div>
                    <div class="header-title">
                        <h1>تطبيق الإدارة القانونية</h1>
                        <p>نظام إدارة شامل للخدمات القانونية</p>
                    </div>
                </div>
            </div>
            
            <!-- Navigation Section -->
            <div class="header-navigation">
                <div class="nav-tabs">
                    <button class="nav-tab active" data-tab="dashboard" title="لوحة التحكم الرئيسية">
                        <i class="fas fa-chart-pie"></i>
                        <span>لوحة التحكم</span>
                    </button>
                    <button class="nav-tab" data-tab="cases" title="إدارة جميع الدعاوى">
                        <i class="fas fa-file-contract"></i>
                        <span>الدعاوى</span>
                    </button>
                    <button class="nav-tab" data-tab="defendants" title="إدارة المدعى عليهم">
                        <i class="fas fa-users"></i>
                        <span>المدعى عليهم</span>
                    </button>
                    <button class="nav-tab" data-tab="lawyers" title="إدارة المحامين">
                        <i class="fas fa-user-tie"></i>
                        <span>المحامون</span>
                    </button>
                    <button class="nav-tab" data-tab="deductions" title="الاستقطاعات المالية">
                        <i class="fas fa-coins"></i>
                        <span>الاستقطاعات</span>
                    </button>
                    <button class="nav-tab" data-tab="templates" title="القوالب القانونية">
                        <i class="fas fa-file-contract"></i>
                        <span>القوالب</span>
                    </button>
                    <button class="nav-tab" data-tab="chat" title="الدردشة مع المحامين">
                        <i class="fas fa-comments"></i>
                        <span>الدردشة</span>
                        <span class="chat-badge" id="chat-badge" style="display: none;">0</span>
                    </button>
                    <button class="nav-tab" data-tab="reports" title="التقارير والإحصائيات">
                        <i class="fas fa-chart-bar"></i>
                        <span>التقارير</span>
                    </button>
                    <button class="nav-tab" data-tab="settings" title="إعدادات النظام">
                        <i class="fas fa-cog"></i>
                        <span>الإعدادات</span>
                    </button>
                </div>
            </div>
            
            <!-- User Section -->
            <div class="header-user-section">
                <div class="notification-area">
                    <button class="notification-btn" onclick="showNotifications()" title="الإشعارات">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge" id="notification-count">0</span>
                    </button>
                </div>
                <div class="user-profile" onclick="showUserMenu()">
                    <div class="user-info">
                        <span class="user-greeting">مرحباً</span>
                        <span class="user-name" id="current-user-name">السيد أسامة</span>
                    </div>
                    <div class="user-avatar">
                        <span id="user-avatar-initial">أ</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="main-content full-width-container">
        <!-- Dashboard -->
        <div id="dashboard-content" class="content-section">
            <!-- Global Search -->
            <div class="global-search-container">
                <div class="global-search-wrapper">
                    <input type="text" 
                           id="global-search-input" 
                           class="global-search-input" 
                           placeholder="البحث في جميع أنحاء التطبيق... (الدعاوى، المحامين، المدعى عليهم، الاستقطاعات)"
                           autocomplete="off">
                    <i class="fas fa-search global-search-icon"></i>
                    <div id="global-search-results" class="global-search-results"></div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card blue">
                    <div class="stat-info">
                        <p>إجمالي الدعاوى</p>
                        <p id="total-cases">0</p>
                    </div>
                    <i class="fas fa-file-contract stat-icon"></i>
                </div>
                <div class="stat-card yellow">
                    <div class="stat-info">
                        <p>تحت المراجعة</p>
                        <p id="pending-cases">0</p>
                    </div>
                    <i class="fas fa-clock stat-icon"></i>
                </div>
                <div class="stat-card green">
                    <div class="stat-info">
                        <p>مكتملة</p>
                        <p id="completed-cases">0</p>
                    </div>
                    <i class="fas fa-check-circle stat-icon"></i>
                </div>
                <div class="stat-card purple">
                    <div class="stat-info">
                        <p>إجمالي المبالغ</p>
                        <p id="total-amount">0 د.ع</p>
                    </div>
                    <i class="fas fa-dollar-sign stat-icon"></i>
                </div>
            </div>

            <div class="grid-full">
                <div class="card">
                    <h3>
                        <i class="fas fa-calendar-alt"></i>
                        الجلسات القادمة
                    </h3>
                    <div id="upcoming-hearings">
                        <p style="text-align: center; color: var(--gray-500); padding: 2rem;">لا توجد جلسات قادمة حالياً</p>
                    </div>
                </div>

                <div class="card">
                    <h3>
                        <i class="fas fa-exclamation-triangle"></i>
                        التنبيهات والإشعارات
                    </h3>
                    <div id="alerts-container">
                        <p style="text-align: center; color: var(--gray-500); padding: 2rem;">لا توجد تنبيهات جديدة</p>
                    </div>
                </div>

                <div class="card">
                    <h3>
                        <i class="fas fa-chart-line"></i>
                        إحصائيات الأداء
                    </h3>
                    <div id="performance-chart">
                        <div style="display: flex; justify-content: space-around; text-align: center; padding: 2rem;">
                            <div>
                                <div style="font-size: 2rem; font-weight: 800; color: var(--success-green); margin-bottom: 0.5rem;" id="success-rate">0%</div>
                                <div style="color: var(--gray-600);">معدل النجاح</div>
                            </div>
                            <div>
                                <div style="font-size: 2rem; font-weight: 800; color: var(--primary-blue); margin-bottom: 0.5rem;" id="monthly-cases">0</div>
                                <div style="color: var(--gray-600);">قضايا هذا الشهر</div>
                            </div>
                            <div>
                                <div style="font-size: 2rem; font-weight: 800; color: var(--warning-yellow); margin-bottom: 0.5rem;" id="avg-duration">0</div>
                                <div style="color: var(--gray-600);">متوسط المدة (شهر)</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>
                        <i class="fas fa-tasks"></i>
                        المهام السريعة
                    </h3>
                    <div id="quick-actions" style="display: flex; flex-direction: column; gap: 1rem;">
                        <button class="btn btn-primary" onclick="showNewCaseModal()">
                            <i class="fas fa-plus"></i>
                            دعوى جديدة
                        </button>
                        <button class="btn btn-secondary" onclick="showTab('new-defendant')">
                            <i class="fas fa-user-plus"></i>
                            مدعى عليه جديد
                        </button>
                        <button class="btn btn-success" onclick="showTab('new-lawyer')">
                            <i class="fas fa-user-tie"></i>
                            محامٍ جديد
                        </button>
                        <button class="btn btn-info" onclick="simulateIncomingMessage()">
                            <i class="fas fa-comments"></i>
                            رسالة تجريبية
                        </button>
                        <button class="btn btn-success" onclick="generateReport()">
                            <i class="fas fa-file-pdf"></i>
                            تقرير سريع
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cases Management -->
        <div id="cases-content" class="content-section hidden">
            <div class="content-header">
                <h2 class="content-title">إدارة الدعاوى</h2>
                <div class="content-actions">
                    <button class="btn btn-primary" onclick="showNewCaseModal()">
                        <i class="fas fa-plus"></i>
                        دعوى جديدة
                    </button>
                    <button class="btn btn-secondary" onclick="exportCases()">
                        <i class="fas fa-download"></i>
                        تصدير البيانات
                    </button>
                </div>
            </div>

            <div class="table-container">
                <div class="table-header">
                    <div class="search-container">
                        <input type="text" class="search-input" placeholder="البحث في الدعاوى بالاسم، رقم الدعوى، أو الحالة..." id="search-cases">
                        <button class="btn btn-primary" onclick="searchCases()">
                            <i class="fas fa-search"></i>
                            بحث
                        </button>
                        <select id="filter-status" class="search-input" style="min-width: 200px;">
                            <option value="">جميع الحالات</option>
                            <option value="تحت المراجعة">تحت المراجعة</option>
                            <option value="صدر الحكم">صدر الحكم</option>
                            <option value="تبليغ بالحكم">تبليغ بالحكم</option>
                            <option value="تنفيذ">تنفيذ</option>
                        </select>
                    </div>
                </div>

                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>المدعي</th>
                                <th>رقم الدعوى</th>
                                <th>مبلغ الدين</th>
                                <th>المرحلة</th>
                                <th>الحالة</th>
                                <th>الجلسة القادمة</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="cases-table-body">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 3rem; color: var(--gray-500);">
                                    <i class="fas fa-file-contract" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i>
                                    لا توجد دعاوى مسجلة. ابدأ بإضافة دعوى جديدة.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Defendants Management -->
        <div id="defendants-content" class="content-section hidden">
            <div class="content-header">
                <h2 class="content-title">إدارة المدعى عليهم</h2>
                <button class="btn btn-primary" onclick="showTab('new-defendant')">
                    <i class="fas fa-user-plus"></i>
                    مدعى عليه جديد
                </button>
            </div>

            <div class="filters-panel">
                <div class="filter-group">
                    <label>البحث:</label>
                    <input type="text" class="search-input" placeholder="البحث في المدعى عليهم..." id="search-defendants">
                    <button class="btn btn-primary" onclick="searchDefendants()">
                        <i class="fas fa-search"></i>
                        بحث
                    </button>
                </div>
                <div class="filter-group">
                    <label>ترتيب حسب:</label>
                    <select id="sort-defendants" onchange="sortDefendants()">
                        <option value="name">الاسم</option>
                        <option value="casesCount">عدد الدعاوى</option>
                        <option value="registrationDate">تاريخ التسجيل</option>
                    </select>
                </div>
            </div>

            <div class="table-container">
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>اسم المدعى عليه</th>
                                <th>رقم الهاتف</th>
                                <th>البريد الإلكتروني</th>
                                <th>عدد الدعاوى</th>
                                <th>تاريخ التسجيل</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="defendants-table-body">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 3rem; color: var(--gray-500);">
                                    <i class="fas fa-users" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i>
                                    لا يوجد مدعى عليهم مسجلين. ابدأ بإضافة مدعى عليه جديد.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Lawyers Management -->
        <div id="lawyers-content" class="content-section hidden">
            <div class="content-header">
                <h2 class="content-title">إدارة المحامين</h2>
                <button class="btn btn-primary" onclick="showTab('new-lawyer')">
                    <i class="fas fa-user-tie"></i>
                    محامٍ جديد
                </button>
            </div>

            <div class="filters-panel">
                <div class="filter-group">
                    <label>البحث:</label>
                    <input type="text" class="search-input" placeholder="البحث في المحامين..." id="search-lawyers">
                    <button class="btn btn-primary" onclick="searchLawyers()">
                        <i class="fas fa-search"></i>
                        بحث
                    </button>
                </div>
                <div class="filter-group">
                    <label>التخصص:</label>
                    <select id="filter-specialization" onchange="filterLawyersBySpecialization()">
                        <option value="">جميع التخصصات</option>
                        <option value="القانون المدني">القانون المدني</option>
                        <option value="القانون التجاري">القانون التجاري</option>
                        <option value="قانون العمل">قانون العمل</option>
                        <option value="القانون الجنائي">القانون الجنائي</option>
                    </select>
                </div>
            </div>

            <div class="table-container">
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>اسم المحامي</th>
                                <th>رقم الترخيص</th>
                                <th>التخصص</th>
                                <th>رقم الهاتف</th>
                                <th>عدد الدعاوى</th>
                                <th>تاريخ التسجيل</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="lawyers-table-body">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 3rem; color: var(--gray-500);">
                                    <i class="fas fa-user-tie" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i>
                                    لا يوجد محامون مسجلون. ابدأ بإضافة محامٍ جديد.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Deductions -->
        <div id="deductions-content" class="content-section hidden">
            <div class="content-header">
                <h2 class="content-title">الاستقطاعات</h2>
                <button class="btn btn-primary" onclick="showNewDeductionModal()">
                    <i class="fas fa-plus"></i>
                    استقطاع جديد
                </button>
            </div>
            
            <div class="deduction-summary">
                <div class="deduction-summary-grid">
                    <div class="deduction-summary-item">
                        <div class="deduction-summary-value" id="total-deductions">0 د.ع</div>
                        <div class="deduction-summary-label">إجمالي الاستقطاعات</div>
                    </div>
                    <div class="deduction-summary-item">
                        <div class="deduction-summary-value" id="deductions-count">0</div>
                        <div class="deduction-summary-label">عدد الاستقطاعات</div>
                    </div>
                    <div class="deduction-summary-item">
                        <div class="deduction-summary-value" id="avg-deduction">0 د.ع</div>
                        <div class="deduction-summary-label">متوسط الاستقطاع</div>
                    </div>
                    <div class="deduction-summary-item">
                        <div class="deduction-summary-value" id="last-deduction-date">لا يوجد</div>
                        <div class="deduction-summary-label">آخر استقطاع</div>
                    </div>
                </div>
            </div>

            <div class="table-container">
                <div class="table-header">
                    <h3>سجل الاستقطاعات</h3>
                    <div class="search-container">
                        <input type="text" class="search-input" placeholder="البحث في الاستقطاعات..." id="search-deductions">
                        <button class="btn btn-primary" onclick="searchDeductions()">
                            <i class="fas fa-search"></i>
                            بحث
                        </button>
                    </div>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>المدعي</th>
                                <th>رقم الدعوى</th>
                                <th>المبلغ المستقطع</th>
                                <th>تاريخ الاستقطاع</th>
                                <th>المصدر</th>
                                <th>الحالة</th>
                                <th>مضاف من</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="deductions-table-body">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 3rem; color: var(--gray-500);">
                                    <i class="fas fa-coins" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i>
                                    لا توجد استقطاعات مسجلة بعد.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Templates Content -->
        <div id="templates-content" class="content-section hidden">
            <div class="content-header">
                <h2 class="content-title">
                    <i class="fas fa-file-contract"></i>
                    القوالب القانونية
                </h2>
                <button class="btn btn-primary" onclick="showNewTemplateModal()">
                    <i class="fas fa-plus"></i>
                    قالب جديد
                </button>
            </div>

            <!-- Templates Summary -->
            <div class="templates-summary">
                <div class="templates-grid">
                    <div class="template-card" onclick="showTemplateModal('professional')">
                        <div class="template-icon">
                            <i class="fas fa-briefcase"></i>
                        </div>
                        <h3>وثيقة قانونية احترافية</h3>
                        <p>قالب احترافي للوثائق القانونية الرسمية</p>
                        <div class="template-actions">
                            <button class="btn btn-sm btn-primary">استخدام القالب</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Templates -->
            <div class="recent-templates">
                <h3>القوالب المستخدمة حديثاً</h3>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>اسم القالب</th>
                                <th>النوع</th>
                                <th>تاريخ الاستخدام</th>
                                <th>المستخدم</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="recent-templates-table">
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 2rem;">
                                    <div style="color: var(--gray-500);">
                                        <i class="fas fa-file-alt" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                                        <p>لا توجد قوالب مستخدمة بعد</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Chat -->
        <div id="chat-content" class="content-section hidden">
            <div class="content-header">
                <h2 class="content-title">
                    <i class="fas fa-comments"></i>
                    الدردشة مع المحامين
                </h2>
                <div class="content-actions">
                    <button class="btn btn-success" onclick="refreshChatData()" title="تحديث الرسائل">
                        <i class="fas fa-sync"></i>
                        تحديث
                    </button>
                    <button class="btn btn-secondary" onclick="markAllChatsAsRead()" title="تعليم جميع الرسائل كمقروءة">
                        <i class="fas fa-check-double"></i>
                        تعليم الكل كمقروء
                    </button>
                </div>
            </div>

            <div class="chat-container">
                <!-- Lawyers Sidebar -->
                <div class="chat-sidebar">
                    <div class="chat-header">
                        <i class="fas fa-user-tie"></i>
                        المحامون المتصلون
                    </div>
                    <div class="lawyers-list" id="lawyers-list">
                        <div style="padding: 2rem; text-align: center; color: var(--gray-500);">
                            <i class="fas fa-users" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                            <p>لا يوجد محامون متصلون حالياً</p>
                        </div>
                    </div>
                </div>

                <!-- Chat Main Area -->
                <div class="chat-main" id="chat-main">
                    <div class="chat-placeholder">
                        <i class="fas fa-comment-dots"></i>
                        <h3>اختر محامياً لبدء المحادثة</h3>
                        <p>سيتم عرض الرسائل هنا عند اختيار محامي من القائمة</p>
                        <div style="margin-top: 2rem; padding: 1.5rem; background: var(--gray-50); border-radius: 8px; text-align: left;">
                            <h4 style="color: var(--gray-700); margin-bottom: 1rem;">تعليمات النظام:</h4>
                            <ul style="color: var(--gray-600); line-height: 1.6;">
                                <li>الرسائل من Firebase تظهر تلقائياً</li>
                                <li>نظام دردشة في الوقت الفعلي مع Firebase</li>
                                <li>الرسائل غير المقروءة تظهر بلون مختلف</li>
                                <li>يتم حفظ الرسائل محلياً ومزامنتها مع Firebase</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reports -->
        <div id="reports-content" class="content-section hidden">
            <div class="content-header">
                <h2 class="content-title">التقارير</h2>
            </div>

            <div class="grid-3">
                <div class="card">
                    <h3>
                        <i class="fas fa-chart-pie"></i>
                        تقرير الأداء الشهري
                    </h3>
                    <p style="color: var(--gray-600); margin-bottom: 2rem;">
                        إحصائيات شاملة عن الدعاوى والاستقطاعات للشهر الحالي
                    </p>
                    <button class="btn btn-primary" onclick="generateMonthlyReport()">
                        <i class="fas fa-file-pdf"></i>
                        إنشاء التقرير
                    </button>
                </div>

                <div class="card">
                    <h3>
                        <i class="fas fa-users"></i>
                        تقرير المدعى عليهم
                    </h3>
                    <p style="color: var(--gray-600); margin-bottom: 2rem;">
                        قائمة شاملة بجميع المدعى عليهم وحالات دعاويهم
                    </p>
                    <button class="btn btn-success" onclick="generateDefendantsReport()">
                        <i class="fas fa-file-excel"></i>
                        إنشاء التقرير
                    </button>
                </div>

                <div class="card">
                    <h3>
                        <i class="fas fa-dollar-sign"></i>
                        التقرير المالي
                    </h3>
                    <p style="color: var(--gray-600); margin-bottom: 2rem;">
                        تفصيل كامل للاستقطاعات والمبالغ المحصلة
                    </p>
                    <button class="btn btn-secondary" onclick="generateFinancialReport()">
                        <i class="fas fa-chart-bar"></i>
                        إنشاء التقرير
                    </button>
                </div>
            </div>
        </div>

        <!-- New Case -->
        <div id="new-case-content" class="content-section hidden">
            <div class="content-header">
                <h2 class="content-title">دعوى جديدة</h2>
                <div class="content-actions">
                    <button class="btn btn-secondary" onclick="showTab('cases')">
                        <i class="fas fa-times"></i>
                        إلغاء
                    </button>
                    <button class="btn btn-primary" onclick="saveNewCase()">
                        <i class="fas fa-save"></i>
                        حفظ الدعوى
                    </button>
                </div>
            </div>

            <div class="case-form-sections">
                <!-- Basic Information Section -->
                <div class="case-section">
                    <div class="section-title">
                        <i class="fas fa-info-circle"></i>
                        المعلومات الأساسية
                    </div>
                    
                    <div class="form-row">
                        <div class="form-field">
                            <label><i class="fas fa-file"></i>رقم الدعوى</label>
                            <input type="text" id="new-case-number" placeholder="مثال: D-2024-001">
                        </div>
                        <div class="form-field">
                            <label><i class="fas fa-calendar"></i>تاريخ رفع الدعوى</label>
                            <input type="date" id="new-case-file-date">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-field">
                            <label><i class="fas fa-flag"></i>أولوية الدعوى</label>
                            <select id="new-case-priority">
                                <option value="">اختر الأولوية</option>
                                <option value="عادية">عادية</option>
                                <option value="مهمة">مهمة</option>
                                <option value="عاجلة">عاجلة</option>
                                <option value="طارئة">طارئة</option>
                            </select>
                        </div>
                        <div class="form-field">
                            <label><i class="fas fa-info-circle"></i>الحالة</label>
                            <select id="new-case-status">
                                <option value="">اختر الحالة</option>
                                <option value="مسودة">مسودة</option>
                                <option value="مرفوع">مرفوع</option>
                                <option value="تحت المراجعة">تحت المراجعة</option>
                                <option value="في المحكمة">في المحكمة</option>
                                <option value="صدور حكم">صدور حكم</option>
                                <option value="تبليغ بالحكم">تبليغ بالحكم</option>
                                <option value="تنفيذ">تنفيذ</option>
                                <option value="مغلق">مغلق</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-field form-field-full">
                        <label><i class="fas fa-dollar-sign"></i>مبلغ الدعوى (د.ع)</label>
                        <input type="number" id="new-case-amount" placeholder="100000">
                    </div>
                </div>

                <!-- Parties Section -->
                <div class="case-section">
                    <div class="section-title">
                        <i class="fas fa-users"></i>
                        أطراف الدعوى
                    </div>
                    
                    <div class="form-row">
                        <div class="form-field">
                            <label><i class="fas fa-user"></i>اسم المدعي</label>
                            <input type="text" id="new-case-plaintiff-name" placeholder="الاسم الكامل للمدعي">
                        </div>
                        <div class="form-field">
                            <label><i class="fas fa-phone"></i>رقم الهاتف</label>
                            <input type="tel" id="new-case-plaintiff-phone" placeholder="+964-770-123-4567">
                        </div>
                    </div>

                    <div class="form-field form-field-full">
                        <label><i class="fas fa-map-marker-alt"></i>عنوان المدعي</label>
                        <textarea id="new-case-plaintiff-address" rows="2" placeholder="العنوان الكامل..."></textarea>
                    </div>

                    <div class="form-field form-field-full">
                        <label><i class="fas fa-user-tie"></i>اسم المدعى عليه</label>
                        <input type="text" id="new-case-defendant-name" placeholder="الاسم الكامل للمدعى عليه">
                    </div>

                    <div class="form-field form-field-full">
                        <label><i class="fas fa-map-marker-alt"></i>عنوان المدعى عليه</label>
                        <textarea id="new-case-defendant-address" rows="2" placeholder="العنوان الكامل للمدعى عليه..."></textarea>
                    </div>
                </div>

                <!-- Legal Details Section -->
                <div class="case-section">
                    <div class="section-title">
                        <i class="fas fa-balance-scale"></i>
                        التفاصيل القانونية
                    </div>
                    
                    <div class="form-row">
                        <div class="form-field required">
                            <label><i class="fas fa-user-tie"></i>المحامي المسؤول</label>
                            <select id="new-case-lawyer-select" onchange="updateLawyerInfo()" required>
                                <option value="">اختر المحامي</option>
                                <option value="manual">إدخال يدوي</option>
                            </select>
                        </div>
                        <div class="form-field" id="manual-lawyer-field" style="display: none;">
                            <label><i class="fas fa-edit"></i>اسم المحامي (يدوي)</label>
                            <input type="text" id="new-case-lawyer-name" placeholder="اسم المحامي المسؤول">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-field required">
                            <label><i class="fas fa-building"></i>اسم المحكمة</label>
                            <input type="text" id="new-case-court-name" placeholder="مثال: محكمة بداءة بغداد" required>
                        </div>
                        <div class="form-field">
                            <label><i class="fas fa-hashtag"></i>اسم الدائرة</label>
                            <input type="text" id="new-case-court-section" placeholder="اسم الدائرة">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-field">
                            <label><i class="fas fa-tasks"></i>المرحلة الحالية</label>
                            <select id="new-case-stage" onchange="handleStageChange()">
                                <option value="إعداد الدعوى">إعداد الدعوى</option>
                                <option value="تقييم الدعوى">تقييم الدعوى</option>
                                <option value="التبليغ">التبليغ</option>
                                <option value="المرافعة">المرافعة</option>
                                <option value="تحت الدراسة">تحت الدراسة</option>
                                <option value="صدور حكم">صدور حكم</option>
                                <option value="الاستئناف">الاستئناف</option>
                                <option value="التنفيذ">التنفيذ</option>
                            </select>
                        </div>
                        <div class="form-field">
                            <label><i class="fas fa-calendar"></i>تاريخ الجلسة القادمة</label>
                            <input type="date" id="new-case-hearing">
                        </div>
                    </div>

                    <!-- Execution Options -->
                    <div class="execution-options" id="execution-options">
                        <h4 style="margin-bottom: 1rem; color: var(--indigo);">
                            <i class="fas fa-gavel"></i>
                            خيارات التنفيذ
                        </h4>
                        <div class="execution-option" onclick="toggleExecutionOption('seizure')">
                            <input type="checkbox" id="execution-seizure">
                            <label class="execution-option-label">حجز / تم الحجز</label>
                        </div>
                        <div class="execution-option" onclick="toggleExecutionOption('deduction')">
                            <input type="checkbox" id="execution-deduction">
                            <label class="execution-option-label">تم الاستقطاع</label>
                        </div>
                    </div>
                </div>

                <!-- Documents Section -->
                <div class="case-section">
                    <div class="section-title">
                        <i class="fas fa-file-text"></i>
                        المستندات والملاحظات
                    </div>

                    <div class="form-field form-field-full">
                        <label><i class="fas fa-upload"></i>رفع المستندات</label>
                        <div class="file-upload-area" id="file-upload-area" onclick="triggerFileUpload()">
                            <div class="file-upload-content">
                                <i class="fas fa-cloud-upload-alt file-upload-icon"></i>
                                <div class="file-upload-text">
                                    اسحب الملفات هنا أو انقر للاختيار
                                </div>
                                <div class="file-upload-buttons">
                                    <button type="button" class="btn btn-primary" onclick="triggerFileUpload()">
                                        <i class="fas fa-file-upload"></i>
                                        اختر ملفات
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="captureDocument()">
                                        <i class="fas fa-camera"></i>
                                        التقط صورة
                                    </button>
                                </div>
                            </div>
                        </div>
                        <input type="file" id="file-input" multiple accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" style="display: none;" onchange="handleFileUpload(event)">
                        <div class="uploaded-files" id="uploaded-files">
                            <!-- سيتم إضافة الملفات المرفوعة هنا -->
                        </div>
                    </div>
                    
                    <div class="form-field form-field-full">
                        <label><i class="fas fa-comment"></i>ملاحظات إضافية</label>
                        <textarea id="new-case-notes" rows="4" placeholder="أي ملاحظات إضافية عن القضية..."></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- New Defendant -->
        <div id="new-defendant-content" class="content-section hidden">
            <div class="content-header">
                <h2 class="content-title">مدعى عليه جديد</h2>
                <div class="content-actions">
                    <button class="btn btn-secondary" onclick="showTab('defendants')">
                        <i class="fas fa-times"></i>
                        إلغاء
                    </button>
                    <button class="btn btn-primary" onclick="saveNewDefendant()">
                        <i class="fas fa-save"></i>
                        حفظ المدعى عليه
                    </button>
                </div>
            </div>

            <div class="card" style="max-width: 800px; margin: 0 auto;">
                <h3>
                    <i class="fas fa-user-plus"></i>
                    بيانات المدعى عليه الجديد
                </h3>
                <div class="case-info-grid">
                    <div class="form-field">
                        <label><i class="fas fa-user"></i>اسم المدعى عليه الكامل</label>
                        <input type="text" id="new-defendant-name" placeholder="مثال: علي حسن محمد">
                    </div>
                    <div class="form-field">
                        <label><i class="fas fa-phone"></i>رقم الهاتف</label>
                        <input type="tel" id="new-defendant-phone" placeholder="مثال: +964-770-123-4567">
                    </div>
                    <div class="form-field">
                        <label><i class="fas fa-envelope"></i>البريد الإلكتروني</label>
                        <input type="email" id="new-defendant-email" placeholder="مثال: ali@email.com">
                    </div>
                    <div class="form-field">
                        <label><i class="fas fa-building"></i>جهة العمل</label>
                        <input type="text" id="new-defendant-workplace" placeholder="جهة العمل">
                    </div>
                </div>
                <div class="form-field">
                    <label><i class="fas fa-map-marker-alt"></i>العنوان</label>
                    <textarea id="new-defendant-address" placeholder="العنوان الكامل..." rows="3"></textarea>
                </div>
            </div>
        </div>

        <!-- New Lawyer -->
        <div id="new-lawyer-content" class="content-section hidden">
            <div class="content-header">
                <h2 class="content-title">محامٍ جديد</h2>
                <div class="content-actions">
                    <button class="btn btn-secondary" onclick="showTab('lawyers')">
                        <i class="fas fa-times"></i>
                        إلغاء
                    </button>
                    <button class="btn btn-primary" onclick="saveNewLawyer()">
                        <i class="fas fa-save"></i>
                        حفظ المحامي
                    </button>
                </div>
            </div>

            <div class="card" style="max-width: 800px; margin: 0 auto;">
                <h3>
                    <i class="fas fa-user-tie"></i>
                    بيانات المحامي الجديد
                </h3>
                <div class="case-info-grid">
                    <div class="form-field required">
                        <label><i class="fas fa-user"></i>اسم المحامي الكامل</label>
                        <input type="text" id="new-lawyer-name" placeholder="مثال: المحامي أحمد علي السعدي" required>
                    </div>
                    <div class="form-field required">
                        <label><i class="fas fa-id-badge"></i>رقم الترخيص</label>
                        <input type="text" id="new-lawyer-license" placeholder="مثال: BG-2024-001" required>
                    </div>
                   <div class="form-field">
    <label><i class="fas fa-phone"></i>رقم الهاتف</label>
    <input type="tel" id="new-lawyer-phone" placeholder="مثال: +964-770-123-4567">
</div>
<div class="form-field">
    <label><i class="fas fa-graduation-cap"></i>التخصص</label>
    <select id="new-lawyer-specialization">
        <option value="">اختر التخصص</option>
        <option value="القانون المدني">القانون المدني</option>
        <option value="القانون التجاري">القانون التجاري</option>
        <option value="قانون العمل">قانون العمل</option>
        <option value="القانون الجنائي">القانون الجنائي</option>
        <option value="القانون الإداري">القانون الإداري</option>
        <option value="قانون الأحوال الشخصية">قانون الأحوال الشخصية</option>
        <option value="القانون الدستوري">القانون الدستوري</option>
        <option value="القانون الدولي">القانون الدولي</option>
    </select>
</div>
                    <div class="form-field">
                        <label><i class="fas fa-calendar"></i>سنوات الخبرة</label>
                        <input type="number" id="new-lawyer-experience" placeholder="مثال: 5" min="0">
                    </div>
                </div>
                <div class="form-field">
                    <label><i class="fas fa-map-marker-alt"></i>العنوان</label>
                    <textarea id="new-lawyer-address" placeholder="العنوان الكامل..." rows="3"></textarea>
                </div>
                <div class="form-field">
                    <label for="plaintiff-area"><i class="fas fa-map-marker-alt"></i>منطقة المدعي</label>
                    <input type="text" id="plaintiff-area" placeholder="البوسعبر">
                </div>
                <div class="form-field">
                    <label for="defendant-area"><i class="fas fa-map-marker-alt"></i>منطقة المدعى عليه</label>
                    <input type="text" id="defendant-area" placeholder="الزبير">
                </div>
                <div class="form-field">
                    <label><i class="fas fa-comment"></i>ملاحظات</label>
                    <textarea id="new-lawyer-notes" placeholder="أي ملاحظات إضافية..." rows="3"></textarea>
                </div>
            </div>
        </div>

        <!-- Case Details -->
        <div id="case-details-content" class="content-section hidden">
            <div class="content-header">
                <h2 class="content-title" id="case-details-title">تفاصيل الدعوى</h2>
                <div class="content-actions">
                    <button class="btn btn-secondary" onclick="showTab('cases')">
                        <i class="fas fa-arrow-right"></i>
                        العودة للقائمة
                    </button>
                    <button class="btn btn-primary" onclick="editCurrentCase()">
                        <i class="fas fa-edit"></i>
                        تحرير
                    </button>
                    <button class="btn btn-success" onclick="printCase()">
                        <i class="fas fa-print"></i>
                        طباعة
                    </button>
                </div>
            </div>

            <div class="progress-container">
                <div class="progress-title">مراحل الدعوى</div>
                <div class="progress-steps" id="case-progress">
                    <!-- سيتم ملؤها بالـ JavaScript -->
                </div>
            </div>

            <div class="case-details-grid">
                <div style="display: flex; flex-direction: column; gap: 2rem;">
                    <div class="card">
                        <h3>
                            <i class="fas fa-info-circle"></i>
                            معلومات القضية
                        </h3>
                        <div class="case-info-grid" id="case-info-grid">
                            <!-- سيتم ملؤها بالـ JavaScript -->
                        </div>
                    </div>

                    <div class="card">
                        <h3>
                            <i class="fas fa-history"></i>
                            سجل الإجراءات
                        </h3>
                        <div class="timeline" id="case-timeline">
                            <!-- سيتم ملؤها بالـ JavaScript -->
                        </div>
                    </div>
                </div>

                <div style="display: flex; flex-direction: column; gap: 2rem;">
                    <div class="card">
                        <h3>
                            <i class="fas fa-dollar-sign"></i>
                            الاستقطاعات
                        </h3>
                        <div id="case-deductions">
                            <!-- سيتم ملؤها بالـ JavaScript -->
                        </div>
                    </div>

                    <div class="card">
                        <h3>
                            <i class="fas fa-file-pdf"></i>
                            المستندات
                        </h3>
                        <div id="case-documents">
                            <!-- سيتم ملؤها بالـ JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lawyer Details Page -->
        <div id="lawyer-details-content" class="content-section hidden">
            <div class="content-header">
                <h2 class="content-title" id="lawyer-details-title">تفاصيل المحامي</h2>
                <div class="content-actions">
                    <button class="btn btn-secondary" onclick="showTab('lawyers')">
                        <i class="fas fa-arrow-right"></i>
                        العودة للقائمة
                    </button>
                    <button class="btn btn-primary" onclick="editCurrentLawyer()">
                        <i class="fas fa-edit"></i>
                        تحرير
                    </button>
                </div>
            </div>

            <div class="grid-2">
                <div class="card">
                    <h3>
                        <i class="fas fa-info-circle"></i>
                        معلومات المحامي
                    </h3>
                    <div class="case-info-grid" id="lawyer-info-grid">
                        <!-- سيتم ملؤها بالـ JavaScript -->
                    </div>
                </div>

                <div class="card">
                    <h3>
                        <i class="fas fa-file-contract"></i>
                        الدعاوى المرتبطة
                    </h3>
                    <div id="lawyer-cases-list">
                        <!-- سيتم ملؤها بالـ JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Defendant Details Page -->
        <div id="defendant-details-content" class="content-section hidden">
            <div class="content-header">
                <h2 class="content-title" id="defendant-details-title">تفاصيل المدعى عليه</h2>
                <div class="content-actions">
                    <button class="btn btn-secondary" onclick="showTab('defendants')">
                        <i class="fas fa-arrow-right"></i>
                        العودة للقائمة
                    </button>
                    <button class="btn btn-primary" onclick="editCurrentDefendant()">
                        <i class="fas fa-edit"></i>
                        تحرير
                    </button>
                </div>
            </div>

            <div class="grid-2">
                <div class="card">
                    <h3>
                        <i class="fas fa-info-circle"></i>
                        معلومات المدعى عليه
                    </h3>
                    <div class="case-info-grid" id="defendant-info-grid">
                        <!-- سيتم ملؤها بالـ JavaScript -->
                    </div>
                </div>

                <div class="card">
                    <h3>
                        <i class="fas fa-file-contract"></i>
                        الدعاوى المرتبطة
                    </h3>
                    <div id="defendant-cases-list">
                        <!-- سيتم ملؤها بالـ JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Deduction Details Page -->
        <div id="deduction-details-content" class="content-section hidden">
            <div class="content-header">
                <h2 class="content-title" id="deduction-details-title">تفاصيل الاستقطاع</h2>
                <div class="content-actions">
                    <button class="btn btn-secondary" onclick="showTab('deductions')">
                        <i class="fas fa-arrow-right"></i>
                        العودة للقائمة
                    </button>
                    <button class="btn btn-primary" onclick="editCurrentDeduction()">
                        <i class="fas fa-edit"></i>
                        تحرير
                    </button>
                </div>
            </div>

            <div class="card">
                <h3>
                    <i class="fas fa-coins"></i>
                    معلومات الاستقطاع
                </h3>
                <div class="case-info-grid" id="deduction-info-grid">
                    <!-- سيتم ملؤها بالـ JavaScript -->
                </div>
            </div>
        </div>

        <!-- Settings -->
        <div id="settings-content" class="content-section hidden">
            <div class="content-header">
                <h2 class="content-title">
                    <i class="fas fa-cog"></i>
                    الإعدادات
                </h2>
                <div class="content-actions">
                    <button class="btn btn-success" onclick="saveAllSettings()">
                        <i class="fas fa-save"></i>
                        حفظ جميع الإعدادات
                    </button>
                </div>
            </div>
            
            <!-- Settings Tabs -->
            <div class="settings-tabs">
                <button class="settings-tab active" onclick="showSettingsTab('general')">
                    <i class="fas fa-home"></i>
                    عام
                </button>
                <button class="settings-tab" onclick="showSettingsTab('appearance')">
                    <i class="fas fa-palette"></i>
                    المظهر
                </button>
                <button class="settings-tab" onclick="showSettingsTab('notifications')">
                    <i class="fas fa-bell"></i>
                    الإشعارات
                </button>
                <button class="settings-tab" onclick="showSettingsTab('backup')">
                    <i class="fas fa-database"></i>
                    النسخ الاحتياطي
                </button>
                <button class="settings-tab" onclick="showSettingsTab('system')">
                    <i class="fas fa-cog"></i>
                    النظام
                </button>
                <button class="settings-tab" onclick="showSettingsTab('advanced')">
                    <i class="fas fa-tools"></i>
                    متقدم
                </button>
            </div>

            <!-- General Settings Tab -->
            <div class="settings-tab-content" id="general-settings">
                <div class="settings-section">
                    <h3>
                        <i class="fas fa-building"></i>
                        معلومات المكتب
                    </h3>
                    <div class="settings-grid">
                        <div class="form-field">
                            <label>
                                <i class="fas fa-signature"></i>
                                اسم المكتب
                            </label>
                            <input type="text" value="تطبيق الإدارة القانونية" id="office-name">
                        </div>
                        <div class="form-field">
                            <label>
                                <i class="fas fa-phone"></i>
                                رقم الهاتف
                            </label>
                            <input type="tel" value="+964-770-123-4567" id="office-phone">
                        </div>
                        <div class="form-field" style="grid-column: 1 / -1;">
                            <label>
                                <i class="fas fa-map-marker-alt"></i>
                                العنوان
                            </label>
                            <textarea rows="3" id="office-address">بغداد - الكرادة - شارع الرئيسي</textarea>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>
                        <i class="fas fa-user-tie"></i>
                        المعلومات الشخصية
                    </h3>
                    <div class="settings-grid">
                        <div class="form-field">
                            <label>
                                <i class="fas fa-user"></i>
                                الاسم الكامل
                            </label>
                            <input type="text" value="السيد أسامة" id="user-name">
                        </div>
                        <div class="form-field">
                            <label>
                                <i class="fas fa-briefcase"></i>
                                المنصب
                            </label>
                            <input type="text" value="المدير العام" id="user-position">
                        </div>
                        <div class="form-field">
                            <label>
                                <i class="fas fa-envelope"></i>
                                البريد الإلكتروني
                            </label>
                            <input type="email" value="osama@legal.com" id="user-email">
                        </div>
                        <div class="form-field">
                            <label>
                                <i class="fas fa-id-card"></i>
                                رقم الترخيص
                            </label>
                            <input type="text" value="LEG-2024-001" id="user-license">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Appearance Settings Tab -->
            <div class="settings-tab-content hidden" id="appearance-settings">
                <div class="settings-section">
                    <h3>
                        <i class="fas fa-palette"></i>
                        المظهر العام
                    </h3>
                    <div class="settings-grid">
                        <div class="form-field">
                            <label>
                                <i class="fas fa-adjust"></i>
                                وضع الإضاءة
                            </label>
                            <select id="theme-mode">
                                <option value="light" selected>فاتح</option>
                                <option value="dark">داكن</option>
                                <option value="auto">تلقائي (حسب النظام)</option>
                            </select>
                        </div>
                        <div class="form-field">
                            <label>
                                <i class="fas fa-paint-brush"></i>
                                اللون الأساسي
                            </label>
                            <select id="primary-color">
                                <option value="blue" selected>أزرق</option>
                                <option value="green">أخضر</option>
                                <option value="purple">بنفسجي</option>
                                <option value="red">أحمر</option>
                                <option value="orange">برتقالي</option>
                            </select>
                        </div>
                        <div class="form-field">
                            <label>
                                <i class="fas fa-text-height"></i>
                                حجم النص
                            </label>
                            <select id="font-size">
                                <option value="small">صغير</option>
                                <option value="normal" selected>عادي</option>
                                <option value="large">كبير</option>
                                <option value="extra-large">كبير جداً</option>
                            </select>
                        </div>
                        <div class="form-field">
                            <label>
                                <i class="fas fa-expand-arrows-alt"></i>
                                كثافة المحتوى
                            </label>
                            <select id="content-density">
                                <option value="compact">مضغوط</option>
                                <option value="normal" selected>عادي</option>
                                <option value="comfortable">مريح</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>
                        <i class="fas fa-desktop"></i>
                        معاينة المظهر
                    </h3>
                    <div class="theme-preview">
                        <div class="preview-card">
                            <div class="preview-header">
                                <h4>عينة من البطاقة</h4>
                                <button class="btn btn-sm btn-primary">زر</button>
                            </div>
                            <div class="preview-content">
                                <p>مثال على المحتوى في تبويب القوالب</p>
                                <div class="preview-stats">
                                    <span class="stat-item">
                                        <i class="fas fa-file"></i>
                                        15 دعوى
                                    </span>
                                    <span class="stat-item">
                                        <i class="fas fa-coins"></i>
                                        500,000 د.ع
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notifications Settings Tab -->
            <div class="settings-tab-content hidden" id="notifications-settings">
                <div class="settings-section">
                    <h3>
                        <i class="fas fa-desktop"></i>
                        إشعارات سطح المكتب
                    </h3>
                    <div class="notification-status-card">
                        <div class="status-header">
                            <div>
                                <h4>حالة الإشعارات</h4>
                                <p>إشعارات خارج المتصفح للمهام المهمة</p>
                            </div>
                            <div id="desktop-notification-status" class="status-badge">
                                <!-- سيتم ملؤه بـ JavaScript -->
                            </div>
                        </div>
                        <div class="status-actions">
                            <button class="btn btn-primary" onclick="requestDesktopNotificationPermission()">
                                <i class="fas fa-desktop"></i>
                                تفعيل الإشعارات
                            </button>

                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>
                        <i class="fas fa-sliders-h"></i>
                        إعدادات الإشعارات
                    </h3>
                    <div class="settings-grid">
                        <div class="setting-item">
                            <div class="setting-info">
                                <label>الإشعارات الصوتية</label>
                                <p>تشغيل صوت عند وصول إشعار جديد</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="sound-notifications" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="setting-item">
                            <div class="setting-info">
                                <label>إشعارات الجلسات</label>
                                <p>تنبيهات للجلسات القادمة والمتأخرة</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="hearing-notifications" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="setting-item">
                            <div class="setting-info">
                                <label>إشعارات الاستقطاعات</label>
                                <p>تنبيهات عند إضافة استقطاعات جديدة</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="deduction-notifications" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="form-field">
                            <label>
                                <i class="fas fa-calendar"></i>
                                تنبيه قبل الجلسة بـ (أيام)
                            </label>
                            <select id="notification-days">
                                <option value="1">يوم واحد</option>
                                <option value="2">يومين</option>
                                <option value="3" selected>3 أيام</option>
                                <option value="5">5 أيام</option>
                                <option value="7">أسبوع</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>
                        <i class="fas fa-chart-bar"></i>
                        إحصائيات الإشعارات
                    </h3>
                    <div class="notifications-stats">
                        <div class="stat-card urgent">
                            <div class="stat-number" id="high-priority-count">0</div>
                            <div class="stat-label">عاجل</div>
                            <i class="fas fa-exclamation-circle"></i>
                        </div>
                        <div class="stat-card warning">
                            <div class="stat-number" id="medium-priority-count">0</div>
                            <div class="stat-label">متوسط</div>
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="stat-card info">
                            <div class="stat-number" id="low-priority-count">0</div>
                            <div class="stat-label">عادي</div>
                            <i class="fas fa-info-circle"></i>
                        </div>
                    </div>
                    <div class="notifications-actions">
                        <button class="btn btn-success" onclick="generateSmartNotifications()">
                            <i class="fas fa-sync"></i>
                            تحديث الإشعارات
                        </button>
                        <button class="btn btn-info" onclick="showNotifications()">
                            <i class="fas fa-list"></i>
                            عرض الإشعارات
                        </button>
                        <button class="btn btn-warning" onclick="clearNotificationHistory()">
                            <i class="fas fa-eraser"></i>
                            مسح السجل
                        </button>
                        <button class="btn btn-danger" onclick="clearAllNotifications()">
                            <i class="fas fa-trash"></i>
                            حذف الكل
                        </button>
                    </div>
                </div>
            </div>

            <!-- Backup Settings Tab -->
            <div class="settings-tab-content hidden" id="backup-settings">
                <div class="settings-section">
                    <h3>
                        <i class="fas fa-cloud"></i>
                        النسخ الاحتياطي
                    </h3>
                    <div class="backup-status-card">
                        <div class="backup-info">
                            <div class="backup-icon">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="backup-details">
                                <h4>حالة النسخ الاحتياطي</h4>
                                <p id="last-backup-info">آخر نسخة احتياطية: <span id="last-backup-date">لم يتم إنشاء نسخة احتياطية بعد</span></p>
                                <div class="backup-size" id="backup-size-info">
                                    حجم البيانات المتوقع: <span>تقدير...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>
                        <i class="fas fa-download"></i>
                        إنشاء نسخة احتياطية
                    </h3>
                    <div class="backup-options">
                        <div class="backup-option">
                            <div class="option-icon">
                                <i class="fas fa-file-archive"></i>
                            </div>
                            <div class="option-details">
                                <h4>نسخة كاملة</h4>
                                <p>جميع البيانات والإعدادات</p>
                            </div>
                            <button class="btn btn-primary" onclick="createFullBackup()">
                                <i class="fas fa-download"></i>
                                تحميل
                            </button>
                        </div>
                        <div class="backup-option">
                            <div class="option-icon">
                                <i class="fas fa-file-contract"></i>
                            </div>
                            <div class="option-details">
                                <h4>الدعاوى فقط</h4>
                                <p>بيانات الدعاوى والاستقطاعات</p>
                            </div>
                            <button class="btn btn-secondary" onclick="createCasesBackup()">
                                <i class="fas fa-download"></i>
                                تحميل
                            </button>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>
                        <i class="fas fa-upload"></i>
                        استرداد النسخة الاحتياطية
                    </h3>
                    <div class="restore-area">
                        <div class="restore-upload" id="restore-drop-zone">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <h4>اسحب ملف النسخة الاحتياطية هنا</h4>
                            <p>أو انقر لاختيار الملف</p>
                            <input type="file" id="backup-file-input" accept=".json" hidden>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>
                        <i class="fas fa-cog"></i>
                        الإعدادات التلقائية
                    </h3>
                    <div class="auto-backup-settings">
                        <div class="setting-item">
                            <div class="setting-info">
                                <label>النسخ الاحتياطي التلقائي</label>
                                <p>إنشاء نسخة احتياطية يومياً</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="auto-backup" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="setting-item">
                            <div class="setting-info">
                                <label>النسخ عند الإغلاق</label>
                                <p>إنشاء نسخة عند إغلاق التطبيق</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="backup-on-exit">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- System Settings Tab -->
            <div class="settings-tab-content hidden" id="system-settings">
                <div class="settings-section">
                    <h3>
                        <i class="fas fa-globe"></i>
                        إعدادات اللغة والتاريخ
                    </h3>
                    <div class="settings-grid">
                        <div class="form-field">
                            <label>
                                <i class="fas fa-language"></i>
                                لغة النظام
                            </label>
                            <select id="system-language">
                                <option value="ar" selected>العربية</option>
                                <option value="en">English</option>
                                <option value="kr">کوردی</option>
                            </select>
                        </div>
                        <div class="form-field">
                            <label>
                                <i class="fas fa-align-right"></i>
                                اتجاه النص
                            </label>
                            <select id="text-direction">
                                <option value="rtl" selected>من اليمين لليسار</option>
                                <option value="ltr">من اليسار لليمين</option>
                            </select>
                        </div>
                        <div class="form-field">
                            <label>
                                <i class="fas fa-calendar"></i>
                                نوع التاريخ
                            </label>
                            <select id="date-type">
                                <option value="gregorian" selected>ميلادي</option>
                                <option value="hijri">هجري</option>
                                <option value="both">كلاهما</option>
                            </select>
                        </div>
                        <div class="form-field">
                            <label>
                                <i class="fas fa-coins"></i>
                                العملة
                            </label>
                            <select id="currency">
                                <option value="iqd" selected>دينار عراقي (د.ع)</option>
                                <option value="usd">دولار أمريكي ($)</option>
                                <option value="eur">يورو (€)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>
                        <i class="fas fa-save"></i>
                        إعدادات الحفظ
                    </h3>
                    <div class="settings-grid">
                        <div class="setting-item">
                            <div class="setting-info">
                                <label>الحفظ التلقائي</label>
                                <p>حفظ البيانات تلقائياً كل فترة</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="auto-save" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="form-field">
                            <label>
                                <i class="fas fa-clock"></i>
                                فترة الحفظ التلقائي (دقائق)
                            </label>
                            <select id="auto-save-interval">
                                <option value="1">دقيقة واحدة</option>
                                <option value="5" selected>5 دقائق</option>
                                <option value="10">10 دقائق</option>
                                <option value="30">30 دقيقة</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>
                        <i class="fas fa-shield-alt"></i>
                        الأمان والخصوصية
                    </h3>
                    <div class="security-settings">
                        <div class="setting-item">
                            <div class="setting-info">
                                <label>تشفير البيانات المحلية</label>
                                <p>تشفير البيانات المحفوظة محلياً</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="encrypt-data">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="setting-item">
                            <div class="setting-info">
                                <label>مسح البيانات عند الإغلاق</label>
                                <p>حذف الملفات المؤقتة عند الإغلاق</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="clear-temp-data">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Advanced Settings Tab -->
            <div class="settings-tab-content hidden" id="advanced-settings">
                <div class="settings-section">
                    <h3>
                        <i class="fas fa-tools"></i>
                        أدوات النظام
                    </h3>
                    <div class="system-tools">
                        <div class="tool-card">
                            <div class="tool-icon">
                                <i class="fas fa-stethoscope"></i>
                            </div>
                            <div class="tool-info">
                                <h4>فحص سلامة البيانات</h4>
                                <p>فحص وإصلاح أي مشاكل في قاعدة البيانات</p>
                            </div>
                            <button class="btn btn-primary" onclick="runDataIntegrityCheck()">
                                <i class="fas fa-play"></i>
                                تشغيل
                            </button>
                        </div>
                        <div class="tool-card">
                            <div class="tool-icon">
                                <i class="fas fa-broom"></i>
                            </div>
                            <div class="tool-info">
                                <h4>تنظيف البيانات</h4>
                                <p>حذف البيانات المؤقتة والملفات غير المستخدمة</p>
                            </div>
                            <button class="btn btn-secondary" onclick="cleanTempData()">
                                <i class="fas fa-play"></i>
                                تشغيل
                            </button>
                        </div>
                        <div class="tool-card">
                            <div class="tool-icon">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div class="tool-info">
                                <h4>إحصائيات الأداء</h4>
                                <p>عرض معلومات حول أداء التطبيق</p>
                            </div>
                            <button class="btn btn-info" onclick="showPerformanceStats()">
                                <i class="fas fa-eye"></i>
                                عرض
                            </button>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>
                        <i class="fas fa-database"></i>
                        إدارة البيانات
                    </h3>
                    <div class="data-management">
                        <div class="data-stats">
                            <div class="stat-item">
                                <span class="stat-label">عدد الدعاوى:</span>
                                <span class="stat-value" id="total-cases-count">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">عدد المحامين:</span>
                                <span class="stat-value" id="total-lawyers-count">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">عدد الاستقطاعات:</span>
                                <span class="stat-value" id="total-deductions-count">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">حجم البيانات:</span>
                                <span class="stat-value" id="data-size">0 KB</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-section danger-section">
                    <h3>
                        <i class="fas fa-exclamation-triangle"></i>
                        المنطقة الخطرة
                    </h3>
                    <div class="danger-actions">
                        <div class="danger-card">
                            <div class="danger-content">
                                <div class="danger-icon">
                                    <i class="fas fa-undo"></i>
                                </div>
                                <div class="danger-info">
                                    <h4>إعادة ضبط المصنع</h4>
                                    <p>حذف جميع البيانات والعودة للإعدادات الافتراضية</p>
                                    <small class="warning-text">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        تحذير: لا يمكن التراجع عن هذا الإجراء
                                    </small>
                                </div>
                                <button class="btn btn-danger" onclick="initiateFactoryReset()">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    إعادة ضبط المصنع
                                </button>
                            </div>
                        </div>
                        <div class="danger-card">
                            <div class="danger-content">
                                <div class="danger-icon">
                                    <i class="fas fa-trash-alt"></i>
                                </div>
                                <div class="danger-info">
                                    <h4>حذف جميع البيانات</h4>
                                    <p>حذف جميع الدعاوى والاستقطاعات والإعدادات</p>
                                    <small class="warning-text">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        تحذير: سيتم فقدان جميع البيانات نهائياً
                                    </small>
                                </div>
                                <button class="btn btn-danger" onclick="deleteAllData()">
                                    <i class="fas fa-trash-alt"></i>
                                    حذف جميع البيانات
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase Status Bar -->
    <div id="firebase-status-bar" class="firebase-status-bar">
        <div class="status-content">
            <div class="status-indicator">
                <i id="firebase-status-icon" class="fas fa-circle"></i>
                <span id="firebase-status-text">جاري الاتصال...</span>
            </div>
            <div class="sync-info">
                <span id="sync-pending-count" class="sync-count hidden">0</span>
                <span id="last-sync-time" class="last-sync hidden">آخر مزامنة: لا يوجد</span>
            </div>
        </div>
    </div>

    <script src="modal-manager.js"></script>
    <script src="shared-config.js"></script>
    <script>

        // Firebase Configuration
      const firebaseConfig = {
  apiKey: "AIzaSyDrZmZwSOVhonbLWGrHnctkV4tUcT7UNZM",
  authDomain: "legal-department-dbd28.firebaseapp.com",
  databaseURL: "https://legal-department-dbd28-default-rtdb.firebaseio.com",
  projectId: "legal-department-dbd28",
  storageBucket: "legal-department-dbd28.firebasestorage.app",
  messagingSenderId: "452600951683",
  appId: "1:452600951683:web:2929d22d53a309d947fcb6"
};

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // Ensure global access to Firebase
        window.firebase = firebase;
        window.database = database;

        // Firebase Sync Manager - مدير المزامنة مع Firebase
        class FirebaseSyncManager {
            constructor() {
                this.database = database;
                this.isOnline = navigator.onLine;
                this.isFirebaseConnected = false;
                this.pendingOperations = JSON.parse(localStorage.getItem('pendingFirebaseOperations') || '[]');
                this.syncInProgress = false;
                this.lastSyncTime = localStorage.getItem('lastFirebaseSync') || null;
                
                // مراقبة حالة الاتصال
                this.setupConnectionMonitoring();
                
                // محاولة الاتصال بـ Firebase
                this.initializeFirebaseConnection();
                
                // Make globally accessible
                window.firebaseManager = this;
            }

            setupConnectionMonitoring() {
                // مراقبة الاتصال بالإنترنت
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    console.log('تم استعادة الاتصال بالإنترنت');
                    this.syncPendingOperations();
                });

                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    console.log('فقدان الاتصال بالإنترنت - سيتم العمل في وضع عدم الاتصال');
                });

                // مراقبة اتصال Firebase
                const connectedRef = database.ref('.info/connected');
                connectedRef.on('value', (snapshot) => {
                    this.isFirebaseConnected = snapshot.val() === true;
                    if (this.isFirebaseConnected) {
                        console.log('متصل بـ Firebase');
                        this.syncPendingOperations();
                    } else {
                        console.log('غير متصل بـ Firebase');
                    }
                });
            }

            async initializeFirebaseConnection() {
                try {
                    // محاولة قراءة بيانات بسيطة للتأكد من الاتصال
                    await database.ref('.info/serverTimeOffset').once('value');
                    this.isFirebaseConnected = true;
                    console.log('تم الاتصال بـ Firebase بنجاح');
                } catch (error) {
                    console.error('فشل الاتصال بـ Firebase:', error);
                    this.isFirebaseConnected = false;
                }
            }

            // إضافة عملية إلى قائمة الانتظار
            addPendingOperation(operation) {
                this.pendingOperations.push({
                    ...operation,
                    timestamp: new Date().toISOString(),
                    retryCount: 0
                });
                localStorage.setItem('pendingFirebaseOperations', JSON.stringify(this.pendingOperations));
            }

            // مزامنة العمليات المعلقة
            async syncPendingOperations() {
                if (!this.isFirebaseConnected || this.syncInProgress || this.pendingOperations.length === 0) {
                    return;
                }

                this.syncInProgress = true;
                console.log(`بدء مزامنة ${this.pendingOperations.length} عملية معلقة...`);

                const operationsToSync = [...this.pendingOperations];
                this.pendingOperations = [];

                for (const operation of operationsToSync) {
                    try {
                        await this.executeOperation(operation);
                        console.log('تمت مزامنة العملية:', operation.type, operation.collection);
                    } catch (error) {
                        console.error('فشل في مزامنة العملية:', operation, error);
                        
                        // إعادة إضافة العملية إذا فشلت وتم المحاولة أقل من 3 مرات
                        if (operation.retryCount < 3) {
                            operation.retryCount++;
                            this.pendingOperations.push(operation);
                        }
                    }
                }

                localStorage.setItem('pendingFirebaseOperations', JSON.stringify(this.pendingOperations));
                this.lastSyncTime = new Date().toISOString();
                localStorage.setItem('lastFirebaseSync', this.lastSyncTime);
                this.syncInProgress = false;

                if (this.pendingOperations.length === 0 && operationsToSync.length > 0) {
                    console.log('تمت مزامنة جميع البيانات مع قاعدة البيانات');
                }
            }

            // تنفيذ عملية واحدة
            async executeOperation(operation) {
                switch (operation.type) {
                    case 'save':
                        await database.ref(`${operation.collection}/${operation.id}`).set(operation.data);
                        break;
                    case 'update':
                        await database.ref(`${operation.collection}/${operation.id}`).update(operation.data);
                        break;
                    case 'delete':
                        await database.ref(`${operation.collection}/${operation.id}`).remove();
                        break;
                    default:
                        throw new Error('نوع عملية غير معروف: ' + operation.type);
                }
            }

            // حفظ البيانات في Firebase
            async saveToFirebase(collection, id, data) {
                const operation = {
                    type: 'save',
                    collection,
                    id,
                    data: {
                        ...data,
                        id: id,
                        lastModified: new Date().toISOString(),
                        syncStatus: 'synced'
                    }
                };

                if (this.isFirebaseConnected) {
                    try {
                        await this.executeOperation(operation);
                        return true;
                    } catch (error) {
                        console.error('خطأ في حفظ البيانات مباشرة:', error);
                        this.addPendingOperation(operation);
                        return false;
                    }
                } else {
                    this.addPendingOperation(operation);
                    return false;
                }
            }

            // تحديث البيانات في Firebase
            async updateInFirebase(collection, id, updates) {
                const operation = {
                    type: 'update',
                    collection,
                    id,
                    data: {
                        ...updates,
                        lastModified: new Date().toISOString(),
                        syncStatus: 'synced'
                    }
                };

                if (this.isFirebaseConnected) {
                    try {
                        await this.executeOperation(operation);
                        return true;
                    } catch (error) {
                        console.error('خطأ في تحديث البيانات مباشرة:', error);
                        this.addPendingOperation(operation);
                        return false;
                    }
                } else {
                    this.addPendingOperation(operation);
                    return false;
                }
            }

            // حذف البيانات من Firebase
            async deleteFromFirebase(collection, id) {
                const operation = {
                    type: 'delete',
                    collection,
                    id
                };

                if (this.isFirebaseConnected) {
                    try {
                        await this.executeOperation(operation);
                        return true;
                    } catch (error) {
                        console.error('خطأ في حذف البيانات مباشرة:', error);
                        this.addPendingOperation(operation);
                        return false;
                    }
                } else {
                    this.addPendingOperation(operation);
                    return false;
                }
            }

            // تحميل البيانات من Firebase
            async loadFromFirebase(collection) {
                if (!this.isFirebaseConnected) {
                    throw new Error('غير متصل بـ Firebase');
                }

                try {
                    const snapshot = await database.ref(collection).once('value');
                    if (snapshot.exists()) {
                        return Object.values(snapshot.val());
                    }
                    return [];
                } catch (error) {
                    console.error(`خطأ في تحميل ${collection} من Firebase:`, error);
                    throw error;
                }
            }

            // إعداد مستمع للتحديثات في الوقت الفعلي
            setupRealtimeListener(collection, callback) {
                if (!this.isFirebaseConnected) {
                    console.warn(`لا يمكن إعداد مستمع لـ ${collection} - غير متصل بـ Firebase`);
                    return null;
                }

                const ref = database.ref(collection);
                ref.on('value', (snapshot) => {
                    if (snapshot.exists()) {
                        const data = Object.values(snapshot.val());
                        console.log(`تحديث فوري لـ ${collection}: ${data.length} عنصر من Firebase`);
                        
                        // لا نقوم بالتحديث إذا كانت البيانات فارغة ولدينا بيانات محلية
                        if (data.length > 0) {
                            callback(data);
                        } else {
                            console.log(`تجاهل البيانات الفارغة لـ ${collection} من Firebase`);
                        }
                    } else {
                        console.log(`لا توجد بيانات لـ ${collection} في Firebase`);
                        // لا نقوم بإرسال مصفوفة فارغة إذا لم تكن هناك بيانات في Firebase
                    }
                });

                return ref;
            }

            // إيقاف مستمع
            removeRealtimeListener(ref) {
                if (ref) {
                    ref.off();
                }
            }

            // الحصول على إحصائيات المزامنة
            getSyncStats() {
                return {
                    isOnline: this.isOnline,
                    isFirebaseConnected: this.isFirebaseConnected,
                    pendingOperationsCount: this.pendingOperations.length,
                    lastSyncTime: this.lastSyncTime,
                    syncInProgress: this.syncInProgress
                };
            }
        }

        // إنشاء مثيل من مدير المزامنة
        const firebaseSync = new FirebaseSyncManager();

        // ========== نظام التنقل بين الحقول باستخدام Enter ==========
        class FieldNavigationManager {
            constructor() {
                this.currentFieldIndex = 0;
                this.navigableFields = [];
                this.isNavigationMode = false;
                this.init();
            }

            init() {
                // إضافة مستمعي الأحداث
                document.addEventListener('keydown', this.handleKeyDown.bind(this));
                document.addEventListener('focus', this.handleFocus.bind(this), true);
                document.addEventListener('blur', this.handleBlur.bind(this), true);
                
                // تحديث قائمة الحقول عند تغيير المحتوى
                this.updateNavigableFields();
                
                // مراقبة تغييرات DOM
                const observer = new MutationObserver(() => {
                    this.updateNavigableFields();
                });
                
                observer.observe(document.body, {
                    childList: true,
                    subtree: true
                });
            }

            updateNavigableFields() {
                // البحث عن جميع الحقول القابلة للتنقل
                const selectors = [
                    'input[type="text"]:not([disabled]):not([readonly])',
                    'input[type="email"]:not([disabled]):not([readonly])',
                    'input[type="password"]:not([disabled]):not([readonly])',
                    'input[type="number"]:not([disabled]):not([readonly])',
                    'input[type="date"]:not([disabled]):not([readonly])',
                    'input[type="tel"]:not([disabled]):not([readonly])',
                    'textarea:not([disabled]):not([readonly])',
                    'select:not([disabled])',
                    '.form-control:not([disabled]):not([readonly])'
                ];
                
                this.navigableFields = Array.from(document.querySelectorAll(selectors.join(', ')))
                    .filter(field => this.isFieldVisible(field))
                    .sort((a, b) => {
                        const rectA = a.getBoundingClientRect();
                        const rectB = b.getBoundingClientRect();
                        
                        // ترتيب حسب الموقع الرأسي ثم الأفقي
                        if (Math.abs(rectA.top - rectB.top) > 10) {
                            return rectA.top - rectB.top;
                        }
                        return rectB.right - rectA.right; // للغة العربية
                    });
            }

            isFieldVisible(field) {
                const rect = field.getBoundingClientRect();
                const style = window.getComputedStyle(field);
                
                return rect.width > 0 && 
                       rect.height > 0 && 
                       style.visibility !== 'hidden' && 
                       style.display !== 'none' &&
                       field.offsetParent !== null;
            }

            handleKeyDown(event) {
                if (event.key === 'Enter' && !event.shiftKey) {
                    const activeElement = document.activeElement;
                    
                    // تجاهل في textarea إلا مع Ctrl
                    if (activeElement.tagName === 'TEXTAREA' && !event.ctrlKey) {
                        return;
                    }
                    
                    // تجاهل في الأزرار
                    if (activeElement.tagName === 'BUTTON' || activeElement.type === 'submit') {
                        return;
                    }
                    
                    // التنقل للحقل التالي
                    this.navigateToNextField(event);
                }
                
                // Alt + Enter للتنقل للحقل السابق
                if (event.key === 'Enter' && event.altKey) {
                    event.preventDefault();
                    this.navigateToPreviousField();
                }
                
                // Escape لإلغاء وضع التنقل
                if (event.key === 'Escape') {
                    this.exitNavigationMode();
                }
            }

            navigateToNextField(event) {
                this.updateNavigableFields();
                
                const currentField = document.activeElement;
                const currentIndex = this.navigableFields.indexOf(currentField);
                
                if (currentIndex !== -1) {
                    event.preventDefault();
                    
                    const nextIndex = (currentIndex + 1) % this.navigableFields.length;
                    const nextField = this.navigableFields[nextIndex];
                    
                    if (nextField) {
                        this.focusField(nextField);
                        this.showNavigationFeedback(nextField);
                    }
                }
            }

            navigateToPreviousField() {
                this.updateNavigableFields();
                
                const currentField = document.activeElement;
                const currentIndex = this.navigableFields.indexOf(currentField);
                
                if (currentIndex !== -1) {
                    const prevIndex = currentIndex === 0 ? 
                        this.navigableFields.length - 1 : currentIndex - 1;
                    const prevField = this.navigableFields[prevIndex];
                    
                    if (prevField) {
                        this.focusField(prevField);
                        this.showNavigationFeedback(prevField);
                    }
                }
            }

            focusField(field) {
                field.focus();
                
                // تحديد النص إذا كان حقل نص
                if (field.type === 'text' || field.type === 'email' || 
                    field.type === 'tel' || field.tagName === 'TEXTAREA') {
                    field.select();
                }
                
                // التمرير للحقل إذا لم يكن مرئياً
                field.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
            }

            showNavigationFeedback(field) {
                // إضافة تأثير بصري مؤقت
                field.classList.add('next-field');
                
                setTimeout(() => {
                    field.classList.remove('next-field');
                }, 800);
                
                // عرض تلميح التنقل
                this.showNavigationHint(field);
            }

            showNavigationHint(field) {
                // إزالة التلميحات السابقة
                document.querySelectorAll('.field-navigation-hint').forEach(hint => {
                    hint.remove();
                });
                
                // إنشاء تلميح جديد
                const hint = document.createElement('div');
                hint.className = 'field-navigation-hint';
                hint.innerHTML = '<i class="fas fa-arrow-down"></i> Enter للتالي | Alt+Enter للسابق | Esc للخروج';
                
                // إضافة التلميح بعد الحقل
                if (field.parentNode) {
                    field.parentNode.insertBefore(hint, field.nextSibling);
                    
                    // إزالة التلميح بعد فترة
                    setTimeout(() => {
                        hint.remove();
                    }, 3000);
                }
            }

            handleFocus(event) {
                const field = event.target;
                if (this.navigableFields.includes(field)) {
                    this.isNavigationMode = true;
                    this.currentFieldIndex = this.navigableFields.indexOf(field);
                }
            }

            handleBlur(event) {
                // إزالة التأثيرات البصرية
                event.target.classList.remove('next-field');
            }

            exitNavigationMode() {
                this.isNavigationMode = false;
                
                // إزالة جميع التأثيرات
                document.querySelectorAll('.next-field').forEach(field => {
                    field.classList.remove('next-field');
                });
                
                document.querySelectorAll('.field-navigation-hint').forEach(hint => {
                    hint.remove();
                });
            }
        }

        // ========== نظام القائمة السياقية (النقر الأيمن) ==========
        class ContextMenuManager {
            constructor() {
                this.contextMenu = null;
                this.targetElement = null;
                this.init();
            }

            init() {
                this.createContextMenu();
                
                // منع القائمة الافتراضية وإظهار القائمة المخصصة
                document.addEventListener('contextmenu', this.handleContextMenu.bind(this));
                
                // إخفاء القائمة عند النقر في مكان آخر
                document.addEventListener('click', this.hideContextMenu.bind(this));
                document.addEventListener('keydown', this.handleKeyDown.bind(this));
            }

            createContextMenu() {
                this.contextMenu = document.createElement('div');
                this.contextMenu.className = 'context-menu';
                this.contextMenu.innerHTML = `
                    <button class="context-menu-item" data-action="copy">
                        <i class="fas fa-copy"></i>
                        نسخ
                    </button>
                    <button class="context-menu-item" data-action="cut">
                        <i class="fas fa-cut"></i>
                        قص
                    </button>
                    <button class="context-menu-item" data-action="paste">
                        <i class="fas fa-paste"></i>
                        لصق
                    </button>
                    <div class="context-menu-separator"></div>
                    <button class="context-menu-item" data-action="select-all">
                        <i class="fas fa-check-square"></i>
                        تحديد الكل
                    </button>
                    <button class="context-menu-item" data-action="clear">
                        <i class="fas fa-eraser"></i>
                        مسح
                    </button>
                    <div class="context-menu-separator"></div>
                    <button class="context-menu-item" data-action="undo">
                        <i class="fas fa-undo"></i>
                        تراجع
                    </button>
                    <button class="context-menu-item" data-action="redo">
                        <i class="fas fa-redo"></i>
                        إعادة
                    </button>
                    <div class="context-menu-separator"></div>
                    <button class="context-menu-item" data-action="format">
                        <i class="fas fa-magic"></i>
                        تنسيق النص
                    </button>
                    <button class="context-menu-item" data-action="translate">
                        <i class="fas fa-language"></i>
                        ترجمة
                    </button>
                `;
                
                document.body.appendChild(this.contextMenu);
                
                // إضافة مستمعي الأحداث للعناصر
                this.contextMenu.addEventListener('click', this.handleMenuClick.bind(this));
            }

            handleContextMenu(event) {
                // التحقق من نوع العنصر
                const target = event.target;
                
                // السماح بالقائمة على حقول النص والنماذج فقط
                if (this.isTextInputElement(target) || this.isFormElement(target)) {
                    event.preventDefault();
                    this.targetElement = target;
                    this.showContextMenu(event.clientX, event.clientY);
                    this.updateMenuState();
                }
            }

            isTextInputElement(element) {
                const textInputTypes = ['text', 'email', 'password', 'tel', 'url', 'search'];
                return (element.tagName === 'INPUT' && textInputTypes.includes(element.type)) ||
                       element.tagName === 'TEXTAREA' ||
                       element.contentEditable === 'true';
            }

            isFormElement(element) {
                return element.tagName === 'SELECT' ||
                       (element.tagName === 'INPUT' && ['number', 'date', 'time'].includes(element.type));
            }

            showContextMenu(x, y) {
                this.contextMenu.style.display = 'block';
                
                // تحديد الموقع مع تجنب الخروج من الشاشة
                const menuRect = this.contextMenu.getBoundingClientRect();
                const windowWidth = window.innerWidth;
                const windowHeight = window.innerHeight;
                
                let left = x;
                let top = y;
                
                // تعديل الموقع الأفقي
                if (left + menuRect.width > windowWidth) {
                    left = windowWidth - menuRect.width - 10;
                }
                
                // تعديل الموقع الرأسي
                if (top + menuRect.height > windowHeight) {
                    top = windowHeight - menuRect.height - 10;
                }
                
                this.contextMenu.style.left = left + 'px';
                this.contextMenu.style.top = top + 'px';
            }

            hideContextMenu() {
                if (this.contextMenu) {
                    this.contextMenu.style.display = 'none';
                }
                this.targetElement = null;
            }

            updateMenuState() {
                if (!this.targetElement) return;
                
                const hasSelection = this.hasTextSelection();
                const hasContent = this.targetElement.value && this.targetElement.value.length > 0;
                const canPaste = true; // سيتم فحصه عند التنفيذ
                
                // تحديث حالة الأزرار
                this.updateButtonState('copy', hasSelection);
                this.updateButtonState('cut', hasSelection && !this.targetElement.readOnly);
                this.updateButtonState('paste', !this.targetElement.readOnly);
                this.updateButtonState('select-all', hasContent);
                this.updateButtonState('clear', hasContent && !this.targetElement.readOnly);
                this.updateButtonState('undo', !this.targetElement.readOnly);
                this.updateButtonState('redo', !this.targetElement.readOnly);
                this.updateButtonState('format', hasContent && !this.targetElement.readOnly);
                this.updateButtonState('translate', hasSelection || hasContent);
            }

            updateButtonState(action, enabled) {
                const button = this.contextMenu.querySelector(`[data-action="${action}"]`);
                if (button) {
                    button.disabled = !enabled;
                }
            }

            hasTextSelection() {
                if (!this.targetElement) return false;
                
                if (this.targetElement.tagName === 'INPUT' || this.targetElement.tagName === 'TEXTAREA') {
                    return this.targetElement.selectionStart !== this.targetElement.selectionEnd;
                }
                
                const selection = window.getSelection();
                return selection.rangeCount > 0 && !selection.getRangeAt(0).collapsed;
            }

            async handleMenuClick(event) {
                const button = event.target.closest('.context-menu-item');
                if (!button || button.disabled || !this.targetElement) return;
                
                const action = button.dataset.action;
                
                try {
                    switch (action) {
                        case 'copy':
                            await this.copyText();
                            break;
                        case 'cut':
                            await this.cutText();
                            break;
                        case 'paste':
                            await this.pasteText();
                            break;
                        case 'select-all':
                            this.selectAllText();
                            break;
                        case 'clear':
                            this.clearText();
                            break;
                        case 'undo':
                            this.undoAction();
                            break;
                        case 'redo':
                            this.redoAction();
                            break;
                        case 'format':
                            this.formatText();
                            break;
                        case 'translate':
                            this.translateText();
                            break;
                    }
                } catch (error) {
                    console.error('خطأ في تنفيذ العملية:', error);
                    this.showNotification('حدث خطأ في تنفيذ العملية', 'error');
                }
                
                this.hideContextMenu();
            }

            async copyText() {
                const selectedText = this.getSelectedText();
                if (selectedText) {
                    await navigator.clipboard.writeText(selectedText);
                    this.showNotification('تم نسخ النص', 'success');
                }
            }

            async cutText() {
                const selectedText = this.getSelectedText();
                if (selectedText) {
                    await navigator.clipboard.writeText(selectedText);
                    this.deleteSelectedText();
                    this.showNotification('تم قص النص', 'success');
                }
            }

            async pasteText() {
                try {
                    const text = await navigator.clipboard.readText();
                    this.insertText(text);
                    this.showNotification('تم لصق النص', 'success');
                } catch (error) {
                    // fallback لمتصفحات قديمة
                    document.execCommand('paste');
                }
            }

            selectAllText() {
                if (this.targetElement.tagName === 'INPUT' || this.targetElement.tagName === 'TEXTAREA') {
                    this.targetElement.select();
                } else {
                    document.execCommand('selectAll');
                }
                this.showNotification('تم تحديد النص بالكامل', 'info');
            }

            clearText() {
                if (this.hasTextSelection()) {
                    this.deleteSelectedText();
                } else {
                    this.targetElement.value = '';
                    this.targetElement.dispatchEvent(new Event('input', { bubbles: true }));
                }
                this.showNotification('تم مسح النص', 'info');
            }

            undoAction() {
                document.execCommand('undo');
                this.showNotification('تم التراجع', 'info');
            }

            redoAction() {
                document.execCommand('redo');
                this.showNotification('تم الإعادة', 'info');
            }

            formatText() {
                const text = this.getSelectedText() || this.targetElement.value;
                if (text) {
                    // تنسيق أساسي للنص العربي
                    const formattedText = this.formatArabicText(text);
                    
                    if (this.hasTextSelection()) {
                        this.replaceSelectedText(formattedText);
                    } else {
                        this.targetElement.value = formattedText;
                        this.targetElement.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                    
                    this.showNotification('تم تنسيق النص', 'success');
                }
            }

            translateText() {
                const text = this.getSelectedText() || this.targetElement.value;
                if (text) {
                    // فتح خدمة ترجمة في نافذة جديدة
                    const encodedText = encodeURIComponent(text);
                    window.open(`https://translate.google.com/?sl=auto&tl=ar&text=${encodedText}`, '_blank');
                    this.showNotification('تم فتح خدمة الترجمة', 'info');
                }
            }

            // دوال مساعدة
            getSelectedText() {
                if (this.targetElement.tagName === 'INPUT' || this.targetElement.tagName === 'TEXTAREA') {
                    const start = this.targetElement.selectionStart;
                    const end = this.targetElement.selectionEnd;
                    return this.targetElement.value.substring(start, end);
                }
                
                return window.getSelection().toString();
            }

            deleteSelectedText() {
                if (this.targetElement.tagName === 'INPUT' || this.targetElement.tagName === 'TEXTAREA') {
                    const start = this.targetElement.selectionStart;
                    const end = this.targetElement.selectionEnd;
                    const value = this.targetElement.value;
                    
                    this.targetElement.value = value.substring(0, start) + value.substring(end);
                    this.targetElement.selectionStart = this.targetElement.selectionEnd = start;
                    this.targetElement.dispatchEvent(new Event('input', { bubbles: true }));
                }
            }

            insertText(text) {
                if (this.targetElement.tagName === 'INPUT' || this.targetElement.tagName === 'TEXTAREA') {
                    const start = this.targetElement.selectionStart;
                    const end = this.targetElement.selectionEnd;
                    const value = this.targetElement.value;
                    
                    this.targetElement.value = value.substring(0, start) + text + value.substring(end);
                    this.targetElement.selectionStart = this.targetElement.selectionEnd = start + text.length;
                    this.targetElement.dispatchEvent(new Event('input', { bubbles: true }));
                } else {
                    document.execCommand('insertText', false, text);
                }
            }

            replaceSelectedText(text) {
                if (this.hasTextSelection()) {
                    this.deleteSelectedText();
                    this.insertText(text);
                }
            }

            formatArabicText(text) {
                return text
                    .replace(/\s+/g, ' ') // توحيد المسافات
                    .replace(/^\s+|\s+$/g, '') // إزالة المسافات من البداية والنهاية
                    .replace(/([,.!?;:])([^\s])/g, '$1 $2') // إضافة مسافة بعد علامات الترقيم
                    .replace(/\s+([,.!?;:])/g, '$1'); // إزالة المسافة قبل علامات الترقيم
            }

            handleKeyDown(event) {
                // إخفاء القائمة عند الضغط على Escape
                if (event.key === 'Escape') {
                    this.hideContextMenu();
                }
            }

            showNotification(message, type = 'info') {
                // استخدام نظام الإشعارات الموجود في التطبيق
                if (window.showNotification) {
                    window.showNotification(message, type);
                } else {
                    // fallback
                    console.log(`${type.toUpperCase()}: ${message}`);
                }
            }
        }

        // تهيئة الأنظمة الجديدة
        const fieldNavigation = new FieldNavigationManager();
        const contextMenu = new ContextMenuManager();

        // إضافة الأنظمة للنطاق العام
        window.fieldNavigation = fieldNavigation;
        window.contextMenu = contextMenu;

        // ========== تحسينات إضافية للنماذج ==========
        function enhanceFormsWithNavigation() {
            // إضافة تلميحات التنقل للنماذج
            const forms = document.querySelectorAll('form, .modal-content, .create-section');
            
            forms.forEach(form => {
                // إضافة مؤشر للنموذج النشط
                form.addEventListener('focusin', () => {
                    form.classList.add('form-active');
                });
                
                form.addEventListener('focusout', () => {
                    setTimeout(() => {
                        if (!form.contains(document.activeElement)) {
                            form.classList.remove('form-active');
                        }
                    }, 100);
                });
                
                // إضافة تلميح التنقل للنموذج
                if (!form.querySelector('.form-navigation-info')) {
                    const info = document.createElement('div');
                    info.className = 'form-navigation-info';
                    info.innerHTML = `
                        <div style="font-size: 12px; color: #6b7280; padding: 8px; background: #f8fafc; border-radius: 4px; margin: 10px 0; border-left: 3px solid var(--primary-blue);">
                            <i class="fas fa-keyboard"></i>
                            <strong>اختصارات لوحة المفاتيح:</strong>
                            Enter للحقل التالي | Alt+Enter للحقل السابق | Esc للخروج | نقر يمين للخيارات
                        </div>
                    `;
                    
                    // إضافة التلميح في بداية النموذج
                    const firstElement = form.querySelector('input, textarea, select, .form-group');
                    if (firstElement && firstElement.parentNode) {
                        firstElement.parentNode.insertBefore(info, firstElement);
                    }
                }
            });
        }

        // تحسين تجربة النماذج المعقدة
        function enhanceComplexForms() {
            // تحسين نموذج إضافة دعوى
            const caseForm = document.getElementById('add-case-form');
            if (caseForm) {
                enhanceFormFieldLogic(caseForm);
            }
            
            // تحسين نموذج إضافة محامي
            const lawyerForm = document.getElementById('add-lawyer-form');
            if (lawyerForm) {
                enhanceFormFieldLogic(lawyerForm);
            }
            
            // تحسين نموذج إضافة استقطاع
            const deductionForm = document.getElementById('add-deduction-form');
            if (deductionForm) {
                enhanceFormFieldLogic(deductionForm);
            }
        }

        function enhanceFormFieldLogic(form) {
            const fields = form.querySelectorAll('input, textarea, select');
            
            fields.forEach((field, index) => {
                // إضافة placeholder محسن
                if (field.placeholder && !field.getAttribute('data-original-placeholder')) {
                    field.setAttribute('data-original-placeholder', field.placeholder);
                    field.placeholder = `${field.placeholder} (${index + 1}/${fields.length})`;
                }
                
                // إضافة تلميح للحقل الحالي
                field.addEventListener('focus', () => {
                    updateFieldHint(field, index + 1, fields.length);
                });
                
                // إضافة validation محسن
                field.addEventListener('blur', () => {
                    validateFieldInput(field);
                });
                
                // تحسين تجربة الأرقام
                if (field.type === 'number') {
                    enhanceNumberField(field);
                }
                
                // تحسين تجربة التواريخ
                if (field.type === 'date') {
                    enhanceDateField(field);
                }
                
                // تحسين تجربة القوائم المنسدلة
                if (field.tagName === 'SELECT') {
                    enhanceSelectField(field);
                }
            });
        }

        function updateFieldHint(field, current, total) {
            // إزالة التلميحات السابقة
            document.querySelectorAll('.current-field-hint').forEach(hint => hint.remove());
            
            // إنشاء تلميح جديد
            const hint = document.createElement('div');
            hint.className = 'current-field-hint field-navigation-hint';
            hint.innerHTML = `
                <i class="fas fa-edit"></i>
                <span>الحقل ${current} من ${total}</span>
                <span style="margin-right: 10px;">
                    <i class="fas fa-arrow-down"></i> Enter للتالي
                </span>
            `;
            
            if (field.parentNode) {
                field.parentNode.insertBefore(hint, field.nextSibling);
                
                // إزالة التلميح بعد 5 ثوان
                setTimeout(() => hint.remove(), 5000);
            }
        }

        function validateFieldInput(field) {
            const value = field.value.trim();
            
            // إزالة رسائل التحقق السابقة
            const existingError = field.parentNode?.querySelector('.field-validation-error');
            if (existingError) {
                existingError.remove();
            }
            
            let errorMessage = '';
            
            // التحقق من الحقول المطلوبة
            if (field.required && !value) {
                errorMessage = 'هذا الحقل مطلوب';
            }
            
            // التحقق من الأرقام
            if (field.type === 'number' && value && isNaN(value)) {
                errorMessage = 'يرجى إدخال رقم صحيح';
            }
            
            // التحقق من الإيميل
            if (field.type === 'email' && value && !isValidEmail(value)) {
                errorMessage = 'يرجى إدخال بريد إلكتروني صحيح';
            }
            
            // التحقق من رقم الهاتف
            if (field.type === 'tel' && value && !isValidPhone(value)) {
                errorMessage = 'يرجى إدخال رقم هاتف صحيح';
            }
            
            // عرض رسالة الخطأ
            if (errorMessage) {
                showFieldError(field, errorMessage);
                field.classList.add('field-error');
            } else {
                field.classList.remove('field-error');
                field.classList.add('field-valid');
                
                // إزالة التأثير بعد ثانية واحدة
                setTimeout(() => {
                    field.classList.remove('field-valid');
                }, 1000);
            }
        }

        function showFieldError(field, message) {
            const error = document.createElement('div');
            error.className = 'field-validation-error';
            error.style.cssText = `
                color: var(--error-red);
                font-size: 12px;
                margin-top: 4px;
                display: flex;
                align-items: center;
                gap: 4px;
            `;
            error.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
            
            if (field.parentNode) {
                field.parentNode.appendChild(error);
                
                // إزالة الرسالة بعد 5 ثوان
                setTimeout(() => error.remove(), 5000);
            }
        }

        function enhanceNumberField(field) {
            // إضافة تنسيق للأرقام العربية
            field.addEventListener('input', () => {
                let value = field.value;
                if (value && !isNaN(value)) {
                    // تنسيق الرقم بالفواصل
                    const formatted = new Intl.NumberFormat('ar-IQ').format(value);
                    
                    // إظهار القيمة المنسقة في تلميح
                    field.title = `القيمة المنسقة: ${formatted}`;
                }
            });
            
            // إضافة أزرار زيادة ونقصان سريعة
            addNumberFieldControls(field);
        }

        function addNumberFieldControls(field) {
            const container = document.createElement('div');
            container.style.cssText = `
                display: flex;
                align-items: center;
                gap: 5px;
                margin-top: 5px;
            `;
            
            const decreaseBtn = document.createElement('button');
            decreaseBtn.type = 'button';
            decreaseBtn.innerHTML = '<i class="fas fa-minus"></i>';
            decreaseBtn.style.cssText = `
                background: var(--error-red);
                color: white;
                border: none;
                border-radius: 3px;
                padding: 4px 8px;
                cursor: pointer;
                font-size: 10px;
            `;
            
            const increaseBtn = document.createElement('button');
            increaseBtn.type = 'button';
            increaseBtn.innerHTML = '<i class="fas fa-plus"></i>';
            increaseBtn.style.cssText = `
                background: var(--success-green);
                color: white;
                border: none;
                border-radius: 3px;
                padding: 4px 8px;
                cursor: pointer;
                font-size: 10px;
            `;
            
            decreaseBtn.addEventListener('click', () => {
                const currentValue = parseInt(field.value) || 0;
                field.value = Math.max(0, currentValue - 1000);
                field.dispatchEvent(new Event('input'));
            });
            
            increaseBtn.addEventListener('click', () => {
                const currentValue = parseInt(field.value) || 0;
                field.value = currentValue + 1000;
                field.dispatchEvent(new Event('input'));
            });
            
            container.appendChild(decreaseBtn);
            container.appendChild(document.createTextNode('1000'));
            container.appendChild(increaseBtn);
            
            if (field.parentNode) {
                field.parentNode.appendChild(container);
            }
        }

        function enhanceDateField(field) {
            // إضافة اختصارات للتواريخ الشائعة
            const shortcuts = document.createElement('div');
            shortcuts.style.cssText = `
                display: flex;
                gap: 5px;
                margin-top: 5px;
                flex-wrap: wrap;
            `;
            
            const dateShortcuts = [
                { label: 'اليوم', value: () => new Date().toISOString().split('T')[0] },
                { label: 'أمس', value: () => {
                    const date = new Date();
                    date.setDate(date.getDate() - 1);
                    return date.toISOString().split('T')[0];
                }},
                { label: 'الأسبوع القادم', value: () => {
                    const date = new Date();
                    date.setDate(date.getDate() + 7);
                    return date.toISOString().split('T')[0];
                }}
            ];
            
            dateShortcuts.forEach(shortcut => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.textContent = shortcut.label;
                btn.style.cssText = `
                    background: var(--primary-blue-light);
                    color: var(--primary-blue);
                    border: 1px solid var(--primary-blue);
                    border-radius: 3px;
                    padding: 2px 6px;
                    cursor: pointer;
                    font-size: 10px;
                `;
                
                btn.addEventListener('click', () => {
                    field.value = shortcut.value();
                    field.dispatchEvent(new Event('input'));
                });
                
                shortcuts.appendChild(btn);
            });
            
            if (field.parentNode) {
                field.parentNode.appendChild(shortcuts);
            }
        }

        function enhanceSelectField(field) {
            // إضافة بحث في القوائم الطويلة
            if (field.options.length > 5) {
                addSearchToSelect(field);
            }
            
            // إضافة إحصائيات للخيارات
            field.addEventListener('change', () => {
                updateSelectStats(field);
            });
        }

        function addSearchToSelect(select) {
            const searchInput = document.createElement('input');
            searchInput.type = 'text';
            searchInput.placeholder = 'البحث في الخيارات...';
            searchInput.style.cssText = `
                width: 100%;
                padding: 5px;
                margin-bottom: 5px;
                border: 1px solid #ddd;
                border-radius: 3px;
                font-size: 12px;
            `;
            
            searchInput.addEventListener('input', () => {
                const query = searchInput.value.toLowerCase();
                Array.from(select.options).forEach(option => {
                    const match = option.text.toLowerCase().includes(query);
                    option.style.display = match ? 'block' : 'none';
                });
            });
            
            if (select.parentNode) {
                select.parentNode.insertBefore(searchInput, select);
            }
        }

        function updateSelectStats(select) {
            const selectedOption = select.options[select.selectedIndex];
            if (selectedOption && selectedOption.value) {
                const stats = document.createElement('div');
                stats.className = 'select-stats';
                stats.style.cssText = `
                    font-size: 11px;
                    color: #6b7280;
                    margin-top: 3px;
                `;
                stats.textContent = `تم اختيار: ${selectedOption.text}`;
                
                // إزالة الإحصائيات السابقة
                const existingStats = select.parentNode?.querySelector('.select-stats');
                if (existingStats) {
                    existingStats.remove();
                }
                
                if (select.parentNode) {
                    select.parentNode.appendChild(stats);
                    
                    // إزالة الإحصائيات بعد 3 ثوان
                    setTimeout(() => stats.remove(), 3000);
                }
            }
        }

        // دوال مساعدة للتحقق
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function isValidPhone(phone) {
            const phoneRegex = /^[\+]?[0-9\s\-\(\)]{10,}$/;
            return phoneRegex.test(phone);
        }

        // تهيئة التحسينات عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', () => {
            enhanceFormsWithNavigation();
            enhanceComplexForms();
        });

        // إعادة تهيئة التحسينات عند فتح النماذج
        function reinitializeFormEnhancements() {
            setTimeout(() => {
                enhanceFormsWithNavigation();
                enhanceComplexForms();
            }, 100);
        }

        // ربط إعادة التهيئة بفتح النماذج
        const originalShowModal = window.showModal;
        if (originalShowModal) {
            window.showModal = function(...args) {
                const result = originalShowModal.apply(this, args);
                reinitializeFormEnhancements();
                return result;
            };
        }

        // إضافة CSS للتحسينات الجديدة
        const enhancementStyles = document.createElement('style');
        enhancementStyles.textContent = `
            .form-active {
                box-shadow: 0 0 10px rgba(59, 130, 246, 0.2);
                border-radius: 8px;
            }
            
            .field-error {
                border-color: var(--error-red) !important;
                box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.1) !important;
            }
            
            .field-valid {
                border-color: var(--success-green) !important;
                box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.1) !important;
            }
            
            .form-navigation-info {
                transition: all 0.3s ease;
            }
            
            .current-field-hint {
                background: linear-gradient(135deg, var(--primary-blue-light), #ffffff);
                border: 1px solid var(--primary-blue);
                animation: fadeInSlide 0.3s ease;
            }
            
            @keyframes fadeInSlide {
                from {
                    opacity: 0;
                    transform: translateY(-10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
        `;
        document.head.appendChild(enhancementStyles);

        // ========== تفعيل النظام للعناصر الديناميكية ==========
        function initializeEnhancementsForDynamicContent() {
            // مراقب للعناصر الجديدة
            const dynamicObserver = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    mutation.addedNodes.forEach((node) => {
                        if (node.nodeType === Node.ELEMENT_NODE) {
                            // تفعيل التحسينات للعناصر الجديدة
                            enhanceDynamicElement(node);
                        }
                    });
                });
            });

            dynamicObserver.observe(document.body, {
                childList: true,
                subtree: true
            });
        }

        function enhanceDynamicElement(element) {
            // تحسين الحقول الجديدة
            const newFields = element.querySelectorAll('input, textarea, select');
            newFields.forEach(field => {
                enhanceIndividualField(field);
            });

            // تحسين النماذج الجديدة
            const newForms = element.querySelectorAll('form, .modal-content');
            newForms.forEach(form => {
                enhanceFormFieldLogic(form);
            });
        }

        function enhanceIndividualField(field) {
            // منع التحسين المتكرر
            if (field.hasAttribute('data-enhanced')) return;
            field.setAttribute('data-enhanced', 'true');

            // إضافة تحسينات حسب نوع الحقل
            switch (field.type) {
                case 'text':
                case 'email':
                case 'password':
                case 'tel':
                    enhanceTextInput(field);
                    break;
                case 'number':
                    enhanceNumberInput(field);
                    break;
                case 'date':
                    enhanceDateInput(field);
                    break;
            }

            if (field.tagName === 'TEXTAREA') {
                enhanceTextArea(field);
            }

            if (field.tagName === 'SELECT') {
                enhanceSelectInput(field);
            }

            // إضافة مستمعي الأحداث الأساسية
            addBasicFieldEnhancements(field);
        }

        function enhanceTextInput(field) {
            // إضافة اقتراحات ذكية
            addSmartSuggestions(field);
            
            // إضافة تنسيق تلقائي
            addAutoFormatting(field);
        }

        function enhanceNumberInput(field) {
            // إضافة تنسيق الأرقام
            field.addEventListener('input', () => {
                formatNumberInput(field);
            });

            // إضافة أزرار التحكم
            if (!field.parentNode.querySelector('.number-controls')) {
                addNumberControls(field);
            }
        }

        function enhanceDateInput(field) {
            // إضافة اختصارات التاريخ
            if (!field.parentNode.querySelector('.date-shortcuts')) {
                addDateShortcuts(field);
            }
        }

        function enhanceTextArea(field) {
            // إضافة عداد الأحرف
            addCharacterCounter(field);
            
            // إضافة تغيير الحجم التلقائي
            addAutoResize(field);
        }

        function enhanceSelectInput(field) {
            // إضافة بحث للقوائم الطويلة
            if (field.options.length > 10) {
                addSelectSearch(field);
            }
        }

        function addBasicFieldEnhancements(field) {
            // مؤشر التركيز المحسن
            field.addEventListener('focus', () => {
                addFocusIndicator(field);
            });

            field.addEventListener('blur', () => {
                removeFocusIndicator(field);
            });

            // تلميحات التنقل
            field.addEventListener('keydown', (e) => {
                if (e.key === 'F1') {
                    e.preventDefault();
                    showFieldHelp(field);
                }
            });
        }

        function addSmartSuggestions(field) {
            const suggestions = getSuggestionsForField(field);
            if (suggestions.length === 0) return;

            const suggestionContainer = document.createElement('div');
            suggestionContainer.className = 'smart-field-suggestions';
            
            field.parentNode.style.position = 'relative';
            field.parentNode.appendChild(suggestionContainer);

            field.addEventListener('input', () => {
                updateSuggestions(field, suggestionContainer, suggestions);
            });

            field.addEventListener('blur', () => {
                setTimeout(() => {
                    suggestionContainer.style.display = 'none';
                }, 200);
            });
        }

        function getSuggestionsForField(field) {
            const fieldName = field.name || field.id || '';
            const placeholder = field.placeholder || '';
            
            // اقتراحات حسب نوع الحقل
            if (fieldName.includes('name') || placeholder.includes('اسم')) {
                return ['أحمد محمد', 'فاطمة علي', 'محمد حسن', 'زينب أحمد'];
            }
            
            if (fieldName.includes('court') || placeholder.includes('محكمة')) {
                return ['محكمة بداءة بغداد', 'محكمة الأحوال الشخصية', 'محكمة التمييز', 'محكمة الاستئناف'];
            }
            
            if (fieldName.includes('city') || placeholder.includes('مدينة')) {
                return ['بغداد', 'البصرة', 'الموصل', 'أربيل', 'النجف', 'كربلاء'];
            }
            
            return [];
        }

        function updateSuggestions(field, container, suggestions) {
            const value = field.value.toLowerCase();
            if (value.length < 2) {
                container.style.display = 'none';
                return;
            }

            const filteredSuggestions = suggestions.filter(suggestion => 
                suggestion.toLowerCase().includes(value)
            );

            if (filteredSuggestions.length === 0) {
                container.style.display = 'none';
                return;
            }

            container.innerHTML = filteredSuggestions.map(suggestion => 
                `<div class="smart-suggestion-item" onclick="selectSuggestion('${field.id}', '${suggestion}')">${suggestion}</div>`
            ).join('');

            container.style.display = 'block';
        }

        function selectSuggestion(fieldId, value) {
            const field = document.getElementById(fieldId);
            if (field) {
                field.value = value;
                field.dispatchEvent(new Event('input', { bubbles: true }));
                field.focus();
            }
        }

        function addAutoFormatting(field) {
            if (field.type === 'tel') {
                field.addEventListener('input', () => {
                    formatPhoneNumber(field);
                });
            }

            if (field.type === 'email') {
                field.addEventListener('blur', () => {
                    formatEmail(field);
                });
            }
        }

        function formatPhoneNumber(field) {
            let value = field.value.replace(/\D/g, '');
            if (value.length >= 10) {
                value = value.replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3');
            }
            field.value = value;
        }

        function formatEmail(field) {
            field.value = field.value.toLowerCase().trim();
        }

        function formatNumberInput(field) {
            const value = field.value;
            if (value && !isNaN(value)) {
                const formatted = new Intl.NumberFormat('ar-IQ').format(value);
                field.setAttribute('data-formatted', formatted);
                field.title = `القيمة المنسقة: ${formatted}`;
            }
        }

        function addNumberControls(field) {
            const container = document.createElement('div');
            container.className = 'number-controls field-action-buttons';
            container.innerHTML = `
                <button type="button" class="field-action-btn" onclick="adjustNumber('${field.id}', -1000)">
                    <i class="fas fa-minus"></i> 1K
                </button>
                <button type="button" class="field-action-btn" onclick="adjustNumber('${field.id}', -100)">
                    <i class="fas fa-minus"></i> 100
                </button>
                <button type="button" class="field-action-btn" onclick="adjustNumber('${field.id}', 100)">
                    <i class="fas fa-plus"></i> 100
                </button>
                <button type="button" class="field-action-btn" onclick="adjustNumber('${field.id}', 1000)">
                    <i class="fas fa-plus"></i> 1K
                </button>
            `;
            
            field.parentNode.appendChild(container);
        }

        function adjustNumber(fieldId, amount) {
            const field = document.getElementById(fieldId);
            if (field) {
                const currentValue = parseInt(field.value) || 0;
                field.value = Math.max(0, currentValue + amount);
                field.dispatchEvent(new Event('input', { bubbles: true }));
            }
        }

        function addDateShortcuts(field) {
            const container = document.createElement('div');
            container.className = 'date-shortcuts field-action-buttons';
            container.innerHTML = `
                <button type="button" class="field-action-btn" onclick="setDate('${field.id}', 'today')">
                    اليوم
                </button>
                <button type="button" class="field-action-btn" onclick="setDate('${field.id}', 'tomorrow')">
                    غداً
                </button>
                <button type="button" class="field-action-btn" onclick="setDate('${field.id}', 'next-week')">
                    الأسبوع القادم
                </button>
            `;
            
            field.parentNode.appendChild(container);
        }

        function setDate(fieldId, type) {
            const field = document.getElementById(fieldId);
            if (!field) return;

            const date = new Date();
            
            switch (type) {
                case 'today':
                    break;
                case 'tomorrow':
                    date.setDate(date.getDate() + 1);
                    break;
                case 'next-week':
                    date.setDate(date.getDate() + 7);
                    break;
            }
            
            field.value = date.toISOString().split('T')[0];
            field.dispatchEvent(new Event('input', { bubbles: true }));
        }

        function addCharacterCounter(field) {
            const counter = document.createElement('div');
            counter.className = 'character-counter field-counter';
            counter.style.cssText = 'text-align: left; margin-top: 5px;';
            
            const updateCounter = () => {
                const length = field.value.length;
                const maxLength = field.maxLength || 1000;
                counter.textContent = `${length}/${maxLength}`;
                
                if (length > maxLength * 0.9) {
                    counter.style.color = 'var(--error-red)';
                } else if (length > maxLength * 0.7) {
                    counter.style.color = 'var(--warning-yellow)';
                } else {
                    counter.style.color = '#6b7280';
                }
            };
            
            field.addEventListener('input', updateCounter);
            updateCounter();
            
            field.parentNode.appendChild(counter);
        }

        function addAutoResize(field) {
            const resize = () => {
                field.style.height = 'auto';
                field.style.height = field.scrollHeight + 'px';
            };
            
            field.addEventListener('input', resize);
            resize();
        }

        function addSelectSearch(field) {
            const search = document.createElement('input');
            search.type = 'text';
            search.placeholder = 'البحث...';
            search.className = 'select-search';
            search.style.cssText = `
                width: 100%;
                padding: 5px;
                margin-bottom: 5px;
                border: 1px solid #d1d5db;
                border-radius: 4px;
                font-size: 12px;
            `;
            
            search.addEventListener('input', () => {
                const query = search.value.toLowerCase();
                Array.from(field.options).forEach(option => {
                    option.style.display = option.text.toLowerCase().includes(query) ? '' : 'none';
                });
            });
            
            field.parentNode.insertBefore(search, field);
        }

        function addFocusIndicator(field) {
            field.classList.add('enhanced-focus');
            
            // إضافة تلميح التنقل
            showNavigationHint(field);
        }

        function removeFocusIndicator(field) {
            field.classList.remove('enhanced-focus');
        }

        function showNavigationHint(field) {
            if (field.hasAttribute('data-hint-shown')) return;
            field.setAttribute('data-hint-shown', 'true');
            
            const hint = document.createElement('div');
            hint.className = 'navigation-hint';
            hint.innerHTML = `
                <span class="keyboard-shortcut-hint">Enter: التالي</span>
                <span class="keyboard-shortcut-hint">Alt+Enter: السابق</span>
                <span class="keyboard-shortcut-hint">F1: مساعدة</span>
            `;
            hint.style.cssText = `
                position: absolute;
                top: -30px;
                right: 0;
                display: flex;
                gap: 5px;
                z-index: 1000;
            `;
            
            field.parentNode.style.position = 'relative';
            field.parentNode.appendChild(hint);
            
            setTimeout(() => {
                hint.remove();
                field.removeAttribute('data-hint-shown');
            }, 3000);
        }

        function showFieldHelp(field) {
            const help = getFieldHelp(field);
            if (help) {
                alert(help);
            }
        }

        function getFieldHelp(field) {
            const fieldName = field.name || field.id || '';
            const placeholder = field.placeholder || '';
            
            if (fieldName.includes('name') || placeholder.includes('اسم')) {
                return 'أدخل الاسم الكامل كما هو مكتوب في الوثائق الرسمية';
            }
            
            if (fieldName.includes('amount') || placeholder.includes('مبلغ')) {
                return 'أدخل المبلغ بالدينار العراقي بدون فواصل. سيتم تنسيقه تلقائياً';
            }
            
            if (fieldName.includes('date') || field.type === 'date') {
                return 'اختر التاريخ أو استخدم الاختصارات السريعة';
            }
            
            return 'استخدم Enter للانتقال للحقل التالي، أو Alt+Enter للحقل السابق';
        }

        // تهيئة النظام للمحتوى الديناميكي
        initializeEnhancementsForDynamicContent();

        // إضافة أحداث لتفعيل النظام مع النماذج الجديدة
        document.addEventListener('modal-opened', reinitializeFormEnhancements);
        document.addEventListener('tab-changed', reinitializeFormEnhancements);

        // تصدير الوظائف للاستخدام العام
        window.enhanceForm = enhanceFormFieldLogic;
        window.enhanceField = enhanceIndividualField;
        window.selectSuggestion = selectSuggestion;
        window.adjustNumber = adjustNumber;
        window.setDate = setDate;

        // مراقب التحديثات من تطبيق المحامي
        class LawyerUpdatesMonitor {
            constructor() {
                this.setupUpdatesListener();
            }

            setupUpdatesListener() {
                // مراقبة التحديثات من تطبيق المحامي
                database.ref('system/updates').on('child_added', (snapshot) => {
                    const update = snapshot.val();
                    if (update && update.source === 'mobile_app') {
                        this.handleLawyerUpdate(update, snapshot.key);
                    }
                });

                // مراقبة التحديثات المباشرة على الدعاوى
                database.ref('data/cases').on('child_changed', (snapshot) => {
                    const caseData = snapshot.val();
                    if (caseData && caseData.updatedFrom === 'mobile_app') {
                        this.handleDirectCaseUpdate(caseData, snapshot.key);
                    }
                });

                // مراقبة تحديثات النظام العامة
                database.ref('system/lastUpdate').on('value', (snapshot) => {
                    const lastUpdate = snapshot.val();
                    if (lastUpdate && lastUpdate.source === 'mobile_app') {
                        this.refreshDataIfNeeded(lastUpdate);
                    }
                });
            }

            handleLawyerUpdate(update, updateKey) {
                console.log('🔄 تحديث من تطبيق المحامي:', update);
                
                switch (update.type) {
                    case 'case_status_update':
                        this.handleCaseStatusUpdate(update);
                        // إضافة إشعار للإدارة
                        this.addAdminNotification(update);
                        break;
                    case 'deduction_added':
                        this.handleDeductionAdded(update);
                        // إضافة إشعار للإدارة
                        this.addAdminNotification(update);
                        break;
                }

                // حذف الإشعار بعد المعالجة
                database.ref(`system/updates/${updateKey}`).remove().catch(() => {});
            }

            handleCaseStatusUpdate(update) {
                console.log('معالجة تحديث الحالة من المحامي:', update);
                
                // البحث عن الدعوى وتحديثها في البيانات المحلية
                const caseIndex = dataManager.casesData.findIndex(c => 
                    c.caseNumber === update.caseNumber || 
                    c.id === update.caseId
                );

                if (caseIndex >= 0) {
                    const caseItem = dataManager.casesData[caseIndex];
                    const actualCaseId = caseItem.id || caseItem.firebaseId || update.caseId;
                    
                    // تحديث البيانات المحلية
                    caseItem.status = update.newStatus;
                    caseItem.stage = update.newStage;
                    caseItem.lastModified = update.timestamp;
                    caseItem.updatedBy = update.lawyerName;
                    caseItem.updatedFrom = 'mobile_app';

                    // إضافة إلى الجدول الزمني
                    if (!caseItem.timeline) {
                        caseItem.timeline = [];
                    }
                    caseItem.timeline.push({
                        date: new Date(update.timestamp).toISOString().split('T')[0],
                        title: `تحديث من المحامي: ${update.lawyerName}`,
                        desc: `الحالة: ${update.newStatus} | المرحلة: ${update.newStage}${update.notes ? ` - ${update.notes}` : ''}`,
                        type: 'blue'
                    });

                    // حفظ التحديثات في Firebase للحفاظ على الثبات
                    const updateData = {
                        status: update.newStatus,
                        stage: update.newStage,
                        lastModified: update.timestamp,
                        updatedBy: update.lawyerName,
                        updatedFrom: 'mobile_app',
                        timeline: caseItem.timeline
                    };

                    // تحديث في كلا مسارين Firebase
                    Promise.all([
                        // التحديث في المسار الرئيسي
                        database.ref(`data/cases/${caseIndex}`).update(updateData).catch(() => {}),
                        // التحديث في المسار البديل
                        database.ref(`cases/${actualCaseId}`).update(updateData).catch(() => {})
                    ]).then(() => {
                        console.log('تم حفظ التحديث في Firebase بنجاح');
                        // حفظ محلياً
                        dataManager.saveData();
                    }).catch(error => {
                        console.error('خطأ في حفظ التحديث في Firebase:', error);
                    });

                    // تحديث العرض
                    this.refreshUI();

                    // إظهار إشعار
                    showNotification(
                        '🔄 تحديث من المحامي',
                        `المحامي ${update.lawyerName} قام بتحديث الدعوى ${update.caseNumber}\n📊 الحالة: ${update.newStatus}\n🎯 المرحلة: ${update.newStage}`,
                        'info'
                    );
                } else {
                    console.warn('لم يتم العثور على الدعوى للتحديث:', update.caseNumber);
                }
            }

            handleDeductionAdded(update) {
                // تحديث بيانات الاستقطاعات - البيانات تتحدث تلقائياً من Firebase
                this.refreshUI();

                showNotification(
                    '💰 استقطاع جديد',
                    `المحامي ${update.lawyerName} أضاف استقطاع جديد للدعوى ${update.caseNumber}`,
                    'success'
                );
            }

            addAdminNotification(update) {
                let notificationTitle = '';
                let notificationMessage = '';
                let notificationType = 'info';

                switch (update.type) {
                    case 'case_status_update':
                        notificationTitle = '🔄 تحديث حالة الدعوى';
                        notificationMessage = `المحامي ${update.lawyerName} قام بتحديث:\n📋 الدعوى: ${update.caseNumber}\n📊 الحالة: ${update.newStatus}\n🎯 المرحلة: ${update.newStage}`;
                        notificationType = 'info';
                        break;
                    case 'deduction_added':
                        notificationTitle = '💰 استقطاع جديد';
                        notificationMessage = `المحامي ${update.lawyerName} أضاف استقطاع للدعوى ${update.caseNumber}`;
                        notificationType = 'success';
                        break;
                }

                // إضافة إشعار للنظام الرئيسي
                if (window.notificationManager) {
                    const adminNotification = {
                        id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                        title: notificationTitle,
                        message: notificationMessage,
                        type: notificationType,
                        timestamp: new Date().toISOString(),
                        read: false,
                        source: 'lawyer_update',
                        caseId: update.caseId,
                        caseNumber: update.caseNumber,
                        lawyerName: update.lawyerName,
                        action: () => {
                            // التوجه إلى الدعوى عند النقر على الإشعار
                            if (update.caseId) {
                                showCaseDetails(update.caseId);
                            } else {
                                showTab('cases');
                            }
                        }
                    };

                    window.notificationManager.addNotification(adminNotification);
                }

                // إظهار إشعار منبثق فوري
                showNotification(notificationTitle, notificationMessage, notificationType, true);
                
                // تشغيل صوت تنبيه (إذا كان متاحاً)
                this.playNotificationSound();
            }

            playNotificationSound() {
                try {
                    // إنشاء صوت تنبيه بسيط
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                    oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);
                    
                    gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime + 0.01);
                    gainNode.gain.setValueAtTime(0, audioContext.currentTime + 0.2);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.2);
                } catch (error) {
                    console.log('لا يمكن تشغيل الصوت:', error);
                }
            }

            handleDirectCaseUpdate(caseData, caseKey) {
                console.log('🔄 تحديث مباشر على الدعوى من المحامي:', caseData.caseNumber);
                
                // تحديث البيانات المحلية
                const caseIndex = dataManager.casesData.findIndex(c => 
                    c.caseNumber === caseData.caseNumber || 
                    c.id === caseKey
                );

                if (caseIndex >= 0) {
                    Object.assign(dataManager.casesData[caseIndex], caseData);
                    dataManager.saveData();
                }

                // إنشاء إشعار للإدارة
                const adminNotification = {
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                    title: '🔄 تحديث مباشر من المحامي',
                    message: `المحامي ${caseData.lawyerName} قام بتحديث الدعوى ${caseData.caseNumber}\nالحالة: ${caseData.status}\nالمرحلة: ${caseData.stage}`,
                    type: 'info',
                    timestamp: new Date().toISOString(),
                    read: false,
                    source: 'direct_case_update',
                    caseId: caseKey,
                    caseNumber: caseData.caseNumber,
                    lawyerName: caseData.lawyerName,
                    action: () => {
                        showCaseDetails(caseKey);
                    }
                };

                if (window.notificationManager) {
                    window.notificationManager.addNotification(adminNotification);
                }

                // تحديث العرض
                this.refreshUI();

                // إظهار إشعار منبثق
                showNotification(
                    '🔔 تحديث فوري',
                    `المحامي ${caseData.lawyerName} حدث الدعوى ${caseData.caseNumber}`,
                    'info'
                );

                // تشغيل صوت تنبيه
                this.playNotificationSound();
            }

            refreshDataIfNeeded(lastUpdate) {
                if (lastUpdate.action === 'status_stage_update' || lastUpdate.action === 'deduction_added') {
                    // البيانات تتحدث تلقائياً من Firebase - نحتاج فقط لتحديث الواجهة
                    setTimeout(() => {
                        this.refreshUI();
                    }, 1000);
                }
            }

            refreshUI() {
                // تحديث جميع الجداول والإحصائيات
                renderCasesTable();
                updateDashboardStats();
                renderDeductionsTable();
                
                // تحديث تفاصيل الدعوى إذا كانت مفتوحة
                const currentCaseContent = document.getElementById('case-details-content');
                if (currentCaseContent && !currentCaseContent.classList.contains('hidden')) {
                    const caseId = dataManager.currentCaseId;
                    if (caseId) {
                        showCaseDetails(caseId);
                    }
                }
            }
        }

        // إنشاء مثيل من مراقب التحديثات
        const lawyerUpdatesMonitor = new LawyerUpdatesMonitor();

        // دالة التحقق من التحديثات المعلقة
        function checkPendingUpdates() {
            database.ref('system/updates').once('value', (snapshot) => {
                const updates = snapshot.val();
                if (updates) {
                    Object.entries(updates).forEach(([key, update]) => {
                        if (update.source === 'mobile_app') {
                            lawyerUpdatesMonitor.handleLawyerUpdate(update, key);
                        }
                    });
                }
            });
        }

        // تشغيل فحص التحديثات المعلقة عند بدء التطبيق
        setTimeout(checkPendingUpdates, 2000);

        // Local Storage Management
        class LocalStorage {
            static save(key, data) {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                    return true;
                } catch (error) {
                    console.error('خطأ في حفظ البيانات:', error);
                    return false;
                }
            }

            static load(key, defaultValue = null) {
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : defaultValue;
                } catch (error) {
                    console.error('خطأ في تحميل البيانات:', error);
                    return defaultValue;
                }
            }

            static remove(key) {
                try {
                    localStorage.removeItem(key);
                    return true;
                } catch (error) {
                    console.error('خطأ في حذف البيانات:', error);
                    return false;
                }
            }

            static clear() {
                try {
                    localStorage.clear();
                    return true;
                } catch (error) {
                    console.error('خطأ في مسح البيانات:', error);
                    return false;
                }
            }
        }

        // Application Data Management
        class DataManager {
            constructor() {
                // Ensure arrays are properly initialized
                this.casesData = this.ensureArray(LocalStorage.load('casesData', []));
                this.defendantsData = this.ensureArray(LocalStorage.load('defendantsData', []));
                this.lawyersData = this.ensureArray(LocalStorage.load('lawyersData', []));
                this.deductionsData = this.ensureArray(LocalStorage.load('deductionsData', []));
                this.notificationsData = this.ensureArray(LocalStorage.load('notificationsData', []));
                this.settingsData = LocalStorage.load('settingsData', this.getDefaultSettings()) || this.getDefaultSettings();
                this.chatData = this.ensureArray(LocalStorage.load('chatData', []));
                this.activeLawyers = this.ensureArray(LocalStorage.load('activeLawyers', []));
                
                // قوائم العناصر المحذوفة - لمنع إعادة إضافتها من Firebase
                this.deletedItems = {
                    cases: this.ensureArray(LocalStorage.load('deletedCases', [])),
                    defendants: this.ensureArray(LocalStorage.load('deletedDefendants', [])),
                    lawyers: this.ensureArray(LocalStorage.load('deletedLawyers', [])),
                    deductions: this.ensureArray(LocalStorage.load('deletedDeductions', []))
                };
                
                this.filteredCases = [...this.casesData];
                this.filteredDefendants = [...this.defendantsData];
                this.filteredLawyers = [...this.lawyersData];
                this.filteredDeductions = [...this.deductionsData];
                
                this.currentCase = null;
                this.uploadedFiles = [];
                
                // Firebase integration
                this.realtimeListeners = {};
                this.isUpdatingLocally = false; // علم لتجنب التحديثات المتضاربة
                this.lastDeleteTime = {}; // تتبع آخر وقت حذف لكل نوع بيانات
                
                // تحميل البيانات من Firebase وإعداد المستمعين
                this.initializeFirebaseIntegration();
            }

            async initializeFirebaseIntegration() {
                // انتظار قليل للتأكد من اتصال Firebase
                setTimeout(async () => {
                    try {
                        // تحميل البيانات من Firebase أولاً
                        await this.loadDataFromFirebase();
                        
                        // إعداد المستمعين للتحديثات في الوقت الفعلي
                        this.setupRealtimeListeners();
                        
                        // إذا لم توجد بيانات في Firebase ولكن توجد بيانات محلية، رفعها
                        setTimeout(async () => {
                            const hasLocalData = this.casesData.length > 0 || this.defendantsData.length > 0 || 
                                                this.lawyersData.length > 0 || this.deductionsData.length > 0;
                            
                            if (hasLocalData && firebaseSync.isFirebaseConnected) {
                                console.log('فحص إذا كانت البيانات المحلية تحتاج للرفع إلى Firebase...');
                                const uploadResult = await this.uploadExistingDataToFirebase();
                                if (uploadResult) {
                                    console.log('تم رفع البيانات المحلية إلى Firebase');
                                }
                            }
                        }, 5000); // انتظار 5 ثوانٍ للتأكد من اكتمال التحميل
                        
                        console.log('تم دمج Firebase بنجاح');
                    } catch (error) {
                        console.error('خطأ في دمج Firebase:', error);
                        console.log('سيتم العمل مع البيانات المحلية فقط');
                    }
                }, 2000);
            }

            async loadDataFromFirebase() {
                if (!firebaseSync.isFirebaseConnected) {
                    console.log('غير متصل بـ Firebase - استخدام البيانات المحلية');
                    return;
                }

                try {
                    console.log('جاري تحميل البيانات من Firebase...');
                    
                    const [cases, defendants, lawyers, deductions] = await Promise.all([
                        firebaseSync.loadFromFirebase('cases').catch(() => []),
                        firebaseSync.loadFromFirebase('defendants').catch(() => []),
                        firebaseSync.loadFromFirebase('lawyers').catch(() => []),
                        firebaseSync.loadFromFirebase('deductions').catch(() => [])
                    ]);

                    // دمج البيانات من Firebase مع البيانات المحلية
                    this.mergeDataFromFirebase(cases, defendants, lawyers, deductions);
                    
                    // حفظ البيانات المدمجة محلياً
                    this.saveData();
                    
                    // تحديث واجهة المستخدم
                    this.updateAllUI();
                    
                    console.log('تم تحميل ودمج البيانات من Firebase بنجاح');
                } catch (error) {
                    console.error('خطأ في تحميل البيانات من Firebase:', error);
                }
            }

            mergeDataFromFirebase(cases, defendants, lawyers, deductions) {
                console.log('دمج البيانات من Firebase...');
                console.log('Firebase - الدعاوى:', cases.length, 'المدعى عليهم:', defendants.length, 'المحامين:', lawyers.length, 'الاستقطاعات:', deductions.length);
                console.log('محلياً - الدعاوى:', this.casesData.length, 'المدعى عليهم:', this.defendantsData.length, 'المحامين:', this.lawyersData.length, 'الاستقطاعات:', this.deductionsData.length);
                
                // دمج البيانات مع تجاهل العناصر المحذوفة
                if (cases && cases.length > 0) {
                    this.mergeArrayWithDeletedFilter(this.casesData, cases, 'cases');
                }
                
                if (defendants && defendants.length > 0) {
                    this.mergeArrayWithDeletedFilter(this.defendantsData, defendants, 'defendants');
                }
                
                if (lawyers && lawyers.length > 0) {
                    this.mergeArrayWithDeletedFilter(this.lawyersData, lawyers, 'lawyers');
                }
                
                if (deductions && deductions.length > 0) {
                    this.mergeArrayWithDeletedFilter(this.deductionsData, deductions, 'deductions');
                }
                
                // تحديث المصفوفات المفلترة
                this.filteredCases = [...this.casesData];
                this.filteredDefendants = [...this.defendantsData];
                this.filteredLawyers = [...this.lawyersData];
                this.filteredDeductions = [...this.deductionsData];
                
                console.log('بعد الدمج - الدعاوى:', this.casesData.length, 'المدعى عليهم:', this.defendantsData.length, 'المحامين:', this.lawyersData.length, 'الاستقطاعات:', this.deductionsData.length);
            }

            mergeArrayWithDeletedFilter(localArray, firebaseArray, type) {
                const deletedIds = this.deletedItems[type] || [];
                
                firebaseArray.forEach(firebaseItem => {
                    // تجاهل العناصر المحذوفة
                    if (deletedIds.includes(firebaseItem.id)) {
                        console.log(`تجاهل عنصر محذوف من ${type}:`, firebaseItem.id);
                        return;
                    }
                    
                    const existingIndex = localArray.findIndex(localItem => localItem.id === firebaseItem.id);
                    
                    if (existingIndex === -1) {
                        // عنصر جديد من Firebase - إضافته
                        localArray.push(firebaseItem);
                        console.log(`إضافة عنصر جديد من Firebase في ${type}:`, firebaseItem.id);
                    } else {
                        // عنصر موجود - تحديثه إذا كانت النسخة من Firebase أحدث
                        const localItem = localArray[existingIndex];
                        const firebaseTime = new Date(firebaseItem.lastModified || firebaseItem.createdAt || 0);
                        const localTime = new Date(localItem.lastModified || localItem.createdAt || 0);
                        
                        if (firebaseTime > localTime) {
                            localArray[existingIndex] = firebaseItem;
                            console.log(`تحديث عنصر من Firebase في ${type}:`, firebaseItem.id);
                        }
                    }
                });
            }

            mergeArray(localArray, firebaseArray) {
                firebaseArray.forEach(firebaseItem => {
                    const existingIndex = localArray.findIndex(localItem => localItem.id === firebaseItem.id);
                    
                    if (existingIndex === -1) {
                        // عنصر جديد من Firebase - إضافته
                        localArray.push(firebaseItem);
                    } else {
                        // عنصر موجود - تحديثه إذا كان أحدث
                        const localItem = localArray[existingIndex];
                        const firebaseModified = new Date(firebaseItem.lastModified || 0);
                        const localModified = new Date(localItem.lastModified || 0);
                        
                        if (firebaseModified > localModified) {
                            localArray[existingIndex] = firebaseItem;
                        }
                    }
                });
            }

            setupRealtimeListeners() {
                if (!firebaseSync.isFirebaseConnected) {
                    return;
                }

                // مستمع الدعاوى
                this.realtimeListeners.cases = firebaseSync.setupRealtimeListener('cases', (data) => {
                    this.handleRealtimeUpdate('cases', data);
                });

                // مستمع المدعى عليهم
                this.realtimeListeners.defendants = firebaseSync.setupRealtimeListener('defendants', (data) => {
                    this.handleRealtimeUpdate('defendants', data);
                });

                // مستمع المحامين
                this.realtimeListeners.lawyers = firebaseSync.setupRealtimeListener('lawyers', (data) => {
                    this.handleRealtimeUpdate('lawyers', data);
                });

                // مستمع الاستقطاعات
                this.realtimeListeners.deductions = firebaseSync.setupRealtimeListener('deductions', (data) => {
                    this.handleRealtimeUpdate('deductions', data);
                });

                // مستمع الاستقطاعات من المسار الجديد
                this.realtimeListeners.dataDeductions = firebaseSync.setupRealtimeListener('data/deductions', (data) => {
                    this.handleRealtimeUpdate('deductions', data);
                });

                // مستمع الإشعارات
                this.realtimeListeners.notifications = firebaseSync.setupRealtimeListener('notifications', (data) => {
                    this.handleRealtimeUpdate('notifications', data);
                });

                // مستمع تحديثات النظام من التطبيق المحمول
                this.realtimeListeners.systemUpdates = firebaseSync.setupRealtimeListener('system/lastUpdate', (data) => {
                    if (data && data.source === 'mobile_app') {
                        console.log('تحديث من التطبيق المحمول، جاري إعادة تحميل البيانات...');
                        setTimeout(() => {
                            this.refreshAllData();
                        }, 1000);
                    }
                });

                console.log('تم إعداد مستمعي Firebase للتحديثات في الوقت الفعلي مع تصفية المحذوفات');
            }

            handleRealtimeUpdate(collection, data) {
                const collectionMap = {
                    'cases': 'casesData',
                    'defendants': 'defendantsData',
                    'lawyers': 'lawyersData',
                    'deductions': 'deductionsData',
                    'notifications': 'notificationsData',
                    'chat': 'chatData',
                    'activeLawyers': 'activeLawyers'
                };

                const localCollection = collectionMap[collection];
                if (!localCollection) return;

                // تجنب التحديث المكرر أثناء العمليات المحلية
                if (this.isUpdatingLocally) {
                    console.log(`تجاهل التحديث الفوري لـ ${collection} أثناء العملية المحلية`);
                    return;
                }

                // تجاهل التحديثات لمدة 5 ثوانٍ بعد الحذف
                const lastDelete = this.lastDeleteTime[collection];
                if (lastDelete && (Date.now() - lastDelete) < 5000) {
                    console.log(`تجاهل التحديث الفوري لـ ${collection} بعد الحذف الأخير`);
                    return;
                }

                // Handle different data formats (array vs object)
                let processedData = [];
                if (data) {
                    if (Array.isArray(data)) {
                        processedData = data.filter(item => item !== null && item !== undefined);
                    } else {
                        processedData = Object.values(data).filter(item => item !== null && item !== undefined);
                    }
                }

                console.log(`تحديث فوري لـ ${collection}:`, processedData.length, 'عنصر قبل التصفية');

                // تصفية العناصر المحذوفة من البيانات الواردة من Firebase
                const deletedIds = this.deletedItems[collection] || [];
                const filteredData = processedData.filter(item => {
                    const isDeleted = deletedIds.includes(item.id);
                    if (isDeleted) {
                        console.log(`تجاهل عنصر محذوف من ${collection}:`, item.id);
                    }
                    return !isDeleted;
                });

                console.log(`بعد التصفية لـ ${collection}:`, filteredData.length, 'عنصر');

                // Update local data with filtered data
                this[localCollection] = filteredData;

                // Update filtered arrays
                const filteredCollectionMap = {
                    'casesData': 'filteredCases',
                    'defendantsData': 'filteredDefendants',
                    'lawyersData': 'filteredLawyers',
                    'deductionsData': 'filteredDeductions'
                };

                const filteredArray = filteredCollectionMap[localCollection];
                if (filteredArray) {
                    this[filteredArray] = [...this[localCollection]];
                }

                // Update UI if needed
                this.updateUIAfterDataChange(collection);

                // Save updated data
                this.saveData();

                console.log(`تم تحديث ${collection} من Firebase مع تجاهل المحذوفات`);
            }

            updateUIAfterDataChange(collection) {
                // Update specific UI components based on the data type
                switch (collection) {
                    case 'cases':
                        if (typeof renderCasesTable === 'function') renderCasesTable();
                        if (typeof updateDashboardStats === 'function') updateDashboardStats();
                        break;
                    case 'defendants':
                        if (typeof renderDefendantsTable === 'function') renderDefendantsTable();
                        break;
                    case 'lawyers':
                        if (typeof renderLawyersTable === 'function') renderLawyersTable();
                        break;
                    case 'deductions':
                        if (typeof renderDeductionsTable === 'function') renderDeductionsTable();
                        if (typeof updateDeductionStats === 'function') updateDeductionStats();
                        if (typeof updateDashboardStats === 'function') updateDashboardStats();
                        break;
                    case 'notifications':
                        if (typeof updateNotificationDisplay === 'function') updateNotificationDisplay();
                        break;
                }
            }

            refreshAllData() {
                console.log('إعادة تحميل جميع البيانات من Firebase...');
                
                // Reload data from Firebase
                this.loadDataFromFirebase().then(() => {
                    // Update all UI components
                    if (typeof renderCasesTable === 'function') renderCasesTable();
                    if (typeof renderDefendantsTable === 'function') renderDefendantsTable();
                    if (typeof renderLawyersTable === 'function') renderLawyersTable();
                    if (typeof renderDeductionsTable === 'function') renderDeductionsTable();
                    if (typeof updateDashboardStats === 'function') updateDashboardStats();
                    if (typeof updateDeductionStats === 'function') updateDeductionStats();
                    if (typeof updateNotificationDisplay === 'function') updateNotificationDisplay();
                    
                    console.log('تم تحديث جميع البيانات والواجهة');
                }).catch(error => {
                    console.error('خطأ في إعادة تحميل البيانات:', error);
                });
            }

            // دالة دمج ذكية للبيانات
            smartMergeData(localCollectionName, firebaseData) {
                const localData = this[localCollectionName];
                
                // إنشاء خريطة للبيانات المحلية للوصول السريع
                const localMap = new Map();
                localData.forEach(item => localMap.set(item.id, item));
                
                // دمج البيانات من Firebase
                firebaseData.forEach(firebaseItem => {
                    const localItem = localMap.get(firebaseItem.id);
                    
                    if (!localItem) {
                        // عنصر جديد من Firebase - إضافته
                        localData.push(firebaseItem);
                        console.log(`تمت إضافة عنصر جديد من Firebase:`, firebaseItem.id);
                    } else {
                        // عنصر موجود - تحديثه إذا كان أحدث
                        const firebaseModified = new Date(firebaseItem.lastModified || firebaseItem.createdAt || 0);
                        const localModified = new Date(localItem.lastModified || localItem.createdAt || 0);
                        
                        if (firebaseModified > localModified) {
                            const index = localData.findIndex(item => item.id === firebaseItem.id);
                            if (index !== -1) {
                                localData[index] = firebaseItem;
                                console.log(`تم تحديث عنصر من Firebase:`, firebaseItem.id);
                            }
                        }
                    }
                });
                
                // البحث عن العناصر المحذوفة (موجودة محلياً ولكن غير موجودة في Firebase)
                const firebaseIds = new Set(firebaseData.map(item => item.id));
                for (let i = localData.length - 1; i >= 0; i--) {
                    if (!firebaseIds.has(localData[i].id)) {
                        // هذا العنصر محذوف من Firebase
                        const deletedItem = localData[i];
                        // تحقق من أن العنصر قديم بما فيه الكفاية للحذف (لتجنب حذف البيانات الجديدة)
                        const itemAge = Date.now() - new Date(deletedItem.lastModified || deletedItem.createdAt || 0).getTime();
                        if (itemAge > 10000) { // 10 ثوانٍ
                            localData.splice(i, 1);
                            console.log(`تم حذف عنصر غير موجود في Firebase:`, deletedItem.id);
                        }
                    }
                }
            }

            updateAllUI() {
                setTimeout(() => {
                    if (typeof renderCasesTable === 'function') renderCasesTable();
                    if (typeof renderDefendantsTable === 'function') renderDefendantsTable();
                    if (typeof renderLawyersTable === 'function') renderLawyersTable();
                    if (typeof renderDeductionsTable === 'function') renderDeductionsTable();
                    if (typeof updateDashboardStats === 'function') updateDashboardStats();
                    if (typeof updateLawyerSelector === 'function') updateLawyerSelector();
                }, 100);
            }

            ensureArray(data) {
                return Array.isArray(data) ? data : [];
            }

            getDefaultSettings() {
                return {
                    officeName: 'تطبيق الإدارة القانونية',
                    officeAddress: 'بغداد - الكرادة - شارع الرئيسي',
                    officePhone: '+964-770-123-4567',
                    autoNotifications: true,
                    hearingNotifications: true,
                    monthlyReports: false,
                    notificationDays: 3,
                    systemLanguage: 'ar',
                    dateType: 'gregorian',
                    autoSave: true,
                    autoSaveInterval: 5,
                    dailyBackup: true,
                    lastBackupDate: null
                };
            }

            // Cases Methods
            async addCase(caseData) {
                this.isUpdatingLocally = true; // تعيين العلم لتجنب التحديثات المتضاربة
                
                const newCase = {
                    id: this.generateId('case'),
                    ...caseData,
                    createdAt: new Date().toISOString(),
                    lastUpdate: new Date().toISOString(),
                    lastModified: new Date().toISOString(),
                    deductions: 0,
                    timeline: [{
                        date: caseData.fileDate,
                        title: 'تم رفع الدعوى',
                        desc: `تم تقديم الدعوى للمحكمة بموضوع: ${caseData.subject.substring(0, 50)}...`,
                        type: 'blue'
                    }]
                };
                
                // إضافة محلياً أولاً
                this.casesData.push(newCase);
                this.filteredCases = [...this.casesData];
                
                // حفظ محلياً
                this.saveDataLocally();
                
                try {
                    // حفظ في Firebase
                    await firebaseSync.saveToFirebase('cases', newCase.id, newCase);
                    console.log('تم حفظ الدعوى في Firebase:', newCase.id);
                } catch (error) {
                    console.error('خطأ في حفظ الدعوى في Firebase:', error);
                }
                
                // تحديث عدد دعاوى المدعى عليه
                this.updateDefendantCaseCount(caseData.defendantName);
                
                this.isUpdatingLocally = false; // إلغاء العلم
                
                return newCase;
            }

            async updateCase(id, updates) {
                const index = this.casesData.findIndex(c => c.id === id);
                if (index !== -1) {
                    const updatedCase = { 
                        ...this.casesData[index], 
                        ...updates, 
                        lastUpdate: new Date().toISOString(),
                        lastModified: new Date().toISOString()
                    };
                    
                    this.casesData[index] = updatedCase;
                    this.filteredCases = [...this.casesData];
                    
                    // حفظ محلياً
                    this.saveDataLocally();
                    
                    // تحديث في Firebase
                    await firebaseSync.updateInFirebase('cases', id, updatedCase);
                    
                    return updatedCase;
                }
                return null;
            }

            // Cases Methods - إصلاح دوال الحذف والتعديل
            async addCase(caseData) {
                this.isUpdatingLocally = true;
                
                const newCase = {
                    id: this.generateId('case'),
                    ...caseData,
                    createdAt: new Date().toISOString(),
                    lastModified: new Date().toISOString()
                };
                
                // إزالة من قائمة المحذوفات إذا كان موجوداً (إعادة إضافة)
                const deletedIndex = this.deletedItems.cases.indexOf(newCase.id);
                if (deletedIndex > -1) {
                    this.deletedItems.cases.splice(deletedIndex, 1);
                    LocalStorage.save('deletedCases', this.deletedItems.cases);
                }
                
                // إضافة محلياً أولاً
                this.casesData.push(newCase);
                this.filteredCases = [...this.casesData];
                
                // حفظ محلياً فوراً
                this.saveDataLocally();
                
                try {
                    // حفظ في Firebase
                    await firebaseSync.saveToFirebase('cases', newCase.id, newCase);
                    console.log('تم حفظ الدعوى في Firebase:', newCase.id);
                } catch (error) {
                    console.error('خطأ في حفظ الدعوى في Firebase:', error);
                }
                
                this.isUpdatingLocally = false;
                
                // Update defendant if exists
                if (caseData.defendantName) {
                    this.updateDefendantCaseCount(caseData.defendantName, 1);
                }
                
                return newCase;
            }

            async updateCase(id, updates) {
                const index = this.casesData.findIndex(c => c.id === id);
                if (index !== -1) {
                    const updatedCase = { 
                        ...this.casesData[index], 
                        ...updates,
                        lastModified: new Date().toISOString()
                    };
                    
                    this.casesData[index] = updatedCase;
                    this.filteredCases = [...this.casesData];
                    
                    // حفظ محلياً فوراً
                    this.saveDataLocally();
                    
                    try {
                        // تحديث في Firebase
                        await firebaseSync.updateInFirebase('cases', id, updatedCase);
                        console.log('تم تحديث الدعوى في Firebase:', id);
                    } catch (error) {
                        console.error('خطأ في تحديث الدعوى في Firebase:', error);
                    }
                    
                    return updatedCase;
                }
                return null;
            }

            async deleteCase(id) {
                console.log('حذف الدعوى:', id);
                const index = this.casesData.findIndex(c => c.id === id);
                if (index !== -1) {
                    const deletedCase = this.casesData[index];
                    
                    // تسجيل وقت الحذف
                    this.lastDeleteTime.cases = Date.now();
                    
                    // إضافة إلى قائمة المحذوفات
                    if (!this.deletedItems.cases.includes(id)) {
                        this.deletedItems.cases.push(id);
                        LocalStorage.save('deletedCases', this.deletedItems.cases);
                        console.log('تم إضافة الدعوى إلى قائمة المحذوفات:', id);
                    }
                    
                    // حذف محلياً أولاً
                    this.casesData.splice(index, 1);
                    this.filteredCases = [...this.casesData];
                    
                    // حفظ محلياً فوراً
                    this.saveDataLocally();
                    
                    try {
                        // حذف من Firebase
                        await firebaseSync.deleteFromFirebase('cases', id);
                        console.log('تم حذف الدعوى من Firebase:', id);
                    } catch (error) {
                        console.error('خطأ في حذف الدعوى من Firebase:', error);
                    }
                    
                    // Update defendant case count
                    if (deletedCase.defendantName) {
                        this.updateDefendantCaseCount(deletedCase.defendantName, -1);
                    }
                    
                    return true;
                }
                return false;
            }

            getCaseById(id) {
                return this.casesData.find(c => c.id === id);
            }

            // Defendants Methods
            async addDefendant(defendantData) {
                this.isUpdatingLocally = true;
                
                const newDefendant = {
                    id: this.generateId('defendant'),
                    ...defendantData,
                    casesCount: 0,
                    registrationDate: new Date().toISOString(),
                    createdAt: new Date().toISOString(),
                    lastModified: new Date().toISOString()
                };
                
                // إزالة من قائمة المحذوفات إذا كان موجوداً
                const deletedIndex = this.deletedItems.defendants.indexOf(newDefendant.id);
                if (deletedIndex > -1) {
                    this.deletedItems.defendants.splice(deletedIndex, 1);
                    LocalStorage.save('deletedDefendants', this.deletedItems.defendants);
                }
                
                // إضافة محلياً أولاً
                this.defendantsData.push(newDefendant);
                this.filteredDefendants = [...this.defendantsData];
                
                // حفظ محلياً
                this.saveDataLocally();
                
                try {
                    // حفظ في Firebase
                    await firebaseSync.saveToFirebase('defendants', newDefendant.id, newDefendant);
                    console.log('تم حفظ المدعى عليه في Firebase:', newDefendant.id);
                } catch (error) {
                    console.error('خطأ في حفظ المدعى عليه في Firebase:', error);
                }
                
                this.isUpdatingLocally = false;
                
                return newDefendant;
            }

            async updateDefendant(id, updates) {
                const index = this.defendantsData.findIndex(d => d.id === id);
                if (index !== -1) {
                    const updatedDefendant = { 
                        ...this.defendantsData[index], 
                        ...updates,
                        lastModified: new Date().toISOString()
                    };
                    
                    this.defendantsData[index] = updatedDefendant;
                    this.filteredDefendants = [...this.defendantsData];
                    
                    // حفظ محلياً
                    this.saveDataLocally();
                    
                    // تحديث في Firebase
                    await firebaseSync.updateInFirebase('defendants', id, updatedDefendant);
                    
                    return updatedDefendant;
                }
                return null;
            }

            async deleteDefendant(id) {
                console.log('حذف المدعى عليه:', id);
                
                // تسجيل وقت الحذف
                this.lastDeleteTime.defendants = Date.now();
                
                const index = this.defendantsData.findIndex(d => d.id === id);
                if (index !== -1) {
                    // إضافة إلى قائمة المحذوفات
                    if (!this.deletedItems.defendants.includes(id)) {
                        this.deletedItems.defendants.push(id);
                        LocalStorage.save('deletedDefendants', this.deletedItems.defendants);
                        console.log('تم إضافة المدعى عليه إلى قائمة المحذوفات:', id);
                    }
                    
                    // حذف محلياً أولاً
                    this.defendantsData.splice(index, 1);
                    this.filteredDefendants = [...this.defendantsData];
                    
                    // حفظ محلياً فوراً
                    this.saveDataLocally();
                    
                    try {
                        // حذف من Firebase
                        await firebaseSync.deleteFromFirebase('defendants', id);
                        console.log('تم حذف المدعى عليه من Firebase:', id);
                    } catch (error) {
                        console.error('خطأ في حذف المدعى عليه من Firebase:', error);
                    }
                    
                    return true;
                }
                return false;
            }

            async updateDefendantCaseCount(defendantName, increment = 1) {
                const defendant = this.defendantsData.find(d => d.name === defendantName);
                if (defendant) {
                    defendant.casesCount += increment;
                    defendant.lastModified = new Date().toISOString();
                    
                    // حفظ محلياً
                    this.saveDataLocally();
                    
                    // تحديث في Firebase
                    await firebaseSync.updateInFirebase('defendants', defendant.id, defendant);
                } else if (increment > 0) {
                    // Create new defendant if not exists
                    await this.addDefendant({
                        name: defendantName,
                        phone: '',
                        email: '',
                        workplace: '',
                        address: '',
                        casesCount: 1
                    });
                }
            }

            // Lawyers Methods
            async addLawyer(lawyerData) {
                this.isUpdatingLocally = true;
                
                const newLawyer = {
                    id: this.generateId('lawyer'),
                    ...lawyerData,
                    casesCount: 0,
                    registrationDate: new Date().toISOString(),
                    createdAt: new Date().toISOString(),
                    lastModified: new Date().toISOString()
                };
                
                // إزالة من قائمة المحذوفات إذا كان موجوداً
                const deletedIndex = this.deletedItems.lawyers.indexOf(newLawyer.id);
                if (deletedIndex > -1) {
                    this.deletedItems.lawyers.splice(deletedIndex, 1);
                    LocalStorage.save('deletedLawyers', this.deletedItems.lawyers);
                }
                
                // إضافة محلياً أولاً
                this.lawyersData.push(newLawyer);
                this.filteredLawyers = [...this.lawyersData];
                
                // حفظ محلياً
                this.saveDataLocally();
                
                try {
                    // حفظ في Firebase
                    await firebaseSync.saveToFirebase('lawyers', newLawyer.id, newLawyer);
                    console.log('تم حفظ المحامي في Firebase:', newLawyer.id);
                } catch (error) {
                    console.error('خطأ في حفظ المحامي في Firebase:', error);
                }
                
                this.isUpdatingLocally = false;
                
                return newLawyer;
            }

            async updateLawyer(id, updates) {
                const index = this.lawyersData.findIndex(l => l.id === id);
                if (index !== -1) {
                    const updatedLawyer = { 
                        ...this.lawyersData[index], 
                        ...updates,
                        lastModified: new Date().toISOString()
                    };
                    
                    this.lawyersData[index] = updatedLawyer;
                    this.filteredLawyers = [...this.lawyersData];
                    
                    // حفظ محلياً
                    this.saveDataLocally();
                    
                    // تحديث في Firebase
                    await firebaseSync.updateInFirebase('lawyers', id, updatedLawyer);
                    
                    return updatedLawyer;
                }
                return null;
            }

            async deleteLawyer(id) {
                console.log('حذف المحامي:', id);
                
                // تسجيل وقت الحذف
                this.lastDeleteTime.lawyers = Date.now();
                
                const index = this.lawyersData.findIndex(l => l.id === id);
                if (index !== -1) {
                    // إضافة إلى قائمة المحذوفات
                    if (!this.deletedItems.lawyers.includes(id)) {
                        this.deletedItems.lawyers.push(id);
                        LocalStorage.save('deletedLawyers', this.deletedItems.lawyers);
                        console.log('تم إضافة المحامي إلى قائمة المحذوفات:', id);
                    }
                    
                    // حذف محلياً أولاً
                    this.lawyersData.splice(index, 1);
                    this.filteredLawyers = [...this.lawyersData];
                    
                    // حفظ محلياً فوراً
                    this.saveDataLocally();
                    
                    try {
                        // حذف من Firebase
                        await firebaseSync.deleteFromFirebase('lawyers', id);
                        console.log('تم حذف المحامي من Firebase:', id);
                    } catch (error) {
                        console.error('خطأ في حذف المحامي من Firebase:', error);
                    }
                    
                    return true;
                }
                return false;
            }

            // Deductions Methods
            async addDeduction(deductionData) {
                this.isUpdatingLocally = true;
                
                // التأكد من أن deductionsData مصفوفة صحيحة
                if (!Array.isArray(this.deductionsData)) {
                    this.deductionsData = [];
                }
                
                const newDeduction = {
                    id: this.generateId('deduction'),
                    ...deductionData,
                    status: deductionData.status || 'مستلم',
                    createdAt: new Date().toISOString(),
                    lastModified: new Date().toISOString()
                };
                
                // إزالة من قائمة المحذوفات إذا كان موجوداً
                const deletedIndex = this.deletedItems.deductions.indexOf(newDeduction.id);
                if (deletedIndex > -1) {
                    this.deletedItems.deductions.splice(deletedIndex, 1);
                    LocalStorage.save('deletedDeductions', this.deletedItems.deductions);
                }
                
                // إضافة الاستقطاع الجديد محلياً أولاً
                this.deductionsData.push(newDeduction);
                this.filteredDeductions = [...this.deductionsData];
                
                // تحديث القضية
                const caseItem = this.casesData.find(c => c.caseNumber === deductionData.caseNumber);
                if (caseItem) {
                    caseItem.deductions = (caseItem.deductions || 0) + deductionData.amount;
                    caseItem.lastUpdate = new Date().toISOString();
                    caseItem.lastModified = new Date().toISOString();
                    
                    if (!caseItem.timeline) {
                        caseItem.timeline = [];
                    }
                    
                    caseItem.timeline.push({
                        date: deductionData.date,
                        title: 'استقطاع جديد',
                        desc: `تم استقطاع ${this.formatNumber(deductionData.amount)} د.ع من ${deductionData.source}`,
                        type: 'green'
                    });
                    
                    // تحديث الدعوى في Firebase
                    try {
                        await firebaseSync.updateInFirebase('cases', caseItem.id, caseItem);
                    } catch (error) {
                        console.error('خطأ في تحديث الدعوى في Firebase:', error);
                    }
                }
                
                // حفظ محلياً
                this.saveDataLocally();
                
                try {
                    // حفظ في Firebase
                    await firebaseSync.saveToFirebase('deductions', newDeduction.id, newDeduction);
                    console.log('تم حفظ الاستقطاع في Firebase:', newDeduction.id);
                } catch (error) {
                    console.error('خطأ في حفظ الاستقطاع في Firebase:', error);
                }
                
                console.log('تم إضافة استقطاع:', newDeduction);
                console.log('إجمالي الاستقطاعات:', this.deductionsData.length);
                
                this.isUpdatingLocally = false;
                
                return newDeduction;
            }

            async updateDeduction(id, updates) {
                this.isUpdatingLocally = true;
                
                const index = this.deductionsData.findIndex(d => d.id === id);
                if (index !== -1) {
                    const updatedDeduction = { 
                        ...this.deductionsData[index], 
                        ...updates,
                        lastModified: new Date().toISOString()
                    };
                    
                    this.deductionsData[index] = updatedDeduction;
                    this.filteredDeductions = [...this.deductionsData];
                    
                    // حفظ محلياً
                    this.saveDataLocally();
                    
                    try {
                        // تحديث في Firebase
                        await firebaseSync.updateInFirebase('deductions', id, updatedDeduction);
                        console.log('تم تحديث الاستقطاع في Firebase:', id);
                    } catch (error) {
                        console.error('خطأ في تحديث الاستقطاع في Firebase:', error);
                    }
                    
                    this.isUpdatingLocally = false;
                    return updatedDeduction;
                }
                this.isUpdatingLocally = false;
                return null;
            }

            async deleteDeduction(id) {
                console.log('حذف الاستقطاع:', id);
                
                // تسجيل وقت الحذف
                this.lastDeleteTime.deductions = Date.now();
                
                // التأكد من أن id رقم
                const numId = typeof id === 'string' ? parseInt(id) : id;
                console.log('محاولة حذف استقطاع برقم:', numId);
                console.log('الاستقطاعات قبل الحذف:', this.deductionsData.length);
                
                // البحث عن الاستقطاع المراد حذفه
                const deductionIndex = this.deductionsData.findIndex(d => d.id === numId || d.id == id);
                
                if (deductionIndex === -1) {
                    console.error('لم يتم العثور على الاستقطاع برقم:', numId);
                    return false;
                }
                
                const deductionToDelete = this.deductionsData[deductionIndex];
                
                // إضافة إلى قائمة المحذوفات
                if (!this.deletedItems.deductions.includes(deductionToDelete.id)) {
                    this.deletedItems.deductions.push(deductionToDelete.id);
                    LocalStorage.save('deletedDeductions', this.deletedItems.deductions);
                    console.log('تم إضافة الاستقطاع إلى قائمة المحذوفات:', deductionToDelete.id);
                }
                
                // حذف الاستقطاع محلياً أولاً
                this.deductionsData.splice(deductionIndex, 1);
                this.filteredDeductions = [...this.deductionsData];
                
                console.log('الاستقطاعات بعد الحذف:', this.deductionsData.length);
                
                // حفظ محلياً فوراً
                this.saveDataLocally();
                
                try {
                    // حذف من Firebase
                    await firebaseSync.deleteFromFirebase('deductions', deductionToDelete.id);
                    console.log('تم حذف الاستقطاع من Firebase:', deductionToDelete.id);
                } catch (error) {
                    console.error('خطأ في حذف الاستقطاع من Firebase:', error);
                }
                
                // تحديث القضية المرتبطة
                const caseItem = this.casesData.find(c => c.caseNumber === deductionToDelete.caseNumber);
                if (caseItem && caseItem.deductions) {
                    caseItem.deductions -= deductionToDelete.amount;
                    if (caseItem.deductions < 0) caseItem.deductions = 0;
                    caseItem.lastModified = new Date().toISOString();
                    
                    try {
                        // تحديث الدعوى في Firebase
                        await firebaseSync.updateInFirebase('cases', caseItem.id, caseItem);
                    } catch (error) {
                        console.error('خطأ في تحديث الدعوى:', error);
                    }
                }
                
                return true;
            }

            // Notifications Methods
            addNotification(notificationData) {
                const newNotification = {
                    id: this.generateId('notification'),
                    ...notificationData,
                    read: false,
                    createdAt: new Date().toISOString()
                };
                
                this.notificationsData.unshift(newNotification); // Add to beginning
                if (this.notificationsData.length > 50) {
                    this.notificationsData = this.notificationsData.slice(0, 50); // Keep only last 50
                }
                
                LocalStorage.save('notificationsData', this.notificationsData);
                this.updateNotificationBadge();
                return newNotification;
            }

            markNotificationAsRead(id) {
                const notification = this.notificationsData.find(n => n.id === id);
                if (notification) {
                    notification.read = true;
                    this.saveData();
                    this.updateNotificationBadge();
                }
            }

            getUnreadNotificationsCount() {
                return this.notificationsData.filter(n => !n.read).length;
            }

            updateNotificationBadge() {
                const badge = document.getElementById('notification-count');
                const count = this.getUnreadNotificationsCount();
                
                console.log('🔔 تحديث شارة الإشعارات:', {
                    العدد: count,
                    إجمالي_الإشعارات: this.notificationsData.length,
                    غير_المقروءة: this.notificationsData.filter(n => !n.read).length,
                    إشعارات_الدردشة: this.notificationsData.filter(n => n.type === 'chat').length
                });
                
                if (badge) {
                    badge.textContent = count;
                    badge.style.display = count > 0 ? 'flex' : 'none';
                    
                    if (count > 0) {
                        console.log('📊 تحديث الشارة لتظهر:', count, 'إشعار');
                    }
                } else {
                    console.error('❌ لم يتم العثور على عنصر notification-count');
                }
            }

            // إخفاء شارة الإشعارات مؤقتاً عند عرض الإشعارات
            hideNotificationBadge() {
                const badge = document.getElementById('notification-count');
                if (badge) {
                    badge.style.display = 'none';
                    console.log('🔕 تم إخفاء شارة الإشعارات مؤقتاً');
                    
                    // إعادة تحديث الشارة بعد 3 ثواني للتأكد من العدد الصحيح
                    setTimeout(() => {
                        this.updateNotificationBadge();
                    }, 3000);
                }
            }

            // Settings Methods
            updateSettings(updates) {
                this.settingsData = { ...this.settingsData, ...updates };
                this.saveData();
                return this.settingsData;
            }

            // إدارة قائمة المحذوفات
            cleanupDeletedItems() {
                // تنظيف قوائم المحذوفات (الاحتفاظ بآخر 1000 عنصر لكل نوع)
                const maxDeletedItems = 1000;
                
                Object.keys(this.deletedItems).forEach(type => {
                    if (this.deletedItems[type].length > maxDeletedItems) {
                        this.deletedItems[type] = this.deletedItems[type].slice(-maxDeletedItems);
                        LocalStorage.save(`deleted${type.charAt(0).toUpperCase() + type.slice(1)}`, this.deletedItems[type]);
                    }
                });
            }

            // Utility Methods
            generateId(prefix) {
                // توليد ID فريد حقيقي
                const timestamp = Date.now();
                const random = Math.floor(Math.random() * 1000000);
                return parseInt(`${timestamp}${random}`);
            }

            saveData() {
                this.saveDataLocally();
            }

            saveDataLocally() {
                try {
                    // التأكد من أن البيانات مصفوفات صحيحة قبل الحفظ
                    const casesArray = Array.isArray(this.casesData) ? this.casesData : [];
                    const defendantsArray = Array.isArray(this.defendantsData) ? this.defendantsData : [];
                    const lawyersArray = Array.isArray(this.lawyersData) ? this.lawyersData : [];
                    const deductionsArray = Array.isArray(this.deductionsData) ? this.deductionsData : [];
                    const notificationsArray = Array.isArray(this.notificationsData) ? this.notificationsData : [];
                    
                    LocalStorage.save('casesData', casesArray);
                    LocalStorage.save('defendantsData', defendantsArray);
                    LocalStorage.save('lawyersData', lawyersArray);
                    LocalStorage.save('deductionsData', deductionsArray);
                    LocalStorage.save('notificationsData', notificationsArray);
                    LocalStorage.save('settingsData', this.settingsData || this.getDefaultSettings());
                    LocalStorage.save('chatData', Array.isArray(this.chatData) ? this.chatData : []);
                    LocalStorage.save('activeLawyers', Array.isArray(this.activeLawyers) ? this.activeLawyers : []);
                    
                    // تنظيف قوائم المحذوفات دورياً
                    this.cleanupDeletedItems();
                    
                    console.log('تم حفظ البيانات محلياً بنجاح - الاستقطاعات:', deductionsArray.length);
                } catch (error) {
                    console.error('خطأ في حفظ البيانات محلياً:', error);
                }
            }

            // Chat Management Functions
            addChatMessage(lawyerId, message, isFromLawyer = false) {
                const chatMessage = {
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                    lawyerId: lawyerId,
                    message: message,
                    timestamp: new Date().toISOString(),
                    isFromLawyer: isFromLawyer,
                    read: false
                };

                this.chatData.unshift(chatMessage);
                LocalStorage.save('chatData', this.chatData);

                // Update chat badge
                this.updateChatBadge();

                // Show notification for new messages from lawyers
                if (isFromLawyer) {
                    const lawyer = this.lawyersData.find(l => l.id === lawyerId);
                    const lawyerName = lawyer ? lawyer.name : 'محامي';
                    
                    // Show immediate notification
                    showNotification(
                        '💬 رسالة جديدة',
                        `رسالة من المحامي ${lawyerName}`,
                        'info',
                        false
                    );

                    // Add notification to system
                    const notification = {
                        id: 'chat_' + chatMessage.id,
                        title: '💬 رسالة جديدة من المحامي',
                        message: `${lawyerName}: ${message.substring(0, 50)}${message.length > 50 ? '...' : ''}`,
                        details: `رسالة من المحامي ${lawyerName} وصلت في ${this.formatDateTime(chatMessage.timestamp)}`,
                        type: 'chat',
                        priority: 'high',
                        read: false,
                        createdAt: chatMessage.timestamp,
                        lawyerId: lawyerId,
                        lawyerName: lawyerName,
                        actionText: 'عرض الرسالة',
                        actionFn: () => {
                            showTab('chat');
                            setTimeout(() => selectLawyer(lawyerId), 100);
                        }
                    };

                    console.log('📢 إضافة إشعار جديد:', notification.title);
                    this.notificationsData.unshift(notification);
                    LocalStorage.save('notificationsData', this.notificationsData);
                    this.updateNotificationBadge();
                    
                    // Show browser notification if supported
                    if ('Notification' in window && Notification.permission === 'granted') {
                        const browserNotification = new Notification(`رسالة من ${lawyerName}`, {
                            body: message.substring(0, 100),
                            icon: '/assets/icon.png',
                            tag: 'chat_' + lawyerId
                        });
                        
                        browserNotification.onclick = () => {
                            window.focus();
                            showTab('chat');
                            setTimeout(() => selectLawyer(lawyerId), 100);
                            browserNotification.close();
                        };
                    }
                    LocalStorage.save('notificationsData', this.notificationsData);
                    this.updateNotificationBadge();
                }

                return chatMessage;
            }

            getChatMessages(lawyerId) {
                const messages = this.chatData.filter(msg => {
                    // Convert both IDs to strings for proper comparison
                    const msgLawyerId = msg.lawyerId ? msg.lawyerId.toString() : '';
                    const targetLawyerId = lawyerId ? lawyerId.toString() : '';
                    return msgLawyerId === targetLawyerId;
                }).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                
                console.log(`📋 getChatMessages للمحامي ${lawyerId}:`, {
                    total: this.chatData.length,
                    filtered: messages.length,
                    messages: messages
                });
                
                return messages;
            }

            markChatMessagesAsRead(lawyerId) {
                this.chatData.forEach(msg => {
                    if (msg.lawyerId === lawyerId && msg.isFromLawyer) {
                        msg.read = true;
                    }
                });
                LocalStorage.save('chatData', this.chatData);
                this.updateChatBadge();
            }

            getUnreadChatCount(lawyerId = null) {
                if (lawyerId) {
                    return this.chatData.filter(msg => 
                        msg.lawyerId === lawyerId && msg.isFromLawyer && !msg.read
                    ).length;
                }
                return this.chatData.filter(msg => msg.isFromLawyer && !msg.read).length;
            }

            updateChatBadge() {
                const unreadCount = this.getUnreadChatCount();
                const badge = document.getElementById('chat-badge');
                if (badge) {
                    if (unreadCount > 0) {
                        badge.textContent = unreadCount;
                        badge.style.display = 'inline-block';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            }

            setLawyerActive(lawyerId, isActive = true) {
                const lawyer = this.lawyersData.find(l => l.id === lawyerId);
                if (!lawyer) return;

                if (isActive) {
                    if (!this.activeLawyers.find(l => l.id === lawyerId)) {
                        this.activeLawyers.push({
                            id: lawyerId,
                            name: lawyer.name,
                            lastSeen: new Date().toISOString(),
                            isOnline: true
                        });
                    } else {
                        const activeLawyer = this.activeLawyers.find(l => l.id === lawyerId);
                        activeLawyer.lastSeen = new Date().toISOString();
                        activeLawyer.isOnline = true;
                    }
                } else {
                    const activeLawyer = this.activeLawyers.find(l => l.id === lawyerId);
                    if (activeLawyer) {
                        activeLawyer.isOnline = false;
                        activeLawyer.lastSeen = new Date().toISOString();
                    }
                }

                LocalStorage.save('activeLawyers', this.activeLawyers);
            }

            getActiveLawyers() {
                return this.activeLawyers.filter(lawyer => lawyer.isOnline);
            }

            // Search Methods
            searchCases(searchTerm, statusFilter = '') {
                this.filteredCases = this.casesData.filter(caseItem => {
                    const matchesSearch = !searchTerm || 
                        caseItem.plaintiffName.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        caseItem.caseNumber.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        caseItem.status.includes(searchTerm);
                        
                    const matchesStatus = !statusFilter || caseItem.status === statusFilter;
                    
                    return matchesSearch && matchesStatus;
                });
            }

            searchDefendants(searchTerm) {
                this.filteredDefendants = this.defendantsData.filter(defendant => 
                    !searchTerm ||
                    defendant.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    defendant.phone.includes(searchTerm) ||
                    defendant.email.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }

            searchLawyers(searchTerm, specializationFilter = '') {
                this.filteredLawyers = this.lawyersData.filter(lawyer => {
                    const matchesSearch = !searchTerm ||
                        lawyer.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        lawyer.license.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        lawyer.specialization.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        lawyer.phone.includes(searchTerm);
                        
                    const matchesSpecialization = !specializationFilter || lawyer.specialization === specializationFilter;
                    
                    return matchesSearch && matchesSpecialization;
                });
            }

            searchDeductions(searchTerm) {
                this.filteredDeductions = this.deductionsData.filter(deduction =>
                    !searchTerm ||
                    deduction.plaintiffName.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    deduction.caseNumber.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    deduction.source.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }

            // Sort Methods
            sortDefendants(sortBy) {
                this.filteredDefendants.sort((a, b) => {
                    switch (sortBy) {
                        case 'name':
                            return a.name.localeCompare(b.name, 'ar');
                        case 'casesCount':
                            return b.casesCount - a.casesCount;
                        case 'registrationDate':
                            return new Date(b.registrationDate) - new Date(a.registrationDate);
                        default:
                            return 0;
                    }
                });
            }

            // Statistics Methods
            getStatistics() {
                const totalCases = this.casesData.length;
                const pendingCases = this.casesData.filter(c => c.status === 'تحت المراجعة').length;
                const completedCases = this.casesData.filter(c => c.status === 'تنفيذ' || c.status === 'مغلقة').length;
                const totalAmount = this.casesData.reduce((sum, c) => sum + (c.amount || 0), 0);
                const totalDeductions = this.deductionsData.reduce((sum, d) => sum + (d.amount || 0), 0);
                
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();
                const monthlyCases = this.casesData.filter(c => {
                    const caseDate = new Date(c.fileDate);
                    return caseDate.getMonth() === currentMonth && caseDate.getFullYear() === currentYear;
                }).length;
                
                const successRate = totalCases > 0 ? Math.round((completedCases / totalCases) * 100) : 0;
                
                const avgDuration = this.calculateAverageDuration();
                
                return {
                    totalCases,
                    pendingCases,
                    completedCases,
                    totalAmount,
                    totalDeductions,
                    monthlyCases,
                    successRate,
                    avgDuration
                };
            }

            calculateAverageDuration() {
                const completedCases = this.casesData.filter(c => c.status === 'تنفيذ' || c.status === 'مغلقة');
                if (completedCases.length === 0) return 0;
                
                const totalDuration = completedCases.reduce((sum, c) => {
                    const startDate = new Date(c.fileDate);
                    const endDate = new Date(c.lastUpdate);
                    const duration = (endDate - startDate) / (1000 * 60 * 60 * 24 * 30); // in months
                    return sum + duration;
                }, 0);
                
                return Math.round(totalDuration / completedCases.length * 10) / 10;
            }

            // Export/Import Methods
            exportData() {
                const data = {
                    cases: this.casesData,
                    defendants: this.defendantsData,
                    lawyers: this.lawyersData,
                    deductions: this.deductionsData,
                    notifications: this.notificationsData,
                    settings: this.settingsData,
                    exportDate: new Date().toISOString(),
                    version: '1.0'
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `legal_cases_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.settingsData.lastBackupDate = new Date().toISOString();
                this.saveData();
                
                return true;
            }

            async importData(file) {
                return new Promise(async (resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            this.isUpdatingLocally = true;
                            
                            const data = JSON.parse(e.target.result);
                            
                            console.log('بدء استيراد البيانات...');
                            let importStats = {
                                cases: 0,
                                defendants: 0,
                                lawyers: 0,
                                deductions: 0
                            };
                            
                            // دمج الدعاوى
                            if (data.cases && Array.isArray(data.cases)) {
                                for (const importedCase of data.cases) {
                                    if (!this.casesData.find(c => c.id === importedCase.id)) {
                                        importedCase.lastModified = new Date().toISOString();
                                        this.casesData.push(importedCase);
                                        importStats.cases++;
                                        
                                        // حفظ في Firebase
                                        try {
                                            await firebaseSync.saveToFirebase('cases', importedCase.id, importedCase);
                                        } catch (error) {
                                            console.error('خطأ في حفظ الدعوى في Firebase:', error);
                                        }
                                    }
                                }
                            }
                            
                            // دمج المدعى عليهم
                            if (data.defendants && Array.isArray(data.defendants)) {
                                for (const importedDefendant of data.defendants) {
                                    if (!this.defendantsData.find(d => d.id === importedDefendant.id)) {
                                        importedDefendant.lastModified = new Date().toISOString();
                                        this.defendantsData.push(importedDefendant);
                                        importStats.defendants++;
                                        
                                        // حفظ في Firebase
                                        try {
                                            await firebaseSync.saveToFirebase('defendants', importedDefendant.id, importedDefendant);
                                        } catch (error) {
                                            console.error('خطأ في حفظ المدعى عليه في Firebase:', error);
                                        }
                                    }
                                }
                            }
                            
                            // دمج المحامين
                            if (data.lawyers && Array.isArray(data.lawyers)) {
                                for (const importedLawyer of data.lawyers) {
                                    if (!this.lawyersData.find(l => l.id === importedLawyer.id)) {
                                        importedLawyer.lastModified = new Date().toISOString();
                                        this.lawyersData.push(importedLawyer);
                                        importStats.lawyers++;
                                        
                                        // حفظ في Firebase
                                        try {
                                            await firebaseSync.saveToFirebase('lawyers', importedLawyer.id, importedLawyer);
                                        } catch (error) {
                                            console.error('خطأ في حفظ المحامي في Firebase:', error);
                                        }
                                    }
                                }
                            }
                            
                            // دمج الاستقطاعات
                            if (data.deductions && Array.isArray(data.deductions)) {
                                for (const importedDeduction of data.deductions) {
                                    if (!this.deductionsData.find(d => d.id === importedDeduction.id)) {
                                        importedDeduction.lastModified = new Date().toISOString();
                                        this.deductionsData.push(importedDeduction);
                                        importStats.deductions++;
                                        
                                        // حفظ في Firebase
                                        try {
                                            await firebaseSync.saveToFirebase('deductions', importedDeduction.id, importedDeduction);
                                        } catch (error) {
                                            console.error('خطأ في حفظ الاستقطاع في Firebase:', error);
                                        }
                                    }
                                }
                            }
                            
                            // دمج الإعدادات (لا يتم استبدالها)
                            if (data.settings) {
                                this.settingsData = { ...this.settingsData, ...data.settings };
                            }
                            
                            // تحديث المصفوفات المفلترة
                            this.filteredCases = [...this.casesData];
                            this.filteredDefendants = [...this.defendantsData];
                            this.filteredLawyers = [...this.lawyersData];
                            this.filteredDeductions = [...this.deductionsData];
                            
                            // حفظ البيانات محلياً
                            this.saveDataLocally();
                            
                            // تحديث واجهة المستخدم
                            this.updateAllUI();
                            
                            this.isUpdatingLocally = false;
                            
                            console.log('تم استيراد البيانات بنجاح:', importStats);
                            resolve(importStats);
                        } catch (error) {
                            this.isUpdatingLocally = false;
                            console.error('خطأ في استيراد البيانات:', error);
                            reject(error);
                        }
                    };
                    reader.onerror = () => {
                        this.isUpdatingLocally = false;
                        reject(new Error('فشل في قراءة الملف'));
                    };
                    reader.readAsText(file);
                });
            }

            // Utility formatting methods
            formatNumber(num) {
                return new Intl.NumberFormat('ar-EG').format(num);
            }

            formatDate(dateString) {
                if (!dateString) return '-';
                const date = new Date(dateString);
                // استخدام التقويم الميلادي باللغة العربية
                return date.toLocaleDateString('ar-EG', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
            }

            formatDateTime(dateString) {
                if (!dateString) return '-';
                const date = new Date(dateString);
                // تنسيق التاريخ والوقت
                return date.toLocaleString('ar-EG', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });
            }

            formatTime(dateString) {
                if (!dateString) return '-';
                const date = new Date(dateString);
                // تنسيق الوقت فقط
                return date.toLocaleTimeString('ar-EG', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 بايت';
                const k = 1024;
                const sizes = ['بايت', 'كيلوبايت', 'ميجابايت', 'جيجابايت'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            // إضافة دالة جديدة للتحقق من سلامة البيانات
            checkDataIntegrity() {
                console.log('=== فحص سلامة البيانات ===');
                console.log('القضايا:', this.casesData.length);
                console.log('المدعى عليهم:', this.defendantsData.length);
                console.log('المحامون:', this.lawyersData.length);
                console.log('الاستقطاعات:', this.deductionsData.length);
                
                // التحقق من عدم وجود IDs مكررة
                const deductionIds = this.deductionsData.map(d => d.id);
                const uniqueIds = [...new Set(deductionIds)];
                
                if (deductionIds.length !== uniqueIds.length) {
                    console.warn('تحذير: يوجد معرفات مكررة في الاستقطاعات!');
                }
                
                console.log('========================');
            }

            // رفع البيانات الموجودة إلى Firebase للمرة الأولى
            async uploadExistingDataToFirebase() {
                if (!firebaseSync.isFirebaseConnected) {
                    console.log('غير متصل بـ Firebase - لا يمكن رفع البيانات');
                    return false;
                }

                try {
                    console.log('بدء رفع البيانات الموجودة إلى Firebase...');
                    let uploadStats = {
                        cases: 0,
                        defendants: 0,
                        lawyers: 0,
                        deductions: 0
                    };

                    this.isUpdatingLocally = true;

                    // رفع الدعاوى
                    for (const caseItem of this.casesData) {
                        try {
                            await firebaseSync.saveToFirebase('cases', caseItem.id, {
                                ...caseItem,
                                lastModified: new Date().toISOString()
                            });
                            uploadStats.cases++;
                        } catch (error) {
                            console.error('خطأ في رفع الدعوى:', caseItem.id, error);
                        }
                    }

                    // رفع المدعى عليهم
                    for (const defendant of this.defendantsData) {
                        try {
                            await firebaseSync.saveToFirebase('defendants', defendant.id, {
                                ...defendant,
                                lastModified: new Date().toISOString()
                            });
                            uploadStats.defendants++;
                        } catch (error) {
                            console.error('خطأ في رفع المدعى عليه:', defendant.id, error);
                        }
                    }

                    // رفع المحامين
                    for (const lawyer of this.lawyersData) {
                        try {
                            await firebaseSync.saveToFirebase('lawyers', lawyer.id, {
                                ...lawyer,
                                lastModified: new Date().toISOString()
                            });
                            uploadStats.lawyers++;
                        } catch (error) {
                            console.error('خطأ في رفع المحامي:', lawyer.id, error);
                        }
                    }

                    // رفع الاستقطاعات
                    for (const deduction of this.deductionsData) {
                        try {
                            await firebaseSync.saveToFirebase('deductions', deduction.id, {
                                ...deduction,
                                lastModified: new Date().toISOString()
                            });
                            uploadStats.deductions++;
                        } catch (error) {
                            console.error('خطأ في رفع الاستقطاع:', deduction.id, error);
                        }
                    }

                    this.isUpdatingLocally = false;

                    console.log('تم رفع البيانات إلى Firebase بنجاح:', uploadStats);
                    return uploadStats;

                } catch (error) {
                    this.isUpdatingLocally = false;
                    console.error('خطأ في رفع البيانات إلى Firebase:', error);
                    return false;
                }
            }
        }

        // Initialize Data Manager
        const dataManager = new DataManager();

        // Notification Manager Class
        class NotificationManager {
            constructor(dataManager) {
                this.dataManager = dataManager;
                this.checkInterval = null;
                this.desktopNotificationPermission = 'default';
                this.shownDesktopNotifications = new Set(); // تتبع الإشعارات المعروضة على سطح المكتب
                this.notificationTypes = {
                    OVERDUE_HEARING: 'overdue_hearing',
                    UPCOMING_HEARING: 'upcoming_hearing',
                    NEW_DEDUCTION: 'new_deduction',
                    CASE_NEEDS_UPDATE: 'case_needs_update',
                    HIGH_REMAINING_AMOUNT: 'high_remaining_amount',
                    CASE_COMPLETED: 'case_completed',
                    MONTHLY_SUMMARY: 'monthly_summary'
                };
            }

            async initialize() {
                // طلب إذن الإشعارات من المتصفح مرة واحدة فقط
                if (!sessionStorage.getItem('notificationPermissionRequested')) {
                    await this.requestNotificationPermission();
                    sessionStorage.setItem('notificationPermissionRequested', 'true');
                }
                
                // تحميل حالة الإشعارات المعروضة من التخزين المحلي
                this.loadShownNotifications();
                
                // إنشاء إشعارات الترحيب مرة واحدة فقط
                if (!sessionStorage.getItem('welcomeNotificationShown')) {
                    this.generateWelcomeNotification();
                    sessionStorage.setItem('welcomeNotificationShown', 'true');
                }
                
                this.checkAllNotifications();
                // تحديث الإشعارات كل 30 دقيقة
                this.checkInterval = setInterval(() => {
                    this.checkAllNotifications();
                }, 30 * 60 * 1000);
            }

            async requestNotificationPermission() {
                // تحديث محدود للرسائل في الكونسول
                if (!sessionStorage.getItem('consoleMessagesReduced')) {
                    console.log('🔧 تم تقليل رسائل الكونسول لتحسين الأداء');
                    sessionStorage.setItem('consoleMessagesReduced', 'true');
                }
                
                if ('Notification' in window) {
                    if (Notification.permission === 'default') {
                        this.desktopNotificationPermission = await Notification.requestPermission();
                    } else {
                        this.desktopNotificationPermission = Notification.permission;
                    }
                    
                    if (this.desktopNotificationPermission === 'granted') {
                        if (!sessionStorage.getItem('notificationPermissionGranted')) {
                            showNotification('الإشعارات مفعلة', 'سيتم إرسال إشعارات سطح المكتب للمهام المهمة', 'success');
                            sessionStorage.setItem('notificationPermissionGranted', 'true');
                        }
                    }
                }
            }

            loadShownNotifications() {
                try {
                    const saved = localStorage.getItem('shownDesktopNotifications');
                    if (saved) {
                        this.shownDesktopNotifications = new Set(JSON.parse(saved));
                    }
                } catch (error) {
                    console.error('خطأ في تحميل حالة الإشعارات:', error);
                }
            }

            saveShownNotifications() {
                try {
                    localStorage.setItem('shownDesktopNotifications', JSON.stringify([...this.shownDesktopNotifications]));
                } catch (error) {
                    console.error('خطأ في حفظ حالة الإشعارات:', error);
                }
            }

            showDesktopNotification(notification) {
                // تحقق من عدم عرض هذا الإشعار من قبل
                if (this.shownDesktopNotifications.has(notification.id)) {
                    return;
                }

                // تحقق من الإذن والدعم
                if (this.desktopNotificationPermission !== 'granted' || !('Notification' in window)) {
                    return;
                }

                try {
                    const desktopNotification = new Notification(notification.title, {
                        body: `${notification.message}\n${notification.details}`,
                        icon: 'assets/icon.png', // تأكد من وجود الأيقونة
                        badge: 'assets/icon.png',
                        tag: notification.id, // لتجنب التكرار
                        requireInteraction: notification.priority === 'high', // الإشعارات العاجلة تتطلب تفاعل
                        silent: notification.priority === 'low', // الإشعارات العادية صامتة
                        timestamp: Date.now(),
                        data: {
                            notificationId: notification.id
                        }
                    });

                    // إضافة معالجات الأحداث
                    desktopNotification.onclick = () => {
                        // إحضار النافذة للمقدمة
                        window.focus();
                        
                        // تنفيذ الإجراء إذا كان متوفراً
                        if (notification.actionFn) {
                            setTimeout(() => {
                                notification.actionFn();
                                this.markAsRead(notification.id);
                            }, 100);
                        }
                        
                        desktopNotification.close();
                    };

                    desktopNotification.onclose = () => {
                        // تسجيل أن الإشعار تم عرضه
                        this.shownDesktopNotifications.add(notification.id);
                        this.saveShownNotifications();
                    };

                    desktopNotification.onerror = (error) => {
                        console.error('خطأ في إشعار سطح المكتب:', error);
                    };

                    // إغلاق تلقائي للإشعارات العادية بعد 10 ثوانٍ
                    if (notification.priority === 'low') {
                        setTimeout(() => {
                            desktopNotification.close();
                        }, 10000);
                    }

                    // تسجيل أن الإشعار تم عرضه
                    this.shownDesktopNotifications.add(notification.id);
                    this.saveShownNotifications();

                } catch (error) {
                    console.error('خطأ في إنشاء إشعار سطح المكتب:', error);
                }
            }

            checkAllNotifications() {
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                // مسح الإشعارات القديمة (أكثر من 30 يوم)
                this.cleanOldNotifications();

                // 1. فحص الجلسات المتأخرة والقادمة
                this.checkHearings(today);

                // 2. فحص الاستقطاعات الجديدة
                this.checkNewDeductions(today);

                // 3. فحص الدعاوى التي تحتاج متابعة
                this.checkCasesNeedingUpdate(today);

                // 4. فحص المبالغ المتبقية الكبيرة
                this.checkHighRemainingAmounts();

                // 5. فحص الدعاوى المكتملة مؤخراً
                this.checkRecentlyCompletedCases(today);

                // تحديث العرض
                this.dataManager.updateNotificationBadge();
                renderAlerts();
            }

            generateWelcomeNotification() {
                console.log('🎉 إضافة إشعار الترحيب...');
                
                const stats = this.dataManager.getStatistics();
                
                // إشعار ترحيبي واحد فقط
                this.createNotification({
                    id: 'welcome_' + new Date().toDateString(),
                    type: 'SYSTEM_STATUS',
                    title: '🎉 مرحباً بك!',
                    message: `تم تحميل تطبيق الإدارة القانونية بنجاح`,
                    details: `${stats.totalCases} دعوى • ${stats.totalLawyers} محامي • ${stats.totalDefendants} مدعى عليه`,
                    priority: 'low',
                    actionText: 'عرض اللوحة الرئيسية',
                    actionFn: () => showTab('dashboard')
                });
            }

            checkUpcomingHearings() {
                const today = new Date();
                const upcomingHearings = this.dataManager.casesData.filter(caseItem => {
                    if (!caseItem.nextHearing) return false;
                    const hearingDate = new Date(caseItem.nextHearing);
                    const daysUntil = Math.floor((hearingDate - today) / (24 * 60 * 60 * 1000));
                    return daysUntil >= 0 && daysUntil <= 7; // الجلسات خلال الأسبوع القادم
                });

                if (upcomingHearings.length > 0) {
                    this.createNotification({
                        id: 'upcoming_hearings_' + Date.now(),
                        type: 'UPCOMING_HEARING',
                        title: '📅 جلسات قادمة',
                        message: `لديك ${upcomingHearings.length} جلسة خلال الأسبوع القادم`,
                        details: upcomingHearings.map(c => `${c.caseNumber} - ${this.dataManager.formatDate(c.nextHearing)}`).join(', '),
                        priority: 'high',
                        actionText: 'عرض الجلسات',
                        actionFn: () => showTab('cases')
                    });
                }
            }

            checkHearings(today) {
                this.dataManager.casesData.forEach(caseItem => {
                    if (!caseItem.nextHearing) return;

                    const hearingDate = new Date(caseItem.nextHearing);
                    hearingDate.setHours(0, 0, 0, 0);
                    
                    const daysUntil = Math.floor((hearingDate - today) / (24 * 60 * 60 * 1000));
                    const notificationId = `hearing_${caseItem.id}_${caseItem.nextHearing}`;

                    // تجنب التكرار
                    if (this.notificationExists(notificationId)) return;

                    if (daysUntil < 0) {
                        // جلسة متأخرة
                        this.createNotification({
                            id: notificationId,
                            type: this.notificationTypes.OVERDUE_HEARING,
                            title: '⚠️ جلسة متأخرة',
                            message: `الدعوى ${caseItem.caseNumber} - ${caseItem.plaintiffName}`,
                            details: `الجلسة كانت مقررة في ${this.dataManager.formatDate(caseItem.nextHearing)} (متأخرة ${Math.abs(daysUntil)} يوم)`,
                            priority: 'high',
                            actionText: 'عرض الدعوى',
                            actionFn: () => showCaseDetails(caseItem.id),
                            caseId: caseItem.id
                        });
                    } else if (daysUntil === 0) {
                        // جلسة اليوم
                        this.createNotification({
                            id: notificationId,
                            type: this.notificationTypes.UPCOMING_HEARING,
                            title: '🔔 جلسة اليوم',
                            message: `الدعوى ${caseItem.caseNumber} - ${caseItem.plaintiffName}`,
                            details: `الجلسة اليوم في ${caseItem.courtName || 'المحكمة'}`,
                            priority: 'high',
                            actionText: 'عرض التفاصيل',
                            actionFn: () => showCaseDetails(caseItem.id),
                            caseId: caseItem.id
                        });
                    } else if (daysUntil === 1) {
                        // جلسة غداً
                        this.createNotification({
                            id: notificationId,
                            type: this.notificationTypes.UPCOMING_HEARING,
                            title: '📅 جلسة غداً',
                            message: `الدعوى ${caseItem.caseNumber} - ${caseItem.plaintiffName}`,
                            details: `الجلسة غداً ${this.dataManager.formatDate(caseItem.nextHearing)} في ${caseItem.courtName || 'المحكمة'}`,
                            priority: 'medium',
                            actionText: 'عرض الدعوى',
                            actionFn: () => showCaseDetails(caseItem.id),
                            caseId: caseItem.id
                        });
                    } else if (daysUntil <= 3) {
                        // جلسة خلال 3 أيام
                        this.createNotification({
                            id: notificationId,
                            type: this.notificationTypes.UPCOMING_HEARING,
                            title: '📆 جلسة قريبة',
                            message: `الدعوى ${caseItem.caseNumber} - ${caseItem.plaintiffName}`,
                            details: `الجلسة بعد ${daysUntil} يوم - ${this.dataManager.formatDate(caseItem.nextHearing)}`,
                            priority: 'medium',
                            actionText: 'عرض الدعوى',
                            actionFn: () => showCaseDetails(caseItem.id),
                            caseId: caseItem.id
                        });
                    } else if (daysUntil <= 7) {
                        // جلسة خلال أسبوع
                        this.createNotification({
                            id: notificationId,
                            type: this.notificationTypes.UPCOMING_HEARING,
                            title: '📋 جلسة خلال أسبوع',
                            message: `الدعوى ${caseItem.caseNumber} - ${caseItem.plaintiffName}`,
                            details: `الجلسة بعد ${daysUntil} يوم - ${this.dataManager.formatDate(caseItem.nextHearing)}`,
                            priority: 'low',
                            actionText: 'عرض الدعوى',
                            actionFn: () => showCaseDetails(caseItem.id),
                            caseId: caseItem.id
                        });
                    }
                });
            }

            checkNewDeductions(today) {
                const sevenDaysAgo = new Date(today.getTime() - (7 * 24 * 60 * 60 * 1000));
                
                this.dataManager.deductionsData.forEach(deduction => {
                    const deductionDate = new Date(deduction.createdAt);
                    deductionDate.setHours(0, 0, 0, 0);
                    
                    if (deductionDate >= sevenDaysAgo && deductionDate <= today) {
                        const notificationId = `deduction_${deduction.id}`;
                        
                        if (this.notificationExists(notificationId)) return;

                        const daysAgo = Math.floor((today - deductionDate) / (24 * 60 * 60 * 1000));
                        const timeText = daysAgo === 0 ? 'اليوم' : daysAgo === 1 ? 'أمس' : `منذ ${daysAgo} يوم`;

                        this.createNotification({
                            id: notificationId,
                            type: this.notificationTypes.NEW_DEDUCTION,
                            title: '💰 استقطاع جديد',
                            message: `الدعوى ${deduction.caseNumber} - ${deduction.plaintiffName}`,
                            details: `تم استقطاع ${this.dataManager.formatNumber(deduction.amount)} د.ع من ${deduction.source} ${timeText}`,
                            priority: 'medium',
                            actionText: 'عرض الاستقطاع',
                            actionFn: () => viewDeduction(deduction.id),
                            caseId: deduction.caseNumber
                        });
                    }
                });
            }

            checkCasesNeedingUpdate(today) {
                this.dataManager.casesData.forEach(caseItem => {
                    if (caseItem.status === 'مغلقة' || caseItem.status === 'تنفيذ') return;

                    const lastUpdate = new Date(caseItem.lastUpdate);
                    lastUpdate.setHours(0, 0, 0, 0);
                    
                    const daysSinceUpdate = Math.floor((today - lastUpdate) / (24 * 60 * 60 * 1000));
                    
                    if (daysSinceUpdate >= 30) {
                        const notificationId = `update_needed_${caseItem.id}_${Math.floor(daysSinceUpdate / 30)}`;
                        
                        if (this.notificationExists(notificationId)) return;

                        this.createNotification({
                            id: notificationId,
                            type: this.notificationTypes.CASE_NEEDS_UPDATE,
                            title: '⏰ دعوى تحتاج متابعة',
                            message: `الدعوى ${caseItem.caseNumber} - ${caseItem.plaintiffName}`,
                            details: `لم يتم تحديث الدعوى منذ ${daysSinceUpdate} يوم`,
                            priority: daysSinceUpdate >= 60 ? 'high' : 'medium',
                            actionText: 'تحديث الآن',
                            actionFn: () => editCase(caseItem.id),
                            caseId: caseItem.id
                        });
                    }
                });
            }

            checkHighRemainingAmounts() {
                this.dataManager.casesData.forEach(caseItem => {
                    if (caseItem.status !== 'تنفيذ') return;

                    const remaining = caseItem.amount - (caseItem.deductions || 0);
                    
                    if (remaining > 50000) {
                        const notificationId = `high_remaining_${caseItem.id}`;
                        
                        if (this.notificationExists(notificationId)) return;

                        const percentage = Math.round((remaining / caseItem.amount) * 100);

                        this.createNotification({
                            id: notificationId,
                            type: this.notificationTypes.HIGH_REMAINING_AMOUNT,
                            title: '💵 مبلغ متبقي كبير',
                            message: `الدعوى ${caseItem.caseNumber} - ${caseItem.plaintiffName}`,
                            details: `متبقي ${this.dataManager.formatNumber(remaining)} د.ع (${percentage}% من المبلغ الكلي)`,
                            priority: 'medium',
                            actionText: 'إضافة استقطاع',
                            actionFn: () => showNewDeductionModal(),
                            caseId: caseItem.id
                        });
                    }
                });
            }

            checkRecentlyCompletedCases(today) {
                const sevenDaysAgo = new Date(today.getTime() - (7 * 24 * 60 * 60 * 1000));
                
                this.dataManager.casesData.forEach(caseItem => {
                    if (caseItem.status !== 'مغلقة' && caseItem.status !== 'تنفيذ') return;

                    const lastUpdate = new Date(caseItem.lastUpdate);
                    lastUpdate.setHours(0, 0, 0, 0);
                    
                    if (lastUpdate >= sevenDaysAgo && lastUpdate <= today) {
                        const notificationId = `completed_${caseItem.id}`;
                        
                        if (this.notificationExists(notificationId)) return;

                        this.createNotification({
                            id: notificationId,
                            type: this.notificationTypes.CASE_COMPLETED,
                            title: '✅ دعوى مكتملة',
                            message: `الدعوى ${caseItem.caseNumber} - ${caseItem.plaintiffName}`,
                            details: `تم إكمال الدعوى بنجاح بمبلغ ${this.dataManager.formatNumber(caseItem.amount)} د.ع`,
                            priority: 'low',
                            actionText: 'عرض التفاصيل',
                            actionFn: () => showCaseDetails(caseItem.id),
                            caseId: caseItem.id
                        });
                    }
                });
            }

            createNotification(notification) {
                const existingNotification = this.dataManager.notificationsData.find(n => n.id === notification.id);
                if (existingNotification) return;

                const newNotification = {
                    ...notification,
                    read: false,
                    createdAt: new Date().toISOString()
                };

                this.dataManager.notificationsData.unshift(newNotification);
                
                // Keep only last 100 notifications
                if (this.dataManager.notificationsData.length > 100) {
                    this.dataManager.notificationsData = this.dataManager.notificationsData.slice(0, 100);
                }

                this.dataManager.saveData();

                // لا نعرض إشعارات منبثقة مزعجة - فقط تحديث زر الإشعارات
                // تحديث شارة الإشعارات
                if (typeof window.dataManager !== 'undefined' && window.dataManager.updateNotificationBadge) {
                    window.dataManager.updateNotificationBadge();
                }

                // إظهار إشعار سطح المكتب للإشعارات المهمة
                if (notification.priority === 'high' || notification.priority === 'medium') {
                    this.showDesktopNotification(newNotification);
                }
                
                // Update UI
                if (typeof renderAlerts === 'function') {
                    renderAlerts();
                }
                
                console.log(`📢 إشعار جديد (${notification.priority}): ${notification.title}`);
            }

            notificationExists(id) {
                return this.dataManager.notificationsData.some(n => n.id === id);
            }

            cleanOldNotifications() {
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

                this.dataManager.notificationsData = this.dataManager.notificationsData.filter(n => {
                    const notificationDate = new Date(n.createdAt);
                    return notificationDate >= thirtyDaysAgo;
                });

                this.dataManager.saveData();
            }

            markAsRead(id) {
                const notification = this.dataManager.notificationsData.find(n => n.id === id);
                if (notification && !notification.read) {
                    notification.read = true;
                    this.dataManager.saveData();
                    
                    // حفظ في LocalStorage مباشرة للتأكد
                    LocalStorage.save('notificationsData', this.dataManager.notificationsData);
                    
                    this.dataManager.updateNotificationBadge();
                    console.log('✅ تم تعليم الإشعار كمقروء:', id);
                    return true;
                }
                return false;
            }

            markAllAsRead() {
                let updated = false;
                this.dataManager.notificationsData.forEach(n => {
                    if (!n.read) {
                        n.read = true;
                        updated = true;
                    }
                });
                
                if (updated) {
                    this.dataManager.saveData();
                    
                    // حفظ في LocalStorage مباشرة للتأكد
                    LocalStorage.save('notificationsData', this.dataManager.notificationsData);
                    
                    this.dataManager.updateNotificationBadge();
                    console.log('✅ تم تعليم جميع الإشعارات كمقروءة');
                }
                return updated;
            }

            deleteNotification(id) {
                const initialLength = this.dataManager.notificationsData.length;
                this.dataManager.notificationsData = this.dataManager.notificationsData.filter(n => n.id !== id);
                
                if (this.dataManager.notificationsData.length < initialLength) {
                    this.dataManager.saveData();
                    
                    // حفظ في LocalStorage مباشرة للتأكد
                    LocalStorage.save('notificationsData', this.dataManager.notificationsData);
                    
                    this.dataManager.updateNotificationBadge();
                    console.log('🗑️ تم حذف الإشعار:', id);
                    return true;
                }
                return false;
            }

            getNotificationsByPriority() {
                const notifications = {
                    high: [],
                    medium: [],
                    low: []
                };

                this.dataManager.notificationsData.forEach(n => {
                    if (notifications[n.priority]) {
                        notifications[n.priority].push(n);
                    }
                });

                return notifications;
            }

            getNotificationsByType(type) {
                return this.dataManager.notificationsData.filter(n => n.type === type);
            }

            // دوال إضافية لإدارة إشعارات سطح المكتب
            clearShownNotifications() {
                this.shownDesktopNotifications.clear();
                this.saveShownNotifications();
                console.log('تم مسح سجل الإشعارات المعروضة');
            }

            getDesktopNotificationSettings() {
                return {
                    permission: this.desktopNotificationPermission,
                    supported: 'Notification' in window,
                    shownCount: this.shownDesktopNotifications.size
                };
            }

            testDesktopNotification() {
                if (this.desktopNotificationPermission === 'granted') {
                    const testNotification = {
                        id: 'test_notification_' + Date.now(),
                        title: '🔔 إشعار تجريبي',
                        message: 'تطبيق الإدارة القانونية',
                        details: 'إشعارات سطح المكتب تعمل بنجاح!',
                        priority: 'medium',
                        actionText: 'رائع!',
                        actionFn: () => {
                            showNotification('تم الاختبار', 'إشعارات سطح المكتب تعمل بشكل مثالي!', 'success', true);
                        }
                    };
                    
                    this.showDesktopNotification(testNotification);
                } else {
                    showNotification('إذن مطلوب', 'يرجى منح إذن الإشعارات لاختبار الميزة', 'warning', true);
                }
            }

            // Test function for in-app notifications
            testInAppNotifications() {
                const testTypes = [
                    { title: '✅ اختبار النجاح', message: 'هذا إشعار نجاح تجريبي', type: 'success' },
                    { title: '⚠️ اختبار التحذير', message: 'هذا إشعار تحذير تجريبي', type: 'warning' },
                    { title: '❌ اختبار الخطأ', message: 'هذا إشعار خطأ تجريبي', type: 'error' },
                    { title: 'ℹ️ اختبار المعلومات', message: 'هذا إشعار معلومات تجريبي', type: 'info' }
                ];

                testTypes.forEach((test, index) => {
                    setTimeout(() => {
                        showNotification(test.title, test.message, test.type, index === testTypes.length - 1);
                    }, index * 1000);
                });
            }

            // دالة لإعادة تعيين الإشعارات عند بدء تشغيل جديد
            resetForNewSession() {
                // احتفظ بالإشعارات المهمة فقط
                const importantNotifications = [...this.shownDesktopNotifications].filter(id => {
                    const notification = this.dataManager.notificationsData.find(n => n.id === id);
                    return notification && notification.priority === 'high' && !notification.read;
                });
                
                this.shownDesktopNotifications = new Set(importantNotifications);
                this.saveShownNotifications();
            }

            // دالة لإدارة الإشعارات بناءً على حالة النافذة
            handleWindowVisibility() {
                if (document.hidden) {
                    // النافذة مخفية - فعل إشعارات سطح المكتب للإشعارات الجديدة
                    this.desktopNotificationsEnabled = true;
                } else {
                    // النافذة مرئية - قلل من إشعارات سطح المكتب
                    this.desktopNotificationsEnabled = false;
                }
            }

            // Method to add notifications from external sources (like lawyer updates)
            addNotification(notificationData) {
                const newNotification = {
                    id: notificationData.id || Date.now().toString() + Math.random().toString(36).substr(2, 9),
                    title: notificationData.title,
                    message: notificationData.message,
                    details: notificationData.details || notificationData.message,
                    type: notificationData.type || 'info',
                    priority: notificationData.priority || 'medium',
                    read: false,
                    createdAt: new Date().toISOString(),
                    source: notificationData.source || 'system',
                    caseId: notificationData.caseId,
                    caseNumber: notificationData.caseNumber,
                    lawyerName: notificationData.lawyerName,
                    actionText: notificationData.actionText,
                    actionFn: notificationData.action
                };
                
                // Ensure notificationsData exists and is array
                if (!Array.isArray(this.dataManager.notificationsData)) {
                    this.dataManager.notificationsData = [];
                }
                
                // Add to the notifications array
                this.dataManager.notificationsData.unshift(newNotification);
                
                // Keep only last 100 notifications
                if (this.dataManager.notificationsData.length > 100) {
                    this.dataManager.notificationsData = this.dataManager.notificationsData.slice(0, 100);
                }
                
                // Save to localStorage explicitly
                LocalStorage.save('notificationsData', this.dataManager.notificationsData);
                
                // Update notification badge
                this.dataManager.updateNotificationBadge();
                
                // Update alerts display
                if (typeof renderAlerts === 'function') {
                    renderAlerts();
                }
                
                // Show desktop notification if priority is high or medium
                if (newNotification.priority === 'high' || newNotification.priority === 'medium') {
                    this.showDesktopNotification(newNotification);
                }
                
                console.log('تم إضافة إشعار جديد:', newNotification.title, {
                    notification: newNotification,
                    totalNotifications: this.dataManager.notificationsData.length
                });
                
                return newNotification;
            }
        }

        // Initialize Notification Manager
        window.notificationManager = null;
        
        // Make functions available globally for testing
        window.testNotifications = function() {
            console.log('🧪 بدء اختبار الإشعارات...');
            
            // Add test notifications directly to dataManager
            const testNotifications = [
                {
                    id: 'test_high_' + Date.now(),
                    title: '⚠️ تنبيه عاجل',
                    message: 'جلسة مهمة اليوم',
                    details: 'جلسة الدعوى رقم 123 اليوم الساعة 10:00 صباحاً',
                    type: 'error',
                    priority: 'high',
                    read: false,
                    createdAt: new Date().toISOString()
                },
                {
                    id: 'test_medium_' + Date.now() + 1,
                    title: '📋 تحديث متوسط',
                    message: 'استقطاع جديد',
                    details: 'تم إضافة استقطاع جديد للدعوى رقم 456',
                    type: 'warning',
                    priority: 'medium',
                    read: false,
                    createdAt: new Date().toISOString()
                },
                {
                    id: 'test_low_' + Date.now() + 2,
                    title: '✅ إشعار عادي',
                    message: 'تم حفظ البيانات',
                    details: 'تم حفظ جميع البيانات بنجاح في قاعدة البيانات',
                    type: 'success',
                    priority: 'low',
                    read: false,
                    createdAt: new Date().toISOString()
                }
            ];
            
            // Add to dataManager
            if (!Array.isArray(dataManager.notificationsData)) {
                dataManager.notificationsData = [];
            }
            
            testNotifications.forEach(notification => {
                dataManager.notificationsData.unshift(notification);
            });
            
            // Save to localStorage
            LocalStorage.save('notificationsData', dataManager.notificationsData);
            
            // Update badge
            dataManager.updateNotificationBadge();
            
            // Update alerts display
            renderAlerts();
            
            console.log('✅ تم إضافة إشعارات تجريبية:', dataManager.notificationsData.length);
            
            if (window.notificationManager) {
                window.notificationManager.testInAppNotifications();
            } else {
                console.error('❌ NotificationManager غير متاح');
            }
        };

        window.generateRealNotifications = function() {
            // منع إنشاء إشعارات متكررة
            if (sessionStorage.getItem('realNotificationsGenerated')) {
                console.log('⚠️ تم إنشاء الإشعارات الحقيقية مسبقاً');
                return;
            }
            
            console.log('🔄 إنشاء إشعارات حقيقية بناءً على البيانات...');
            
            sessionStorage.setItem('realNotificationsGenerated', 'true');
            
            if (!Array.isArray(dataManager.notificationsData)) {
                dataManager.notificationsData = [];
            }

            const stats = dataManager.getStatistics();
            
            // إشعار حالة النظام
            const systemNotification = {
                id: 'system_status_' + Date.now(),
                title: '📊 حالة النظام',
                message: 'تقرير البيانات الحالية',
                details: `الدعاوى: ${stats.totalCases} | المحامون: ${stats.totalLawyers} | المدعى عليهم: ${stats.totalDefendants} | الاستقطاعات: ${stats.totalDeductions}`,
                type: 'info',
                priority: 'medium',
                read: false,
                createdAt: new Date().toISOString()
            };

            dataManager.notificationsData.unshift(systemNotification);

            // إشعارات الدعاوى النشطة
            if (stats.pendingCases > 0) {
                const casesNotification = {
                    id: 'pending_cases_' + Date.now(),
                    title: '📋 دعاوى تحت المراجعة',
                    message: `لديك ${stats.pendingCases} دعوى تحتاج للمتابعة`,
                    details: 'يُنصح بمراجعة الدعاوى وتحديث حالتها بانتظام',
                    type: stats.pendingCases > 5 ? 'warning' : 'info',
                    priority: stats.pendingCases > 5 ? 'high' : 'medium',
                    read: false,
                    createdAt: new Date().toISOString()
                };
                dataManager.notificationsData.unshift(casesNotification);
            }

            // إشعارات مالية
            if (stats.totalDeductionsAmount > 0) {
                const financialNotification = {
                    id: 'financial_summary_' + Date.now(),
                    title: '💰 ملخص مالي',
                    message: `إجمالي الاستقطاعات: ${dataManager.formatNumber(stats.totalDeductionsAmount)} د.ع`,
                    details: `عدد الاستقطاعات: ${stats.totalDeductions}`,
                    type: 'success',
                    priority: 'low',
                    read: false,
                    createdAt: new Date().toISOString()
                };
                dataManager.notificationsData.unshift(financialNotification);
            }

            // فحص الجلسات القادمة
            const today = new Date();
            const upcomingHearings = dataManager.casesData.filter(caseItem => {
                if (!caseItem.nextHearing) return false;
                const hearingDate = new Date(caseItem.nextHearing);
                const daysUntil = Math.floor((hearingDate - today) / (24 * 60 * 60 * 1000));
                return daysUntil >= 0 && daysUntil <= 7;
            });

            if (upcomingHearings.length > 0) {
                const hearingsNotification = {
                    id: 'upcoming_hearings_' + Date.now(),
                    title: '📅 جلسات قادمة',
                    message: `لديك ${upcomingHearings.length} جلسة خلال الأسبوع القادم`,
                    details: upcomingHearings.map(c => `${c.caseNumber} - ${dataManager.formatDate(c.nextHearing)}`).join(', '),
                    type: 'warning',
                    priority: 'high',
                    read: false,
                    createdAt: new Date().toISOString()
                };
                dataManager.notificationsData.unshift(hearingsNotification);
            }

            // Save to localStorage
            LocalStorage.save('notificationsData', dataManager.notificationsData);
            
            // Update badge and UI
            dataManager.updateNotificationBadge();
            renderAlerts();
            
            console.log('✅ تم إنشاء إشعارات حقيقية:', dataManager.notificationsData.length);
        };

        window.testDesktopNotifications = function() {
            console.log('🧪 بدء اختبار إشعارات سطح المكتب...');
            
            if (window.notificationManager) {
                window.notificationManager.testDesktopNotification();
            } else {
                console.error('❌ NotificationManager غير متاح');
            }
        };

        window.testSingleNotification = function(title = 'اختبار', message = 'رسالة تجريبية', type = 'info', persistent = false) {
            console.log(`🧪 اختبار إشعار واحد: ${title}`);
            showNotification(title, message, type, persistent);
        };

        window.clearAllNotifications = function() {
            console.log('🧹 مسح جميع الإشعارات...');
            closeAllNotifications();
        };

        window.resetNotifications = function() {
            console.log('🔄 إعادة تعيين نظام الإشعارات...');
            dataManager.notificationsData = [];
            LocalStorage.save('notificationsData', []);
            dataManager.updateNotificationBadge();
            renderAlerts();
            console.log('✅ تم إعادة تعيين نظام الإشعارات');
        };

        window.debugNotifications = function() {
            console.log('🔍 فحص حالة نظام الإشعارات:', {
                notificationsData: dataManager.notificationsData,
                localStorage: LocalStorage.load('notificationsData', []),
                notificationManager: window.notificationManager,
                badge: document.querySelector('.notification-badge')?.textContent
            });
        };

        window.closeModal = function() {
            const modals = document.querySelectorAll('.modal-overlay');
            modals.forEach(modal => {
                modal.remove();
            });
        };

        // Add function to force notification refresh
        window.refreshNotifications = function() {
            console.log('🔄 تحديث نظام الإشعارات...');
            
            // Force reload from localStorage
            dataManager.notificationsData = LocalStorage.load('notificationsData', []);
            
            // Update badge
            dataManager.updateNotificationBadge();
            
            // Update alerts
            renderAlerts();
            
            console.log('✅ تم تحديث نظام الإشعارات:', dataManager.notificationsData.length);
        };
        window.dataManager = dataManager;

        // Utility Functions
        function getStatusBadgeClass(status) {
            const statusClasses = {
                'مسودة': 'status-under-trial',
                'مرفوع': 'status-judgment-issued',
                'تحت المراجعة': 'status-under-trial',
                'في المحكمة': 'status-notification-issued',
                'صدور حكم': 'status-judgment-issued',
                'تبليغ بالحكم': 'status-notification-issued',
                'تنفيذ': 'status-execution',
                'مغلق': 'status-under-trial'
            };
            return statusClasses[status] || 'status-under-trial';
        }

        function showNotification(title, message, type = 'info', persistent = false) {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const icon = {
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-triangle',
                warning: 'fas fa-exclamation-circle',
                info: 'fas fa-info-circle'
            }[type];
            
            // Create unique ID for this notification
            const notificationId = 'notif_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            notification.setAttribute('data-notification-id', notificationId);
            
            notification.innerHTML = `
                <div class="notification-content">
                    <div class="notification-icon">
                        <i class="${icon}"></i>
                    </div>
                    <div class="notification-text">
                        <div class="notification-title">${title}</div>
                        <div class="notification-message">${message}</div>
                    </div>
                    <button class="notification-close" onclick="closeNotification('${notificationId}')" title="إغلاق">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            container.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            
            // Auto-hide based on type and persistence
            let autoHideDelay;
            if (persistent) {
                autoHideDelay = 0; // Don't auto-hide persistent notifications
            } else {
                switch(type) {
                    case 'success':
                        autoHideDelay = 4000; // 4 seconds for success
                        break;
                    case 'info':
                        autoHideDelay = 6000; // 6 seconds for info
                        break;
                    case 'warning':
                        autoHideDelay = 8000; // 8 seconds for warnings
                        break;
                    case 'error':
                        autoHideDelay = 10000; // 10 seconds for errors
                        break;
                    default:
                        autoHideDelay = 5000;
                }
            }
            
            if (autoHideDelay > 0) {
                setTimeout(() => {
                    closeNotification(notificationId);
                }, autoHideDelay);
            }

            // Only add to notifications data without triggering save chain
            const newNotification = {
                id: Date.now(),
                title,
                message,
                type,
                read: false,
                createdAt: new Date().toISOString(),
                priority: type === 'error' ? 'high' : type === 'warning' ? 'medium' : 'low',
                details: message // Add details field
            };
            
            // Make sure notificationsData is initialized
            if (!Array.isArray(dataManager.notificationsData)) {
                dataManager.notificationsData = [];
            }
            
            dataManager.notificationsData.unshift(newNotification);
            if (dataManager.notificationsData.length > 50) {
                dataManager.notificationsData = dataManager.notificationsData.slice(0, 50);
            }
            
            // Save to localStorage explicitly
            LocalStorage.save('notificationsData', dataManager.notificationsData);
            
            dataManager.updateNotificationBadge();
            
            // Log notification for debugging
            console.log(`📨 إشعار جديد: ${title} - ${message}`, {
                notification: newNotification,
                totalNotifications: dataManager.notificationsData.length
            });
        }

        // Function to close specific notification
        function closeNotification(notificationId) {
            const notification = document.querySelector(`[data-notification-id="${notificationId}"]`);
            if (notification) {
                notification.classList.remove('show');
                setTimeout(() => {
                    const container = document.getElementById('notification-container');
                    if (container && container.contains(notification)) {
                        container.removeChild(notification);
                    }
                }, 300);
            }
        }

        // Function to close all notifications
        function closeAllNotifications() {
            const container = document.getElementById('notification-container');
            const notifications = container.querySelectorAll('.notification');
            notifications.forEach(notification => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (container.contains(notification)) {
                        container.removeChild(notification);
                    }
                }, 300);
            });
        }

        // Chat Functions
        let currentSelectedLawyer = null;
        let previousAdminMessageCount = 0; // لتتبع الرسائل السابقة في التطبيق الرئيسي
        // متغير عام لإيقاف التحديثات التلقائية
        window.autoRefreshDisabled = true;
        
        // دالة لإيقاف جميع فترات التحديث
        function stopAllAutoRefresh() {
            // إيقاف تحديثات الدردشة
            if (window.chatPeriodicRefresh) {
                clearInterval(window.chatPeriodicRefresh);
                window.chatPeriodicRefresh = null;
            }
            
            if (window.conversationRefresh) {
                clearInterval(window.conversationRefresh);
                window.conversationRefresh = null;
            }
            
            if (window.chatRefreshInterval) {
                clearInterval(window.chatRefreshInterval);
                window.chatRefreshInterval = null;
            }
            
            console.log('⏹️ تم إيقاف جميع التحديثات التلقائية نهائياً');
        }

        let chatRefreshInterval = null;

        function initializeChat() {
            console.log('🔄 تهيئة نظام الدردشة...');
            
            // Initialize real-time monitoring
            refreshChatData();
            
            // Update chat badge
            dataManager.updateChatBadge();
            
            // Load lawyers list
            renderLawyersList();
            
            // Set up real-time listeners for immediate updates
            if (window.firebaseManager && window.firebaseManager.database) {
                console.log('🔄 إعداد المراقبة الفورية للرسائل...');
                
                // Monitor chat messages in real-time
                window.firebaseManager.database.ref('chat/admin/messages')
                    .on('child_added', (snapshot) => {
                        const message = snapshot.val();
                        if (message && message.from && message.from !== 'admin') {
                            // New message from lawyer
                            console.log('📨 رسالة فورية جديدة من المحامي:', message.lawyerName || message.from);
                            
                            const exists = dataManager.chatData.some(msg => msg.id === message.id);
                            if (!exists) {
                                // Find or create lawyer entry
                                let lawyer = dataManager.lawyersData.find(l => l.id === message.from);
                                if (!lawyer) {
                                    lawyer = {
                                        id: message.from,
                                        name: message.lawyerName || 'محامي غير معروف',
                                        specialization: 'محامي'
                                    };
                                    dataManager.lawyersData.push(lawyer);
                                    console.log('➕ إضافة محامي جديد:', lawyer.name);
                                }
                                
                                // Add the message
                                dataManager.addChatMessage(message.from, message.message, true);
                                
                                // Force UI updates
                                dataManager.updateNotificationBadge();
                                dataManager.updateChatBadge();
                                
                                // Update UI immediately
                                renderLawyersList();
                                if (currentSelectedLawyer === message.from) {
                                    renderChatConversation(message.from);
                                }
                                
                                console.log('🔔 تم إرسال إشعار للرسالة من:', lawyer.name);
                                console.log('📊 إجمالي الإشعارات غير المقروءة:', dataManager.getUnreadNotificationsCount());
                                
                                // Show browser notification if supported
                                if ('Notification' in window && Notification.permission === 'granted') {
                                    const browserNotification = new Notification(`رسالة جديدة من ${lawyer.name}`, {
                                        body: message.message.substring(0, 100),
                                        icon: '/assets/icon.png',
                                        tag: 'chat_' + message.from
                                    });
                                    
                                    browserNotification.onclick = () => {
                                        window.focus();
                                        showTab('chat');
                                        setTimeout(() => selectLawyer(message.from), 100);
                                        browserNotification.close();
                                    };
                                }
                            }
                        }
                    });
            }
            
            // تم إلغاء التحديث التلقائي لمنع إعادة الرسائل المحذوفة
            console.log('✅ تم تهيئة نظام الدردشة بنجاح');
        }

        function renderLawyersList() {
            const lawyersList = document.getElementById('lawyers-list');
            if (!lawyersList) return;

            const lawyers = dataManager.lawyersData;
            const activeLawyers = dataManager.getActiveLawyers();

            if (lawyers.length === 0) {
                lawyersList.innerHTML = `
                    <div style="padding: 2rem; text-align: center; color: var(--gray-500);">
                        <i class="fas fa-user-tie" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <p>لا يوجد محامون مسجلون</p>
                        <button class="btn btn-primary" onclick="showTab('lawyers')" style="margin-top: 1rem; font-size: 0.875rem;">
                            <i class="fas fa-plus"></i>
                            إضافة محامي
                        </button>
                    </div>
                `;
                return;
            }

            lawyersList.innerHTML = lawyers.map(lawyer => {
                const isActive = activeLawyers.some(al => al.id === lawyer.id);
                const unreadCount = dataManager.getUnreadChatCount(lawyer.id);
                const isSelected = currentSelectedLawyer && currentSelectedLawyer.toString() === lawyer.id.toString();
                
                // Get last message info with detailed logging
                const messages = dataManager.getChatMessages(lawyer.id);
                console.log(`👤 ${lawyer.name} - ${messages.length} رسالة - غير مقروءة: ${unreadCount}`);
                
                const lastMessage = messages.length > 0 ? messages[messages.length - 1] : null;
                const lastMessageTime = lastMessage ? dataManager.formatTime(lastMessage.timestamp) : '';
                const lastMessagePreview = lastMessage ? 
                    (lastMessage.message.length > 25 ? lastMessage.message.substring(0, 25) + '...' : lastMessage.message) : 
                    'لا توجد رسائل';

                return `
                    <div class="lawyer-item ${isSelected ? 'active' : ''} ${unreadCount > 0 ? 'has-unread' : ''}" 
                         onclick="selectLawyer('${lawyer.id}')"
                         title="النقر لعرض المحادثة مع ${lawyer.name}">
                        ${unreadCount > 0 ? `<div class="unread-count">${unreadCount}</div>` : ''}
                        <div class="lawyer-name">
                            ${lawyer.name}
                            ${unreadCount > 0 ? `<i class="fas fa-comment-dots" style="color: var(--primary); margin-right: 0.5rem; animation: pulse 1.5s infinite;"></i>` : ''}
                        </div>
                        <div class="lawyer-status">
                            <div class="status-indicator ${isActive ? 'online' : ''}"></div>
                            <span>${isActive ? 'متصل الآن' : 'غير متصل'}</span>
                        </div>
                        <div style="font-size: 0.75rem; color: var(--gray-500); margin-top: 0.25rem;">
                            ${lawyer.specialization || 'محامي'}
                            ${messages.length > 0 ? `<span style="color: var(--info); font-weight: bold;"> • ${messages.length} رسالة</span>` : ''}
                            ${unreadCount > 0 ? `<span style="color: var(--primary); font-weight: bold;"> • ${unreadCount} غير مقروءة</span>` : ''}
                        </div>
                        ${lastMessage ? `
                        <div style="font-size: 0.7rem; color: var(--gray-400); margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid var(--border);">
                            <div style="margin-bottom: 0.25rem;"><strong>آخر رسالة:</strong> ${lastMessagePreview}</div>
                            <div>${lastMessageTime}</div>
                        </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function selectLawyer(lawyerId) {
            console.log('🎯 اختيار المحامي:', lawyerId);
            console.log('📊 بيانات الدردشة الحالية:', dataManager.chatData.length, 'رسالة');
            
            // Find lawyer with proper ID matching
            const lawyer = dataManager.lawyersData.find(l => l.id.toString() === lawyerId.toString());
            
            if (!lawyer) {
                console.warn('❌ لم يتم العثور على المحامي:', lawyerId);
                console.log('📋 المحامون المتاحون:', dataManager.lawyersData.map(l => ({ id: l.id, name: l.name })));
                
                showNotification('خطأ', 'لم يتم العثور على المحامي المطلوب', 'error');
                
                // Clear selection and show placeholder
                currentSelectedLawyer = null;
                renderChatConversation(null);
                renderLawyersList();
                return;
            }

            console.log('✅ تم العثور على المحامي:', lawyer.name);
            
            // Get messages before updating selection
            const messages = dataManager.getChatMessages(lawyerId);
            console.log(`💬 الرسائل مع ${lawyer.name}:`, messages.length);
            
            currentSelectedLawyer = lawyerId;

            // Mark ALL messages as read for this lawyer (both from lawyer and to lawyer)
            dataManager.chatData.forEach(msg => {
                if (msg.lawyerId && msg.lawyerId.toString() === lawyerId.toString()) {
                    msg.read = true;
                }
            });
            
            // Mark related chat notifications as read
            dataManager.notificationsData.forEach(notification => {
                if (notification.type === 'chat' && notification.lawyerId && notification.lawyerId.toString() === lawyerId.toString()) {
                    notification.read = true;
                }
            });
            
            // Save the updated data
            LocalStorage.save('chatData', dataManager.chatData);
            LocalStorage.save('notificationsData', dataManager.notificationsData);
            
            // Update all badges and notifications immediately
            dataManager.updateChatBadge();
            dataManager.updateNotificationBadge();
            
            console.log('📖 تم تعيين جميع رسائل المحامي', lawyer.name, 'كمقروءة');
            
            // Update UI immediately to hide counters
            renderLawyersList();
            renderChatConversation(lawyerId);
            
            // إيقاف التحديث التلقائي نهائياً لمنع عودة الرسائل المحذوفة
            if (window.chatPeriodicRefresh) {
                clearInterval(window.chatPeriodicRefresh);
                console.log('⏸️ تم إيقاف التحديث التلقائي نهائياً');
            }
            
            if (window.conversationRefresh) {
                clearInterval(window.conversationRefresh);
                console.log('⏸️ تم إيقاف تحديث المحادثة التلقائي');
            }
        }

        function renderChatConversation(lawyerId) {
            const chatMain = document.getElementById('chat-main');
            if (!chatMain) return;

            // Reset current selected lawyer if lawyer not found
            if (!lawyerId) {
                currentSelectedLawyer = null;
                chatMain.innerHTML = `
                    <div class="chat-placeholder">
                        <i class="fas fa-comment-dots"></i>
                        <h3>اختر محامياً لبدء المحادثة</h3>
                        <p>سيتم عرض الرسائل هنا عند اختيار محامي من القائمة</p>
                    </div>
                `;
                return;
            }

            const lawyer = dataManager.lawyersData.find(l => l.id.toString() === lawyerId.toString());
            if (!lawyer) {
                console.warn('لم يتم العثور على المحامي مع ID:', lawyerId);
                console.log('المحامون المتاحون:', dataManager.lawyersData.map(l => ({ id: l.id, name: l.name })));
                
                // Reset and show placeholder
                currentSelectedLawyer = null;
                chatMain.innerHTML = `
                    <div class="chat-placeholder">
                        <i class="fas fa-user-slash" style="color: var(--error-red); margin-bottom: 1rem;"></i>
                        <h3 style="color: var(--error-red);">محامي غير موجود</h3>
                        <p>المحامي المطلوب غير موجود في النظام</p>
                        <button class="btn btn-primary" onclick="refreshChatData(); renderLawyersList();">
                            <i class="fas fa-sync"></i>
                            تحديث القائمة
                        </button>
                    </div>
                `;
                return;
            }

            // Get messages for this lawyer with detailed logging
            const messages = dataManager.getChatMessages(lawyerId);
            console.log(`💬 عرض محادثة ${lawyer.name}:`, {
                lawyerId: lawyerId,
                messagesCount: messages.length,
                messages: messages
            });

            const activeLawyers = dataManager.getActiveLawyers();
            const isOnline = activeLawyers.some(al => al.id.toString() === lawyerId.toString());

            chatMain.innerHTML = `
                <div class="chat-conversation-header">
                    <div class="conversation-info">
                        <h3>
                            <div class="status-indicator ${isOnline ? 'online' : ''}" style="display: inline-block; margin-left: 0.5rem;"></div>
                            ${lawyer.name}
                        </h3>
                        <p>${isOnline ? 'متصل الآن' : 'غير متصل'} • ${lawyer.specialization || 'محامي'}</p>
                        <small style="color: var(--gray-500);">عدد الرسائل: ${messages.length}</small>
                    </div>
                    <div class="chat-actions">
                        <button class="btn btn-secondary" onclick="clearChatHistory('${lawyerId}')" title="مسح سجل المحادثة">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="btn btn-primary" onclick="refreshChatData()" title="تحديث">
                            <i class="fas fa-sync"></i>
                        </button>
                    </div>
                </div>
                
                <div class="messages-container" id="messages-container">
                    ${messages.length === 0 ? `
                        <div style="text-align: center; padding: 3rem; color: var(--gray-500);">
                            <i class="fas fa-comment-dots" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                            <p>لا توجد رسائل مع ${lawyer.name}</p>
                            <p style="font-size: 0.875rem;">ابدأ المحادثة بإرسال رسالة</p>
                        </div>
                    ` : messages.map((message, index) => {
                        console.log(`📨 رسالة ${index + 1}:`, message);
                        
                        // تحديد حالة التسليم والمشاهدة
                        let statusIcon = '';
                        let statusText = '';
                        let statusClass = '';
                        
                        if (!message.isFromLawyer) {
                            // للرسائل المرسلة من الإدارة
                            if (message.readByLawyer) {
                                statusIcon = '<span class="whatsapp-check double delivery-status read" title="تمت المشاهدة"></span>';
                                statusText = 'تمت المشاهدة';
                                statusClass = 'read';
                            } else if (message.delivered) {
                                statusIcon = '<span class="whatsapp-check delivery-status delivered" title="تم التسليم"></span>';
                                statusText = 'تم التسليم';
                                statusClass = 'delivered';
                            } else if (message.deliveryStatus === 'failed') {
                                statusIcon = '<i class="fas fa-exclamation-triangle delivery-status failed"></i>';
                                statusText = 'فشل الإرسال';
                                statusClass = 'failed';
                            } else {
                                statusIcon = '<i class="fas fa-clock delivery-status sending"></i>';
                                statusText = 'جاري الإرسال';
                                statusClass = 'sending';
                            }
                        }
                        
                        return `
                            <div class="message ${message.isFromLawyer ? 'received' : 'sent'}" 
                                 id="message-${message.id}"
                                 oncontextmenu="showMessageOptions(event, '${message.id}', '${lawyerId}', ${message.isFromLawyer})"
                                 ontouchstart="handleMessageTouchStart(event, '${message.id}', '${lawyerId}', ${message.isFromLawyer})"
                                 ontouchend="handleMessageTouchEnd(event)">
                                <div class="message-content">
                                    <div class="message-text">${message.message || 'رسالة فارغة'}</div>
                                    <div class="message-time">
                                        <span>${dataManager.formatDateTime(message.timestamp)}</span>
                                        <span>${message.isFromLawyer ? ' - من المحامي' : ' - من الإدارة'}</span>
                                        ${!message.isFromLawyer && statusIcon ? `
                                            <div class="delivery-status ${statusClass}" title="${statusText}">
                                                ${statusIcon}
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                
                <div class="message-input-container">
                    <textarea class="message-input" 
                              id="message-input" 
                              placeholder="اكتب رسالتك هنا..."
                              onkeypress="handleMessageKeyPress(event)"
                              rows="1"></textarea>
                    <button class="send-button" onclick="sendMessage('${lawyerId}')" id="send-button">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            `;

            // Auto-scroll to bottom
            setTimeout(() => {
                const messagesContainer = document.getElementById('messages-container');
                if (messagesContainer) {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    console.log('📜 تم التمرير لأسفل المحادثة');
                }
            }, 100);

            // Auto-resize textarea
            const messageInput = document.getElementById('message-input');
            if (messageInput) {
                messageInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 100) + 'px';
                });
            }

            console.log(`✅ تم عرض محادثة ${lawyer.name} بنجاح - ${messages.length} رسالة`);
            
            // تحديث حالة المشاهدة عند فتح المحادثة
            markMessagesAsRead(lawyerId);
        }

        // ========== نظام تتبع المشاهدة ==========
        
        async function markMessagesAsRead(lawyerId) {
            if (!lawyerId || !window.firebaseManager?.database) return;
            
            try {
                console.log('👁️ تحديث حالة المشاهدة للمحامي:', lawyerId);
                
                // تحديث حالة قراءة الإدارة للرسائل
                const readStatusUpdate = {
                    adminLastRead: Date.now(),
                    adminReadBy: 'admin',
                    lastReadUpdate: new Date().toISOString()
                };
                
                // تحديث في Firebase
                await window.firebaseManager.database.ref(`chat/admin/readStatus/${lawyerId}`).update(readStatusUpdate);
                await window.firebaseManager.database.ref(`chat/${lawyerId}/readStatus/admin`).update(readStatusUpdate);
                
                // تحديث الرسائل المحلية
                dataManager.chatData.forEach(message => {
                    if (message.lawyerId === lawyerId && message.isFromLawyer) {
                        message.readByAdmin = true;
                        message.readTimestamp = Date.now();
                    }
                });
                
                // حفظ التحديث محلياً
                LocalStorage.save('chatData', dataManager.chatData);
                
                // تحديث مؤشرات المشاهدة في واجهة المحامي
                updateReadStatusInUI(lawyerId);
                
                console.log('✅ تم تحديث حالة المشاهدة بنجاح');
                
            } catch (error) {
                console.error('❌ خطأ في تحديث حالة المشاهدة:', error);
            }
        }
        
        function updateReadStatusInUI(lawyerId) {
            // تحديث مؤشرات المشاهدة في قائمة المحادثات
            const lawyerItem = document.querySelector(`.lawyer-item[data-lawyer-id="${lawyerId}"]`);
            if (lawyerItem) {
                const unreadBadge = lawyerItem.querySelector('.unread-count');
                if (unreadBadge) {
                    unreadBadge.style.display = 'none';
                }
                
                // إضافة مؤشر "تمت المشاهدة"
                const readIndicator = lawyerItem.querySelector('.read-indicator');
                if (!readIndicator) {
                    const indicator = document.createElement('div');
                    indicator.className = 'read-indicator';
                    indicator.innerHTML = '<i class="fas fa-eye" title="تمت المشاهدة"></i>';
                    indicator.style.cssText = `
                        color: var(--primary-blue);
                        font-size: 12px;
                        margin-left: 5px;
                    `;
                    lawyerItem.querySelector('.lawyer-info').appendChild(indicator);
                }
            }
            
            // تحديث مؤشرات المشاهدة في الرسائل
            const messages = document.querySelectorAll(`#messages-container .message.sent`);
            messages.forEach(messageEl => {
                addReadIndicatorToMessage(messageEl);
            });
        }
        
        function addReadIndicatorToMessage(messageElement) {
            if (messageElement.querySelector('.read-status')) return;
            
            const readStatus = document.createElement('span');
            readStatus.className = 'read-status';
            readStatus.innerHTML = '<span class="whatsapp-check double delivery-status read" title="تمت المشاهدة"></span>';
            
            const messageTime = messageElement.querySelector('.message-time');
            if (messageTime) {
                messageTime.appendChild(readStatus);
            }
        }
        
        // مراقبة حالة المشاهدة من المحامين
        function setupReadStatusListener() {
            if (!window.firebaseManager?.database) return;
            
            // مراقبة تحديثات حالة القراءة من المحامين
            window.firebaseManager.database.ref('chat').on('child_changed', (snapshot) => {
                const lawyerId = snapshot.key;
                const data = snapshot.val();
                
                if (data && data.readStatus && data.readStatus.admin) {
                    const readStatus = data.readStatus.admin;
                    if (readStatus.lawyerLastRead) {
                        console.log(`👁️ المحامي ${lawyerId} شاهد رسائل الإدارة في:`, new Date(readStatus.lawyerLastRead));
                        updateLawyerReadStatus(lawyerId, readStatus.lawyerLastRead);
                    }
                }
            });
        }
        
        function updateLawyerReadStatus(lawyerId, readTimestamp) {
            // تحديث حالة مشاهدة المحامي للرسائل
            dataManager.chatData.forEach(message => {
                if (message.lawyerId === lawyerId && 
                    !message.isFromLawyer && 
                    message.timestamp <= readTimestamp) {
                    message.readByLawyer = true;
                    message.lawyerReadTimestamp = readTimestamp;
                }
            });
            
            // تحديث الواجهة إذا كانت المحادثة مفتوحة
            if (currentSelectedLawyer === lawyerId) {
                updateReadIndicatorsInConversation(lawyerId);
            }
            
            // حفظ التحديث
            LocalStorage.save('chatData', dataManager.chatData);
        }
        
        function updateReadIndicatorsInConversation(lawyerId) {
            const sentMessages = document.querySelectorAll('#messages-container .message.sent');
            
            sentMessages.forEach(messageEl => {
                const messageId = messageEl.id.replace('message-', '');
                const message = dataManager.chatData.find(m => m.id === messageId);
                
                if (message && message.readByLawyer) {
                    addReadIndicatorToMessage(messageEl);
                } else {
                    // إزالة مؤشر المشاهدة إذا لم تتم المشاهدة
                    const readStatus = messageEl.querySelector('.read-status');
                    if (readStatus) {
                        readStatus.remove();
                    }
                }
            });
        }

        function handleMessageKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage(currentSelectedLawyer);
            }
        }

        // ========== نظام الإشعارات الصوتية ==========
        
        function playNotificationSound() {
            try {
                const audio = document.getElementById('notification-sound');
                if (audio) {
                    // إعادة تعيين موقع التشغيل للبداية
                    audio.currentTime = 0;
                    
                    // محاولة تشغيل الصوت
                    const playPromise = audio.play();
                    
                    if (playPromise !== undefined) {
                        playPromise
                            .then(() => {
                                console.log('🔊 تم تشغيل صوت الإشعار بنجاح');
                            })
                            .catch(error => {
                                console.warn('⚠️ فشل في تشغيل صوت الإشعار:', error);
                                // محاولة بديلة
                                setTimeout(() => {
                                    try {
                                        audio.play();
                                    } catch (e) {
                                        console.warn('⚠️ فشل في المحاولة البديلة لتشغيل الصوت');
                                    }
                                }, 100);
                            });
                    }
                }
            } catch (error) {
                console.error('❌ خطأ في تشغيل صوت الإشعار:', error);
            }
        }
        
        function enableAudioInteraction() {
            // تفعيل الصوت عند أول تفاعل من المستخدم
            const audio = document.getElementById('notification-sound');
            if (audio) {
                audio.volume = 0.7; // تقليل الصوت قليلاً
                
                // محاولة تشغيل صامت لتفعيل الصوت
                audio.play().then(() => {
                    audio.pause();
                    audio.currentTime = 0;
                }).catch(() => {
                    // تجاهل الأخطاء في التشغيل الصامت
                });
            }
        }
        
        // تفعيل الصوت عند أول نقرة
        document.addEventListener('click', enableAudioInteraction, { once: true });
        document.addEventListener('keydown', enableAudioInteraction, { once: true });

        function sendMessage(lawyerId) {
            const messageInput = document.getElementById('message-input');
            const sendButton = document.getElementById('send-button');
            
            if (!messageInput || !lawyerId) return;

            const message = messageInput.value.trim();
            if (!message) return;

            // Disable input temporarily
            messageInput.disabled = true;
            sendButton.disabled = true;

            // Generate unique message ID
            const messageId = `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            const timestamp = new Date().toISOString();

            // Add message to local chat immediately for instant feedback
            const chatMessage = {
                id: messageId,
                lawyerId: lawyerId,
                message: message,
                timestamp: timestamp,
                isFromLawyer: false,
                read: true,
                delivered: false,
                readByLawyer: false,
                deliveryStatus: 'sending'
            };

            // Add to local data immediately
            dataManager.chatData.push(chatMessage);
            LocalStorage.save('chatData', dataManager.chatData);

            console.log('📤 إرسال رسالة من الإدارة:', {
                إلى: lawyerId,
                المحتوى: message.substring(0, 50) + (message.length > 50 ? '...' : ''),
                الوقت: new Date().toLocaleTimeString('ar-EG'),
                messageId: messageId
            });

            // Send to Firebase in both locations for cross-compatibility
            if (window.firebaseManager && window.firebaseManager.database) {
                const messageData = {
                    id: messageId,
                    message: message,
                    timestamp: timestamp,
                    from: 'admin',
                    to: lawyerId,
                    adminName: 'نظام الإدارة القانونية',
                    read: false
                };

                console.log('🔥 حفظ الرسالة في Firebase:', messageData);

                // Promise array to handle multiple saves
                const savePromises = [];

                // Save in admin's chat directory
                savePromises.push(
                    window.firebaseManager.database.ref(`chat/admin/messages/${messageId}`)
                        .set(messageData)
                        .then(() => {
                            console.log('✅ تم حفظ الرسالة في chat/admin/messages');
                        })
                        .catch((error) => {
                            console.error('❌ خطأ في حفظ الرسالة في admin chat:', error);
                        })
                );

                // Save in lawyer's chat directory  
                savePromises.push(
                    window.firebaseManager.database.ref(`chat/${lawyerId}/messages/${messageId}`)
                        .set(messageData)
                        .then(() => {
                            console.log('✅ تم حفظ الرسالة في chat/' + lawyerId + '/messages');
                        })
                        .catch((error) => {
                            console.error('❌ خطأ في حفظ الرسالة في lawyer chat:', error);
                        })
                );

                // Wait for all saves to complete
                Promise.all(savePromises)
                    .then(() => {
                        console.log('✅ تم حفظ الرسالة في جميع المواقع');
                        
                        // تحديث حالة التسليم في الرسالة المحلية
                        const localMessage = dataManager.chatData.find(msg => msg.id === messageId);
                        if (localMessage) {
                            localMessage.delivered = true;
                            localMessage.deliveryStatus = 'delivered';
                            localMessage.deliveredAt = new Date().toISOString();
                        }
                        
                        // حفظ التحديث محلياً
                        LocalStorage.save('chatData', dataManager.chatData);
                        
                        // تحديث الواجهة لإظهار حالة التسليم
                        if (currentSelectedLawyer === lawyerId) {
                            renderChatConversation(lawyerId);
                        }
                        
                        // Send notification to lawyer via Firebase
                        const notification = {
                            title: 'رسالة جديدة من الإدارة',
                            message: message.substring(0, 100),
                            timestamp: timestamp,
                            from: 'admin',
                            read: false
                        };
                        
                        return window.firebaseManager.database.ref(`notifications/${lawyerId}`)
                            .push(notification);
                    })
                    .then(() => {
                        console.log('✅ تم إرسال إشعار للمحامي');
                        
                        // تشغيل صوت الإشعار عند نجاح الإرسال
                        playNotificationSound();
                        
                        // Force refresh to ensure message appears
                        setTimeout(() => {
                            refreshChatData();
                        }, 1000);
                    })
                    .catch((error) => {
                        console.error('❌ خطأ في العملية:', error);
                        
                        // تحديث حالة فشل التسليم
                        const localMessage = dataManager.chatData.find(msg => msg.id === messageId);
                        if (localMessage) {
                            localMessage.deliveryStatus = 'failed';
                        }
                        
                        LocalStorage.save('chatData', dataManager.chatData);
                        
                        if (currentSelectedLawyer === lawyerId) {
                            renderChatConversation(lawyerId);
                        }
                    });
            } else {
                console.warn('⚠️ Firebase غير متاح - الرسالة محفوظة محلياً فقط');
            }

            // Clear input and update UI immediately
            messageInput.value = '';
            messageInput.style.height = 'auto';
            messageInput.disabled = false;
            sendButton.disabled = false;
            messageInput.focus();

            // Update UI immediately to show the sent message
            dataManager.updateChatBadge();
            renderChatConversation(lawyerId);
            renderLawyersList();

            showNotification('تم الإرسال', 'تم إرسال الرسالة بنجاح', 'success');
        }

        function clearChatHistory(lawyerId) {
            if (!confirm('هل أنت متأكد من حذف سجل المحادثة؟ لا يمكن التراجع عن هذا الإجراء.')) {
                return;
            }

            // Remove messages for this lawyer
            dataManager.chatData = dataManager.chatData.filter(msg => msg.lawyerId !== lawyerId);
            LocalStorage.save('chatData', dataManager.chatData);

            // Update UI
            dataManager.updateChatBadge();
            renderChatConversation(lawyerId);

            showNotification('تم الحذف', 'تم حذف سجل المحادثة بنجاح', 'success');
        }

        function refreshChatData() {
            console.log('🔄 تحديث بيانات الدردشة...');
            
            // Load messages from Firebase for all lawyers
            if (window.firebaseManager && window.firebaseManager.database) {
                console.log('🔗 Firebase متاح، محاولة جلب بيانات الدردشة...');
                
                // Load chat data from Firebase
                window.firebaseManager.database.ref('chat').once('value')
                    .then((snapshot) => {
                        if (snapshot.exists()) {
                            const chatData = snapshot.val();
                            console.log('📨 بيانات الدردشة من Firebase:', Object.keys(chatData));
                            
                            let newMessagesCount = 0;
                            
                            // تحميل قائمة الرسائل المحذوفة نهائياً
                            const deletedMessages = JSON.parse(localStorage.getItem('deletedMessages') || '[]');
                            
                            // Clear existing messages to avoid duplicates
                            const existingMessageIds = dataManager.chatData.map(msg => msg.id);
                            
                            // Process admin chat data
                            if (chatData.admin && chatData.admin.messages) {
                                console.log('📩 معالجة رسائل الإدارة:', Object.keys(chatData.admin.messages).length);
                                Object.entries(chatData.admin.messages).forEach(([messageKey, message]) => {
                                    if (message && message.from && message.from !== 'admin') {
                                        // This is a message from a lawyer to admin
                                        const messageId = message.id || messageKey;
                                        
                                        // تجاهل الرسائل المحذوفة نهائياً
                                        if (deletedMessages.includes(messageId)) {
                                            console.log('🚫 تجاهل رسالة محذوفة نهائياً:', messageId);
                                            return;
                                        }
                                        
                                        const exists = existingMessageIds.includes(messageId) || 
                                                     dataManager.chatData.some(msg => 
                                                         msg.id === messageId || 
                                                         (msg.message === message.message && 
                                                          msg.timestamp === message.timestamp &&
                                                          msg.lawyerId === message.from)
                                                     );
                                        
                                        if (!exists) {
                                            // Find lawyer info for this message
                                            let lawyer = dataManager.lawyersData.find(l => l.id.toString() === message.from.toString());
                                            if (!lawyer) {
                                                // Look for lawyer info in the message
                                                lawyer = {
                                                    id: message.from,
                                                    name: message.lawyerName || 'محامي غير معروف',
                                                    specialization: 'محامي',
                                                    license: message.lawyerLicense || 'غير محدد'
                                                };
                                                console.log('➕ إضافة محامي جديد من الرسالة:', lawyer.name);
                                            }
                                            
                                            // Add message to chat data
                                            const chatMessage = {
                                                id: messageId,
                                                lawyerId: message.from,
                                                message: message.message,
                                                timestamp: message.timestamp,
                                                isFromLawyer: true,
                                                read: false
                                            };
                                            
                                            dataManager.chatData.push(chatMessage);
                                            newMessagesCount++;
                                            console.log('📨 رسالة جديدة من:', lawyer.name, 'المحتوى:', message.message.substring(0, 30));
                                        }
                                    }
                                });
                            }
                            
                            // Process individual lawyer chat data
                            Object.keys(chatData).forEach(lawyerId => {
                                if (lawyerId !== 'admin' && chatData[lawyerId] && chatData[lawyerId].messages) {
                                    console.log(`📩 معالجة رسائل المحامي ${lawyerId}:`, Object.keys(chatData[lawyerId].messages).length);
                                    Object.entries(chatData[lawyerId].messages).forEach(([messageKey, message]) => {
                                        if (message) {
                                            const messageId = message.id || messageKey;
                                            
                                            // تجاهل الرسائل المحذوفة نهائياً
                                            if (deletedMessages.includes(messageId)) {
                                                console.log('🚫 تجاهل رسالة محذوفة نهائياً:', messageId);
                                                return;
                                            }
                                            
                                            const exists = existingMessageIds.includes(messageId) || 
                                                         dataManager.chatData.some(msg => 
                                                             msg.id === messageId || 
                                                             (msg.message === message.message && 
                                                              msg.timestamp === message.timestamp &&
                                                              msg.lawyerId === lawyerId)
                                                         );
                                            
                                            if (!exists) {
                                                if (message.from && message.from.toString() === lawyerId.toString()) {
                                                    // Message from lawyer to admin
                                                    const lawyer = dataManager.lawyersData.find(l => l.id.toString() === lawyerId.toString());
                                                    if (lawyer) {
                                                        const chatMessage = {
                                                            id: messageId,
                                                            lawyerId: lawyerId,
                                                            message: message.message,
                                                            timestamp: message.timestamp,
                                                            isFromLawyer: true,
                                                            read: false
                                                        };
                                                        
                                                        dataManager.chatData.push(chatMessage);
                                                        newMessagesCount++;
                                                        console.log('📨 رسالة من المحامي:', lawyer.name, 'المحتوى:', message.message.substring(0, 30));
                                                    }
                                                } else if (message.from === 'admin') {
                                                    // Message from admin to lawyer (our sent messages)
                                                    const adminMessage = {
                                                        id: messageId,
                                                        lawyerId: lawyerId,
                                                        message: message.message,
                                                        timestamp: message.timestamp,
                                                        isFromLawyer: false,
                                                        read: true
                                                    };
                                                    
                                                    dataManager.chatData.push(adminMessage);
                                                    console.log('📤 رسالة من الإدارة إلى:', lawyerId);
                                                }
                                            }
                                        }
                                    });
                                }
                            });
                            
                            // Save updated chat data
                            LocalStorage.save('chatData', dataManager.chatData);
                            
                            // Update UI
                            dataManager.updateChatBadge();
                            renderLawyersList();
                            
                            if (currentSelectedLawyer) {
                                renderChatConversation(currentSelectedLawyer);
                            }
                            
                            if (newMessagesCount > 0) {
                                console.log(`✅ تم إضافة ${newMessagesCount} رسالة جديدة. إجمالي الرسائل:`, dataManager.chatData.length);
                            } else {
                                console.log('📭 لا توجد رسائل جديدة. إجمالي الرسائل:', dataManager.chatData.length);
                            }
                            
                        } else {
                            console.log('📭 لا توجد بيانات دردشة في Firebase');
                        }
                    })
                    .catch((error) => {
                        console.error('❌ خطأ في جلب بيانات الدردشة:', error);
                        console.log('⚠️ استخدام البيانات المحلية بدلاً من Firebase');
                    });
                    
                // Set up real-time listeners for new messages if not already set up
                if (!window.chatListenersSetup) {
                    setupChatListeners();
                    window.chatListenersSetup = true;
                }
            } else {
                console.log('⚠️ Firebase غير متاح، استخدام البيانات المحلية فقط');
                console.log('🔗 حالة Firebase:', {
                    manager: !!window.firebaseManager,
                    database: !!window.firebaseManager?.database,
                    connected: window.firebaseManager?.isConnected
                });
            }

            // Update UI with current data
            try {
                dataManager.updateChatBadge();
                renderLawyersList();
                
                if (currentSelectedLawyer) {
                    const lawyer = dataManager.lawyersData.find(l => l.id.toString() === currentSelectedLawyer.toString());
                    if (lawyer) {
                        renderChatConversation(currentSelectedLawyer);
                    } else {
                        console.warn('لم يتم العثور على المحامي:', currentSelectedLawyer);
                        currentSelectedLawyer = null;
                    }
                }
            } catch (error) {
                console.error('❌ خطأ في تحديث واجهة الدردشة:', error);
            }
        }
        
        function setupChatListeners() {
            if (!window.firebaseManager || !window.firebaseManager.database) {
                console.log('⚠️ Firebase غير متاح لإعداد مستمعي الدردشة');
                return;
            }
            
            console.log('🔄 إعداد مستمعي الدردشة في الوقت الفعلي...');
            
            // إعداد مراقب حالة المشاهدة
            setupReadStatusListener();
            
            try {
                // Listen for new messages in admin chat
                window.firebaseManager.database.ref('chat/admin/messages')
                    .on('child_added', (snapshot) => {
                        try {
                            const messageKey = snapshot.key;
                            const message = snapshot.val();
                            console.log('👂 رسالة جديدة في admin chat:', { key: messageKey, message });
                            
                            if (message && message.from && message.from !== 'admin') {
                                // New message from lawyer to admin
                                const messageId = message.id || messageKey;
                                const exists = dataManager.chatData.some(msg => msg.id === messageId);
                                
                                if (!exists) {
                                    let lawyer = dataManager.lawyersData.find(l => l.id.toString() === message.from.toString());
                                    if (!lawyer) {
                                        lawyer = {
                                            id: message.from,
                                            name: message.lawyerName || 'محامي غير معروف',
                                            specialization: 'محامي',
                                            license: message.lawyerLicense || 'غير محدد'
                                        };
                                        dataManager.lawyersData.push(lawyer);
                                        console.log('➕ إضافة محامي جديد:', lawyer.name);
                                    }
                                    
                                    const chatMessage = {
                                        id: messageId,
                                        lawyerId: message.from,
                                        message: message.message,
                                        timestamp: message.timestamp,
                                        isFromLawyer: true,
                                        read: false
                                    };
                                    
                                    dataManager.chatData.push(chatMessage);
                                    
                                    // تشغيل صوت الإشعار عند استقبال رسالة جديدة
                                    if (previousAdminMessageCount > 0) { // تجنب التشغيل عند التحميل الأول
                                        playNotificationSound();
                                    }
                                    previousAdminMessageCount = dataManager.chatData.length;
                                    LocalStorage.save('chatData', dataManager.chatData);
                                    
                                    // Update UI immediately
                                    dataManager.updateChatBadge();
                                    renderLawyersList();
                                    
                                    if (currentSelectedLawyer && currentSelectedLawyer.toString() === message.from.toString()) {
                                        renderChatConversation(currentSelectedLawyer);
                                    }
                                    
                                    console.log('📨 رسالة جديدة في الوقت الفعلي من:', lawyer.name);
                                    showNotification('رسالة جديدة', `رسالة جديدة من ${lawyer.name}: ${message.message.substring(0, 30)}`, 'info');
                                }
                            }
                        } catch (error) {
                            console.error('❌ خطأ في معالجة رسالة admin:', error);
                        }
                    }, (error) => {
                        console.error('❌ خطأ في مستمع admin chat:', error);
                    });
                
                // Listen for changes in admin chat (for updates)
                window.firebaseManager.database.ref('chat/admin/messages')
                    .on('child_changed', (snapshot) => {
                        try {
                            const messageKey = snapshot.key;
                            const message = snapshot.val();
                            console.log('🔄 تحديث رسالة في admin chat:', { key: messageKey, message });
                            
                            // Update existing message if found
                            const messageId = message.id || messageKey;
                            const existingIndex = dataManager.chatData.findIndex(msg => msg.id === messageId);
                            
                            if (existingIndex >= 0) {
                                dataManager.chatData[existingIndex].message = message.message;
                                dataManager.chatData[existingIndex].timestamp = message.timestamp;
                                LocalStorage.save('chatData', dataManager.chatData);
                                
                                // Update UI
                                if (currentSelectedLawyer && currentSelectedLawyer.toString() === message.from.toString()) {
                                    renderChatConversation(currentSelectedLawyer);
                                }
                            }
                        } catch (error) {
                            console.error('❌ خطأ في تحديث رسالة admin:', error);
                        }
                    });
                    
                // Listen for new messages in each lawyer's chat
                dataManager.lawyersData.forEach(lawyer => {
                    if (lawyer && lawyer.id) {
                        try {
                            console.log(`👂 إعداد مستمع للمحامي: ${lawyer.name} (ID: ${lawyer.id})`);
                            
                            // Listen for new messages
                            window.firebaseManager.database.ref(`chat/${lawyer.id}/messages`)
                                .on('child_added', (snapshot) => {
                                    try {
                                        const messageKey = snapshot.key;
                                        const message = snapshot.val();
                                        console.log(`👂 رسالة جديدة من ${lawyer.name}:`, { key: messageKey, message });
                                        
                                        if (message) {
                                            const messageId = message.id || messageKey;
                                            const exists = dataManager.chatData.some(msg => msg.id === messageId);
                                            
                                            if (!exists) {
                                                let chatMessage;
                                                
                                                if (message.from && message.from.toString() === lawyer.id.toString()) {
                                                    // Message from lawyer to admin
                                                    chatMessage = {
                                                        id: messageId,
                                                        lawyerId: lawyer.id,
                                                        message: message.message,
                                                        timestamp: message.timestamp,
                                                        isFromLawyer: true,
                                                        read: false
                                                    };
                                                    
                                                    console.log('📨 رسالة جديدة في الوقت الفعلي من المحامي:', lawyer.name);
                                                    showNotification('رسالة جديدة', `رسالة من ${lawyer.name}: ${message.message.substring(0, 30)}`, 'info');
                                                } else if (message.from === 'admin') {
                                                    // Message from admin to lawyer
                                                    chatMessage = {
                                                        id: messageId,
                                                        lawyerId: lawyer.id,
                                                        message: message.message,
                                                        timestamp: message.timestamp,
                                                        isFromLawyer: false,
                                                        read: true
                                                    };
                                                    
                                                    console.log('📤 رسالة من الإدارة إلى:', lawyer.name);
                                                }
                                                
                                                if (chatMessage) {
                                                    dataManager.chatData.push(chatMessage);
                                                    LocalStorage.save('chatData', dataManager.chatData);
                                                    
                                                    // Update UI immediately
                                                    dataManager.updateChatBadge();
                                                    renderLawyersList();
                                                    
                                                    if (currentSelectedLawyer && currentSelectedLawyer.toString() === lawyer.id.toString()) {
                                                        renderChatConversation(currentSelectedLawyer);
                                                    }
                                                }
                                            }
                                        }
                                    } catch (error) {
                                        console.error(`❌ خطأ في معالجة رسالة من ${lawyer.name}:`, error);
                                    }
                                }, (error) => {
                                    console.error(`❌ خطأ في مستمع ${lawyer.name}:`, error);
                                });
                        } catch (error) {
                            console.error(`❌ خطأ في إعداد مستمع للمحامي ${lawyer.name}:`, error);
                        }
                    }
                });
                
                console.log('✅ تم إعداد مستمعي الدردشة في الوقت الفعلي');
            } catch (error) {
                console.error('❌ خطأ عام في إعداد مستمعي الدردشة:', error);
            }
        }

        function markAllChatsAsRead() {
            dataManager.chatData.forEach(msg => {
                if (msg.isFromLawyer) {
                    msg.read = true;
                }
            });
            
            LocalStorage.save('chatData', dataManager.chatData);
            dataManager.updateChatBadge();
            renderLawyersList();

            showNotification('تم التحديث', 'تم تعليم جميع الرسائل كمقروءة', 'success');
        }
        
        function initializeChatSystem() {
            console.log('🔄 تهيئة نظام الدردشة...');
            
            // إيقاف جميع التحديثات التلقائية أولاً
            stopAllAutoRefresh();
            
            // Force load chat data from localStorage first
            dataManager.chatData = LocalStorage.load('chatData', []);
            console.log('📂 تم تحميل بيانات الدردشة المحلية:', dataManager.chatData.length, 'رسالة');
            previousAdminMessageCount = dataManager.chatData.length; // تهيئة العداد
            
            // Log current lawyers for debugging
            console.log('👥 المحامون المتاحون:', dataManager.lawyersData.map(l => ({ 
                id: l.id, 
                name: l.name, 
                messages: dataManager.getChatMessages(l.id).length 
            })));
            
            // Update badge and UI
            dataManager.updateChatBadge();
            renderLawyersList();
            
            // Refresh from Firebase
            refreshChatData();
            
            // Set up periodic refresh for real-time updates - REDUCED FREQUENCY
            if (window.chatPeriodicRefresh) {
                clearInterval(window.chatPeriodicRefresh);
            }
            
            // Only refresh every 30 seconds to reduce flickering
            window.chatPeriodicRefresh = setInterval(() => {
                console.log('🔄 تحديث دوري للدردشة...');
                refreshChatData();
            }, 30000); // Increased from 5 seconds to 30 seconds
            
            console.log('✅ تم تهيئة نظام الدردشة بنجاح');
        }

        // Simulate receiving test messages
        function simulateIncomingMessage() {
            if (dataManager.lawyersData.length === 0) {
                showNotification('تنبيه', 'لا يوجد محامون لاستقبال رسائل منهم', 'warning');
                return;
            }

            const randomLawyer = dataManager.lawyersData[Math.floor(Math.random() * dataManager.lawyersData.length)];
            const testMessages = [
                'مرحباً، أريد الاستفسار عن حالة الدعوى',
                'هل هناك تحديثات جديدة؟',
                'تم تأجيل الجلسة إلى الأسبوع القادم',
                'أحتاج إلى المستندات الإضافية',
                'تم صدور الحكم لصالح موكلنا'
            ];
            
            const randomMessage = testMessages[Math.floor(Math.random() * testMessages.length)];
            
            // Set lawyer as active
            dataManager.setLawyerActive(randomLawyer.id, true);
            
            // Add message
            dataManager.addChatMessage(randomLawyer.id, randomMessage, true);
            
            // Update UI
            renderLawyersList();
            
            showNotification('رسالة تجريبية', `رسالة تجريبية من ${randomLawyer.name}: ${randomMessage.substring(0, 30)}...`, 'info');
        }
        
        function simulateFirebaseMessage() {
            if (dataManager.lawyersData.length === 0) {
                showNotification('تنبيه', 'لا يوجد محامون لمحاكاة الرسائل', 'warning');
                return;
            }

            const randomLawyer = dataManager.lawyersData[Math.floor(Math.random() * dataManager.lawyersData.length)];
            const testMessage = 'رسالة تجريبية من Firebase - هذه رسالة للاختبار';
            
            // Create message data similar to Firebase structure
            const messageData = {
                id: 'test_' + Date.now() + Math.random().toString(36).substr(2, 9),
                message: testMessage,
                timestamp: new Date().toISOString(),
                from: randomLawyer.id,
                to: 'admin',
                lawyerName: randomLawyer.name,
                lawyerLicense: randomLawyer.license,
                read: false
            };
            
            // Simulate Firebase message by adding directly to chat data
            const chatMessage = {
                id: messageData.id,
                lawyerId: randomLawyer.id,
                message: messageData.message,
                timestamp: messageData.timestamp,
                isFromLawyer: true,
                read: false
            };
            
            // Check if message already exists
            const exists = dataManager.chatData.some(msg => msg.id === messageData.id);
            if (!exists) {
                dataManager.chatData.push(chatMessage);
                LocalStorage.save('chatData', dataManager.chatData);
                
                // Update UI
                dataManager.updateChatBadge();
                renderLawyersList();
                
                if (currentSelectedLawyer && currentSelectedLawyer.toString() === randomLawyer.id.toString()) {
                    renderChatConversation(currentSelectedLawyer);
                }
                
                showNotification('رسالة Firebase تجريبية', `رسالة محاكاة من ${randomLawyer.name}`, 'info');
                
                console.log('📨 تم إنشاء رسالة Firebase تجريبية من:', randomLawyer.name);
            }
        }
        
        // Add to window to make globally accessible
        window.simulateFirebaseMessage = simulateFirebaseMessage;
        
        // Test Firebase connection function
        window.testFirebaseConnection = function() {
            console.log('🧪 اختبار اتصال Firebase...');
            
            if (!window.firebaseManager || !window.firebaseManager.database) {
                console.error('❌ Firebase غير متاح');
                showNotification('خطأ', 'Firebase غير متاح', 'error');
                return;
            }
            
            // Test write to Firebase
            const testData = {
                test: 'connection_test',
                timestamp: new Date().toISOString(),
                from: 'admin'
            };
            
            window.firebaseManager.database.ref('test/connection')
                .set(testData)
                .then(() => {
                    console.log('✅ نجح الكتابة إلى Firebase');
                    
                    // Test read from Firebase
                    return window.firebaseManager.database.ref('test/connection').once('value');
                })
                .then((snapshot) => {
                    const data = snapshot.val();
                    console.log('✅ نجح القراءة من Firebase:', data);
                    showNotification('نجح الاختبار', 'اتصال Firebase يعمل بشكل صحيح', 'success');
                    
                    // Clean up test data
                    return window.firebaseManager.database.ref('test/connection').remove();
                })
                .catch((error) => {
                    console.error('❌ فشل اختبار Firebase:', error);
                    showNotification('فشل الاختبار', 'مشكلة في اتصال Firebase', 'error');
                });
        };
        
        // Force refresh chat data function
        window.forceRefreshChat = function() {
            console.log('🔄 إجبار تحديث الدردشة...');
            
            // Clear existing chat data
            dataManager.chatData = [];
            LocalStorage.save('chatData', []);
            
            // Refresh from Firebase
            refreshChatData();
            
            showNotification('تم التحديث', 'تم إجبار تحديث بيانات الدردشة', 'info');
        };
        
        // Silent refresh function that doesn't update UI immediately
        function refreshChatDataSilently() {
            if (!window.firebaseManager || !window.firebaseManager.database) {
                return;
            }
            
            // Load chat data from Firebase silently
            window.firebaseManager.database.ref('chat').once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        const chatData = snapshot.val();
                        let newMessagesCount = 0;
                        const existingMessageIds = dataManager.chatData.map(msg => msg.id);
                        
                        // Process messages without UI updates
                        if (chatData.admin && chatData.admin.messages) {
                            Object.entries(chatData.admin.messages).forEach(([messageKey, message]) => {
                                if (message && message.from && message.from !== 'admin') {
                                    const messageId = message.id || messageKey;
                                    const exists = existingMessageIds.includes(messageId);
                                    
                                    if (!exists) {
                                        const chatMessage = {
                                            id: messageId,
                                            lawyerId: message.from,
                                            message: message.message,
                                            timestamp: message.timestamp,
                                            isFromLawyer: true,
                                            read: false
                                        };
                                        
                                        dataManager.chatData.push(chatMessage);
                                        newMessagesCount++;
                                    }
                                }
                            });
                        }
                        
                        // Process individual lawyer messages
                        Object.keys(chatData).forEach(lawyerId => {
                            if (lawyerId !== 'admin' && chatData[lawyerId] && chatData[lawyerId].messages) {
                                Object.entries(chatData[lawyerId].messages).forEach(([messageKey, message]) => {
                                    if (message) {
                                        const messageId = message.id || messageKey;
                                        const exists = existingMessageIds.includes(messageId);
                                        
                                        if (!exists) {
                                            let chatMessage;
                                            if (message.from && message.from.toString() === lawyerId.toString()) {
                                                chatMessage = {
                                                    id: messageId,
                                                    lawyerId: lawyerId,
                                                    message: message.message,
                                                    timestamp: message.timestamp,
                                                    isFromLawyer: true,
                                                    read: false
                                                };
                                            } else if (message.from === 'admin') {
                                                chatMessage = {
                                                    id: messageId,
                                                    lawyerId: lawyerId,
                                                    message: message.message,
                                                    timestamp: message.timestamp,
                                                    isFromLawyer: false,
                                                    read: true
                                                };
                                            }
                                            
                                            if (chatMessage) {
                                                dataManager.chatData.push(chatMessage);
                                                newMessagesCount++;
                                            }
                                        }
                                    }
                                });
                            }
                        });
                        
                        // Only update if there are new messages
                        if (newMessagesCount > 0) {
                            LocalStorage.save('chatData', dataManager.chatData);
                            
                            // Only update the current conversation if it's selected
                            if (currentSelectedLawyer) {
                                renderChatConversation(currentSelectedLawyer);
                            }
                            
                            console.log(`🔕 تحديث صامت: ${newMessagesCount} رسالة جديدة`);
                        }
                    }
                })
                .catch((error) => {
                    console.error('❌ خطأ في التحديث الصامت:', error);
                });
        }
        
        // Debug chat data function
        window.debugChatData = function() {
            console.log('🔍 تشخيص بيانات الدردشة...');
            console.log('📊 إجمالي الرسائل المحلية:', dataManager.chatData.length);
            console.log('📋 بيانات الدردشة الكاملة:', dataManager.chatData);
            
            // Group messages by lawyer
            const messagesByLawyer = {};
            dataManager.chatData.forEach(msg => {
                const lawyerId = msg.lawyerId.toString();
                if (!messagesByLawyer[lawyerId]) {
                    messagesByLawyer[lawyerId] = [];
                }
                messagesByLawyer[lawyerId].push(msg);
            });
            
            console.log('📊 الرسائل مجمعة حسب المحامي:', messagesByLawyer);
            console.log('👥 المحامون:', dataManager.lawyersData.map(l => ({ 
                id: l.id, 
                name: l.name, 
                messages: dataManager.getChatMessages(l.id).length,
                allMessages: messagesByLawyer[l.id.toString()] || []
            })));
            
            // Current selection info
            if (currentSelectedLawyer) {
                const selectedMessages = dataManager.getChatMessages(currentSelectedLawyer);
                console.log(`🎯 المحامي المختار حالياً: ${currentSelectedLawyer}`);
                console.log(`💬 رسائل المحامي المختار:`, selectedMessages);
            }
            
            // Check Firebase data
            if (window.firebaseManager && window.firebaseManager.database) {
                window.firebaseManager.database.ref('chat').once('value')
                    .then((snapshot) => {
                        if (snapshot.exists()) {
                            const firebaseData = snapshot.val();
                            console.log('🔥 بيانات Firebase:', firebaseData);
                            
                            // Count messages per location
                            let adminMessages = 0;
                            let lawyerMessages = 0;
                            
                            if (firebaseData.admin && firebaseData.admin.messages) {
                                adminMessages = Object.keys(firebaseData.admin.messages).length;
                                console.log('📨 رسائل في admin chat:', firebaseData.admin.messages);
                            }
                            
                            Object.keys(firebaseData).forEach(key => {
                                if (key !== 'admin' && firebaseData[key] && firebaseData[key].messages) {
                                    const count = Object.keys(firebaseData[key].messages).length;
                                    lawyerMessages += count;
                                    console.log(`📨 رسائل المحامي ${key}:`, firebaseData[key].messages);
                                }
                            });
                            
                            console.log(`📈 Firebase: ${adminMessages} رسالة في admin، ${lawyerMessages} رسالة في محامين`);
                            
                            showNotification('تشخيص', `محلي: ${dataManager.chatData.length} | Firebase: ${adminMessages + lawyerMessages}`, 'info');
                        } else {
                            console.log('📭 لا توجد بيانات دردشة في Firebase');
                            showNotification('تشخيص', 'لا توجد بيانات في Firebase', 'warning');
                        }
                    })
                    .catch((error) => {
                        console.error('❌ خطأ في جلب بيانات Firebase:', error);
                        showNotification('خطأ', 'فشل في الوصول لـ Firebase', 'error');
                    });
            } else {
                showNotification('خطأ', 'Firebase غير متاح', 'error');
            }
        };
        
        // Message options and long press handling
        let touchTimer = null;
        let isLongPress = false;
        
        function handleMessageTouchStart(event, messageId, lawyerId, isFromLawyer) {
            isLongPress = false;
            touchTimer = setTimeout(() => {
                isLongPress = true;
                showMessageOptions(event, messageId, lawyerId, isFromLawyer);
            }, 800); // 800ms for long press
        }
        
        function handleMessageTouchEnd(event) {
            if (touchTimer) {
                clearTimeout(touchTimer);
            }
            if (!isLongPress) {
                // Normal tap - hide any existing options
                hideMessageOptions();
            }
        }
        
        function showMessageOptions(event, messageId, lawyerId, isFromLawyer) {
            event.preventDefault();
            
            // Remove any existing options menu
            hideMessageOptions();
            
            const menu = document.createElement('div');
            menu.className = 'message-options-menu';
            menu.id = 'message-options-menu';
            
            menu.innerHTML = `
                <div class="message-option" onclick="deleteMessage('${messageId}', '${lawyerId}')">
                    <i class="fas fa-trash"></i>
                    <span>حذف للطرفين</span>
                </div>
                <div class="message-option" onclick="forwardMessage('${messageId}', '${lawyerId}')">
                    <i class="fas fa-share"></i>
                    <span>إعادة توجيه</span>
                </div>
                <div class="message-option cancel" onclick="hideMessageOptions()">
                    <i class="fas fa-times"></i>
                    <span>إلغاء</span>
                </div>
            `;
            
            // Position the menu
            const rect = event.target.getBoundingClientRect();
            menu.style.position = 'fixed';
            menu.style.left = rect.left + 'px';
            menu.style.top = (rect.top - 120) + 'px';
            menu.style.zIndex = '10000';
            
            document.body.appendChild(menu);
            
            // Close menu when clicking outside
            setTimeout(() => {
                document.addEventListener('click', hideMessageOptions, { once: true });
            }, 100);
        }
        
        function hideMessageOptions() {
            const menu = document.getElementById('message-options-menu');
            if (menu) {
                menu.remove();
            }
        }
        
        function deleteMessage(messageId, lawyerId) {
            if (!confirm('هل أنت متأكد من حذف هذه الرسالة نهائياً؟ لا يمكن التراجع عن هذا الإجراء.')) {
                hideMessageOptions();
                return;
            }
            
            console.log('🗑️ حذف نهائي للرسالة:', messageId, 'للمحامي:', lawyerId);
            
            // إضافة الرسالة لقائمة المحذوفة المحلية لمنع عودتها
            let deletedMessages = JSON.parse(localStorage.getItem('deletedMessages') || '[]');
            if (!deletedMessages.includes(messageId)) {
                deletedMessages.push(messageId);
                localStorage.setItem('deletedMessages', JSON.stringify(deletedMessages));
            }
            
            // Remove from local data immediately
            const messageIndex = dataManager.chatData.findIndex(msg => msg.id === messageId);
            if (messageIndex >= 0) {
                dataManager.chatData.splice(messageIndex, 1);
                LocalStorage.save('chatData', dataManager.chatData);
                console.log('✅ تم حذف الرسالة محلياً');
            }
            
            // Remove from Firebase completely
            if (window.firebaseManager && window.firebaseManager.database) {
                const deletePromises = [];
                
                // Delete completely from all Firebase paths
                deletePromises.push(
                    window.firebaseManager.database.ref(`chat/admin/${messageId}`).remove()
                );
                deletePromises.push(
                    window.firebaseManager.database.ref(`chat/${lawyerId}/${messageId}`).remove()
                );
                deletePromises.push(
                    window.firebaseManager.database.ref(`chat/admin/messages/${messageId}`).remove()
                );
                deletePromises.push(
                    window.firebaseManager.database.ref(`chat/${lawyerId}/messages/${messageId}`).remove()
                );
                
                // Mark as permanently deleted to prevent re-sync
                const deleteTimestamp = Date.now();
                deletePromises.push(
                    window.firebaseManager.database.ref(`deletedMessages/${messageId}`).set({
                        deletedAt: deleteTimestamp,
                        deletedBy: 'admin',
                        lawyerId: lawyerId,
                        permanent: true
                    })
                );
                
                Promise.all(deletePromises)
                    .then(() => {
                        console.log('✅ تم الحذف النهائي من Firebase');
                        showNotification('تم الحذف نهائياً', 'تم حذف الرسالة نهائياً ولن تعود', 'success');
                        
                        // Update UI immediately without refresh
                        renderChatConversation(lawyerId);
                        renderLawyersList();
                    })
                    .catch((error) => {
                        console.error('❌ خطأ في الحذف النهائي:', error);
                        showNotification('خطأ', 'فشل في الحذف النهائي', 'error');
                    });
            } else {
                // Update UI even if Firebase is not available
                renderChatConversation(lawyerId);
                renderLawyersList();
                showNotification('تم الحذف محلياً', 'تم حذف الرسالة من المخزن المحلي', 'info');
            }
            
            hideMessageOptions();
        }
        
        // دالة لتنظيف الرسائل المحذوفة من Firebase نهائياً
        function cleanupDeletedMessages() {
            const deletedMessages = JSON.parse(localStorage.getItem('deletedMessages') || '[]');
            
            if (deletedMessages.length > 0 && window.firebaseManager && window.firebaseManager.database) {
                console.log('🧹 تنظيف الرسائل المحذوفة من Firebase:', deletedMessages.length);
                
                const cleanupPromises = [];
                
                deletedMessages.forEach(messageId => {
                    // حذف من جميع المسارات الممكنة
                    cleanupPromises.push(
                        window.firebaseManager.database.ref(`chat/admin/${messageId}`).remove(),
                        window.firebaseManager.database.ref(`chat/admin/messages/${messageId}`).remove()
                    );
                    
                    // حذف من محادثات المحامين
                    dataManager.lawyersData.forEach(lawyer => {
                        cleanupPromises.push(
                            window.firebaseManager.database.ref(`chat/${lawyer.id}/${messageId}`).remove(),
                            window.firebaseManager.database.ref(`chat/${lawyer.id}/messages/${messageId}`).remove()
                        );
                    });
                });
                
                Promise.all(cleanupPromises)
                    .then(() => {
                        console.log('✅ تم تنظيف الرسائل المحذوفة من Firebase بنجاح');
                    })
                    .catch(error => {
                        console.error('❌ خطأ في تنظيف Firebase:', error);
                    });
            }
        }

        function forwardMessage(messageId, lawyerId) {
            const message = dataManager.chatData.find(msg => msg.id === messageId);
            if (!message) {
                hideMessageOptions();
                return;
            }
            
            // Fill the input with the message content
            const messageInput = document.getElementById('message-input');
            if (messageInput) {
                messageInput.value = `📩 رسالة معاد توجيهها: ${message.message}`;
                messageInput.focus();
            }
            
            hideMessageOptions();
            showNotification('تم التوجيه', 'تم نسخ الرسالة لإعادة الإرسال', 'info');
        }

        // Dashboard Functions
        function updateDashboardStats() {
            const stats = dataManager.getStatistics();
            
            document.getElementById('total-cases').textContent = stats.totalCases;
            document.getElementById('pending-cases').textContent = stats.pendingCases;
            document.getElementById('completed-cases').textContent = stats.completedCases;
            document.getElementById('total-amount').textContent = dataManager.formatNumber(stats.totalAmount) + ' د.ع';
            
            document.getElementById('success-rate').textContent = stats.successRate + '%';
            document.getElementById('monthly-cases').textContent = stats.monthlyCases;
            document.getElementById('avg-duration').textContent = stats.avgDuration;
        }

        function renderUpcomingHearings() {
            const container = document.getElementById('upcoming-hearings');
            const upcomingCases = dataManager.casesData
                .filter(c => c.nextHearing && new Date(c.nextHearing) >= new Date())
                .sort((a, b) => new Date(a.nextHearing) - new Date(b.nextHearing))
                .slice(0, 5);

            if (upcomingCases.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--gray-500); padding: 2rem;">لا توجد جلسات قادمة</p>';
                return;
            }

            container.innerHTML = upcomingCases.map(caseItem => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--gray-50); border-radius: 0.5rem; margin-bottom: 1rem; border-right: 4px solid var(--primary-blue);">
                    <div>
                        <div style="font-weight: 700; margin-bottom: 0.25rem;">${caseItem.plaintiffName}</div>
                        <div style="font-size: 0.875rem; color: var(--gray-600);">${caseItem.caseNumber}</div>
                    </div>
                    <div style="text-align: left;">
                        <div style="font-weight: 600; margin-bottom: 0.5rem;">${dataManager.formatDate(caseItem.nextHearing)}</div>
                        <span class="status-badge ${getStatusBadgeClass(caseItem.status)}">${caseItem.status}</span>
                    </div>
                </div>
            `).join('');
        }

        function renderAlerts() {
            const container = document.getElementById('alerts-container');
            
            console.log('🔍 فحص تنبيهات اللوحة:', {
                total: dataManager.notificationsData.length,
                unread: dataManager.notificationsData.filter(n => !n.read).length,
                high: dataManager.notificationsData.filter(n => !n.read && n.priority === 'high').length,
                medium: dataManager.notificationsData.filter(n => !n.read && n.priority === 'medium').length
            });
            
            // Get high priority notifications only for dashboard
            const recentNotifications = dataManager.notificationsData
                .filter(n => !n.read && (n.priority === 'high' || n.priority === 'medium'))
                .slice(0, 5);
            
            if (recentNotifications.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--gray-500);">
                        <i class="fas fa-check-circle" style="font-size: 2.5rem; margin-bottom: 0.5rem; color: var(--success-green);"></i>
                        <p style="font-weight: 600;">لا توجد تنبيهات عاجلة</p>
                        <p style="font-size: 0.875rem; margin-top: 0.25rem;">جميع الأمور تحت السيطرة</p>
                        <button class="btn btn-primary" style="margin-top: 1rem; font-size: 0.75rem;" onclick="renderNotifications()">
                            <i class="fas fa-sync"></i>
                            تحديث الإشعارات
                        </button>
                            إشعارات تجريبية
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = recentNotifications.map(alert => {
                const priorityStyles = {
                    high: { color: 'var(--error-red)', icon: 'exclamation-circle', bg: 'var(--error-red-light)' },
                    medium: { color: 'var(--warning-yellow)', icon: 'exclamation-triangle', bg: 'var(--warning-yellow-light)' },
                    low: { color: 'var(--primary-blue)', icon: 'info-circle', bg: 'var(--primary-blue-light)' }
                };
                
                const style = priorityStyles[alert.priority] || priorityStyles.low;
                
                return `
                    <div style="display: flex; align-items: flex-start; padding: 1rem; border-radius: 0.75rem; border-right: 4px solid ${style.color}; margin-bottom: 1rem; background: ${style.bg}; cursor: pointer; transition: all 0.3s ease;" 
                         onclick="handleNotificationClick('${alert.id}', 'execute')"
                         onmouseover="this.style.transform='translateX(-4px)'; this.style.boxShadow='var(--shadow-md)'" 
                         onmouseout="this.style.transform='none'; this.style.boxShadow='none'">
                        <i class="fas fa-${style.icon}" style="margin-left: 1rem; font-size: 1.5rem; color: ${style.color}; margin-top: 0.25rem;"></i>
                        <div style="flex: 1;">
                            <div style="font-weight: 700; margin-bottom: 0.25rem; color: var(--gray-900);">${alert.title}</div>
                            <div style="font-size: 0.875rem; color: var(--gray-700); margin-bottom: 0.25rem;">${alert.message}</div>
                            <div style="font-size: 0.75rem; color: var(--gray-600);">${alert.details}</div>
                        </div>
                        <div style="font-size: 0.75rem; color: var(--gray-500); white-space: nowrap; margin-right: 1rem;">
                            ${formatNotificationTime(alert.createdAt)}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Cases Functions
        function renderCasesTable() {
            const tbody = document.getElementById('cases-table-body');
            if (!tbody) return;

            if (dataManager.filteredCases.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 3rem; color: var(--gray-500);">
                            <i class="fas fa-file-contract" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i>
                            ${dataManager.casesData.length === 0 ? 'لا توجد دعاوى مسجلة. ابدأ بإضافة دعوى جديدة.' : 'لم يتم العثور على أي دعاوى تطابق البحث'}
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = dataManager.filteredCases.map(caseItem => `
                <tr>
                    <td>
                        <div class="client-info">
                            <div class="client-name">${caseItem.defendantName}</div>
                            <div class="client-update">
                                <i class="fas fa-user-tie"></i>
                                المحامي: ${caseItem.lawyerName || 'غير محدد'}
                            </div>
                            <div class="client-update">
                                <i class="fas fa-clock"></i>
                                آخر تحديث: ${dataManager.formatDate(caseItem.lastUpdate)}
                            </div>
                        </div>
                    </td>
                    <td>
                        <div style="display: flex; flex-direction: column;">
                            <strong style="color: var(--primary-blue); margin-bottom: 0.25rem;">${caseItem.caseNumber}</strong>
                            <span style="font-size: 0.75rem; color: var(--gray-500);">${caseItem.courtName}</span>
                        </div>
                    </td>
                    <td><strong style="color: var(--success-green);">${dataManager.formatNumber(caseItem.amount)} د.ع</strong></td>
                    <td>
                        <span style="background: var(--indigo-light); color: var(--indigo); padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600;">
                            ${caseItem.stage}
                        </span>
                    </td>
                    <td>
                        <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                            <span class="status-badge ${getStatusBadgeClass(caseItem.status)}">
                                <i class="fas fa-circle" style="font-size: 0.5rem;"></i>
                                ${caseItem.status}
                            </span>
                            <span style="font-size: 0.75rem; color: var(--gray-500); font-weight: 600;">
                                ${caseItem.priority}
                            </span>
                        </div>
                    </td>
                    <td><strong>${dataManager.formatDate(caseItem.nextHearing)}</strong></td>
                    <td>
                        <div class="actions">
                            <button class="action-btn view" onclick="showCaseDetails(${caseItem.id})" title="عرض التفاصيل">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn edit" onclick="editCase(${caseItem.id})" title="تحرير">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete" onclick="deleteCase(${caseItem.id})" title="حذف">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Defendants Functions
        function renderDefendantsTable() {
            const tbody = document.getElementById('defendants-table-body');
            if (!tbody) return;

            if (dataManager.filteredDefendants.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 3rem; color: var(--gray-500);">
                            <i class="fas fa-users" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i>
                            ${dataManager.defendantsData.length === 0 ? 'لا يوجد مدعى عليهم مسجلين. ابدأ بإضافة مدعى عليه جديد.' : 'لم يتم العثور على أي مدعى عليهم يطابقون البحث'}
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = dataManager.filteredDefendants.map(defendant => `
                <tr>
                    <td><strong style="color: var(--gray-900);">${defendant.name}</strong></td>
                    <td>${defendant.phone || '-'}</td>
                    <td>${defendant.email || '-'}</td>
                    <td>
                        <span style="background: var(--primary-blue-light); color: var(--primary-blue); padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600;">
                            ${defendant.casesCount}
                        </span>
                    </td>
                    <td>${dataManager.formatDate(defendant.registrationDate)}</td>
                    <td>
                        <div class="actions">
                            <button class="action-btn view" onclick="viewDefendant(${defendant.id})" title="عرض">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn edit" onclick="editDefendant(${defendant.id})" title="تحرير">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete" onclick="confirmDeleteDefendant(${defendant.id})" title="حذف">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Lawyers Functions  
        function renderLawyersTable() {
            const tbody = document.getElementById('lawyers-table-body');
            if (!tbody) return;

            if (dataManager.filteredLawyers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 3rem; color: var(--gray-500);">
                            <i class="fas fa-user-tie" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i>
                            ${dataManager.lawyersData.length === 0 ? 'لا يوجد محامون مسجلون. ابدأ بإضافة محامٍ جديد.' : 'لم يتم العثور على أي محامين يطابقون البحث'}
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = dataManager.filteredLawyers.map(lawyer => `
                <tr>
                    <td><strong style="color: var(--gray-900);">${lawyer.name}</strong></td>
                    <td style="color: var(--primary-blue); font-weight: 600;">${lawyer.license}</td>
                    <td>
                        <span style="background: var(--success-green-light); color: var(--success-green); padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600;">
                            ${lawyer.specialization}
                        </span>
                    </td>
                    <td>${lawyer.phone || '-'}</td>
                    <td>
                        <span style="background: var(--primary-blue-light); color: var(--primary-blue); padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600;">
                            ${lawyer.casesCount}
                        </span>
                    </td>
                    <td>${dataManager.formatDate(lawyer.registrationDate)}</td>
                    <td>
                        <div class="actions">
                            <button class="action-btn view" onclick="viewLawyer(${lawyer.id})" title="عرض">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn edit" onclick="editLawyer(${lawyer.id})" title="تحرير">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete" onclick="confirmDeleteLawyer(${lawyer.id})" title="حذف">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Deductions Functions
        function renderDeductionsTable() {
            const tbody = document.getElementById('deductions-table-body');
            if (!tbody) return;

            console.log('Debug - Rendering deductions table with', dataManager.filteredDeductions.length, 'deductions');

            if (dataManager.filteredDeductions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 3rem; color: var(--gray-500);">
                            <i class="fas fa-coins" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i>
                            ${dataManager.deductionsData.length === 0 ? 'لا توجد استقطاعات مسجلة بعد.' : 'لم يتم العثور على أي استقطاعات تطابق البحث'}
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = dataManager.filteredDeductions.map(deduction => {
                    // Handle different ID formats for onclick events
                    const deductionId = typeof deduction.id === 'string' ? `'${deduction.id}'` : deduction.id;
                    
                    return `
                    <tr>
                        <td><strong>${deduction.plaintiffName}</strong></td>
                        <td style="color: var(--primary-blue); font-weight: 600;">${deduction.caseNumber}</td>
                        <td style="color: var(--success-green); font-weight: 700;">${dataManager.formatNumber(deduction.amount)} د.ع</td>
                        <td>${dataManager.formatDate(deduction.date)}</td>
                        <td>${deduction.source}</td>
                        <td>
                            <span class="status-badge" style="background: var(--success-green-light); color: var(--success-green);">
                                <i class="fas fa-check-circle" style="font-size: 0.75rem;"></i>
                                ${deduction.status}
                            </span>
                        </td>
                        <td>
                            ${deduction.addedVia === 'mobile_app' ? 
                                '<i class="fas fa-mobile-alt" style="color: var(--primary-blue);" title="تم الإضافة من التطبيق المحمول"></i>' : 
                                '<i class="fas fa-desktop" style="color: var(--gray);" title="تم الإضافة من التطبيق الرئيسي"></i>'
                            }
                        </td>
                        <td>
                            <div class="actions">
                                <button class="action-btn view" onclick="viewDeduction(${deductionId})" title="عرض">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="action-btn edit" onclick="editDeduction(${deductionId})" title="تحرير">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="action-btn delete" onclick="confirmDeleteDeduction(${deductionId})" title="حذف">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    `;
                }).join('');
            }

            updateDeductionStats();
        }

        function updateDeductionStats() {
            const totalDeductions = dataManager.filteredDeductions.reduce((sum, d) => sum + d.amount, 0);
            const deductionsCount = dataManager.filteredDeductions.length;
            const avgDeduction = deductionsCount > 0 ? Math.round(totalDeductions / deductionsCount) : 0;
            const lastDeduction = dataManager.filteredDeductions.length > 0 ? 
                dataManager.filteredDeductions.sort((a, b) => new Date(b.date) - new Date(a.date))[0].date : 
                null;

            document.getElementById('total-deductions').textContent = dataManager.formatNumber(totalDeductions) + ' د.ع';
            document.getElementById('deductions-count').textContent = deductionsCount;
            document.getElementById('avg-deduction').textContent = dataManager.formatNumber(avgDeduction) + ' د.ع';
            document.getElementById('last-deduction-date').textContent = lastDeduction ? dataManager.formatDate(lastDeduction) : 'لا يوجد';
        }

        // File Upload Functions
        function triggerFileUpload() {
            document.getElementById('file-input').click();
        }

        function handleFileUpload(event) {
            const files = Array.from(event.target.files);
            files.forEach(file => {
                dataManager.uploadedFiles.push({
                    id: Date.now() + Math.random(),
                    name: file.name,
                    size: dataManager.formatFileSize(file.size),
                    type: file.type,
                    file: file
                });
            });
            
            renderUploadedFiles();
            showNotification('تم الرفع', `تم رفع ${files.length} ملف بنجاح`, 'success');
        }

        function captureDocument() {
            showNotification('التقاط الصورة', 'يتم تشغيل الكاميرا...', 'info');
            
            setTimeout(() => {
                const mockFile = {
                    id: Date.now(),
                    name: `مستند_${new Date().toLocaleDateString('ar-EG')}.jpg`,
                    size: '2.3 ميجابايت',
                    type: 'image/jpeg',
                    file: null
                };
                
                dataManager.uploadedFiles.push(mockFile);
                renderUploadedFiles();
                showNotification('تم الالتقاط', 'تم التقاط الصورة وحفظها بنجاح', 'success');
            }, 2000);
        }

        function renderUploadedFiles() {
            const container = document.getElementById('uploaded-files');
            
            if (dataManager.uploadedFiles.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = dataManager.uploadedFiles.map(file => `
                <div class="uploaded-file">
                    <div class="file-info">
                        <i class="fas fa-${getFileIcon(file.type)} file-icon"></i>
                        <div class="file-details">
                            <div class="file-name">${file.name}</div>
                            <div class="file-size">${file.size}</div>
                        </div>
                    </div>
                    <div class="file-actions">
                        <button class="file-action-btn view" onclick="viewFile(${file.id})" title="عرض">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="file-action-btn delete" onclick="removeFile(${file.id})" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function getFileIcon(fileType) {
            if (fileType.includes('pdf')) return 'file-pdf';
            if (fileType.includes('image')) return 'file-image';
            if (fileType.includes('word')) return 'file-word';
            return 'file';
        }

        function removeFile(fileId) {
            dataManager.uploadedFiles = dataManager.uploadedFiles.filter(f => f.id !== fileId);
            renderUploadedFiles();
            showNotification('تم الحذف', 'تم حذف الملف بنجاح', 'success');
        }

        function viewFile(fileId) {
            const file = dataManager.uploadedFiles.find(f => f.id === fileId);
            if (file) {
                showNotification('عرض الملف', `جاري فتح ${file.name}...`, 'info');
            }
        }

        // Stage change handler
        function handleStageChange() {
            const stage = document.getElementById('new-case-stage').value;
            const executionOptions = document.getElementById('execution-options');
            
            if (stage === 'التنفيذ') {
                executionOptions.classList.add('show');
            } else {
                executionOptions.classList.remove('show');
            }
        }

        function toggleExecutionOption(optionType) {
            const checkbox = document.getElementById(`execution-${optionType}`);
            checkbox.checked = !checkbox.checked;
        }

        // Search Functions
        function searchCases() {
            const searchTerm = document.getElementById('search-cases').value.trim();
            const statusFilter = document.getElementById('filter-status').value;
            
            dataManager.searchCases(searchTerm, statusFilter);
            renderCasesTable();
        }

        function searchDefendants() {
            const searchTerm = document.getElementById('search-defendants').value.trim();
            dataManager.searchDefendants(searchTerm);
            renderDefendantsTable();
        }

        function searchLawyers() {
            const searchTerm = document.getElementById('search-lawyers').value.trim();
            const specializationFilter = document.getElementById('filter-specialization').value;
            dataManager.searchLawyers(searchTerm, specializationFilter);
            renderLawyersTable();
        }

        function searchDeductions() {
            const searchTerm = document.getElementById('search-deductions').value.trim();
            dataManager.searchDeductions(searchTerm);
            renderDeductionsTable();
        }

        function filterLawyersBySpecialization() {
            const searchTerm = document.getElementById('search-lawyers').value.trim();
            const specializationFilter = document.getElementById('filter-specialization').value;
            dataManager.searchLawyers(searchTerm, specializationFilter);
            renderLawyersTable();
        }

        function sortDefendants() {
            const sortBy = document.getElementById('sort-defendants').value;
            dataManager.sortDefendants(sortBy);
            renderDefendantsTable();
        }

       async function saveNewCase() {
    const caseData = {
        caseNumber: document.getElementById('new-case-number')?.value?.trim() || '',
        fileDate: document.getElementById('new-case-file-date')?.value || '',
        priority: document.getElementById('new-case-priority')?.value || 'عادية',
        status: document.getElementById('new-case-status')?.value || 'مسودة',
        amount: parseInt(document.getElementById('new-case-amount')?.value) || 0,
        plaintiffName: document.getElementById('new-case-plaintiff-name')?.value?.trim() || '',
        plaintiffPhone: document.getElementById('new-case-plaintiff-phone')?.value?.trim() || '',
        plaintiffAddress: document.getElementById('new-case-plaintiff-address')?.value?.trim() || '',
        defendantName: document.getElementById('new-case-defendant-name')?.value?.trim() || '',
        defendantAddress: document.getElementById('new-case-defendant-address')?.value?.trim() || '',
        lawyerName: document.getElementById('new-case-lawyer-name')?.value?.trim() || '',
        courtName: document.getElementById('new-case-court-name')?.value?.trim() || '',
        courtSection: document.getElementById('new-case-court-section')?.value?.trim() || '',
        stage: document.getElementById('new-case-stage')?.value || 'مرحلة ما قبل المحاكمة',
        nextHearing: document.getElementById('new-case-hearing')?.value || '',
        notes: document.getElementById('new-case-notes')?.value?.trim() || '',
        documents: dataManager.uploadedFiles.map(f => f.name)
    };

    // Validation - التحقق من البيانات المطلوبة
    if (!caseData.lawyerName) {
        showNotification('خطأ', 'يرجى اختيار المحامي المسؤول عن الدعوى', 'error');
        return;
    }

    if (!caseData.caseNumber) {
        showNotification('خطأ', 'يرجى إدخال رقم الدعوى', 'error');
        return;
    }

    // Check if case number already exists
    if (dataManager.casesData.some(c => c.caseNumber === caseData.caseNumber)) {
        showNotification('خطأ', 'رقم الدعوى موجود بالفعل', 'error');
        return;
    }

    // Get execution options
    const executionOptions = [];
    if (document.getElementById('execution-seizure').checked) executionOptions.push('تم الحجز');
    if (document.getElementById('execution-deduction').checked) executionOptions.push('تم الاستقطاع');
    caseData.executionOptions = executionOptions;

    try {
        const newCase = await dataManager.addCase(caseData);
        
        // إرسال إشعار للمحامي عن الدعوى الجديدة
        if (caseData.lawyerName && newCase && newCase.id && caseData.caseNumber) {
            const notification = {
                id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                type: 'new-case',
                title: 'دعوى جديدة',
                description: `تم تخصيص دعوى جديدة رقم ${caseData.caseNumber} لك من قبل الإدارة`,
                targetLawyer: caseData.lawyerName,
                caseId: newCase.id,
                caseNumber: caseData.caseNumber,
                timestamp: new Date().toISOString(),
                read: false,
                source: 'main_app'
            };
            
            // التأكد من أن جميع البيانات المطلوبة موجودة
            if (notification.caseId && notification.caseNumber && notification.targetLawyer) {
                // حفظ الإشعار في Firebase
                database.ref('notifications').push(notification).catch(error => {
                    console.warn('خطأ في إرسال الإشعار:', error);
                });
            } else {
                console.warn('تم تخطي إرسال الإشعار - بيانات ناقصة:', {
                    caseId: notification.caseId,
                    caseNumber: notification.caseNumber,
                    targetLawyer: notification.targetLawyer
                });
            }
        }
    } catch (error) {
        console.error('خطأ في حفظ الدعوى:', error);
        showNotification('خطأ', 'حدث خطأ أثناء حفظ الدعوى', 'error');
        return;
    }
    
    // تحديث عدد الدعاوى للمحامي
    if (caseData.lawyerName) {
        const lawyer = dataManager.lawyersData.find(l => l.name === caseData.lawyerName);
        if (lawyer) {
            lawyer.casesCount = (lawyer.casesCount || 0) + 1;
            dataManager.saveData();
        }
    }
    
    renderCasesTable();
    renderDefendantsTable();
    renderLawyersTable();
    updateDashboardStats();
    showTab('cases');
    showNotification('نجح الحفظ', `تم إضافة الدعوى ${caseData.caseNumber} بنجاح`, 'success');
    
    clearNewCaseForm();
}

        function saveNewDefendant() {
            const name = document.getElementById('new-defendant-name').value.trim();
            const phone = document.getElementById('new-defendant-phone').value.trim();
            const email = document.getElementById('new-defendant-email').value.trim();
            const workplace = document.getElementById('new-defendant-workplace').value.trim();
            const address = document.getElementById('new-defendant-address').value.trim();

            if (!name) {
                showNotification('خطأ', 'يرجى إدخال اسم المدعى عليه', 'error');
                return;
            }

            // Check if defendant already exists
            if (dataManager.defendantsData.some(d => d.name === name)) {
                showNotification('خطأ', 'هذا المدعى عليه موجود بالفعل', 'error');
                return;
            }

            const defendantData = {
                name,
                phone: phone || '',
                email: email || '',
                workplace: workplace || '',
                address: address || ''
            };

            dataManager.addDefendant(defendantData);
            renderDefendantsTable();
            showTab('defendants');
            showNotification('نجح الحفظ', 'تم إضافة المدعى عليه بنجاح', 'success');
            
            clearNewDefendantForm();
        }

       function saveNewLawyer() {
    const name = document.getElementById('new-lawyer-name').value.trim();
    const license = document.getElementById('new-lawyer-license').value.trim();
    const phone = document.getElementById('new-lawyer-phone').value.trim();
    const specialization = document.getElementById('new-lawyer-specialization').value;
    const experience = document.getElementById('new-lawyer-experience').value;
    const address = document.getElementById('new-lawyer-address').value.trim();
    const notes = document.getElementById('new-lawyer-notes').value.trim();

    if (!name || !license) {
        showNotification('خطأ', 'يرجى ملء الحقول المطلوبة (الاسم، رقم الترخيص)', 'error');
        return;
    }

    // Check if lawyer already exists
    if (dataManager.lawyersData.some(l => l.license === license)) {
        showNotification('خطأ', 'رقم الترخيص موجود بالفعل', 'error');
        return;
    }

    const lawyerData = {
        name,
        license,
        phone: phone || '',
        specialization,
        experience: experience || 0,
        address: address || '',
        notes: notes || ''
    };

    dataManager.addLawyer(lawyerData);
    renderLawyersTable();
    updateLawyerSelector();
    showTab('lawyers');
    showNotification('نجح الحفظ', 'تم إضافة المحامي بنجاح', 'success');
    
    clearNewLawyerForm();
}
        // Update lawyer selector in new case form
        function updateLawyerSelector() {
            const selector = document.getElementById('new-case-lawyer-select');
            if (selector) {
                // Keep existing options and add new lawyers
                const existingOptions = selector.innerHTML;
                const lawyerOptions = dataManager.lawyersData.map(lawyer => 
                    `<option value="${lawyer.id}">${lawyer.name}</option>`
                ).join('');
                
                selector.innerHTML = `
                    <option value="">اختر المحامي</option>
                    ${lawyerOptions}
                    <option value="manual">إدخال يدوي</option>
                `;
            }
        }

        // Clear form functions
        function clearNewCaseForm() {
            const elements = [
                'new-case-number', 'new-case-file-date', 'new-case-priority', 'new-case-status',
                'new-case-amount', 'new-case-plaintiff-name', 'new-case-plaintiff-phone',
                'new-case-plaintiff-address', 'new-case-defendant-name', 'new-case-defendant-address',
                'new-case-lawyer-select', 'new-case-lawyer-name', 'new-case-court-name',
                'new-case-court-section', 'new-case-stage', 'new-case-hearing', 'new-case-notes'
            ];
            
            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = false;
                    } else {
                        element.value = '';
                    }
                }
            });
            
            // Set default values
            const priorityEl = document.getElementById('new-case-priority');
            if (priorityEl) priorityEl.value = 'عادية';
            
            const statusEl = document.getElementById('new-case-status');
            if (statusEl) statusEl.value = 'مسودة';
            
            const stageEl = document.getElementById('new-case-stage');
            if (stageEl) stageEl.value = 'إعداد الدعوى';
            
            // Handle checkboxes and additional elements
            const seizureEl = document.getElementById('execution-seizure');
            if (seizureEl) seizureEl.checked = false;
            
            const deductionEl = document.getElementById('execution-deduction');
            if (deductionEl) deductionEl.checked = false;
            
            const executionOptionsEl = document.getElementById('execution-options');
            if (executionOptionsEl) executionOptionsEl.classList.remove('show');
            
            const manualLawyerEl = document.getElementById('manual-lawyer-field');
            if (manualLawyerEl) manualLawyerEl.style.display = 'none';
            dataManager.uploadedFiles = [];
            renderUploadedFiles();
        }

        function clearNewDefendantForm() {
            document.getElementById('new-defendant-name').value = '';
            document.getElementById('new-defendant-phone').value = '';
            document.getElementById('new-defendant-email').value = '';
            document.getElementById('new-defendant-workplace').value = '';
            document.getElementById('new-defendant-address').value = '';
        }

        function clearNewLawyerForm() {
            document.getElementById('new-lawyer-name').value = '';
            document.getElementById('new-lawyer-license').value = '';
            document.getElementById('new-lawyer-phone').value = '';
            document.getElementById('new-lawyer-specialization').value = '';
            document.getElementById('new-lawyer-experience').value = '';
            document.getElementById('new-lawyer-address').value = '';
            document.getElementById('new-lawyer-notes').value = '';
        }

        // Modal Functions
        function showNewCaseModal() {
            showTab('new-case');
            document.getElementById('new-case-file-date').value = new Date().toISOString().split('T')[0];
            updateLawyerSelector();
        }

        function showNewDeductionModal() {
            if (dataManager.casesData.length === 0) {
                showNotification('تنبيه', 'يجب إضافة دعوى أولاً قبل إضافة استقطاع', 'warning');
                return;
            }

            const content = `
                <div class="form-container">
                    <div class="form-field">
                        <label><i class="fas fa-file"></i>الدعوى</label>
                        <select id="new-deduction-case" onchange="updateCaseInfo()">
                            <option value="">اختر الدعوى</option>
                            ${dataManager.casesData.map(c => `<option value="${c.id}">${c.caseNumber} - ${c.plaintiffName}</option>`).join('')}
                        </select>
                    </div>
                    <div id="case-remaining-amount" class="remaining-amount" style="display: none;">
                        <div class="remaining-amount-label">المبلغ المتبقي للاستقطاع</div>
                        <div class="remaining-amount-value" id="remaining-amount-value">0 د.ع</div>
                    </div>
                    <div class="form-field">
                        <label><i class="fas fa-dollar-sign"></i>المبلغ المستقطع (د.ع)</label>
                        <input type="number" id="new-deduction-amount" placeholder="مثال: 15000">
                    </div>
                    <div class="form-field">
                        <label><i class="fas fa-calendar"></i>تاريخ الاستقطاع</label>
                        <input type="date" id="new-deduction-date" value="${new Date().toISOString().split('T')[0]}">
                    </div>
                    <div class="form-field">
                        <label><i class="fas fa-building"></i>المصدر</label>
                        <select id="new-deduction-source">
                            <option value="محكمة البداءة">محكمة البداءة</option>
                            <option value="دائرة التنفيذ">دائرة التنفيذ</option>
                            <option value="محكمة الاستئناف">محكمة الاستئناف</option>
                            <option value="أخرى">أخرى</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label><i class="fas fa-comment"></i>ملاحظات</label>
                        <textarea id="new-deduction-notes" placeholder="أي ملاحظات إضافية..."></textarea>
                    </div>
                </div>
            `;
            
            const actions = `
                <button class="btn btn-secondary" onclick="closeModal(this)">إلغاء</button>
                <button class="btn btn-primary" onclick="saveNewDeduction()">
                    <i class="fas fa-save"></i>
                    حفظ الاستقطاع
                </button>
            `;
            
            createModal('استقطاع جديد', content, actions);
        }

        function updateCaseInfo() {
            const caseId = document.getElementById('new-deduction-case').value;
            const remainingAmountDiv = document.getElementById('case-remaining-amount');
            
            if (caseId) {
                const caseItem = dataManager.getCaseById(parseInt(caseId));
                if (caseItem) {
                    const remaining = caseItem.amount - caseItem.deductions;
                    document.getElementById('remaining-amount-value').textContent = dataManager.formatNumber(remaining) + ' د.ع';
                    remainingAmountDiv.style.display = 'block';
                } else {
                    remainingAmountDiv.style.display = 'none';
                }
            } else {
                remainingAmountDiv.style.display = 'none';
            }
        }

        function saveNewDeduction() {
            const caseId = document.getElementById('new-deduction-case').value;
            const amount = parseInt(document.getElementById('new-deduction-amount').value);
            const date = document.getElementById('new-deduction-date').value;
            const source = document.getElementById('new-deduction-source').value;
            const notes = document.getElementById('new-deduction-notes').value;

            if (!caseId || !amount || !date) {
                showNotification('خطأ', 'يرجى ملء جميع الحقول المطلوبة', 'error');
                return;
            }

            const caseItem = dataManager.getCaseById(parseInt(caseId));
            if (!caseItem) {
                showNotification('خطأ', 'لم يتم العثور على الدعوى', 'error');
                return;
            }

            const remaining = caseItem.amount - caseItem.deductions;
            if (amount > remaining) {
                showNotification('خطأ', `المبلغ المستقطع أكبر من المبلغ المتبقي (${dataManager.formatNumber(remaining)} د.ع)`, 'error');
                return;
            }

            const deductionData = {
                plaintiffName: caseItem.plaintiffName,
                caseNumber: caseItem.caseNumber,
                amount,
                date,
                source,
                notes: notes || ''
            };

            dataManager.addDeduction(deductionData);
            renderDeductionsTable();
            renderCasesTable();
            updateDashboardStats();
            closeModal(event.target);
            showNotification('نجح الحفظ', 'تم إضافة الاستقطاع بنجاح', 'success');
        }

        // تحسين تجربة التحرير مع اختصارات لوحة المفاتيح
        function enhanceEditingExperience() {
            // إضافة مستمع عالمي لاختصارات لوحة المفاتيح
            document.addEventListener('keydown', function(e) {
                // Ctrl+S لحفظ البيانات في النوافذ المنبثقة
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    const modal = document.querySelector('.modal-overlay.active');
                    if (modal) {
                        const saveButton = modal.querySelector('.btn-primary');
                        if (saveButton) {
                            saveButton.click();
                        }
                    }
                }
                
                // Ctrl+R أو F5 لإعادة تحميل التطبيق
                if ((e.ctrlKey && e.key === 'r') || e.key === 'F5') {
                    e.preventDefault();
                    refreshApp();
                }
                
                // Alt+E للتحرير السريع إذا كان هناك عنصر محدد
                if (e.altKey && e.key === 'e') {
                    e.preventDefault();
                    const activeElement = document.activeElement;
                    const editButton = activeElement.closest('tr')?.querySelector('.action-btn.edit');
                    if (editButton) {
                        editButton.click();
                    }
                }
            });
        }

        // تحسين تحميل البيانات للعرض السريع
        function preloadDataForEditing() {
            // تحميل البيانات مسبقاً لتسريع التحرير
            if (dataManager.lawyersData && dataManager.defendantsData && dataManager.deductionsData) {
                return true;
            }
            return false;
        }

        // دالة مساعدة لإظهار حالة التحميل
        function showQuickLoadingState(element, message = 'جاري التحميل...') {
            if (!element) return;
            
            const originalContent = element.innerHTML;
            element.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${message}`;
            element.disabled = true;
            
            return () => {
                element.innerHTML = originalContent;
                element.disabled = false;
            };
        }

        // Case Details Functions
        function showCaseDetails(caseId) {
            dataManager.currentCase = dataManager.getCaseById(caseId);
            dataManager.currentCaseId = caseId; // حفظ معرف الدعوى الحالية للتحديث التلقائي
            if (!dataManager.currentCase) return;

            showTab('case-details');
            
            document.getElementById('case-details-title').textContent = `تفاصيل الدعوى - ${dataManager.currentCase.plaintiffName}`;
            
            renderCaseProgress();
            renderCaseInfo();
            renderCaseTimeline();
            renderCaseDeductions();
            renderCaseDocuments();
        }

        function renderCaseProgress() {
            const stages = [
                { name: 'إعداد الدعوى', key: 'preparation' },
                { name: 'تقديم الدعوى', key: 'filing' },
                { name: 'المرافعة', key: 'pleading' },
                { name: 'صدور الحكم', key: 'judgment' },
                { name: 'التنفيذ', key: 'execution' }
            ];

            const currentStageIndex = stages.findIndex(s => s.name === dataManager.currentCase.stage);
            const container = document.getElementById('case-progress');
            
            container.innerHTML = stages.map((stage, index) => {
                const isCompleted = index <= currentStageIndex;
                const isLast = index === stages.length - 1;
                
                return `
                    <div class="progress-step">
                        <div class="step-circle ${isCompleted ? 'completed' : 'pending'}">
                            ${isCompleted ? '<i class="fas fa-check"></i>' : index + 1}
                        </div>
                        <span class="step-name ${isCompleted ? 'completed' : 'pending'}">
                            ${stage.name}
                        </span>
                        ${!isLast ? `<div class="step-connector ${index < currentStageIndex ? 'completed' : 'pending'}"></div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function renderCaseInfo() {
            const container = document.getElementById('case-info-grid');
            const remaining = dataManager.currentCase.amount - dataManager.currentCase.deductions;
            
            container.innerHTML = `
                <div class="info-field">
                    <label><i class="fas fa-file"></i>رقم الدعوى</label>
                    <p>${dataManager.currentCase.caseNumber}</p>
                </div>
                <div class="info-field">
                    <label><i class="fas fa-user"></i>المدعي</label>
                    <p>${dataManager.currentCase.plaintiffName}</p>
                </div>
                <div class="info-field">
                    <label><i class="fas fa-user-tie"></i>المدعى عليه</label>
                    <p>${dataManager.currentCase.defendantName}</p>
                </div>
                <div class="info-field">
                    <label><i class="fas fa-balance-scale"></i>المحامي</label>
                    <p>${dataManager.currentCase.lawyerName || 'غير محدد'}</p>
                </div>
                <div class="info-field">
                    <label><i class="fas fa-building"></i>المحكمة</label>
                    <p>${dataManager.currentCase.courtName}</p>
                </div>
                <div class="info-field">
                    <label><i class="fas fa-flag"></i>الأولوية</label>
                    <p style="color: ${dataManager.currentCase.priority === 'طارئة' ? 'var(--error-red)' : dataManager.currentCase.priority === 'عاجلة' ? 'var(--warning-yellow)' : dataManager.currentCase.priority === 'مهمة' ? 'var(--primary-blue)' : 'var(--gray-600)'};">${dataManager.currentCase.priority}</p>
                </div>
                <div class="info-field">
                    <label><i class="fas fa-dollar-sign"></i>مبلغ الدعوى</label>
                    <p style="color: var(--primary-blue); font-weight: 700;">${dataManager.formatNumber(dataManager.currentCase.amount)} د.ع</p>
                </div>
                <div class="info-field highlight">
                    <label><i class="fas fa-coins"></i>إجمالي الاستقطاعات</label>
                    <p>${dataManager.formatNumber(dataManager.currentCase.deductions)} د.ع</p>
                </div>
                <div class="info-field">
                    <label><i class="fas fa-chart-line"></i>المبلغ المتبقي</label>
                    <p style="color: ${remaining > 0 ? 'var(--error-red)' : 'var(--success-green)'}; font-weight: 700;">${dataManager.formatNumber(remaining)} د.ع</p>
                </div>
                <div class="info-field">
                    <label><i class="fas fa-calendar"></i>تاريخ رفع الدعوى</label>
                    <p>${dataManager.formatDate(dataManager.currentCase.fileDate)}</p>
                </div>
                <div class="info-field">
                    <label><i class="fas fa-calendar-alt"></i>الجلسة القادمة</label>
                    <p>${dataManager.formatDate(dataManager.currentCase.nextHearing)}</p>
                </div>
                ${dataManager.currentCase.executionOptions && dataManager.currentCase.executionOptions.length > 0 ? `
                    <div class="info-field">
                        <label><i class="fas fa-gavel"></i>خيارات التنفيذ</label>
                        <p>${dataManager.currentCase.executionOptions.join(', ')}</p>
                    </div>
                ` : ''}
            `;
        }

        function renderCaseTimeline() {
            const container = document.getElementById('case-timeline');
            container.innerHTML = dataManager.currentCase.timeline.map(item => `
                <div class="timeline-item ${item.type}">
                    <div class="timeline-title">
                        <i class="fas fa-${item.type === 'blue' ? 'file' : item.type === 'yellow' ? 'gavel' : 'money-bill'}"></i>
                        ${item.title}
                    </div>
                    <div class="timeline-desc">
                        ${dataManager.formatDate(item.date)} - ${item.desc}
                    </div>
                </div>
            `).join('');
        }

        function renderCaseDeductions() {
            const container = document.getElementById('case-deductions');
            const remaining = dataManager.currentCase.amount - dataManager.currentCase.deductions;
            const caseDeductions = dataManager.deductionsData.filter(d => d.caseNumber === dataManager.currentCase.caseNumber);
            
            container.innerHTML = `
                <div class="deduction-summary" style="margin-bottom: 1.5rem;">
                    <div class="deduction-summary-grid">
                        <div class="deduction-summary-item">
                            <div class="deduction-summary-value">${dataManager.formatNumber(dataManager.currentCase.deductions)} د.ع</div>
                            <div class="deduction-summary-label">المبلغ المستقطع</div>
                        </div>
                        <div class="deduction-summary-item">
                            <div class="deduction-summary-value" style="color: var(--error-red);">${dataManager.formatNumber(remaining)} د.ع</div>
                            <div class="deduction-summary-label">المتبقي</div>
                        </div>
                        <div class="deduction-summary-item">
                            <div class="deduction-summary-value">${caseDeductions.length}</div>
                            <div class="deduction-summary-label">عدد الاستقطاعات</div>
                        </div>
                        <div class="deduction-summary-item">
                            <div class="deduction-summary-value">${caseDeductions.length > 0 ? dataManager.formatDate(caseDeductions[caseDeductions.length - 1].date) : 'لا يوجد'}</div>
                            <div class="deduction-summary-label">آخر استقطاع</div>
                        </div>
                    </div>
                </div>
                
                ${caseDeductions.length > 0 ? `
                    <h4 style="margin-bottom: 1rem; color: var(--gray-700);">
                        <i class="fas fa-list"></i>
                        تفاصيل الاستقطاعات
                    </h4>
                    ${caseDeductions.map(deduction => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--gray-50); border-radius: 0.75rem; margin-bottom: 1rem; border: 1px solid var(--gray-200);">
                            <div>
                                <div style="font-weight: 700; margin-bottom: 0.5rem; color: var(--gray-900);">${dataManager.formatNumber(deduction.amount)} د.ع</div>
                                <div style="font-size: 0.875rem; color: var(--gray-600);">${deduction.source}</div>
                                ${deduction.notes ? `<div style="font-size: 0.75rem; color: var(--gray-500); margin-top: 0.25rem;">${deduction.notes}</div>` : ''}
                            </div>
                            <div style="text-align: left;">
                                <div style="font-weight: 600; margin-bottom: 0.5rem;">${dataManager.formatDate(deduction.date)}</div>
                                <span class="status-badge" style="background: var(--success-green-light); color: var(--success-green); font-size: 0.75rem;">
                                    ${deduction.status}
                                </span>
                            </div>
                        </div>
                    `).join('')}
                ` : '<p style="text-align: center; color: var(--gray-500); padding: 2rem;">لا توجد استقطاعات لهذه الدعوى</p>'}
            `;
        }

        function renderCaseDocuments() {
            const container = document.getElementById('case-documents');
            const documents = dataManager.currentCase.documents || [];
            
            if (documents.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--gray-500); padding: 2rem;">لا توجد مستندات مرفقة</p>';
                return;
            }
            
            container.innerHTML = documents.map(doc => `
                <div style="display: flex; align-items: center; padding: 1rem; background: var(--gray-50); border-radius: 0.75rem; margin-bottom: 1rem; border: 1px solid var(--gray-200); transition: all 0.3s ease; cursor: pointer;" onmouseover="this.style.background='white'; this.style.transform='translateY(-1px)'; this.style.boxShadow='var(--shadow-md)'" onmouseout="this.style.background='var(--gray-50)'; this.style.transform='none'; this.style.boxShadow='none'">
                    <i class="fas fa-file-pdf" style="margin-left: 1rem; font-size: 1.5rem; color: var(--error-red);"></i>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: var(--gray-900); margin-bottom: 0.25rem;">${doc}</div>
                        <div style="font-size: 0.75rem; color: var(--gray-500);">تم إنشاؤه: ${dataManager.formatDate(dataManager.currentCase.fileDate)}</div>
                    </div>
                    <button class="btn btn-primary" style="padding: 0.5rem 1rem;" onclick="downloadDocument('${doc}')">
                        <i class="fas fa-download"></i>
                        تحميل
                    </button>
                </div>
            `).join('');
        }

        // Lawyer selector update
        function updateLawyerInfo() {
            const selector = document.getElementById('new-case-lawyer-select');
            const manualField = document.getElementById('manual-lawyer-field');
            const lawyerNameField = document.getElementById('new-case-lawyer-name');

            if (selector.value === 'manual') {
                manualField.style.display = 'block';
                lawyerNameField.value = '';
            } else {
                manualField.style.display = 'none';
                if (selector.value) {
                    const lawyer = dataManager.lawyersData.find(l => l.id == selector.value);
                    if (lawyer) {
                        lawyerNameField.value = lawyer.name;
                    }
                } else {
                    lawyerNameField.value = '';
                }
            }
        }

       function editCase(id) {
    const caseItem = dataManager.getCaseById(id);
    if (!caseItem) {
        showNotification('خطأ', 'لم يتم العثور على الدعوى المحددة', 'error');
        return;
    }

    // التبديل إلى وضع التحرير مباشرة
    showTab('new-case');
    
    // ملء النموذج بالبيانات الموجودة بسرعة
    const fillField = (id, value) => {
        const element = document.getElementById(id);
        if (element) element.value = value || '';
    };

    // ملء جميع الحقول
    fillField('new-case-number', caseItem.caseNumber);
    fillField('new-case-file-date', caseItem.fileDate);
    fillField('new-case-priority', caseItem.priority);
    fillField('new-case-status', caseItem.status);
    fillField('new-case-amount', caseItem.amount);
    fillField('new-case-plaintiff-name', caseItem.plaintiffName);
    fillField('new-case-plaintiff-phone', caseItem.plaintiffPhone);
    fillField('new-case-plaintiff-address', caseItem.plaintiffAddress);
    fillField('new-case-defendant-name', caseItem.defendantName);
    fillField('new-case-defendant-address', caseItem.defendantAddress);
    fillField('new-case-lawyer-name', caseItem.lawyerName);
    fillField('new-case-court-name', caseItem.courtName);
    fillField('new-case-court-section', caseItem.courtSection);
    fillField('new-case-stage', caseItem.stage);
    fillField('new-case-hearing', caseItem.nextHearing);
    fillField('new-case-notes', caseItem.notes);
    
    // التعامل مع خيارات التنفيذ
    const executionSeizure = document.getElementById('execution-seizure');
    const executionDeduction = document.getElementById('execution-deduction');
    
    if (executionSeizure) executionSeizure.checked = false;
    if (executionDeduction) executionDeduction.checked = false;
    
    if (caseItem.executionOptions) {
        if (caseItem.executionOptions.includes('تم الحجز') && executionSeizure) {
            executionSeizure.checked = true;
        }
        if (caseItem.executionOptions.includes('تم الاستقطاع') && executionDeduction) {
            executionDeduction.checked = true;
        }
    }
    
    // إظهار خيارات التنفيذ إذا كانت المرحلة هي التنفيذ
    const executionOptions = document.getElementById('execution-options');
    if (executionOptions) {
        if (caseItem.stage === 'التنفيذ') {
            executionOptions.classList.add('show');
        } else {
            executionOptions.classList.remove('show');
        }
    }
    
    // تحديث عنوان الصفحة والزر
    const contentTitle = document.querySelector('#new-case-content .content-title');
    if (contentTitle) {
        contentTitle.innerHTML = '<i class="fas fa-edit"></i> تحرير الدعوى';
    }
    
    // تغيير زر الحفظ إلى زر التحديث
    const saveButton = document.querySelector('#new-case-content .btn-primary');
    if (saveButton) {
        saveButton.innerHTML = '<i class="fas fa-save"></i> تحديث الدعوى';
        saveButton.onclick = () => updateCase(id);
        saveButton.title = 'حفظ التغييرات على الدعوى';
    }
    
    // حفظ معرف الدعوى للتحديث
    dataManager.editingCaseId = id;
    
    // التركيز على أول حقل
    setTimeout(() => {
        const firstInput = document.getElementById('new-case-number');
        if (firstInput) {
            firstInput.focus();
            firstInput.select();
        }
    }, 100);
    
    // إظهار إشعار نجاح التحميل
    showNotification('تم التحميل', `تم تحميل بيانات الدعوى ${caseItem.caseNumber} للتحرير`, 'success');
}

function updateCase(id) {
    // جمع البيانات من النموذج
    const caseData = {
        caseNumber: document.getElementById('new-case-number').value.trim(),
        fileDate: document.getElementById('new-case-file-date').value,
        priority: document.getElementById('new-case-priority').value,
        status: document.getElementById('new-case-status').value,
        amount: parseInt(document.getElementById('new-case-amount').value) || 0,
        plaintiffName: document.getElementById('new-case-plaintiff-name').value.trim(),
        plaintiffPhone: document.getElementById('new-case-plaintiff-phone').value.trim(),
        plaintiffAddress: document.getElementById('new-case-plaintiff-address').value.trim(),
        defendantName: document.getElementById('new-case-defendant-name').value.trim(),
        defendantAddress: document.getElementById('new-case-defendant-address').value.trim(),
        lawyerName: document.getElementById('new-case-lawyer-name').value.trim(),
        courtName: document.getElementById('new-case-court-name').value.trim(),
        courtSection: document.getElementById('new-case-court-section').value.trim(),
        stage: document.getElementById('new-case-stage').value,
        nextHearing: document.getElementById('new-case-hearing').value,
        notes: document.getElementById('new-case-notes').value.trim()
    };

    // التحقق من الحقول المطلوبة
    const requiredFields = [
        { field: 'caseNumber', name: 'رقم الدعوى', id: 'new-case-number' },
        { field: 'fileDate', name: 'تاريخ التسجيل', id: 'new-case-file-date' },
        { field: 'plaintiffName', name: 'اسم المدعي', id: 'new-case-plaintiff-name' },
        { field: 'defendantName', name: 'اسم المدعى عليه', id: 'new-case-defendant-name' },
        { field: 'courtName', name: 'اسم المحكمة', id: 'new-case-court-name' }
    ];

    for (const required of requiredFields) {
        if (!caseData[required.field]) {
            showNotification('خطأ', `يرجى ملء حقل ${required.name}`, 'error');
            document.getElementById(required.id).focus();
            return;
        }
    }

    // التحقق من صحة المبلغ
    if (!isValidAmount(caseData.amount)) {
        showNotification('خطأ', 'يرجى إدخال مبلغ صحيح للدعوى', 'error');
        document.getElementById('new-case-amount').focus();
        return;
    }

    // التحقق من صحة رقم الهاتف إذا تم إدخاله
    if (caseData.plaintiffPhone && !isValidPhone(caseData.plaintiffPhone)) {
        showNotification('خطأ', 'يرجى إدخال رقم هاتف صحيح للمدعي', 'error');
        document.getElementById('new-case-plaintiff-phone').focus();
        return;
    }

    // التحقق من التاريخ
    const fileDate = new Date(caseData.fileDate);
    const today = new Date();
    if (fileDate > today) {
        if (!confirm('تاريخ التسجيل في المستقبل. هل تريد المتابعة؟')) {
            return;
        }
    }

    // جمع خيارات التنفيذ
    const executionOptions = [];
    const executionSeizure = document.getElementById('execution-seizure');
    const executionDeduction = document.getElementById('execution-deduction');
    
    if (executionSeizure && executionSeizure.checked) executionOptions.push('تم الحجز');
    if (executionDeduction && executionDeduction.checked) executionOptions.push('تم الاستقطاع');
    
    caseData.executionOptions = executionOptions;

    // تنسيق رقم الهاتف
    if (caseData.plaintiffPhone) {
        caseData.plaintiffPhone = formatPhoneNumber(caseData.plaintiffPhone);
    }

    // إضافة تاريخ آخر تعديل
    caseData.lastModified = new Date().toISOString();

    // تحديث الدعوى محلياً
    dataManager.updateCase(id, caseData);
    
    // حفظ التحديث في Firebase لضمان الثبات
    const updateData = {
        status: caseData.status,
        stage: caseData.stage,
        lastModified: caseData.lastModified,
        updatedBy: 'النظام الرئيسي',
        updatedFrom: 'main_app'
    };

    // حفظ في Firebase بجميع المسارات الممكنة
    Promise.all([
        // حفظ في المسار البديل
        database.ref(`cases/${id}`).update(updateData).catch(() => {}),
        // حفظ في مسار data/cases إذا كان مصفوفة
        database.ref('data/cases').once('value').then(snapshot => {
            const cases = snapshot.val();
            if (Array.isArray(cases)) {
                const caseIndex = cases.findIndex(c => c.id === id || c.caseNumber === caseData.caseNumber);
                if (caseIndex >= 0) {
                    return database.ref(`data/cases/${caseIndex}`).update(updateData);
                }
            }
        }).catch(() => {})
    ]).then(() => {
        console.log('تم حفظ التحديث في Firebase بنجاح');
    }).catch(error => {
        console.error('خطأ في حفظ التحديث في Firebase:', error);
    });
    
    // إرسال إشعار لتطبيق المحامي
    database.ref('system/updates').push({
        type: 'case_status_update',
        caseId: id,
        caseNumber: caseData.caseNumber,
        updatedBy: 'النظام الرئيسي',
        newStatus: caseData.status,
        newStage: caseData.stage,
        notes: caseData.notes,
        timestamp: new Date().toISOString(),
        source: 'main_app'
    });
    
    // إرسال إشعار مباشر للمحامي
    if (caseData.lawyerName && id && caseData.caseNumber) {
        const notification = {
            id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
            type: 'status-update',
            title: 'تحديث على دعوى',
            description: `تم تحديث الدعوى رقم ${caseData.caseNumber} - الحالة: ${caseData.status} - المرحلة: ${caseData.stage}`,
            targetLawyer: caseData.lawyerName,
            caseId: id,
            caseNumber: caseData.caseNumber,
            timestamp: new Date().toISOString(),
            read: false,
            source: 'main_app'
        };
        
        // التأكد من أن جميع البيانات المطلوبة موجودة
        if (notification.caseId && notification.caseNumber && notification.targetLawyer) {
            database.ref('notifications').push(notification).catch(error => {
                console.warn('خطأ في إرسال الإشعار:', error);
            });
        } else {
            console.warn('تم تخطي إرسال إشعار التحديث - بيانات ناقصة:', {
                caseId: notification.caseId,
                caseNumber: notification.caseNumber,
                targetLawyer: notification.targetLawyer
            });
        }
    }
    
    // تحديث الجداول والإحصائيات
    renderCasesTable();
    updateDashboardStats();
    
    // العودة إلى صفحة الدعاوى
    showTab('cases');
    
    // إظهار إشعار النجاح
    showNotification('نجح التحديث', `تم تحديث الدعوى ${caseData.caseNumber} بنجاح`, 'success');
    
    // إعادة تعيين النموذج
    clearNewCaseForm();
    dataManager.editingCaseId = null;
    
    // إعادة تعيين الزر
    const saveButton = document.querySelector('#new-case-content .btn-primary');
    const contentTitle = document.querySelector('#new-case-content .content-title');
    
    if (saveButton) {
        saveButton.innerHTML = '<i class="fas fa-save"></i> حفظ الدعوى';
        saveButton.onclick = saveNewCase;
        saveButton.title = 'حفظ دعوى جديدة';
    }
    
    if (contentTitle) {
        contentTitle.innerHTML = '<i class="fas fa-plus"></i> دعوى جديدة';
    }
}

        async function deleteCase(id) {
            if (confirm('هل أنت متأكد من حذف هذه الدعوى؟')) {
                try {
                    const result = await dataManager.deleteCase(id);
                    if (result) {
                        renderCasesTable();
                        renderDefendantsTable();
                        updateDashboardStats();
                        showNotification('تم الحذف', 'تم حذف الدعوى بنجاح', 'success');
                    } else {
                        showNotification('خطأ', 'فشل في حذف الدعوى', 'error');
                    }
                } catch (error) {
                    console.error('خطأ في حذف الدعوى:', error);
                    showNotification('خطأ', 'حدث خطأ أثناء حذف الدعوى', 'error');
                }
            }
        }

        async function confirmDeleteDefendant(id) {
            if (confirm('هل أنت متأكد من حذف هذا المدعى عليه؟')) {
                try {
                    const result = await dataManager.deleteDefendant(id);
                    if (result) {
                        renderDefendantsTable();
                        showNotification('تم الحذف', 'تم حذف المدعى عليه بنجاح', 'success');
                    } else {
                        showNotification('خطأ', 'فشل في حذف المدعى عليه', 'error');
                    }
                } catch (error) {
                    console.error('خطأ في حذف المدعى عليه:', error);
                    showNotification('خطأ', 'حدث خطأ أثناء حذف المدعى عليه', 'error');
                }
            }
        }

        async function confirmDeleteLawyer(id) {
            if (confirm('هل أنت متأكد من حذف هذا المحامي؟')) {
                try {
                    const result = await dataManager.deleteLawyer(id);
                    if (result) {
                        renderLawyersTable();
                        updateLawyerSelector();
                        showNotification('تم الحذف', 'تم حذف المحامي بنجاح', 'success');
                    } else {
                        showNotification('خطأ', 'فشل في حذف المحامي', 'error');
                    }
                } catch (error) {
                    console.error('خطأ في حذف المحامي:', error);
                    showNotification('خطأ', 'حدث خطأ أثناء حذف المحامي', 'error');
                }
            }
        }

      function confirmDeleteDeduction(id) {
    console.log('Debug - Deleting deduction with ID:', id);

    // Try to find deduction by ID (handle both string and number IDs)
    let deduction = dataManager.deductionsData.find(d => d.id === id);
    if (!deduction) {
        deduction = dataManager.deductionsData.find(d => d.id == id);
    }
    if (!deduction) {
        deduction = dataManager.deductionsData.find(d => d.id.toString() === id.toString());
    }
    
    if (!deduction) {
        console.error('الاستقطاع غير موجود. ID:', id, 'Available:', dataManager.deductionsData.map(d => d.id));
        showNotification('خطأ', 'لم يتم العثور على الاستقطاع', 'error');
        return;
    }

    console.log('Debug - Found deduction for deletion:', deduction);
    
    const confirmMsg = `هل أنت متأكد من حذف الاستقطاع؟\n\nالمبلغ: ${dataManager.formatNumber(deduction.amount)} د.ع\nالتاريخ: ${dataManager.formatDate(deduction.date)}\nالمصدر: ${deduction.source}`;
    
    if (confirm(confirmMsg)) {
        const success = dataManager.deleteDeduction(id);
        
        if (success) {
            renderDeductionsTable();
            renderCasesTable();
            updateDashboardStats();
            showNotification('تم الحذف', 'تم حذف الاستقطاع بنجاح', 'success');
        } else {
            showNotification('خطأ', 'فشل في حذف الاستقطاع', 'error');
        }
    }
}
        function viewDefendant(id) {
            const defendant = dataManager.defendantsData.find(d => d.id === id);
            if (!defendant) return;

            dataManager.currentDefendant = defendant;
            showTab('defendant-details');
            
            document.getElementById('defendant-details-title').textContent = `تفاصيل المدعى عليه - ${defendant.name}`;
            
            // Render defendant info
            const infoGrid = document.getElementById('defendant-info-grid');
            infoGrid.innerHTML = `
                <div class="info-field">
                    <label><i class="fas fa-user"></i>الاسم</label>
                    <p>${defendant.name}</p>
                </div>
                <div class="info-field">
                    <label><i class="fas fa-phone"></i>رقم الهاتف</label>
                    <p>${defendant.phone || 'غير محدد'}</p>
                </div>
                <div class="info-field">
                    <label><i class="fas fa-building"></i>جهة العمل</label>
                    <p>${defendant.workplace || 'غير محدد'}</p>
                </div>
                <div class="info-field highlight">
                    <label><i class="fas fa-file-contract"></i>عدد الدعاوى</label>
                    <p>${defendant.casesCount}</p>
                </div>
                <div class="info-field">
                    <label><i class="fas fa-calendar"></i>تاريخ التسجيل</label>
                    <p>${dataManager.formatDate(defendant.registrationDate)}</p>
                </div>
                ${defendant.address ? `
                    <div class="info-field" style="grid-column: 1 / -1;">
                        <label><i class="fas fa-map-marker-alt"></i>العنوان</label>
                        <p>${defendant.address}</p>
                    </div>
                ` : ''}
            `;
            
            // Render linked cases
            const casesList = document.getElementById('defendant-cases-list');
            const linkedCases = dataManager.casesData.filter(c => c.defendantName === defendant.name);
            
            if (linkedCases.length === 0) {
                casesList.innerHTML = '<p style="text-align: center; color: var(--gray-500); padding: 2rem;">لا توجد دعاوى مرتبطة بهذا المدعى عليه</p>';
            } else {
                casesList.innerHTML = linkedCases.map(caseItem => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--gray-50); border-radius: 0.75rem; margin-bottom: 1rem; border-right: 4px solid var(--error-red); cursor: pointer;" onclick="showCaseDetails(${caseItem.id})">
                        <div>
                            <div style="font-weight: 700; margin-bottom: 0.5rem;">${caseItem.plaintiffName}</div>
                            <div style="font-size: 0.875rem; color: var(--gray-600);">${caseItem.caseNumber}</div>
                        </div>
                        <div style="text-align: left;">
                            <div style="font-weight: 700; color: var(--success-green); margin-bottom: 0.5rem;">${dataManager.formatNumber(caseItem.amount)} د.ع</div>
                            <span class="status-badge ${getStatusBadgeClass(caseItem.status)}">${caseItem.status}</span>
                        </div>
                    </div>
                `).join('');
            }
        }

        function editDefendant(id) {
            const defendant = dataManager.defendantsData.find(d => d.id === id);
            if (!defendant) {
                showNotification('خطأ', 'لم يتم العثور على المدعى عليه المحدد', 'error');
                return;
            }

            // إنشاء المحتوى مباشرة بدون تأخير
            const content = `
                <div class="form-container" style="animation: fadeIn 0.3s ease-in-out;">
                    <div class="case-info-grid">
                        <div class="form-field">
                            <label class="required"><i class="fas fa-user"></i>اسم المدعى عليه الكامل</label>
                            <input type="text" id="edit-defendant-name" value="${defendant.name}" autocomplete="off">
                        </div>
                        <div class="form-field">
                            <label><i class="fas fa-phone"></i>رقم الهاتف</label>
                            <input type="tel" id="edit-defendant-phone" value="${defendant.phone || ''}" autocomplete="off">
                        </div>
                        <div class="form-field">
                            <label><i class="fas fa-envelope"></i>البريد الإلكتروني</label>
                            <input type="email" id="edit-defendant-email" value="${defendant.email || ''}" autocomplete="off">
                        </div>
                        <div class="form-field">
                            <label><i class="fas fa-building"></i>جهة العمل</label>
                            <input type="text" id="edit-defendant-workplace" value="${defendant.workplace || ''}" autocomplete="off" placeholder="أدخل جهة العمل...">
                        </div>
                        <div class="form-field">
                            <label><i class="fas fa-id-card"></i>رقم الهوية</label>
                            <input type="text" id="edit-defendant-id-number" value="${defendant.idNumber || ''}" autocomplete="off" placeholder="رقم الهوية الشخصية">
                        </div>
                        <div class="form-field">
                            <label><i class="fas fa-calendar"></i>تاريخ الميلاد</label>
                            <input type="date" id="edit-defendant-birthdate" value="${defendant.birthdate || ''}" autocomplete="off">
                        </div>
                    </div>
                    <div class="form-field">
                        <label><i class="fas fa-map-marker-alt"></i>العنوان</label>
                        <textarea id="edit-defendant-address" rows="3" placeholder="أدخل العنوان الكامل...">${defendant.address || ''}</textarea>
                    </div>
                    <div class="form-field">
                        <label><i class="fas fa-comment"></i>ملاحظات إضافية</label>
                        <textarea id="edit-defendant-notes" rows="3" placeholder="أدخل ملاحظات إضافية...">${defendant.notes || ''}</textarea>
                    </div>
                </div>
            `;

            const actions = `
                <button class="btn btn-secondary" onclick="closeModal(this)" title="إلغاء التعديل">
                    <i class="fas fa-times"></i> إلغاء
                </button>
                <button class="btn btn-primary" onclick="updateDefendant(${id})" title="حفظ التغييرات">
                    <i class="fas fa-save"></i> حفظ التغييرات
                </button>
            `;

            // عرض النافذة مباشرة
            const modal = createModal(`<i class="fas fa-edit"></i> تحرير المدعى عليه - ${defendant.name}`, content, actions);
            
            // التركيز على أول حقل إدخال
            setTimeout(() => {
                const firstInput = modal.querySelector('#edit-defendant-name');
                if (firstInput) {
                    firstInput.focus();
                    firstInput.select();
                }
            }, 100);
        }

        function updateDefendant(id) {
            const updates = {
                name: document.getElementById('edit-defendant-name').value.trim(),
                phone: document.getElementById('edit-defendant-phone').value.trim(),
                email: document.getElementById('edit-defendant-email').value.trim(),
                workplace: document.getElementById('edit-defendant-workplace').value.trim(),
                address: document.getElementById('edit-defendant-address').value.trim(),
                idNumber: document.getElementById('edit-defendant-id-number').value.trim(),
                birthdate: document.getElementById('edit-defendant-birthdate').value,
                notes: document.getElementById('edit-defendant-notes').value.trim()
            };

            if (!updates.name) {
                showNotification('خطأ', 'يرجى إدخال اسم المدعى عليه', 'error');
                document.getElementById('edit-defendant-name').focus();
                return;
            }

            // التحقق من صحة البريد الإلكتروني إذا تم إدخاله
            if (updates.email && !isValidEmail(updates.email)) {
                showNotification('خطأ', 'يرجى إدخال عنوان بريد إلكتروني صحيح', 'error');
                document.getElementById('edit-defendant-email').focus();
                return;
            }

            // التحقق من صحة رقم الهاتف إذا تم إدخاله
            if (updates.phone && !isValidPhone(updates.phone)) {
                showNotification('خطأ', 'يرجى إدخال رقم هاتف صحيح', 'error');
                document.getElementById('edit-defendant-phone').focus();
                return;
            }

            dataManager.updateDefendant(id, updates);
            renderDefendantsTable();
            closeModal(event.target);
            showNotification('نجح التحديث', 'تم تحديث بيانات المدعى عليه بنجاح', 'success');
        }

        function viewLawyer(id) {
            const lawyer = dataManager.lawyersData.find(l => l.id === id);
            if (!lawyer) return;

            dataManager.currentLawyer = lawyer;
            showTab('lawyer-details');
            
            document.getElementById('lawyer-details-title').textContent = `تفاصيل المحامي - ${lawyer.name}`;
            
            // Render lawyer info
            const infoGrid = document.getElementById('lawyer-info-grid');
            infoGrid.innerHTML = `
                <div class="info-field">
                    <label><i class="fas fa-user"></i>الاسم</label>
                    <p>${lawyer.name}</p>
                </div>
                <div class="info-field">
                    <label><i class="fas fa-id-badge"></i>رقم الترخيص</label>
                    <p>${lawyer.license}</p>
                </div>
                <div class="info-field">
                    <label><i class="fas fa-graduation-cap"></i>التخصص</label>
                    <p>${lawyer.specialization}</p>
                </div>
                <div class="info-field">
                    <label><i class="fas fa-phone"></i>رقم الهاتف</label>
                    <p>${lawyer.phone || 'غير محدد'}</p>
                </div>
                <div class="info-field">
                    <label><i class="fas fa-calendar"></i>سنوات الخبرة</label>
                    <p>${lawyer.experience || 0} سنة</p>
                </div>
                <div class="info-field highlight">
                    <label><i class="fas fa-file-contract"></i>عدد الدعاوى</label>
                    <p>${lawyer.casesCount || 0}</p>
                </div>
                <div class="info-field">
                    <label><i class="fas fa-calendar"></i>تاريخ التسجيل</label>
                    <p>${dataManager.formatDate(lawyer.registrationDate)}</p>
                </div>
                ${lawyer.address ? `
                    <div class="info-field" style="grid-column: 1 / -1;">
                        <label><i class="fas fa-map-marker-alt"></i>العنوان</label>
                        <p>${lawyer.address}</p>
                    </div>
                ` : ''}
                ${lawyer.notes ? `
                    <div class="info-field" style="grid-column: 1 / -1;">
                        <label><i class="fas fa-comment"></i>ملاحظات</label>
                        <p>${lawyer.notes}</p>
                    </div>
                ` : ''}
            `;
            
            // Render linked cases
            const casesList = document.getElementById('lawyer-cases-list');
            const linkedCases = dataManager.casesData.filter(c => c.lawyerName === lawyer.name);
            
            if (linkedCases.length === 0) {
                casesList.innerHTML = '<p style="text-align: center; color: var(--gray-500); padding: 2rem;">لا توجد دعاوى مرتبطة بهذا المحامي</p>';
            } else {
                casesList.innerHTML = linkedCases.map(caseItem => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--gray-50); border-radius: 0.75rem; margin-bottom: 1rem; border-right: 4px solid var(--primary-blue); cursor: pointer;" onclick="showCaseDetails(${caseItem.id})">
                        <div>
                            <div style="font-weight: 700; margin-bottom: 0.5rem;">${caseItem.plaintiffName}</div>
                            <div style="font-size: 0.875rem; color: var(--gray-600);">${caseItem.caseNumber}</div>
                        </div>
                        <div style="text-align: left;">
                            <div style="font-weight: 700; color: var(--success-green); margin-bottom: 0.5rem;">${dataManager.formatNumber(caseItem.amount)} د.ع</div>
                            <span class="status-badge ${getStatusBadgeClass(caseItem.status)}">${caseItem.status}</span>
                        </div>
                    </div>
                `).join('');
            }
        }

        // دوال التحقق من صحة البيانات
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function isValidPhone(phone) {
            // التحقق من أرقام الهاتف العراقية وأرقام عالمية
            const phoneRegex = /^[\+]?[0-9\s\-\(\)]{7,15}$/;
            return phoneRegex.test(phone);
        }

        function isValidAmount(amount) {
            return !isNaN(amount) && amount > 0 && amount <= 999999999;
        }

        function formatPhoneNumber(phone) {
            // تنسيق رقم الهاتف
            return phone.replace(/\D/g, '').replace(/(\d{4})(\d{3})(\d{4})/, '$1-$2-$3');
        }

        function editLawyer(id) {
            const lawyer = dataManager.lawyersData.find(l => l.id === id);
            if (!lawyer) {
                showNotification('خطأ', 'لم يتم العثور على المحامي المحدد', 'error');
                return;
            }

            // إنشاء المحتوى مباشرة بدون تأخير
            const content = `
                <div class="form-container" style="animation: fadeIn 0.3s ease-in-out;">
                    <div class="case-info-grid">
                        <div class="form-field">
                            <label class="required"><i class="fas fa-user"></i>اسم المحامي الكامل</label>
                            <input type="text" id="edit-lawyer-name" value="${lawyer.name}" autocomplete="off">
                        </div>
                        <div class="form-field">
                            <label class="required"><i class="fas fa-id-badge"></i>رقم الترخيص</label>
                            <input type="text" id="edit-lawyer-license" value="${lawyer.license}" autocomplete="off">
                        </div>
                        <div class="form-field">
                            <label><i class="fas fa-phone"></i>رقم الهاتف</label>
                            <input type="tel" id="edit-lawyer-phone" value="${lawyer.phone || ''}" autocomplete="off">
                        </div>
                        <div class="form-field">
                            <label class="required"><i class="fas fa-graduation-cap"></i>التخصص</label>
                            <select id="edit-lawyer-specialization">
                                <option value="القانون المدني" ${lawyer.specialization === 'القانون المدني' ? 'selected' : ''}>القانون المدني</option>
                                <option value="القانون التجاري" ${lawyer.specialization === 'القانون التجاري' ? 'selected' : ''}>القانون التجاري</option>
                                <option value="قانون العمل" ${lawyer.specialization === 'قانون العمل' ? 'selected' : ''}>قانون العمل</option>
                                <option value="القانون الجنائي" ${lawyer.specialization === 'القانون الجنائي' ? 'selected' : ''}>القانون الجنائي</option>
                                <option value="القانون الإداري" ${lawyer.specialization === 'القانون الإداري' ? 'selected' : ''}>القانون الإداري</option>
                                <option value="قانون الأحوال الشخصية" ${lawyer.specialization === 'قانون الأحوال الشخصية' ? 'selected' : ''}>قانون الأحوال الشخصية</option>
                                <option value="القانون الدستوري" ${lawyer.specialization === 'القانون الدستوري' ? 'selected' : ''}>القانون الدستوري</option>
                                <option value="القانون الدولي" ${lawyer.specialization === 'القانون الدولي' ? 'selected' : ''}>القانون الدولي</option>
                            </select>
                        </div>
                        <div class="form-field">
                            <label><i class="fas fa-envelope"></i>البريد الإلكتروني</label>
                            <input type="email" id="edit-lawyer-email" value="${lawyer.email || ''}" autocomplete="off">
                        </div>
                        <div class="form-field">
                            <label><i class="fas fa-calendar"></i>سنوات الخبرة</label>
                            <input type="number" id="edit-lawyer-experience" value="${lawyer.experience || 0}" min="0" max="50">
                        </div>
                    </div>
                    <div class="form-field">
                        <label><i class="fas fa-map-marker-alt"></i>العنوان</label>
                        <textarea id="edit-lawyer-address" rows="3" placeholder="أدخل عنوان المحامي...">${lawyer.address || ''}</textarea>
                    </div>
                    <div class="form-field">
                        <label><i class="fas fa-comment"></i>ملاحظات</label>
                        <textarea id="edit-lawyer-notes" rows="3" placeholder="أدخل ملاحظات إضافية...">${lawyer.notes || ''}</textarea>
                    </div>
                </div>
            `;

            const actions = `
                <button class="btn btn-secondary" onclick="closeModal(this)" title="إلغاء التعديل">
                    <i class="fas fa-times"></i> إلغاء
                </button>
                <button class="btn btn-primary" onclick="updateLawyer(${id})" title="حفظ التغييرات">
                    <i class="fas fa-save"></i> حفظ التغييرات
                </button>
            `;

            // عرض النافذة مباشرة
            const modal = createModal(`<i class="fas fa-edit"></i> تحرير المحامي - ${lawyer.name}`, content, actions);
            
            // التركيز على أول حقل إدخال
            setTimeout(() => {
                const firstInput = modal.querySelector('#edit-lawyer-name');
                if (firstInput) {
                    firstInput.focus();
                    firstInput.select();
                }
            }, 100);
        }

        function updateLawyer(id) {
            const updates = {
                name: document.getElementById('edit-lawyer-name').value.trim(),
                license: document.getElementById('edit-lawyer-license').value.trim(),
                phone: document.getElementById('edit-lawyer-phone').value.trim(),
                specialization: document.getElementById('edit-lawyer-specialization').value,
                email: document.getElementById('edit-lawyer-email').value.trim(),
                experience: document.getElementById('edit-lawyer-experience').value,
                address: document.getElementById('edit-lawyer-address').value.trim(),
                notes: document.getElementById('edit-lawyer-notes').value.trim()
            };

            // التحقق من الحقول المطلوبة
            if (!updates.name) {
                showNotification('خطأ', 'يرجى إدخال اسم المحامي', 'error');
                document.getElementById('edit-lawyer-name').focus();
                return;
            }

            if (!updates.license) {
                showNotification('خطأ', 'يرجى إدخال رقم الترخيص', 'error');
                document.getElementById('edit-lawyer-license').focus();
                return;
            }

            if (!updates.specialization) {
                showNotification('خطأ', 'يرجى اختيار التخصص', 'error');
                document.getElementById('edit-lawyer-specialization').focus();
                return;
            }

            // التحقق من صحة البريد الإلكتروني إذا تم إدخاله
            if (updates.email && !isValidEmail(updates.email)) {
                showNotification('خطأ', 'يرجى إدخال عنوان بريد إلكتروني صحيح', 'error');
                document.getElementById('edit-lawyer-email').focus();
                return;
            }

            // التحقق من صحة رقم الهاتف إذا تم إدخاله
            if (updates.phone && !isValidPhone(updates.phone)) {
                showNotification('خطأ', 'يرجى إدخال رقم هاتف صحيح', 'error');
                document.getElementById('edit-lawyer-phone').focus();
                return;
            }

            // التحقق من سنوات الخبرة
            if (updates.experience && (isNaN(updates.experience) || updates.experience < 0 || updates.experience > 50)) {
                showNotification('خطأ', 'يرجى إدخال عدد سنوات خبرة صحيح (0-50)', 'error');
                document.getElementById('edit-lawyer-experience').focus();
                return;
            }

            // تنسيق رقم الهاتف
            if (updates.phone) {
                updates.phone = formatPhoneNumber(updates.phone);
            }

            // إضافة تاريخ آخر تعديل
            updates.lastModified = new Date().toISOString();

            dataManager.updateLawyer(id, updates);
            renderLawyersTable();
            updateLawyerSelector();
            closeModal(event.target);
            showNotification('نجح التحديث', 'تم تحديث بيانات المحامي بنجاح', 'success');
        }

        function viewDeduction(id) {
            console.log('Debug - Viewing deduction with ID:', id);
            console.log('Debug - Available deductions:', dataManager.deductionsData.map(d => ({
                id: d.id,
                caseNumber: d.caseNumber,
                amount: d.amount,
                addedVia: d.addedVia
            })));

            // Try to find deduction by ID (handle both string and number IDs)
            let deduction = dataManager.deductionsData.find(d => d.id === id);
            if (!deduction) {
                deduction = dataManager.deductionsData.find(d => d.id == id);
            }
            if (!deduction) {
                deduction = dataManager.deductionsData.find(d => d.id.toString() === id.toString());
            }

            if (!deduction) {
                console.error('الاستقطاع غير موجود. ID:', id);
                showNotification('خطأ', 'الاستقطاع المطلوب غير موجود', 'error');
                return;
            }

            console.log('Debug - Found deduction:', deduction);

            dataManager.currentDeduction = deduction;
            showTab('deduction-details');
            
            document.getElementById('deduction-details-title').textContent = `تفاصيل الاستقطاع - ${deduction.caseNumber}`;
            
            // Render deduction info
            const infoGrid = document.getElementById('deduction-info-grid');
            infoGrid.innerHTML = `
                <div class="info-field">
                    <label><i class="fas fa-user"></i>المدعي</label>
                    <p>${deduction.plaintiffName}</p>
                </div>
                <div class="info-field">
                    <label><i class="fas fa-file"></i>رقم الدعوى</label>
                    <p>${deduction.caseNumber}</p>
                </div>
                <div class="info-field highlight">
                    <label><i class="fas fa-dollar-sign"></i>المبلغ المستقطع</label>
                    <p>${dataManager.formatNumber(deduction.amount)} د.ع</p>
                </div>
                <div class="info-field">
                    <label><i class="fas fa-calendar"></i>تاريخ الاستقطاع</label>
                    <p>${dataManager.formatDate(deduction.date)}</p>
                </div>
                <div class="info-field">
                    <label><i class="fas fa-building"></i>المصدر</label>
                    <p>${deduction.source}</p>
                </div>
                <div class="info-field">
                    <label><i class="fas fa-check-circle"></i>الحالة</label>
                    <p><span class="status-badge" style="background: var(--success-green-light); color: var(--success-green);">${deduction.status}</span></p>
                </div>
                ${deduction.lawyerName ? `
                    <div class="info-field">
                        <label><i class="fas fa-balance-scale"></i>المحامي</label>
                        <p>${deduction.lawyerName}</p>
                    </div>
                ` : ''}
                ${deduction.addedVia ? `
                    <div class="info-field">
                        <label><i class="fas fa-mobile-alt"></i>تم الإضافة عبر</label>
                        <p>${deduction.addedVia === 'mobile_app' ? 'التطبيق المحمول' : 'التطبيق الرئيسي'}</p>
                    </div>
                ` : ''}
                ${deduction.notes ? `
                    <div class="info-field" style="grid-column: 1 / -1;">
                        <label><i class="fas fa-comment"></i>ملاحظات</label>
                        <p>${deduction.notes}</p>
                    </div>
                ` : ''}
                <div class="info-field" style="grid-column: 1 / -1;">
                    <label><i class="fas fa-clock"></i>تاريخ الإنشاء</label>
                    <p>${dataManager.formatDate(deduction.createdAt)}</p>
                </div>
            `;
        }

        function editDeduction(id) {
            console.log('Debug - Editing deduction with ID:', id);

            // Try to find deduction by ID (handle both string and number IDs)
            let deduction = dataManager.deductionsData.find(d => d.id === id);
            if (!deduction) {
                deduction = dataManager.deductionsData.find(d => d.id == id);
            }
            if (!deduction) {
                deduction = dataManager.deductionsData.find(d => d.id.toString() === id.toString());
            }

            if (!deduction) {
                console.error('الاستقطاع غير موجود. ID:', id, 'Available:', dataManager.deductionsData.map(d => d.id));
                showNotification('خطأ', 'لم يتم العثور على الاستقطاع المحدد', 'error');
                return;
            }

            console.log('Debug - Found deduction for editing:', deduction);

            // إنشاء المحتوى مباشرة بدون تأخير
            const content = `
                <div class="form-container" style="animation: fadeIn 0.3s ease-in-out;">
                    <div class="case-info-grid">
                        <div class="form-field">
                            <label class="required"><i class="fas fa-dollar-sign"></i>المبلغ المستقطع (د.ع)</label>
                            <input type="number" id="edit-deduction-amount" value="${deduction.amount}" min="0" step="1000" autocomplete="off">
                        </div>
                        <div class="form-field">
                            <label class="required"><i class="fas fa-calendar"></i>تاريخ الاستقطاع</label>
                            <input type="date" id="edit-deduction-date" value="${deduction.date}" autocomplete="off">
                        </div>
                        <div class="form-field">
                            <label class="required"><i class="fas fa-building"></i>المصدر</label>
                            <select id="edit-deduction-source">
                                <option value="">اختر المصدر...</option>
                                <option value="محكمة البداءة" ${deduction.source === 'محكمة البداءة' ? 'selected' : ''}>محكمة البداءة</option>
                                <option value="دائرة التنفيذ" ${deduction.source === 'دائرة التنفيذ' ? 'selected' : ''}>دائرة التنفيذ</option>
                                <option value="محكمة الاستئناف" ${deduction.source === 'محكمة الاستئناف' ? 'selected' : ''}>محكمة الاستئناف</option>
                                <option value="محكمة التمييز" ${deduction.source === 'محكمة التمييز' ? 'selected' : ''}>محكمة التمييز</option>
                                <option value="دائرة الكاتب العدل" ${deduction.source === 'دائرة الكاتب العدل' ? 'selected' : ''}>دائرة الكاتب العدل</option>
                                <option value="أخرى" ${deduction.source === 'أخرى' ? 'selected' : ''}>أخرى</option>
                            </select>
                        </div>
                        <div class="form-field">
                            <label class="required"><i class="fas fa-check-circle"></i>الحالة</label>
                            <select id="edit-deduction-status">
                                <option value="">اختر الحالة...</option>
                                <option value="مستلم" ${deduction.status === 'مستلم' ? 'selected' : ''}>مستلم</option>
                                <option value="قيد المعالجة" ${deduction.status === 'قيد المعالجة' ? 'selected' : ''}>قيد المعالجة</option>
                                <option value="مؤجل" ${deduction.status === 'مؤجل' ? 'selected' : ''}>مؤجل</option>
                                <option value="مكتمل" ${deduction.status === 'مكتمل' ? 'selected' : ''}>مكتمل</option>
                                <option value="ملغى" ${deduction.status === 'ملغى' ? 'selected' : ''}>ملغى</option>
                            </select>
                        </div>
                        <div class="form-field">
                            <label><i class="fas fa-hashtag"></i>رقم الشيك/الحوالة</label>
                            <input type="text" id="edit-deduction-reference" value="${deduction.reference || ''}" autocomplete="off" placeholder="رقم مرجعي للاستقطاع">
                        </div>
                        <div class="form-field">
                            <label><i class="fas fa-user"></i>المسؤول عن المتابعة</label>
                            <input type="text" id="edit-deduction-responsible" value="${deduction.responsible || ''}" autocomplete="off" placeholder="اسم المسؤول">
                        </div>
                    </div>
                    <div class="form-field">
                        <label><i class="fas fa-comment"></i>ملاحظات وتفاصيل إضافية</label>
                        <textarea id="edit-deduction-notes" rows="4" placeholder="أدخل ملاحظات حول الاستقطاع...">${deduction.notes || ''}</textarea>
                    </div>
                </div>
            `;

            const actions = `
                <button class="btn btn-secondary" onclick="closeModal(this)" title="إلغاء التعديل">
                    <i class="fas fa-times"></i> إلغاء
                </button>
                <button class="btn btn-primary" onclick="updateDeduction(${id})" title="حفظ التغييرات">
                    <i class="fas fa-save"></i> حفظ التغييرات
                </button>
            `;

            // عرض النافذة مباشرة
            const modal = createModal(`<i class="fas fa-edit"></i> تحرير الاستقطاع - ${deduction.caseNumber}`, content, actions);
            
            // التركيز على أول حقل إدخال
            setTimeout(() => {
                const firstInput = modal.querySelector('#edit-deduction-amount');
                if (firstInput) {
                    firstInput.focus();
                    firstInput.select();
                }
            }, 100);
        }

        function updateDeduction(id) {
            const amount = parseInt(document.getElementById('edit-deduction-amount').value);
            const date = document.getElementById('edit-deduction-date').value;
            const source = document.getElementById('edit-deduction-source').value;
            const status = document.getElementById('edit-deduction-status').value;
            const notes = document.getElementById('edit-deduction-notes').value.trim();
            const reference = document.getElementById('edit-deduction-reference').value.trim();
            const responsible = document.getElementById('edit-deduction-responsible').value.trim();

            // التحقق من الحقول المطلوبة
            if (!amount || amount <= 0) {
                showNotification('خطأ', 'يرجى إدخال مبلغ صحيح للاستقطاع', 'error');
                document.getElementById('edit-deduction-amount').focus();
                return;
            }

            if (!date) {
                showNotification('خطأ', 'يرجى اختيار تاريخ الاستقطاع', 'error');
                document.getElementById('edit-deduction-date').focus();
                return;
            }

            if (!source) {
                showNotification('خطأ', 'يرجى اختيار مصدر الاستقطاع', 'error');
                document.getElementById('edit-deduction-source').focus();
                return;
            }

            if (!status) {
                showNotification('خطأ', 'يرجى اختيار حالة الاستقطاع', 'error');
                document.getElementById('edit-deduction-status').focus();
                return;
            }

            // التحقق من التاريخ المستقبلي
            const selectedDate = new Date(date);
            const today = new Date();
            if (selectedDate > today) {
                if (!confirm('التاريخ المحدد في المستقبل. هل تريد المتابعة؟')) {
                    return;
                }
            }

            const updates = { 
                amount, 
                date, 
                source, 
                status, 
                notes,
                reference,
                responsible,
                lastModified: new Date().toISOString()
            };

            dataManager.updateDeduction(id, updates);
            renderDeductionsTable();
            closeModal(event.target);
            showNotification('نجح التحديث', 'تم تحديث بيانات الاستقطاع بنجاح', 'success');
        }

        function editCurrentCase() {
            if (!dataManager.currentCase) {
                showNotification('خطأ', 'لا توجد دعوى محددة للتحرير', 'error');
                return;
            }
            editCase(dataManager.currentCase.id);
        }

        function editCurrentLawyer() {
            if (!dataManager.currentLawyer) {
                showNotification('خطأ', 'لا يوجد محامي محدد للتحرير', 'error');
                return;
            }
            editLawyer(dataManager.currentLawyer.id);
        }

        function editCurrentDefendant() {
            if (!dataManager.currentDefendant) {
                showNotification('خطأ', 'لا يوجد مدعى عليه محدد للتحرير', 'error');
                return;
            }
            editDefendant(dataManager.currentDefendant.id);
        }

        function editCurrentDeduction() {
            if (!dataManager.currentDeduction) {
                showNotification('خطأ', 'لا يوجد استقطاع محدد للتحرير', 'error');
                return;
            }
            editDeduction(dataManager.currentDeduction.id);
        }

        function printCase() {
            window.print();
        }

        function downloadDocument(name) {
            showNotification('تحميل', `جاري تحميل ${name}...`, 'info');
        }

        function exportCases() {
            if (dataManager.casesData.length === 0) {
                showNotification('تنبيه', 'لا توجد دعاوى لتصديرها', 'warning');
                return;
            }

            dataManager.exportData();
            showNotification('تم التصدير', 'تم تصدير البيانات بنجاح', 'success');
        }

        function generateReport() {
            const stats = dataManager.getStatistics();
            const reportContent = `
تقرير سريع - تطبيق الإدارة القانونية
=====================================

إحصائيات عامة:
- إجمالي الدعاوى: ${stats.totalCases}
- الدعاوى المعلقة: ${stats.pendingCases}
- الدعاوى المكتملة: ${stats.completedCases}
- إجمالي المبالغ: ${dataManager.formatNumber(stats.totalAmount)} د.ع
- إجمالي الاستقطاعات: ${dataManager.formatNumber(stats.totalDeductions)} د.ع
- معدل النجاح: ${stats.successRate}%
- متوسط مدة الدعوى: ${stats.avgDuration} شهر

تاريخ التقرير: ${new Date().toLocaleDateString('ar-EG', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
})}
            `;

            const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `تقرير_سريع_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showNotification('تم إنشاء التقرير', 'تم إنشاء التقرير السريع وتحميله', 'success');
        }

        function generateMonthlyReport() {
            showNotification('قيد التطوير', 'ميزة التقرير الشهري قيد التطوير', 'info');
        }

        function generateDefendantsReport() {
            if (dataManager.defendantsData.length === 0) {
                showNotification('تنبيه', 'لا يوجد مدعى عليهم لإنشاء تقرير', 'warning');
                return;
            }

            let csvContent = 'اسم المدعى عليه,رقم الهاتف,البريد الإلكتروني,جهة العمل,عدد الدعاوى,تاريخ التسجيل\n';
            
            dataManager.defendantsData.forEach(defendant => {
                csvContent += `"${defendant.name}","${defendant.phone || ''}","${defendant.email || ''}","${defendant.workplace || ''}",${defendant.casesCount},"${dataManager.formatDate(defendant.registrationDate)}"\n`;
            });

            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `تقرير_المدعى_عليهم_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showNotification('تم إنشاء التقرير', 'تم إنشاء تقرير المدعى عليهم وتحميله', 'success');
        }

        function generateFinancialReport() {
            const stats = dataManager.getStatistics();
            
            let reportContent = `التقرير المالي - تطبيق الإدارة القانونية
==========================================\n\n`;
            
            reportContent += `الملخص المالي:\n`;
            reportContent += `- إجمالي مبالغ الدعاوى: ${dataManager.formatNumber(stats.totalAmount)} د.ع\n`;
            reportContent += `- إجمالي الاستقطاعات: ${dataManager.formatNumber(stats.totalDeductions)} د.ع\n`;
            reportContent += `- المبلغ المتبقي: ${dataManager.formatNumber(stats.totalAmount - stats.totalDeductions)} د.ع\n`;
            reportContent += `- نسبة التحصيل: ${stats.totalAmount > 0 ? Math.round((stats.totalDeductions / stats.totalAmount) * 100) : 0}%\n\n`;
            
            reportContent += `تفاصيل الاستقطاعات:\n`;
            reportContent += `================\n`;
            
            dataManager.deductionsData.forEach(deduction => {
                reportContent += `- ${deduction.plaintiffName} (${deduction.caseNumber}): ${dataManager.formatNumber(deduction.amount)} د.ع - ${dataManager.formatDate(deduction.date)} - ${deduction.source}\n`;
            });
            
            reportContent += `\nتاريخ التقرير: ${new Date().toLocaleDateString('ar-EG', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            })}`;

            const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `التقرير_المالي_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showNotification('تم إنشاء التقرير', 'تم إنشاء التقرير المالي وتحميله', 'success');
        }

        // Settings Functions
        function saveOfficeSettings() {
            const updates = {};
            
            const officeNameEl = document.getElementById('office-name');
            const officeAddressEl = document.getElementById('office-address');
            const officePhoneEl = document.getElementById('office-phone');
            
            if (officeNameEl) updates.officeName = officeNameEl.value;
            if (officeAddressEl) updates.officeAddress = officeAddressEl.value;
            if (officePhoneEl) updates.officePhone = officePhoneEl.value;

            dataManager.updateSettings(updates);
            showNotification('نجح الحفظ', 'تم حفظ إعدادات المكتب بنجاح', 'success');
        }

        function saveSystemSettings() {
            const updates = {};
            
            const systemLanguageEl = document.getElementById('system-language');
            const dateTypeEl = document.getElementById('date-type');
            const autoSaveEl = document.getElementById('auto-save');
            const autoSaveIntervalEl = document.getElementById('auto-save-interval');
            const dailyBackupEl = document.getElementById('daily-backup');
            
            if (systemLanguageEl) updates.systemLanguage = systemLanguageEl.value;
            if (dateTypeEl) updates.dateType = dateTypeEl.value;
            if (autoSaveEl) updates.autoSave = autoSaveEl.checked;
            if (autoSaveIntervalEl) updates.autoSaveInterval = parseInt(autoSaveIntervalEl.value);
            if (dailyBackupEl) updates.dailyBackup = dailyBackupEl.checked;

            dataManager.updateSettings(updates);
            showNotification('نجح الحفظ', 'تم حفظ إعدادات النظام بنجاح', 'success');
        }

        function createBackup() {
            showNotification('النسخ الاحتياطي', 'جاري إنشاء النسخة الاحتياطية...', 'info');
            
            setTimeout(() => {
                dataManager.exportData();
                const currentDate = new Date().toLocaleDateString('ar-EG', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                }) + ' - ' + new Date().toLocaleTimeString('ar-EG', { hour12: false });
                document.getElementById('last-backup-date').textContent = currentDate;
                showNotification('نجح الإنشاء', 'تم إنشاء النسخة الاحتياطية بنجاح', 'success');
            }, 1000);
        }

        function restoreBackup() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async function(event) {
                const file = event.target.files[0];
                if (!file) return;

                showNotification('الاسترداد', 'جاري استرداد النسخة الاحتياطية...', 'info');
                
                try {
                    await dataManager.importData(file);
                    
                    // Refresh all data
                    renderCasesTable();
                    renderDefendantsTable();
                    renderLawyersTable();
                    renderDeductionsTable();
                    updateDashboardStats();
                    renderUpcomingHearings();
                    renderAlerts();
                    updateLawyerSelector();
                    
                    showNotification('نجح الاسترداد', 'تم استرداد النسخة الاحتياطية بنجاح', 'success');
                } catch (error) {
                    showNotification('خطأ', 'فشل في استرداد النسخة الاحتياطية: ' + error.message, 'error');
                }
            };
            input.click();
        }

        function showNotifications() {
            console.log('🔍 فحص الإشعارات:', {
                total: dataManager.notificationsData.length,
                notifications: dataManager.notificationsData
            });
            
            // إخفاء عداد الإشعارات عند النقر على الزر
            if (dataManager && dataManager.hideNotificationBadge) {
                dataManager.hideNotificationBadge();
            }
            
            // عرض الإشعارات غير المقروءة فقط
            const unreadNotifications = dataManager.notificationsData.filter(n => !n.read);
            const notifications = unreadNotifications.slice(0, 50);
            
            console.log('📊 إحصائيات الإشعارات:', {
                المجموع: dataManager.notificationsData.length,
                غير_المقروءة: unreadNotifications.length,
                المعروضة: notifications.length
            });
            
            if (notifications.length === 0) {
                const totalNotifications = dataManager.notificationsData.length;
                const readNotifications = dataManager.notificationsData.filter(n => n.read).length;
                
                const content = `
                    <div style="text-align: center; padding: 3rem; color: var(--gray-500);">
                        <i class="fas fa-check-circle" style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.5; color: var(--success-green);"></i>
                        <p style="font-size: 1.125rem; font-weight: 600;">لا توجد إشعارات جديدة</p>
                        <p style="font-size: 0.875rem; margin-top: 0.5rem;">
                            ${totalNotifications > 0 ? 
                                `جميع الإشعارات (${totalNotifications}) مقروءة` : 
                                'سيتم عرض الإشعارات الجديدة هنا عند توفرها'
                            }
                        </p>
                        ${totalNotifications > 0 ? `
                            <button class="btn btn-secondary" style="margin-top: 1rem;" onclick="showAllNotifications();">
                                <i class="fas fa-history"></i>
                                عرض جميع الإشعارات (${totalNotifications})
                            </button>
                        ` : ''}
                        <button class="btn btn-primary" style="margin-top: 1rem;" onclick="testNotifications(); closeModal();">
                            <i class="fas fa-plus"></i>
                            إضافة إشعارات تجريبية
                        </button>
                        <button class="btn btn-success" style="margin-top: 0.5rem;" onclick="generateRealNotifications(); closeModal();">
                            <i class="fas fa-sync"></i>
                            إنشاء إشعارات من البيانات
                        </button>
                    </div>
                `;
                createModal('الإشعارات', content);
                return;
            }

            // Group notifications by priority (handle missing priority)
            const highPriority = notifications.filter(n => n.priority === 'high');
            const mediumPriority = notifications.filter(n => n.priority === 'medium');
            const lowPriority = notifications.filter(n => n.priority === 'low' || !n.priority);
            
            // Assign default priority to notifications without priority
            notifications.forEach(n => {
                if (!n.priority) {
                    n.priority = n.type === 'error' ? 'high' : n.type === 'warning' ? 'medium' : 'low';
                }
            });

            const content = `
                <div style="margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center; padding-bottom: 1rem; border-bottom: 2px solid var(--gray-200);">
                    <div>
                        <span style="background: var(--error-red); color: white; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 700; margin-left: 0.5rem;">${highPriority.length}</span>
                        <span style="font-weight: 600; color: var(--error-red);">عاجل</span>
                        
                        <span style="background: var(--warning-yellow); color: white; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 700; margin-left: 0.5rem; margin-right: 1rem;">${mediumPriority.length}</span>
                        <span style="font-weight: 600; color: var(--warning-yellow);">متوسط</span>
                        
                        <span style="background: var(--primary-blue); color: white; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 700; margin-left: 0.5rem; margin-right: 1rem;">${lowPriority.length}</span>
                        <span style="font-weight: 600; color: var(--primary-blue);">عادي</span>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-success" style="padding: 0.5rem 1rem; font-size: 0.75rem;" onclick="generateRealNotifications(); showNotifications();">
                            <i class="fas fa-sync"></i>
                            تحديث
                        </button>
                        <button class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.875rem;" onclick="handleMarkAllAsRead()">
                            <i class="fas fa-check-double"></i>
                            تعليم الكل كمقروء
                        </button>
                    </div>
                </div>
                
                <div style="max-height: 500px; overflow-y: auto;">
                    ${highPriority.length > 0 ? `
                        <h4 style="color: var(--error-red); margin-bottom: 1rem; font-size: 1rem; font-weight: 700;">
                            <i class="fas fa-exclamation-circle"></i>
                            إشعارات عاجلة
                        </h4>
                        ${renderNotificationGroup(highPriority)}
                        <div style="margin: 2rem 0; border-top: 1px solid var(--gray-200);"></div>
                    ` : ''}
                    
                    ${mediumPriority.length > 0 ? `
                        <h4 style="color: var(--warning-yellow); margin-bottom: 1rem; font-size: 1rem; font-weight: 700;">
                            <i class="fas fa-exclamation-triangle"></i>
                            إشعارات متوسطة
                        </h4>
                        ${renderNotificationGroup(mediumPriority)}
                        ${lowPriority.length > 0 ? '<div style="margin: 2rem 0; border-top: 1px solid var(--gray-200);"></div>' : ''}
                    ` : ''}
                    
                    ${lowPriority.length > 0 ? `
                        <h4 style="color: var(--primary-blue); margin-bottom: 1rem; font-size: 1rem; font-weight: 700;">
                            <i class="fas fa-info-circle"></i>
                            إشعارات عادية
                        </h4>
                        ${renderNotificationGroup(lowPriority)}
                    ` : ''}
                </div>
            `;

            createModal('الإشعارات', content);
        }

        function renderNotificationGroup(notifications) {
            return notifications.map(notification => {
                const priorityColors = {
                    high: { bg: 'var(--error-red-light)', border: 'var(--error-red)', text: 'var(--error-red)' },
                    medium: { bg: 'var(--warning-yellow-light)', border: 'var(--warning-yellow)', text: 'var(--warning-yellow)' },
                    low: { bg: 'var(--primary-blue-light)', border: 'var(--primary-blue)', text: 'var(--primary-blue)' }
                };
                
                const colors = priorityColors[notification.priority] || priorityColors.low;
                
                return `
                    <div data-notification-id="${notification.id}" style="display: flex; gap: 1rem; padding: 1.5rem; margin-bottom: 1rem; border-radius: 0.75rem; border-right: 4px solid ${colors.border}; background: ${!notification.read ? colors.bg : 'white'}; border: 1px solid ${colors.border}; transition: all 0.3s ease; position: relative;" 
                         onmouseover="this.style.transform='translateX(-4px)'; this.style.boxShadow='var(--shadow-md)'" 
                         onmouseout="this.style.transform='none'; this.style.boxShadow='none'">
                        
                        ${!notification.read ? `<div style="position: absolute; top: 1rem; left: 1rem; width: 0.5rem; height: 0.5rem; background: ${colors.text}; border-radius: 50%;"></div>` : ''}
                        
                        <div style="flex: 1;">
                            <div style="font-weight: 700; color: var(--gray-900); margin-bottom: 0.5rem; font-size: 1rem;">
                                ${notification.title}
                            </div>
                            <div style="color: var(--gray-700); font-size: 0.875rem; margin-bottom: 0.5rem; font-weight: 600;">
                                ${notification.message}
                            </div>
                            <div style="color: var(--gray-600); font-size: 0.875rem; margin-bottom: 1rem;">
                                ${notification.details}
                            </div>
                            <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 0.5rem;">
                                <div style="color: var(--gray-500); font-size: 0.75rem;">
                                    <i class="fas fa-clock"></i>
                                    ${formatNotificationTime(notification.createdAt)}
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    ${notification.actionFn ? `
                                        <button class="btn btn-primary" style="padding: 0.5rem 1rem; font-size: 0.75rem;" onclick="handleNotificationClick('${notification.id}', 'execute')">
                                            ${notification.actionText || 'عرض'}
                                        </button>
                                    ` : ''}
                                    ${!notification.read ? `
                                        <button class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.75rem;" 
                                                onclick="event.stopPropagation(); handleNotificationClick('${notification.id}', 'markRead'); return false;" 
                                                title="تعليم كمقروء">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    ` : `
                                        <span class="btn btn-success" style="padding: 0.5rem 1rem; font-size: 0.75rem; opacity: 0.7;" title="مقروء">
                                            <i class="fas fa-check-double"></i>
                                        </span>
                                    `}
                                    <button class="btn btn-danger" style="padding: 0.5rem 1rem; font-size: 0.75rem;" 
                                            onclick="event.stopPropagation(); handleNotificationClick('${notification.id}', 'delete'); return false;" 
                                            title="حذف الإشعار">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function formatNotificationTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'الآن';
            if (diffMins < 60) return `منذ ${diffMins} دقيقة`;
            if (diffHours < 24) return `منذ ${diffHours} ساعة`;
            if (diffDays < 7) return `منذ ${diffDays} يوم`;
            
            return dataManager.formatDate(dateString);
        }

        function executeNotificationAction(notificationId) {
            // إغلاق نافذة الإشعارات أولاً
            closeAllModals();
            
            const notification = dataManager.notificationsData.find(n => n.id === notificationId);
            if (notification) {
                // تعليم الإشعار كمقروء
                if (window.notificationManager) {
                    window.notificationManager.markAsRead(notificationId);
                }
                
                // تنفيذ الإجراء حسب نوع الإشعار
                setTimeout(() => {
                    if (notification.action && typeof notification.action === 'function') {
                        notification.action();
                    } else if (notification.caseId) {
                        // التوجه إلى الدعوى
                        showCaseDetails(notification.caseId);
                    } else if (notification.actionFn) {
                        notification.actionFn();
                    } else {
                        // إجراء افتراضي - الذهاب لصفحة الدعاوى
                        showTab('cases');
                    }
                }, 100);
            }
        }

        function markNotificationAsRead(id) {
            if (window.notificationManager) {
                window.notificationManager.markAsRead(id);
                
                // تحديث العرض بدون إعادة فتح النافذة
                updateNotificationDisplay();
            }
        }

        function markAllNotificationsAsRead() {
            if (window.notificationManager) {
                window.notificationManager.markAllAsRead();
                
                // إغلاق النافذة وإظهار رسالة نجاح
                closeAllModals();
                setTimeout(() => {
                    showNotification('تم التحديث', 'تم تعليم جميع الإشعارات كمقروءة', 'success');
                }, 200);
            }
        }

        function deleteNotification(id) {
            if (confirm('هل تريد حذف هذا الإشعار؟')) {
                if (window.notificationManager) {
                    window.notificationManager.deleteNotification(id);
                    
                    // تحديث العرض بدون إعادة فتح النافذة
                    updateNotificationDisplay();
                    
                    showNotification('تم الحذف', 'تم حذف الإشعار بنجاح', 'success');
                }
            }
        }

        function updateNotificationDisplay() {
            // تحديث شارة الإشعارات
            dataManager.updateNotificationBadge();
            
            // تحديث التنبيهات في لوحة التحكم
            if (document.getElementById('alerts-container')) {
                renderAlerts();
            }
            
            // تحديث نافذة الإشعارات إذا كانت مفتوحة
            refreshNotificationsModal();
            
            console.log('🔄 تم تحديث عرض الإشعارات');
        }

        // دالة لعرض جميع الإشعارات (المقروءة وغير المقروءة)
        function showAllNotifications() {
            console.log('📋 عرض جميع الإشعارات');
            
            const allNotifications = dataManager.notificationsData.slice(0, 50);
            const unreadCount = allNotifications.filter(n => !n.read).length;
            
            if (allNotifications.length === 0) {
                const content = `
                    <div style="text-align: center; padding: 3rem; color: var(--gray-500);">
                        <i class="fas fa-bell-slash" style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <p style="font-size: 1.125rem; font-weight: 600;">لا توجد إشعارات</p>
                        <p style="font-size: 0.875rem; margin-top: 0.5rem;">لم يتم إنشاء أي إشعارات بعد</p>
                    </div>
                `;
                createModal('جميع الإشعارات', content);
                return;
            }

            // تجميع الإشعارات حسب الأولوية
            const highPriority = allNotifications.filter(n => n.priority === 'high');
            const mediumPriority = allNotifications.filter(n => n.priority === 'medium');
            const lowPriority = allNotifications.filter(n => n.priority === 'low' || !n.priority);

            const content = `
                <div style="margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center; padding-bottom: 1rem; border-bottom: 2px solid var(--gray-200);">
                    <div>
                        <span style="background: var(--primary-blue); color: white; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 700; margin-left: 0.5rem;">${allNotifications.length}</span>
                        <span style="font-weight: 600; color: var(--primary-blue);">المجموع</span>
                        
                        <span style="background: var(--success-green); color: white; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 700; margin-left: 0.5rem; margin-right: 1rem;">${allNotifications.length - unreadCount}</span>
                        <span style="font-weight: 600; color: var(--success-green);">مقروء</span>
                        
                        <span style="background: var(--error-red); color: white; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 700; margin-left: 0.5rem; margin-right: 1rem;">${unreadCount}</span>
                        <span style="font-weight: 600; color: var(--error-red);">جديد</span>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-primary" style="padding: 0.5rem 1rem; font-size: 0.875rem;" onclick="showNotifications();">
                            <i class="fas fa-bell"></i>
                            الجديدة فقط
                        </button>
                        <button class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.875rem;" onclick="handleMarkAllAsRead()">
                            <i class="fas fa-check-double"></i>
                            تعليم الكل كمقروء
                        </button>
                    </div>
                </div>
                
                <div style="max-height: 500px; overflow-y: auto;">
                    ${highPriority.length > 0 ? `
                        <h4 style="color: var(--error-red); margin-bottom: 1rem; font-size: 1rem; font-weight: 700;">
                            <i class="fas fa-exclamation-circle"></i>
                            إشعارات عاجلة (${highPriority.length})
                        </h4>
                        ${renderNotificationGroup(highPriority)}
                        <div style="margin: 2rem 0; border-top: 1px solid var(--gray-200);"></div>
                    ` : ''}
                    
                    ${mediumPriority.length > 0 ? `
                        <h4 style="color: var(--warning-yellow); margin-bottom: 1rem; font-size: 1rem; font-weight: 700;">
                            <i class="fas fa-exclamation-triangle"></i>
                            إشعارات متوسطة (${mediumPriority.length})
                        </h4>
                        ${renderNotificationGroup(mediumPriority)}
                        <div style="margin: 2rem 0; border-top: 1px solid var(--gray-200);"></div>
                    ` : ''}
                    
                    ${lowPriority.length > 0 ? `
                        <h4 style="color: var(--primary-blue); margin-bottom: 1rem; font-size: 1rem; font-weight: 700;">
                            <i class="fas fa-info-circle"></i>
                            إشعارات عامة (${lowPriority.length})
                        </h4>
                        ${renderNotificationGroup(lowPriority)}
                    ` : ''}
                </div>
            `;

            createModal('جميع الإشعارات', content);
        }

        // دالة لإغلاق جميع النوافذ المودال
        function closeAllModals() {
            const modalOverlays = document.querySelectorAll('.modal-overlay');
            modalOverlays.forEach(overlay => {
                overlay.classList.remove('active');
                setTimeout(() => {
                    if (document.body.contains(overlay)) {
                        document.body.removeChild(overlay);
                    }
                }, 300);
            });
        }

        // دالة مُحسّنة لتنفيذ إجراءات الإشعارات
        function handleNotificationClick(notificationId, action) {
            console.log('🔔 تفاعل مع الإشعار:', { notificationId, action });
            
            const notification = dataManager.notificationsData.find(n => n.id === notificationId);
            if (!notification) {
                console.error('❌ لم يتم العثور على الإشعار:', notificationId);
                return;
            }

            // تنفيذ الإجراء المحدد
            switch(action) {
                case 'execute':
                    if (notification.actionFn) {
                        closeAllModals();
                        // تعليم كمقروء أولاً
                        if (window.notificationManager && !notification.read) {
                            window.notificationManager.markAsRead(notificationId);
                        }
                        setTimeout(() => {
                            notification.actionFn();
                        }, 100);
                    }
                    break;
                
                case 'markRead':
                    if (window.notificationManager) {
                        const success = window.notificationManager.markAsRead(notificationId);
                        if (success) {
                            console.log('✅ تم تعليم الإشعار كمقروء - سيختفي من النافذة');
                            
                            // إخفاء الإشعار فوراً من النافذة
                            const notificationElement = document.querySelector(`[data-notification-id="${notificationId}"]`);
                            if (notificationElement) {
                                notificationElement.style.animation = 'slideOutLeft 0.3s ease-in-out';
                                setTimeout(() => {
                                    refreshNotificationsModal();
                                }, 300);
                            } else {
                                refreshNotificationsModal();
                            }
                        }
                    }
                    break;
                
                case 'delete':
                    if (confirm('هل تريد حذف هذا الإشعار نهائياً؟')) {
                        if (window.notificationManager) {
                            const success = window.notificationManager.deleteNotification(notificationId);
                            if (success) {
                                console.log('🗑️ تم حذف الإشعار نهائياً');
                                
                                // إخفاء الإشعار فوراً من النافذة
                                const notificationElement = document.querySelector(`[data-notification-id="${notificationId}"]`);
                                if (notificationElement) {
                                    notificationElement.style.animation = 'fadeOut 0.3s ease-in-out';
                                    setTimeout(() => {
                                        refreshNotificationsModal();
                                    }, 300);
                                } else {
                                    refreshNotificationsModal();
                                }
                            }
                        }
                    }
                    break;
                
                default:
                    console.warn('⚠️ إجراء غير معروف:', action);
            }
        }

        function handleMarkAllAsRead() {
            if (window.notificationManager) {
                const success = window.notificationManager.markAllAsRead();
                if (success) {
                    console.log('✅ تم تعليم جميع الإشعارات كمقروءة - النافذة ستعرض "لا توجد إشعارات جديدة"');
                    
                    // تحديث فوري للنافذة
                    setTimeout(() => {
                        refreshNotificationsModal();
                    }, 100);
                }
            }
        }

        // دالة تحديث نافذة الإشعارات فوراً بدون إغلاق
        function refreshNotificationsModal() {
            // التحقق إذا كانت نافذة الإشعارات مفتوحة
            const modalElement = document.querySelector('.modal');
            const modalTitle = document.querySelector('.modal-title');
            
            if (modalElement && modalElement.style.display !== 'none' && 
                modalTitle && modalTitle.textContent.includes('الإشعارات')) {
                
                console.log('🔄 تحديث نافذة الإشعارات...');
                
                // إعادة بناء محتوى النافذة - عرض الإشعارات غير المقروءة فقط
                const allNotifications = dataManager.notificationsData.filter(n => !n.read).slice(0, 50);
                const notifications = allNotifications;
                
                if (notifications.length === 0) {
                    const modalBody = document.querySelector('.modal-body');
                    if (modalBody) {
                        modalBody.innerHTML = `
                            <div style="text-align: center; padding: 3rem; color: var(--gray-500);">
                                <i class="fas fa-bell-slash" style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                                <p style="font-size: 1.125rem; font-weight: 600;">لا توجد إشعارات</p>
                                <p style="font-size: 0.875rem; margin-top: 0.5rem;">سيتم عرض الإشعارات هنا عند توفرها</p>
                            </div>
                        `;
                    }
                    return;
                }

                // تجميع الإشعارات حسب الأولوية
                const highPriority = notifications.filter(n => n.priority === 'high');
                const mediumPriority = notifications.filter(n => n.priority === 'medium');
                const lowPriority = notifications.filter(n => n.priority === 'low' || !n.priority);
                
                // إنشاء المحتوى الجديد
                const newContent = `
                    <div style="margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center; padding-bottom: 1rem; border-bottom: 2px solid var(--gray-200);">
                        <div>
                            <span style="background: var(--error-red); color: white; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 700; margin-left: 0.5rem;">${highPriority.length}</span>
                            <span style="font-weight: 600; color: var(--error-red);">عاجل</span>
                            
                            <span style="background: var(--warning-yellow); color: white; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 700; margin-left: 0.5rem; margin-right: 1rem;">${mediumPriority.length}</span>
                            <span style="font-weight: 600; color: var(--warning-yellow);">متوسط</span>
                            
                            <span style="background: var(--primary-blue); color: white; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 700; margin-left: 0.5rem; margin-right: 1rem;">${lowPriority.length}</span>
                            <span style="font-weight: 600; color: var(--primary-blue);">عادي</span>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-primary" style="padding: 0.5rem 1rem; font-size: 0.875rem;" onclick="showAllNotifications();">
                                <i class="fas fa-history"></i>
                                جميع الإشعارات
                            </button>
                            <button class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.875rem;" onclick="handleMarkAllAsRead()">
                                <i class="fas fa-check-double"></i>
                                تعليم الكل كمقروء
                            </button>
                        </div>
                    </div>
                    
                    <div style="max-height: 500px; overflow-y: auto;">
                        ${highPriority.length > 0 ? `
                            <h4 style="color: var(--error-red); margin-bottom: 1rem; font-size: 1rem; font-weight: 700;">
                                <i class="fas fa-exclamation-circle"></i>
                                إشعارات عاجلة
                            </h4>
                            ${renderNotificationGroup(highPriority)}
                            <div style="margin: 2rem 0; border-top: 1px solid var(--gray-200);"></div>
                        ` : ''}
                        
                        ${mediumPriority.length > 0 ? `
                            <h4 style="color: var(--warning-yellow); margin-bottom: 1rem; font-size: 1rem; font-weight: 700;">
                                <i class="fas fa-exclamation-triangle"></i>
                                إشعارات متوسطة
                            </h4>
                            ${renderNotificationGroup(mediumPriority)}
                            <div style="margin: 2rem 0; border-top: 1px solid var(--gray-200);"></div>
                        ` : ''}
                        
                        ${lowPriority.length > 0 ? `
                            <h4 style="color: var(--primary-blue); margin-bottom: 1rem; font-size: 1rem; font-weight: 700;">
                                <i class="fas fa-info-circle"></i>
                                إشعارات عامة
                            </h4>
                            ${renderNotificationGroup(lowPriority)}
                        ` : ''}
                    </div>
                `;
                
                // تحديث المحتوى
                const modalBody = document.querySelector('.modal-body');
                if (modalBody) {
                    modalBody.innerHTML = newContent;
                }
                
                // تحديث شارة الإشعارات
                dataManager.updateNotificationBadge();
                
                console.log('✅ تم تحديث نافذة الإشعارات بنجاح');
            }
        }

        // دوال إدارة إشعارات سطح المكتب
        async function requestDesktopNotificationPermission() {
            if (window.notificationManager) {
                await window.notificationManager.requestNotificationPermission();
                updateDesktopNotificationStatus();
            }
        }

        function testDesktopNotification() {
            if (window.notificationManager) {
                window.notificationManager.testDesktopNotification();
            }
        }

        function clearNotificationHistory() {
            if (confirm('هل تريد مسح سجل الإشعارات المعروضة؟\nسيتم إعادة إظهار الإشعارات المهمة مرة أخرى.')) {
                if (window.notificationManager) {
                    window.notificationManager.clearShownNotifications();
                    showNotification('تم المسح', 'تم مسح سجل الإشعارات المعروضة', 'success');
                    updateDesktopNotificationStatus();
                }
            }
        }

        function updateDesktopNotificationStatus() {
            const statusElement = document.getElementById('desktop-notification-status');
            if (!statusElement || !window.notificationManager) return;

            const settings = window.notificationManager.getDesktopNotificationSettings();
            let statusHTML = '';
            let statusClass = '';

            if (!settings.supported) {
                statusHTML = '<span style="color: var(--error-red);"><i class="fas fa-times-circle"></i> غير مدعوم</span>';
            } else if (settings.permission === 'granted') {
                statusHTML = '<span style="color: var(--success-green);"><i class="fas fa-check-circle"></i> مفعل</span>';
            } else if (settings.permission === 'denied') {
                statusHTML = '<span style="color: var(--error-red);"><i class="fas fa-ban"></i> مرفوض</span>';
            } else {
                statusHTML = '<span style="color: var(--warning-yellow);"><i class="fas fa-question-circle"></i> في الانتظار</span>';
            }

            statusElement.innerHTML = statusHTML;
        }

        function updateNotificationCounts() {
            if (!window.notificationManager) return;

            const notifications = dataManager.notificationsData;
            const highCount = notifications.filter(n => !n.read && n.priority === 'high').length;
            const mediumCount = notifications.filter(n => !n.read && n.priority === 'medium').length;
            const lowCount = notifications.filter(n => !n.read && n.priority === 'low').length;

            const highEl = document.getElementById('high-priority-count');
            const mediumEl = document.getElementById('medium-priority-count');
            const lowEl = document.getElementById('low-priority-count');

            if (highEl) highEl.textContent = highCount;
            if (mediumEl) mediumEl.textContent = mediumCount;
            if (lowEl) lowEl.textContent = lowCount;
        }

        function clearAllNotifications() {
            if (confirm('هل تريد حذف جميع الإشعارات؟\nلا يمكن التراجع عن هذا الإجراء.')) {
                dataManager.notificationsData = [];
                dataManager.saveData();
                
                if (window.notificationManager) {
                    window.notificationManager.clearShownNotifications();
                }
                
                updateNotificationCounts();
                dataManager.updateNotificationBadge();
                showNotification('تم الحذف', 'تم حذف جميع الإشعارات', 'success');
            }
        }

        function generateSmartNotifications() {
            if (window.notificationManager) {
                window.notificationManager.checkAllNotifications();
                updateNotificationCounts();
                // إزالة الإشعار المزعج - التحديث صامت
                console.log('🔄 تم فحص وتحديث الإشعارات بصمت');
            }
        }

        // Settings Management Functions
        function showSettingsTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.settings-tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.settings-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            const tabContent = document.getElementById(tabName + '-settings');
            if (tabContent) {
                tabContent.classList.remove('hidden');
            }
            
            // Add active class to selected tab
            const activeTab = document.querySelector(`[onclick="showSettingsTab('${tabName}')"]`);
            if (activeTab) {
                activeTab.classList.add('active');
            }

            // Load specific tab data
            switch(tabName) {
                case 'appearance':
                    loadAppearanceSettings();
                    break;
                case 'notifications':
                    updateNotificationCounts();
                    updateDesktopNotificationStatus();
                    break;
                case 'backup':
                    updateBackupInfo();
                    break;
                case 'advanced':
                    updateDataStats();
                    break;
            }
        }

        function loadAppearanceSettings() {
            const settings = dataManager.settingsData;
            
            const themeMode = document.getElementById('theme-mode');
            const primaryColor = document.getElementById('primary-color');
            const fontSize = document.getElementById('font-size');
            const contentDensity = document.getElementById('content-density');
            
            if (themeMode) themeMode.value = settings.themeMode || 'light';
            if (primaryColor) primaryColor.value = settings.primaryColor || 'blue';
            if (fontSize) fontSize.value = settings.fontSize || 'normal';
            if (contentDensity) contentDensity.value = settings.contentDensity || 'normal';
            
            applyThemeSettings();
        }

        function applyThemeSettings() {
            const themeMode = document.getElementById('theme-mode')?.value || 'light';
            const primaryColor = document.getElementById('primary-color')?.value || 'blue';
            const fontSize = document.getElementById('font-size')?.value || 'normal';
            const contentDensity = document.getElementById('content-density')?.value || 'normal';
            
            // Apply theme mode
            if (themeMode === 'dark') {
                document.body.classList.add('dark-theme');
            } else {
                document.body.classList.remove('dark-theme');
            }
            
            // Apply font size
            const fontSizes = {
                'small': '14px',
                'normal': '16px',
                'large': '18px',
                'extra-large': '20px'
            };
            document.body.style.fontSize = fontSizes[fontSize];
            
            // Apply content density
            const densities = {
                'compact': '0.8',
                'normal': '1',
                'comfortable': '1.2'
            };
            document.documentElement.style.setProperty('--content-scale', densities[contentDensity]);
        }

        function updateBackupInfo() {
            const dataSize = JSON.stringify(localStorage).length;
            const sizeInKB = Math.round(dataSize / 1024);
            
            const sizeElement = document.querySelector('#backup-size-info span');
            if (sizeElement) {
                sizeElement.textContent = `${sizeInKB} KB`;
            }
        }

        function updateDataStats() {
            const totalCases = dataManager.casesData.length;
            const totalLawyers = dataManager.lawyersData.length;
            const totalDeductions = dataManager.deductionsData.length;
            const dataSize = JSON.stringify(localStorage).length;
            const sizeInKB = Math.round(dataSize / 1024);
            
            const casesEl = document.getElementById('total-cases-count');
            const lawyersEl = document.getElementById('total-lawyers-count');
            const deductionsEl = document.getElementById('total-deductions-count');
            const sizeEl = document.getElementById('data-size');
            
            if (casesEl) casesEl.textContent = totalCases;
            if (lawyersEl) lawyersEl.textContent = totalLawyers;
            if (deductionsEl) deductionsEl.textContent = totalDeductions;
            if (sizeEl) sizeEl.textContent = `${sizeInKB} KB`;
        }

        function saveAllSettings() {
            // Save general settings
            saveOfficeSettings();
            saveUserSettings();
            
            // Save appearance settings
            saveAppearanceSettings();
            
            // Save notification settings
            saveNotificationSettings();
            
            // Save system settings
            saveSystemSettings();
            
            showNotification('تم الحفظ', 'تم حفظ جميع الإعدادات بنجاح', 'success');
        }

        function saveUserSettings() {
            const userSettings = {
                userName: document.getElementById('user-name')?.value || '',
                userPosition: document.getElementById('user-position')?.value || '',
                userEmail: document.getElementById('user-email')?.value || '',
                userLicense: document.getElementById('user-license')?.value || ''
            };
            
            dataManager.updateSettings(userSettings);
        }

        function saveAppearanceSettings() {
            const appearanceSettings = {
                themeMode: document.getElementById('theme-mode')?.value || 'light',
                primaryColor: document.getElementById('primary-color')?.value || 'blue',
                fontSize: document.getElementById('font-size')?.value || 'normal',
                contentDensity: document.getElementById('content-density')?.value || 'normal'
            };
            
            dataManager.updateSettings(appearanceSettings);
            applyThemeSettings();
        }

        function saveNotificationSettings() {
            const notificationSettings = {
                soundNotifications: document.getElementById('sound-notifications')?.checked || false,
                hearingNotifications: document.getElementById('hearing-notifications')?.checked || true,
                deductionNotifications: document.getElementById('deduction-notifications')?.checked || true,
                notificationDays: parseInt(document.getElementById('notification-days')?.value) || 3
            };
            
            dataManager.updateSettings(notificationSettings);
        }

        function createFullBackup() {
            showNotification('جاري التحضير', 'جاري إنشاء النسخة الاحتياطية الكاملة...', 'info');
            
            setTimeout(() => {
                const fullData = {
                    version: '1.1.0',
                    timestamp: new Date().toISOString(),
                    type: 'full',
                    data: {
                        cases: dataManager.casesData,
                        lawyers: dataManager.lawyersData,
                        defendants: dataManager.defendantsData,
                        deductions: dataManager.deductionsData,
                        notifications: dataManager.notificationsData,
                        settings: dataManager.settingsData
                    }
                };
                
                downloadBackup(fullData, 'full-backup');
            }, 1000);
        }

        function createCasesBackup() {
            showNotification('جاري التحضير', 'جاري إنشاء نسخة احتياطية للدعاوى...', 'info');
            
            setTimeout(() => {
                const casesData = {
                    version: '1.1.0',
                    timestamp: new Date().toISOString(),
                    type: 'cases',
                    data: {
                        cases: dataManager.casesData,
                        lawyers: dataManager.lawyersData,
                        defendants: dataManager.defendantsData,
                        deductions: dataManager.deductionsData
                    }
                };
                
                downloadBackup(casesData, 'cases-backup');
            }, 1000);
        }

        function downloadBackup(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const timestamp = new Date().toISOString().split('T')[0];
            
            a.href = url;
            a.download = `${filename}-${timestamp}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('تم التحميل', 'تم تحميل النسخة الاحتياطية بنجاح', 'success');
            
            // Update last backup date
            dataManager.updateSettings({ lastBackupDate: new Date().toISOString() });
            updateBackupInfo();
        }

        function runDataIntegrityCheck() {
            showNotification('جاري الفحص', 'جاري فحص سلامة البيانات...', 'info');
            
            setTimeout(() => {
                dataManager.checkDataIntegrity();
                showNotification('اكتمل الفحص', 'تم فحص البيانات بنجاح. راجع وحدة التحكم للتفاصيل.', 'success');
            }, 2000);
        }

        function cleanTempData() {
            showNotification('جاري التنظيف', 'جاري حذف البيانات المؤقتة...', 'info');
            
            setTimeout(() => {
                // Clear temporary data
                if (window.notificationManager) {
                    window.notificationManager.clearShownNotifications();
                }
                
                // Clear browser cache data (limited scope)
                if ('caches' in window) {
                    caches.keys().then(names => {
                        names.forEach(name => {
                            caches.delete(name);
                        });
                    });
                }
                
                showNotification('تم التنظيف', 'تم حذف البيانات المؤقتة بنجاح', 'success');
            }, 1500);
        }

        function showPerformanceStats() {
            const stats = {
                totalMemory: performance.memory ? `${Math.round(performance.memory.usedJSHeapSize / 1024 / 1024)} MB` : 'غير متاح',
                loadTime: `${Math.round(performance.now())} ms`,
                dataSize: `${Math.round(JSON.stringify(localStorage).length / 1024)} KB`,
                cacheSize: 'غير متاح'
            };
            
            const content = `
                <div style="font-family: monospace;">
                    <h4 style="margin-bottom: 1rem;">إحصائيات الأداء</h4>
                    <div style="display: grid; gap: 1rem;">
                        <div style="display: flex; justify-content: space-between;">
                            <span>استهلاك الذاكرة:</span>
                            <strong>${stats.totalMemory}</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>وقت التحميل:</span>
                            <strong>${stats.loadTime}</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>حجم البيانات:</span>
                            <strong>${stats.dataSize}</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>عدد الدعاوى:</span>
                            <strong>${dataManager.casesData.length}</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>عدد الإشعارات:</span>
                            <strong>${dataManager.notificationsData.length}</strong>
                        </div>
                    </div>
                </div>
            `;
            
            createModal('إحصائيات الأداء', content);
        }

        function initiateFactoryReset() {
            const content = `
                <div style="text-align: center; padding: 2rem;">
                    <div style="font-size: 4rem; color: var(--error-red); margin-bottom: 1rem;">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h3 style="color: var(--error-red); margin-bottom: 1rem;">تحذير: إعادة ضبط المصنع</h3>
                    <p style="margin-bottom: 2rem; line-height: 1.6;">
                        سيتم حذف جميع البيانات والعودة للإعدادات الافتراضية:<br>
                        • جميع الدعاوى والاستقطاعات<br>
                        • معلومات المحامين والمدعى عليهم<br>
                        • الإشعارات والإعدادات<br>
                        • جميع النسخ الاحتياطية المحلية
                    </p>
                    <div style="background: var(--warning-yellow-light); padding: 1rem; border-radius: 0.75rem; margin-bottom: 2rem; border: 1px solid var(--warning-yellow);">
                        <p style="margin: 0; font-weight: 600; color: var(--warning-yellow);">
                            <i class="fas fa-lightbulb"></i>
                            هل تريد إنشاء نسخة احتياطية قبل المتابعة؟
                        </p>
                    </div>
                </div>
            `;
            
            const actions = `
                <button class="btn btn-secondary" onclick="closeModal(this)">إلغاء</button>
                <button class="btn btn-primary" onclick="createBackupBeforeReset()">
                    <i class="fas fa-download"></i>
                    إنشاء نسخة احتياطية أولاً
                </button>
                <button class="btn btn-danger" onclick="confirmFactoryReset()">
                    <i class="fas fa-exclamation-triangle"></i>
                    متابعة بدون نسخة احتياطية
                </button>
            `;
            
            createModal('إعادة ضبط المصنع', content, actions);
        }

        function createBackupBeforeReset() {
            closeAllModals();
            showNotification('جاري إنشاء النسخة الاحتياطية', 'سيتم إعادة ضبط المصنع بعد اكتمال النسخة الاحتياطية', 'info');
            
            setTimeout(() => {
                createFullBackup();
                setTimeout(() => {
                    confirmFactoryReset();
                }, 2000);
            }, 1000);
        }

        function confirmFactoryReset() {
            closeAllModals();
            
            const finalContent = `
                <div style="text-align: center; padding: 2rem;">
                    <div style="font-size: 4rem; color: var(--error-red); margin-bottom: 1rem;">
                        <i class="fas fa-skull-crossbones"></i>
                    </div>
                    <h3 style="color: var(--error-red); margin-bottom: 1rem;">تأكيد نهائي</h3>
                    <p style="margin-bottom: 2rem;">
                        أكتب "حذف جميع البيانات" في المربع أدناه للتأكيد:
                    </p>
                    <input type="text" id="reset-confirmation" placeholder="أكتب: حذف جميع البيانات" style="width: 100%; padding: 1rem; text-align: center; font-size: 1.1rem; border: 2px solid var(--error-red); border-radius: 0.5rem;">
                </div>
            `;
            
            const finalActions = `
                <button class="btn btn-secondary" onclick="closeModal(this)">إلغاء</button>
                <button class="btn btn-danger" onclick="executeFactoryReset()">
                    <i class="fas fa-trash-alt"></i>
                    تنفيذ إعادة الضبط
                </button>
            `;
            
            createModal('تأكيد نهائي', finalContent, finalActions);
        }

        function executeFactoryReset() {
            const confirmation = document.getElementById('reset-confirmation')?.value;
            
            if (confirmation !== 'حذف جميع البيانات') {
                showNotification('خطأ', 'يرجى كتابة النص المطلوب بالضبط', 'error');
                return;
            }
            
            closeAllModals();
            
            showNotification('جاري التنفيذ', 'جاري حذف جميع البيانات...', 'info');
            
            setTimeout(() => {
                // Clear all local storage
                localStorage.clear();
                sessionStorage.clear();
                
                // Clear notification manager data
                if (window.notificationManager) {
                    window.notificationManager.clearShownNotifications();
                }
                
                showNotification('اكتمل', 'تم إعادة ضبط المصنع بنجاح. سيتم إعادة تحميل الصفحة...', 'success');
                
                setTimeout(() => {
                    location.reload();
                }, 2000);
            }, 2000);
        }

        function deleteAllData() {
            const content = `
                <div style="text-align: center; padding: 2rem;">
                    <div style="font-size: 4rem; color: var(--error-red); margin-bottom: 1rem;">
                        <i class="fas fa-trash-alt"></i>
                    </div>
                    <h3 style="color: var(--error-red); margin-bottom: 1rem;">حذف جميع البيانات</h3>
                    <p style="margin-bottom: 2rem;">
                        سيتم حذف جميع البيانات نهائياً:<br>
                        • ${dataManager.casesData.length} دعوى قضائية<br>
                        • ${dataManager.lawyersData.length} محامي<br>
                        • ${dataManager.defendantsData.length} مدعى عليه<br>
                        • ${dataManager.deductionsData.length} استقطاع
                    </p>
                    <input type="text" id="delete-confirmation" placeholder="أكتب: نعم احذف الكل" style="width: 100%; padding: 1rem; text-align: center; font-size: 1.1rem; border: 2px solid var(--error-red); border-radius: 0.5rem;">
                </div>
            `;
            
            const actions = `
                <button class="btn btn-secondary" onclick="closeModal(this)">إلغاء</button>
                <button class="btn btn-danger" onclick="executeDeleteAllData()">
                    <i class="fas fa-trash-alt"></i>
                    حذف جميع البيانات
                </button>
            `;
            
            createModal('حذف جميع البيانات', content, actions);
        }

        function executeDeleteAllData() {
            const confirmation = document.getElementById('delete-confirmation')?.value;
            
            if (confirmation !== 'نعم احذف الكل') {
                showNotification('خطأ', 'يرجى كتابة النص المطلوب بالضبط', 'error');
                return;
            }
            
            closeAllModals();
            
            showNotification('جاري الحذف', 'جاري حذف جميع البيانات...', 'info');
            
            setTimeout(() => {
                // Clear all data arrays
                dataManager.casesData = [];
                dataManager.lawyersData = [];
                dataManager.defendantsData = [];
                dataManager.deductionsData = [];
                dataManager.notificationsData = [];
                
                // Save empty data
                dataManager.saveData();
                
                // Update displays
                renderCasesTable();
                renderLawyersTable();
                renderDefendantsTable();
                renderDeductionsTable();
                updateDashboardStats();
                updateNotificationCounts();
                
                showNotification('تم الحذف', 'تم حذف جميع البيانات بنجاح', 'success');
            }, 2000);
        }

        // Setup restore functionality
        function setupRestoreArea() {
            const dropZone = document.getElementById('restore-drop-zone');
            const fileInput = document.getElementById('backup-file-input');
            
            if (dropZone && fileInput) {
                dropZone.addEventListener('click', () => fileInput.click());
                dropZone.addEventListener('dragover', handleDragOver);
                dropZone.addEventListener('drop', handleDrop);
                fileInput.addEventListener('change', handleFileSelect);
            }
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.style.borderColor = 'var(--primary-blue)';
            e.currentTarget.style.background = 'var(--primary-blue-light)';
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.style.borderColor = 'var(--gray-300)';
            e.currentTarget.style.background = 'transparent';
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processBackupFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            if (files.length > 0) {
                processBackupFile(files[0]);
            }
        }

        function processBackupFile(file) {
            if (!file.name.endsWith('.json')) {
                showNotification('خطأ', 'يرجى اختيار ملف JSON صالح', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    restoreFromBackup(data);
                } catch (error) {
                    showNotification('خطأ', 'ملف النسخة الاحتياطية تالف أو غير صالح', 'error');
                }
            };
            reader.readAsText(file);
        }

        function restoreFromBackup(backupData) {
            if (!backupData.version || !backupData.data) {
                showNotification('خطأ', 'تنسيق النسخة الاحتياطية غير صالح', 'error');
                return;
            }
            
            const content = `
                <div style="padding: 1rem;">
                    <h4>معلومات النسخة الاحتياطية</h4>
                    <div style="background: var(--gray-50); padding: 1rem; border-radius: 0.5rem; margin: 1rem 0;">
                        <p><strong>النسخة:</strong> ${backupData.version}</p>
                        <p><strong>التاريخ:</strong> ${dataManager.formatDate(backupData.timestamp)}</p>
                        <p><strong>النوع:</strong> ${backupData.type === 'full' ? 'نسخة كاملة' : 'دعاوى فقط'}</p>
                        <p><strong>المحتوى:</strong></p>
                        <ul style="margin: 0.5rem 0;">
                            ${backupData.data.cases ? `<li>الدعاوى: ${backupData.data.cases.length}</li>` : ''}
                            ${backupData.data.lawyers ? `<li>المحامين: ${backupData.data.lawyers.length}</li>` : ''}
                            ${backupData.data.defendants ? `<li>المدعى عليهم: ${backupData.data.defendants.length}</li>` : ''}
                            ${backupData.data.deductions ? `<li>الاستقطاعات: ${backupData.data.deductions.length}</li>` : ''}
                        </ul>
                    </div>
                    <p style="color: var(--error-red); font-weight: 600;">
                        تحذير: سيتم استبدال البيانات الحالية بالكامل
                    </p>
                </div>
            `;
            
            const actions = `
                <button class="btn btn-secondary" onclick="closeModal(this)">إلغاء</button>
                <button class="btn btn-primary" onclick="executeRestore(${JSON.stringify(backupData).replace(/"/g, '&quot;')})">
                    <i class="fas fa-upload"></i>
                    استرداد النسخة الاحتياطية
                </button>
            `;
            
            createModal('استرداد النسخة الاحتياطية', content, actions);
        }

        function executeRestore(backupData) {
            closeAllModals();
            
            showNotification('جاري الاسترداد', 'جاري استرداد النسخة الاحتياطية...', 'info');
            
            setTimeout(() => {
                try {
                    // Restore data
                    if (backupData.data.cases) dataManager.casesData = backupData.data.cases;
                    if (backupData.data.lawyers) dataManager.lawyersData = backupData.data.lawyers;
                    if (backupData.data.defendants) dataManager.defendantsData = backupData.data.defendants;
                    if (backupData.data.deductions) dataManager.deductionsData = backupData.data.deductions;
                    if (backupData.data.notifications) dataManager.notificationsData = backupData.data.notifications;
                    if (backupData.data.settings) dataManager.settingsData = { ...dataManager.settingsData, ...backupData.data.settings };
                    
                    // Save restored data
                    dataManager.saveData();
                    
                    // Update all displays
                    renderCasesTable();
                    renderLawyersTable();
                    renderDefendantsTable();
                    renderDeductionsTable();
                    updateDashboardStats();
                    updateNotificationCounts();
                    
                    showNotification('تم الاسترداد', 'تم استرداد النسخة الاحتياطية بنجاح', 'success');
                    
                    // Reload page to ensure everything is updated
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                } catch (error) {
                    showNotification('خطأ', 'حدث خطأ أثناء استرداد النسخة الاحتياطية', 'error');
                }
            }, 1500);
        }

        function showUserMenu() {
            // تم إزالة نظام المصادقة - ضبط افتراضي للمستخدم
            const currentUser = { displayName: 'المستخدم الرئيسي', role: 'admin' };
            const userName = currentUser ? currentUser.displayName : 'مستخدم';
            const userRole = currentUser && currentUser.role === 'admin' ? 'المدير العام' : 'مستخدم';
            const userInitial = userName.charAt(0);
            
            const content = `
                <div style="min-width: 200px;">
                    <div style="padding: 1rem; border-bottom: 1px solid var(--gray-200); text-align: center;">
                        <div class="user-avatar" style="margin: 0 auto 1rem;">${userInitial}</div>
                        <div style="font-weight: 700; margin-bottom: 0.5rem;">${userName}</div>
                        <div style="color: var(--gray-600); font-size: 0.875rem;">${userRole}</div>
                    </div>
                    <div style="padding: 1rem;">
                        <button class="btn btn-secondary" style="width: 100%; margin-bottom: 0.5rem;" onclick="showProfile()">
                            <i class="fas fa-user"></i>
                            الملف الشخصي
                        </button>
                        <!-- تم إزالة نظام المصادقة - عرض جميع الخيارات -->
                        <button class="btn btn-secondary" style="width: 100%; margin-bottom: 0.5rem;" onclick="openUserManagement()">
                            <i class="fas fa-users-cog"></i>
                            إدارة المستخدمين
                        </button>
                        <button class="btn btn-secondary" style="width: 100%; margin-bottom: 0.5rem;" onclick="showTab('settings'); closeModal(this)">
                            <i class="fas fa-cog"></i>
                            الإعدادات
                        </button>
                        <button class="btn btn-danger" style="width: 100%;" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i>
                            تسجيل الخروج
                        </button>
                    </div>
                </div>
            `;

            createModal('', content);
        }

        function showProfile() {
            const content = `
                <div class="form-container">
                    <div class="case-info-grid">
                        <div class="form-field">
                            <label><i class="fas fa-user"></i>الاسم</label>
                            <input type="text" id="profile-name" value="السيد أسامة">
                        </div>
                        <div class="form-field">
                            <label><i class="fas fa-briefcase"></i>المنصب</label>
                            <input type="text" id="profile-position" value="المدير العام">
                        </div>
                        <div class="form-field">
                            <label><i class="fas fa-envelope"></i>البريد الإلكتروني</label>
                            <input type="email" id="profile-email" value="osama@legal.com">
                        </div>
                        <div class="form-field">
                            <label><i class="fas fa-phone"></i>رقم الهاتف</label>
                            <input type="tel" id="profile-phone" value="+964-770-123-4567">
                        </div>
                    </div>
                </div>
            `;

            const actions = `
                <button class="btn btn-secondary" onclick="closeModal(this)">إلغاء</button>
                <button class="btn btn-primary" onclick="updateProfile()">
                    <i class="fas fa-save"></i>
                    حفظ التغييرات
                </button>
            `;

            closeModal(event.target);
            createModal('الملف الشخصي', content, actions);
        }

        function updateProfile() {
            showNotification('تم التحديث', 'تم تحديث الملف الشخصي بنجاح', 'success');
            closeModal(event.target);
        }

        function logout() {
            if (confirm('هل أنت متأكد من تسجيل الخروج؟')) {
                // تم إزالة نظام المصادقة - إعادة تعيين إلى الصفحة الرئيسية
                showNotification('تم الخروج', 'تم تسجيل الخروج بنجاح', 'info');
                closeModal(event.target);
                
                setTimeout(() => {
                    if (window.electron && window.electron.ipcRenderer) {
                        window.electron.ipcRenderer.send('logout');
                    } else {
                        window.location.href = 'login.html';
                    }
                }, 1000);
            }
        }

        // فتح صفحة إدارة المستخدمين
        function openUserManagement() {
            window.open('user-management.html', '_blank');
            closeModal(event.target);
        }

        // تحديث معلومات المستخدم في الواجهة
        function updateUserInterface() {
            // تم إزالة نظام المصادقة - ضبط افتراضي للمستخدم
            const currentUser = { name: 'المستخدم الرئيسي', role: 'admin' };
            
            if (currentUser) {
                const userNameElement = document.getElementById('current-user-name');
                const userAvatarElement = document.getElementById('user-avatar-initial');
                
                if (userNameElement) {
                    userNameElement.textContent = currentUser.name;
                }
                
                if (userAvatarElement) {
                    userAvatarElement.textContent = (currentUser.displayName || currentUser.name || 'المستخدم').charAt(0);
                }
                
                // إخفاء الأقسام حسب الصلاحيات
                updateUIBasedOnPermissions();
            }
        }

        // تحديث الواجهة حسب الصلاحيات
        function updateUIBasedOnPermissions() {
            const tabs = document.querySelectorAll('.nav-tab');
            
            tabs.forEach(tab => {
                const tabName = tab.getAttribute('data-tab');
                let hasPermission = true; // تم إزالة نظام المصادقة - جميع الصلاحيات متاحة
                
                // تم تعطيل فحص الصلاحيات - جميع التبويبات مرئية
                tab.style.display = 'flex';
            });
        }

        // Window Control Functions
        function minimizeWindow() {
            if (window.electronAPI) {
                window.electronAPI.minimizeWindow();
            } else {
                showNotification('تنبيه', 'هذه الميزة متاحة في تطبيق سطح المكتب فقط', 'info');
            }
        }

        function toggleMaximize() {
            if (window.electronAPI) {
                window.electronAPI.toggleMaximizeWindow();
            } else {
                showNotification('تنبيه', 'هذه الميزة متاحة في تطبيق سطح المكتب فقط', 'info');
            }
        }

        function closeWindow() {
            if (window.electronAPI) {
                window.electronAPI.closeWindow();
            } else {
                if (confirm('هل تريد إغلاق التطبيق؟')) {
                    window.close();
                }
            }
        }

        function refreshApp() {
            // إظهار رسالة تأكيد مفصلة
            const confirmMessage = 'هل تريد إعادة تحميل التطبيق؟\n\n' +
                                 '⚠️ تنبيه:\n' +
                                 '• سيتم فقدان أي بيانات غير محفوظة\n' +
                                 '• سيتم إعادة تشغيل الواجهة بالكامل\n' +
                                 '• قد يحل هذا مشاكل التجمد أو الأخطاء\n\n' +
                                 'هل تريد المتابعة؟';
            
            if (confirm(confirmMessage)) {
                // إضافة تأثير دوران لأيقونة التحديث
                const refreshIcon = document.getElementById('refresh-icon');
                if (refreshIcon) {
                    refreshIcon.style.animation = 'spin 1s linear infinite';
                    refreshIcon.style.color = '#4caf50';
                }
                
                // إظهار رسالة تحميل
                showNotification('إعادة تحميل', 'جاري إعادة تحميل التطبيق، يرجى الانتظار...', 'info');
                
                // حفظ حالة البيانات المهمة إن أمكن
                try {
                    const currentTab = document.querySelector('.nav-tab.active')?.getAttribute('data-tab') || 'dashboard';
                    localStorage.setItem('lastActiveTab', currentTab);
                } catch (e) {
                    console.log('Could not save current state');
                }
                
                // إعادة تحميل الصفحة بعد تأخير قصير
                setTimeout(() => {
                    if (window.electronAPI) {
                        // في حالة Electron، إعادة تحميل النافذة
                        window.electronAPI.reloadWindow().then(() => {
                            console.log('Window reloaded successfully');
                        }).catch(error => {
                            console.error('Error reloading window:', error);
                            // إعادة تحميل عادية في حالة فشل Electron
                            window.location.reload();
                        });
                    } else {
                        // في حالة المتصفح، إعادة تحميل الصفحة
                        window.location.reload();
                    }
                }, 800);
            }
        }

        // Tab Navigation
        function showTab(tabName) {
            // التحقق من الجلسة المحفوظة
            const savedSession = localStorage.getItem('dbAdminSession');
            if (savedSession && JSON.parse(savedSession).expires > Date.now()) {
                isDbAdminAuthenticated = true;
                showDatabaseAdmin();
                return;
            }

            const modal = document.getElementById('db-admin-login-modal');
            modal.classList.add('active');
            
            // تركيز على اسم المستخدم
            setTimeout(() => {
                document.getElementById('admin-username').focus();
            }, 300);
        }

        function closeDatabaseAdminLogin() {
            const modal = document.getElementById('db-admin-login-modal');
            modal.classList.remove('active');
            
            // مسح النموذج
            document.getElementById('db-admin-form').reset();
        }

        function authenticateDatabaseAdmin(event) {
            event.preventDefault();
            
            const username = document.getElementById('admin-username').value;
            const password = document.getElementById('admin-password').value;
            const rememberSession = document.getElementById('remember-session').checked;
            
            // التحقق من بيانات الدخول
            if (username === dbAdminCredentials.username && password === dbAdminCredentials.password) {
                isDbAdminAuthenticated = true;
                
                // حفظ الجلسة إذا طُلب ذلك
                if (rememberSession) {
                    const sessionData = {
                        authenticated: true,
                        expires: Date.now() + (24 * 60 * 60 * 1000), // 24 ساعة
                        key: dbAdminCredentials.sessionKey
                    };
                    localStorage.setItem('dbAdminSession', JSON.stringify(sessionData));
                }
                
                closeDatabaseAdminLogin();
                showDatabaseAdmin();
                showNotification('نجح تسجيل الدخول', 'تم تسجيل الدخول لإدارة قاعدة البيانات بنجاح', 'success');
            } else {
                showNotification('خطأ في تسجيل الدخول', 'اسم المستخدم أو كلمة المرور غير صحيحة', 'error');
                
                // هز النموذج للإشارة إلى الخطأ
                const form = document.getElementById('db-admin-form');
                form.style.animation = 'shake 0.5s ease-in-out';
                setTimeout(() => {
                    form.style.animation = '';
                }, 500);
            }
        }

        function showDatabaseAdmin() {
            if (!isDbAdminAuthenticated) {
                showDatabaseAdminLogin();
                return;
            }

            // إخفاء جميع الأقسام
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.add('hidden');
            });

            // إظهار قسم إدارة قاعدة البيانات
            const dbAdminContent = document.getElementById('database-admin-content');
            dbAdminContent.classList.remove('hidden');

            // تحديث التنقل
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector('[data-tab="database-admin"]').classList.add('active');

            // تحديث الإحصائيات العامة
            updateDatabaseOverview();

            // تحميل بيانات الجدول الحالي
            loadDatabaseTable(currentDbTable);
        }

        function updateDatabaseOverview() {
            if (!window.dataManager) return;

            // تحديث العدادات في لوحة الإحصائيات
            const casesCount = dataManager.casesData?.length || 0;
            const defendantsCount = dataManager.defendantsData?.length || 0;
            const lawyersCount = dataManager.lawyersData?.length || 0;
            const deductionsCount = dataManager.deductionsData?.length || 0;

            // تحديث العدادات في الإحصائيات العامة
            document.getElementById('overview-cases-count').textContent = casesCount;
            document.getElementById('overview-defendants-count').textContent = defendantsCount;
            document.getElementById('overview-lawyers-count').textContent = lawyersCount;
            document.getElementById('overview-deductions-count').textContent = deductionsCount;

            // تحديث العدادات في أزرار الجداول
            document.getElementById('cases-count').textContent = casesCount;
            document.getElementById('defendants-count').textContent = defendantsCount;
            document.getElementById('lawyers-count').textContent = lawyersCount;
            document.getElementById('deductions-count').textContent = deductionsCount;
            document.getElementById('settings-count').textContent = '1';
        }

        function logoutDatabaseAdmin() {
            if (confirm('هل تريد تسجيل الخروج من إدارة قاعدة البيانات؟')) {
                isDbAdminAuthenticated = false;
                localStorage.removeItem('dbAdminSession');
                
                // العودة إلى لوحة التحكم
                showTab('dashboard');
                
                showNotification('تسجيل خروج', 'تم تسجيل الخروج من إدارة قاعدة البيانات', 'info');
            }
        }

        function showDatabaseTable(tableName) {
            currentDbTable = tableName;
            
            // تحديث أزرار التنقل
            document.querySelectorAll('.table-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-table="${tableName}"]`).classList.add('active');
            
            // تحديث عنوان الجدول
            const titles = {
                cases: '<i class="fas fa-gavel"></i> الدعاوى القضائية (Cases)',
                defendants: '<i class="fas fa-users"></i> المدعى عليهم (Defendants)',
                lawyers: '<i class="fas fa-user-tie"></i> المحامون (Lawyers)',
                deductions: '<i class="fas fa-coins"></i> الاستقطاعات المالية (Deductions)',
                settings: '<i class="fas fa-cog"></i> إعدادات النظام (Settings)'
            };
            
            document.getElementById('current-table-title').innerHTML = titles[tableName];
            
            // تحديث حالة الجدول
            document.getElementById('table-status').textContent = 'جاري التحميل...';
            document.getElementById('table-status').style.background = 'var(--warning-yellow-light)';
            document.getElementById('table-status').style.color = 'var(--warning-yellow)';
            
            // تحميل بيانات الجدول
            loadDatabaseTable(tableName);
        }

        function loadDatabaseTable(tableName) {
            // تأكد من وجود DataManager
            if (!window.dataManager) {
                console.error('DataManager not available');
                showNotification('خطأ', 'لم يتم تحميل مدير البيانات بعد', 'error');
                return;
            }

            // الحصول على البيانات من DataManager
            let data = [];
            let columns = [];
            
            switch(tableName) {
                case 'cases':
                    data = dataManager.casesData || [];
                    columns = ['id', 'caseNumber', 'title', 'defendant', 'lawyer', 'status', 'nextHearing'];
                    break;
                case 'defendants':
                    data = dataManager.defendantsData || [];
                    columns = ['id', 'name', 'phone', 'address', 'nationalId'];
                    break;
                case 'lawyers':
                    data = dataManager.lawyersData || [];
                    columns = ['id', 'name', 'phone', 'email', 'specialization'];
                    break;
                case 'deductions':
                    data = dataManager.deductionsData || [];
                    columns = ['id', 'lawyerId', 'amount', 'description', 'date'];
                    break;
                case 'settings':
                    data = [dataManager.settingsData];
                    columns = Object.keys(dataManager.settingsData);
                    break;
            }
            
            // تحديث عداد السجلات
            const countElement = document.getElementById(`${tableName}-count`);
            if (countElement) {
                countElement.textContent = data.length;
            }
            
            // تحديث عداد الجدول الحالي
            const currentTableCountEl = document.querySelector('.current-table-count');
            if (currentTableCountEl) {
                currentTableCountEl.textContent = `${data.length} سجل`;
            }
            
            // تحديث حالة الجدول
            setTimeout(() => {
                const statusEl = document.getElementById('table-status');
                if (statusEl) {
                    statusEl.textContent = 'جاهز';
                    statusEl.style.background = 'var(--success-green-light)';
                    statusEl.style.color = 'var(--success-green)';
                }
            }, 500);
            
            // حفظ البيانات الحالية
            dbTableData[tableName] = data;
            
            // عرض الجدول
            renderDatabaseTable(data, columns, tableName);
        }

        function renderDatabaseTable(data, columns, tableName) {
            const container = document.getElementById('database-table');
            
            if (!data || data.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-database"></i>
                        <h3>لا توجد بيانات</h3>
                        <p>لا توجد سجلات في جدول ${tableName}</p>
                    </div>
                `;
                return;
            }
            
            // إنشاء الجدول
            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            ${columns.map(col => `<th>${translateColumnName(col)}</th>`).join('')}
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // إضافة البيانات
            data.forEach((row, index) => {
                tableHTML += '<tr>';
                columns.forEach(col => {
                    let value = row[col] || '';
                    if (typeof value === 'object') {
                        value = JSON.stringify(value);
                    }
                    if (value.toString().length > 50) {
                        value = value.toString().substring(0, 50) + '...';
                    }
                    tableHTML += `<td title="${value}">${value}</td>`;
                });
                
                tableHTML += `
                    <td class="action-cell">
                        <button class="action-btn view-btn" onclick="viewDatabaseRecord('${tableName}', ${index})" title="عرض التفاصيل">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="action-btn edit-btn" onclick="editDatabaseRecord('${tableName}', ${index})" title="تحرير">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn delete-btn" onclick="deleteDatabaseRecord('${tableName}', ${index})" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tableHTML += '</tr>';
            });
            
            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
        }

        function translateColumnName(columnName) {
            const translations = {
                id: 'المعرف',
                caseNumber: 'رقم الدعوى',
                title: 'العنوان',
                defendant: 'المدعى عليه',
                lawyer: 'المحامي',
                status: 'الحالة',
                nextHearing: 'الجلسة القادمة',
                name: 'الاسم',
                phone: 'الهاتف',
                address: 'العنوان',
                nationalId: 'الهوية الوطنية',
                email: 'البريد الإلكتروني',
                specialization: 'التخصص',
                lawyerId: 'معرف المحامي',
                amount: 'المبلغ',
                description: 'الوصف',
                date: 'التاريخ'
            };
            return translations[columnName] || columnName;
        }

        function refreshDatabaseView() {
            if (!isDbAdminAuthenticated) return;
            
            showNotification('تحديث', 'جاري تحديث بيانات قاعدة البيانات...', 'info');
            
            // تحديث حالة الجدول
            const statusEl = document.getElementById('table-status');
            if (statusEl) {
                statusEl.textContent = 'جاري التحديث...';
                statusEl.style.background = 'var(--warning-yellow-light)';
                statusEl.style.color = 'var(--warning-yellow)';
            }
            
            // البيانات تتحدث تلقائياً من Firebase - نحتاج فقط لتحديث الواجهة
            
            setTimeout(() => {
                // تحديث الإحصائيات العامة
                updateDatabaseOverview();
                
                // إعادة تحميل الجدول الحالي
                loadDatabaseTable(currentDbTable);
                
                showNotification('تحديث', 'تم تحديث بيانات قاعدة البيانات بنجاح', 'success');
            }, 1000);
        }

        function searchInDatabaseTable() {
            const searchTerm = document.getElementById('db-search').value.toLowerCase();
            const table = document.querySelector('.database-table table tbody');
            const searchResults = document.getElementById('search-results');
            
            if (!table) return;
            
            const rows = table.querySelectorAll('tr');
            let visibleCount = 0;
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            // تحديث نتائج البحث
            if (searchResults) {
                if (searchTerm.trim() === '') {
                    searchResults.innerHTML = '<span>جميع السجلات</span>';
                } else {
                    searchResults.innerHTML = `
                        <i class="fas fa-search"></i>
                        <span>عُثر على ${visibleCount} نتيجة للبحث عن "${searchTerm}"</span>
                        ${visibleCount === 0 ? '<span style="color: var(--error-red); margin-right: 0.5rem;">لا توجد نتائج</span>' : ''}
                    `;
                }
            }
        }

        function viewDatabaseRecord(tableName, index) {
            const data = dbTableData[tableName];
            if (!data || !data[index]) {
                showNotification('خطأ', 'لا يمكن العثور على السجل المحدد', 'error');
                return;
            }

            const record = data[index];
            
            // إنشاء محتوى النافذة المنبثقة
            let modalContent = `
                <div class="record-details">
                    <div class="record-header">
                        <h3>
                            <i class="fas fa-info-circle"></i>
                            تفاصيل السجل - ${translateTableName(tableName)}
                        </h3>
                        <div class="record-actions">
                            <button class="btn btn-primary btn-sm" onclick="enableRecordEdit('${tableName}', ${index})">
                                <i class="fas fa-edit"></i>
                                تحرير
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteDatabaseRecord('${tableName}', ${index}); closeModal(this);">
                                <i class="fas fa-trash"></i>
                                حذف
                            </button>
                        </div>
                    </div>
                    <div class="record-content" id="record-content-${index}">
            `;

            // عرض جميع الحقول
            Object.keys(record).forEach(key => {
                let value = record[key];
                if (typeof value === 'object') {
                    value = JSON.stringify(value, null, 2);
                }
                
                modalContent += `
                    <div class="field-group">
                        <label class="field-label">
                            <strong>${translateColumnName(key)}:</strong>
                        </label>
                        <div class="field-value" data-field="${key}">
                            <span class="view-mode">${value || 'غير محدد'}</span>
                            <input type="text" class="edit-mode hidden" value="${value || ''}" data-original="${value || ''}">
                        </div>
                    </div>
                `;
            });

            modalContent += `
                    </div>
                    <div class="record-footer hidden" id="edit-footer-${index}">
                        <div class="edit-actions">
                            <button class="btn btn-success" onclick="saveRecordChanges('${tableName}', ${index})">
                                <i class="fas fa-save"></i>
                                حفظ التغييرات
                            </button>
                            <button class="btn btn-secondary" onclick="cancelRecordEdit('${tableName}', ${index})">
                                <i class="fas fa-times"></i>
                                إلغاء
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // إنشاء النافذة المنبثقة
            createModal('تفاصيل السجل', modalContent);
        }

        function translateTableName(tableName) {
            const translations = {
                cases: 'الدعاوى القضائية',
                defendants: 'المدعى عليهم',
                lawyers: 'المحامون',
                deductions: 'الاستقطاعات',
                settings: 'الإعدادات'
            };
            return translations[tableName] || tableName;
        }

        function enableRecordEdit(tableName, index) {
            // إخفاء أزرار التحرير العلوية
            const recordActions = document.querySelector('.record-actions');
            if (recordActions) recordActions.style.display = 'none';

            // إظهار حقول التحرير
            const viewModes = document.querySelectorAll('.view-mode');
            const editModes = document.querySelectorAll('.edit-mode');
            
            viewModes.forEach(el => el.classList.add('hidden'));
            editModes.forEach(el => el.classList.remove('hidden'));

            // إظهار أزرار الحفظ والإلغاء
            const editFooter = document.getElementById(`edit-footer-${index}`);
            if (editFooter) editFooter.classList.remove('hidden');

            showNotification('وضع التحرير', 'يمكنك الآن تحرير البيانات', 'info');
        }

        function cancelRecordEdit(tableName, index) {
            // إظهار أزرار التحرير العلوية
            const recordActions = document.querySelector('.record-actions');
            if (recordActions) recordActions.style.display = 'flex';

            // إخفاء حقول التحرير واستعادة القيم الأصلية
            const viewModes = document.querySelectorAll('.view-mode');
            const editModes = document.querySelectorAll('.edit-mode');
            
            editModes.forEach(el => {
                el.value = el.getAttribute('data-original');
                el.classList.add('hidden');
            });
            viewModes.forEach(el => el.classList.remove('hidden'));

            // إخفاء أزرار الحفظ والإلغاء
            const editFooter = document.getElementById(`edit-footer-${index}`);
            if (editFooter) editFooter.classList.add('hidden');
        }

        function saveRecordChanges(tableName, index) {
            try {
                const editModes = document.querySelectorAll('.edit-mode');
                const updatedRecord = {};
                
                editModes.forEach(input => {
                    const fieldName = input.closest('.field-value').getAttribute('data-field');
                    let value = input.value;
                    
                    // محاولة تحويل القيم المناسبة
                    if (value && !isNaN(value)) {
                        value = Number(value);
                    } else if (value === 'true') {
                        value = true;
                    } else if (value === 'false') {
                        value = false;
                    }
                    
                    updatedRecord[fieldName] = value;
                });

                // تحديث البيانات
                switch(tableName) {
                    case 'cases':
                        dataManager.casesData[index] = { ...dataManager.casesData[index], ...updatedRecord };
                        break;
                    case 'defendants':
                        dataManager.defendantsData[index] = { ...dataManager.defendantsData[index], ...updatedRecord };
                        break;
                    case 'lawyers':
                        dataManager.lawyersData[index] = { ...dataManager.lawyersData[index], ...updatedRecord };
                        break;
                    case 'deductions':
                        dataManager.deductionsData[index] = { ...dataManager.deductionsData[index], ...updatedRecord };
                        break;
                    case 'settings':
                        dataManager.settingsData = { ...dataManager.settingsData, ...updatedRecord };
                        break;
                }

                // حفظ البيانات
                dataManager.saveData();

                // تحديث العرض
                loadDatabaseTable(tableName);

                // إغلاق النافذة
                closeAllModals();

                showNotification('تم الحفظ', 'تم تحديث السجل بنجاح', 'success');

            } catch (error) {
                console.error('Error saving record:', error);
                showNotification('خطأ', 'حدث خطأ أثناء حفظ البيانات', 'error');
            }
        }

        function editDatabaseRecord(tableName, index) {
            // فتح نافذة العرض مباشرة في وضع التحرير
            viewDatabaseRecord(tableName, index);
            
            // تفعيل وضع التحرير تلقائياً
            setTimeout(() => {
                enableRecordEdit(tableName, index);
            }, 100);
        }

        function deleteDatabaseRecord(tableName, index) {
            if (!confirm('هل تريد حذف هذا السجل؟ هذا الإجراء لا يمكن التراجع عنه.')) {
                return;
            }
            
            // حذف السجل من البيانات
            switch(tableName) {
                case 'cases':
                    dataManager.casesData.splice(index, 1);
                    break;
                case 'defendants':
                    dataManager.defendantsData.splice(index, 1);
                    break;
                case 'lawyers':
                    dataManager.lawyersData.splice(index, 1);
                    break;
                case 'deductions':
                    dataManager.deductionsData.splice(index, 1);
                    break;
            }
            
            // حفظ البيانات
            dataManager.saveData();
            
            // تحديث العرض
            loadDatabaseTable(tableName);
            
            showNotification('حذف', 'تم حذف السجل بنجاح', 'success');
        }

        function addNewRecord() {
            if (!isDbAdminAuthenticated) return;

            const tableName = currentDbTable;
            
            // تحديد الحقول حسب نوع الجدول
            let fields = {};
            switch(tableName) {
                case 'cases':
                    fields = {
                        id: Date.now().toString(),
                        caseNumber: '',
                        title: '',
                        defendant: '',
                        lawyer: '',
                        status: 'معلق',
                        nextHearing: '',
                        amount: 0,
                        description: '',
                        createdAt: new Date().toISOString()
                    };
                    break;
                case 'defendants':
                    fields = {
                        id: Date.now().toString(),
                        name: '',
                        phone: '',
                        address: '',
                        nationalId: '',
                        email: '',
                        createdAt: new Date().toISOString()
                    };
                    break;
                case 'lawyers':
                    fields = {
                        id: Date.now().toString(),
                        name: '',
                        phone: '',
                        email: '',
                        specialization: '',
                        licenseNumber: '',
                        createdAt: new Date().toISOString()
                    };
                    break;
                case 'deductions':
                    fields = {
                        id: Date.now().toString(),
                        lawyerId: '',
                        amount: 0,
                        description: '',
                        date: new Date().toISOString().split('T')[0],
                        createdAt: new Date().toISOString()
                    };
                    break;
                default:
                    showNotification('خطأ', 'لا يمكن إضافة سجل لهذا الجدول', 'error');
                    return;
            }

            // إنشاء نموذج الإضافة
            let modalContent = `
                <div class="add-record-form">
                    <h3>
                        <i class="fas fa-plus-circle"></i>
                        إضافة سجل جديد - ${translateTableName(tableName)}
                    </h3>
                    <form id="add-record-form" onsubmit="submitNewRecord(event, '${tableName}')">
            `;

            // إضافة حقول النموذج
            Object.keys(fields).forEach(key => {
                if (key === 'id' || key === 'createdAt') return; // تخطي الحقول التلقائية
                
                const fieldType = getFieldType(key);
                modalContent += `
                    <div class="form-group">
                        <label for="new-${key}">
                            ${translateColumnName(key)}
                            ${isRequiredField(key, tableName) ? '<span class="required">*</span>' : ''}
                        </label>
                        <input type="${fieldType}" 
                               id="new-${key}" 
                               name="${key}" 
                               value="${fields[key]}"
                               ${isRequiredField(key, tableName) ? 'required' : ''}
                               placeholder="أدخل ${translateColumnName(key)}">
                    </div>
                `;
            });

            modalContent += `
                        <div class="form-actions">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save"></i>
                                حفظ السجل
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="closeModal(this)">
                                <i class="fas fa-times"></i>
                                إلغاء
                            </button>
                        </div>
                    </form>
                </div>
            `;

            createModal('إضافة سجل جديد', modalContent);
        }

        function getFieldType(fieldName) {
            const numberFields = ['amount', 'licenseNumber'];
            const emailFields = ['email'];
            const phoneFields = ['phone'];
            const dateFields = ['date', 'nextHearing'];
            
            if (numberFields.includes(fieldName)) return 'number';
            if (emailFields.includes(fieldName)) return 'email';
            if (phoneFields.includes(fieldName)) return 'tel';
            if (dateFields.includes(fieldName)) return 'date';
            
            return 'text';
        }

        function isRequiredField(fieldName, tableName) {
            const requiredFields = {
                cases: ['caseNumber', 'title', 'defendant'],
                defendants: ['name'],
                lawyers: ['name'],
                deductions: ['amount', 'description']
            };
            
            return requiredFields[tableName] && requiredFields[tableName].includes(fieldName);
        }

        function submitNewRecord(event, tableName) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const newRecord = {
                id: Date.now().toString(),
                createdAt: new Date().toISOString()
            };
            
            // جمع البيانات من النموذج
            for (let [key, value] of formData.entries()) {
                if (value && !isNaN(value) && key !== 'nationalId' && key !== 'phone') {
                    newRecord[key] = Number(value);
                } else {
                    newRecord[key] = value;
                }
            }

            try {
                // إضافة السجل للبيانات
                switch(tableName) {
                    case 'cases':
                        dataManager.casesData.push(newRecord);
                        break;
                    case 'defendants':
                        dataManager.defendantsData.push(newRecord);
                        break;
                    case 'lawyers':
                        dataManager.lawyersData.push(newRecord);
                        break;
                    case 'deductions':
                        dataManager.deductionsData.push(newRecord);
                        break;
                }

                // حفظ البيانات
                dataManager.saveData();

                // تحديث العرض
                loadDatabaseTable(tableName);
                updateDatabaseOverview();

                // إغلاق النافذة
                closeAllModals();

                showNotification('تم الإضافة', 'تم إضافة السجل الجديد بنجاح', 'success');

            } catch (error) {
                console.error('Error adding record:', error);
                showNotification('خطأ', 'حدث خطأ أثناء إضافة السجل', 'error');
            }
        }

        function exportCurrentTable() {
            const data = dbTableData[currentDbTable] || [];
            if (data.length === 0) {
                showNotification('تصدير', 'لا توجد بيانات للتصدير', 'warning');
                return;
            }
            
            // تحويل البيانات إلى CSV
            const csv = convertToCSV(data);
            downloadCSV(csv, `${currentDbTable}_export.csv`);
            
            showNotification('تصدير', 'تم تصدير الجدول بنجاح', 'success');
        }

        function clearCurrentTable() {
            if (!confirm(`هل تريد مسح جميع بيانات جدول ${currentDbTable}؟ هذا الإجراء لا يمكن التراجع عنه.`)) {
                return;
            }
            
            if (!confirm('هذا إجراء خطير جداً! هل أنت متأكد؟')) {
                return;
            }
            
            // مسح البيانات
            switch(currentDbTable) {
                case 'cases':
                    dataManager.casesData = [];
                    break;
                case 'defendants':
                    dataManager.defendantsData = [];
                    break;
                case 'lawyers':
                    dataManager.lawyersData = [];
                    break;
                case 'deductions':
                    dataManager.deductionsData = [];
                    break;
            }
            
            // حفظ البيانات
            dataManager.saveData();
            
            // تحديث العرض
            loadDatabaseTable(currentDbTable);
            
            showNotification('مسح', `تم مسح جدول ${currentDbTable} بالكامل`, 'success');
        }

        function convertToCSV(data) {
            if (!data || data.length === 0) return '';
            
            const headers = Object.keys(data[0]);
            const csvHeaders = headers.join(',');
            
            const csvRows = data.map(row => 
                headers.map(header => {
                    let value = row[header] || '';
                    if (typeof value === 'object') {
                        value = JSON.stringify(value);
                    }
                    // إضافة علامات اقتباس إذا كانت القيمة تحتوي على فاصلة
                    if (value.toString().includes(',')) {
                        value = `"${value}"`;
                    }
                    return value;
                }).join(',')
            );
            
            return [csvHeaders, ...csvRows].join('\n');
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Tab Navigation
        function showTab(tabName) {
            // Stop any active chat refreshes when switching tabs
            if (window.chatPeriodicRefresh) {
                clearInterval(window.chatPeriodicRefresh);
                console.log('⏸️ تم إيقاف التحديث التلقائي للدردشة');
            }
            if (window.conversationRefresh) {
                clearInterval(window.conversationRefresh);
                console.log('⏸️ تم إيقاف التحديث التلقائي للمحادثة');
            }
            
            // Clear current selected lawyer when leaving chat
            if (tabName !== 'chat') {
                currentSelectedLawyer = null;
            }
            
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.add('hidden');
            });

            const targetContent = document.getElementById(tabName + '-content');
            if (targetContent) {
                targetContent.classList.remove('hidden');
            }

            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            const activeTab = document.querySelector(`[data-tab="${tabName}"]`);
            if (activeTab) {
                activeTab.classList.add('active');
            }

            switch(tabName) {
                case 'dashboard':
                    updateDashboardStats();
                    renderUpcomingHearings();
                    renderAlerts();
                    break;
                case 'cases':
                    renderCasesTable();
                    break;
                case 'defendants':
                    renderDefendantsTable();
                    break;
                case 'lawyers':
                    renderLawyersTable();
                    break;
                case 'deductions':
                    renderDeductionsTable();
                    break;
                case 'templates':
                    renderRecentTemplates();
                    break;
                case 'chat':
                    initializeChat();
                    // Force refresh chat data and notifications
                    refreshChatData();
                    dataManager.updateNotificationBadge();
                    dataManager.updateChatBadge();
                    break;
                case 'settings':
                    loadSettings();
                    break;
            }
        }

        function loadSettings() {
            if (!window.dataManager) {
                console.warn('DataManager not initialized yet, skipping loadSettings');
                return;
            }
            
            const settings = dataManager.settingsData;
            
            const officeNameEl = document.getElementById('office-name');
            const officeAddressEl = document.getElementById('office-address');
            const officePhoneEl = document.getElementById('office-phone');
            
            if (officeNameEl) officeNameEl.value = settings.officeName || '';
            if (officeAddressEl) officeAddressEl.value = settings.officeAddress || '';
            if (officePhoneEl) officePhoneEl.value = settings.officePhone || '';
            
            const autoNotificationsEl = document.getElementById('auto-notifications');
            const hearingNotificationsEl = document.getElementById('hearing-notifications');
            const monthlyReportsEl = document.getElementById('monthly-reports');
            const notificationDaysEl = document.getElementById('notification-days');
            const systemLanguageEl = document.getElementById('system-language');
            const dateTypeEl = document.getElementById('date-type');
            const autoSaveEl = document.getElementById('auto-save');
            const autoSaveIntervalEl = document.getElementById('auto-save-interval');
            const dailyBackupEl = document.getElementById('daily-backup');
            const lastBackupDateEl = document.getElementById('last-backup-date');
            
            if (autoNotificationsEl) autoNotificationsEl.checked = settings.autoNotifications;
            if (hearingNotificationsEl) hearingNotificationsEl.checked = settings.hearingNotifications;
            if (monthlyReportsEl) monthlyReportsEl.checked = settings.monthlyReports;
            if (notificationDaysEl) notificationDaysEl.value = settings.notificationDays || 3;
            
            if (systemLanguageEl) systemLanguageEl.value = settings.systemLanguage || 'ar';
            if (dateTypeEl) dateTypeEl.value = settings.dateType || 'gregorian';
            if (autoSaveEl) autoSaveEl.checked = settings.autoSave;
            if (autoSaveIntervalEl) autoSaveIntervalEl.value = settings.autoSaveInterval || 5;
            if (dailyBackupEl) dailyBackupEl.checked = settings.dailyBackup;
            
            if (settings.lastBackupDate && lastBackupDateEl) {
                lastBackupDateEl.textContent = dataManager.formatDate(settings.lastBackupDate) + ' - ' + new Date(settings.lastBackupDate).toLocaleTimeString('ar-EG', { hour12: false });
            }

            // Load user settings
            const userNameEl = document.getElementById('user-name');
            const userPositionEl = document.getElementById('user-position');
            const userEmailEl = document.getElementById('user-email');
            const userLicenseEl = document.getElementById('user-license');
            
            if (userNameEl) userNameEl.value = settings.userName || 'السيد أسامة';
            if (userPositionEl) userPositionEl.value = settings.userPosition || 'المدير العام';
            if (userEmailEl) userEmailEl.value = settings.userEmail || 'osama@legal.com';
            if (userLicenseEl) userLicenseEl.value = settings.userLicense || 'LEG-2024-001';

            // Load appearance settings
            const themeModeEl = document.getElementById('theme-mode');
            const primaryColorEl = document.getElementById('primary-color');
            const fontSizeEl = document.getElementById('font-size');
            const contentDensityEl = document.getElementById('content-density');
            
            if (themeModeEl) themeModeEl.value = settings.themeMode || 'light';
            if (primaryColorEl) primaryColorEl.value = settings.primaryColor || 'blue';
            if (fontSizeEl) fontSizeEl.value = settings.fontSize || 'normal';
            if (contentDensityEl) contentDensityEl.value = settings.contentDensity || 'normal';

            // Load notification settings
            const soundNotificationsEl = document.getElementById('sound-notifications');
            const deductionNotificationsEl = document.getElementById('deduction-notifications');
            
            if (soundNotificationsEl) soundNotificationsEl.checked = settings.soundNotifications !== false;
            if (deductionNotificationsEl) deductionNotificationsEl.checked = settings.deductionNotifications !== false;

            // Load system settings
            const textDirectionEl = document.getElementById('text-direction');
            const currencyEl = document.getElementById('currency');
            const encryptDataEl = document.getElementById('encrypt-data');
            const clearTempDataEl = document.getElementById('clear-temp-data');
            const autoBackupEl = document.getElementById('auto-backup');
            const backupOnExitEl = document.getElementById('backup-on-exit');
            
            if (textDirectionEl) textDirectionEl.value = settings.textDirection || 'rtl';
            if (currencyEl) currencyEl.value = settings.currency || 'iqd';
            if (encryptDataEl) encryptDataEl.checked = settings.encryptData || false;
            if (clearTempDataEl) clearTempDataEl.checked = settings.clearTempData || false;
            if (autoBackupEl) autoBackupEl.checked = settings.autoBackup !== false;
            if (backupOnExitEl) backupOnExitEl.checked = settings.backupOnExit || false;

            // Apply appearance settings
            applyThemeSettings();

            // تحديث إعدادات الإشعارات
            updateNotificationCounts();
            updateDesktopNotificationStatus();
        }

        // Initialize Application
        function initializeApp() {
            updateDashboardStats();
            renderUpcomingHearings();
            
            // Initialize Notification Manager
            window.notificationManager = new NotificationManager(dataManager);
            window.notificationManager.initialize();
            
            // Show welcome notification to test the system
            setTimeout(() => {
                if (!sessionStorage.getItem('welcomeNotificationShown')) {
                    console.log('🎉 إضافة إشعار الترحيب...');
                    
                    showNotification(
                        '🎉 مرحباً بك!', 
                        'تم تحميل تطبيق الإدارة القانونية بنجاح', 
                        'success', 
                        false
                    );
                    
                    sessionStorage.setItem('welcomeNotificationShown', 'true');
                    console.log('✅ تم إعداد نظام الإشعارات بنجاح');
                }
            }, 2000);
            
            renderAlerts();
            dataManager.updateNotificationBadge();
            
            // Force refresh notifications to ensure they appear
            setTimeout(() => {
                refreshNotifications();
                console.log('🔄 تم فرض تحديث الإشعارات بعد التحميل');
            }, 3000);
            
            // Initialize and force refresh chat data
            setTimeout(() => {
                console.log('🔄 إجبار تحديث بيانات الدردشة والإشعارات...');
                initializeChatSystem();
                refreshChatData();
                dataManager.updateChatBadge();
                console.log('✅ تم إجبار تحديث بيانات الدردشة والإشعارات');
            }, 4000);
            
            setupEventListeners();
            
            renderCasesTable();
            renderDefendantsTable();
            renderLawyersTable();
            renderDeductionsTable();
            updateLawyerSelector();
            
            // Initialize chat system
            dataManager.updateChatBadge();
            
            // Force update all notification badges
            setTimeout(() => {
                dataManager.updateNotificationBadge();
                dataManager.updateChatBadge();
                console.log('🔔 تم تحديث جميع شارات الإشعارات');
            }, 1000);
            
            // Add some test active lawyers
            setTimeout(() => {
                if (dataManager.lawyersData.length > 0) {
                    dataManager.lawyersData.forEach((lawyer, index) => {
                        // Make some lawyers "active" randomly
                        if (Math.random() > 0.5) {
                            dataManager.setLawyerActive(lawyer.id, true);
                        }
                    });
                }
            }, 1000);
            
            // إعداد إشعارات سطح المكتب
            setupDesktopNotifications();
            
            // تحديث إحصائيات الإشعارات في الإعدادات
            updateNotificationCounts();
            updateDesktopNotificationStatus();
            
            // استعادة التبويب الأخير بعد إعادة التحميل
            try {
                const lastActiveTab = localStorage.getItem('lastActiveTab');
                if (lastActiveTab && lastActiveTab !== 'dashboard') {
                    setTimeout(() => {
                        showTab(lastActiveTab);
                    }, 500);
                    localStorage.removeItem('lastActiveTab'); // إزالة البيانات المحفوظة
                }
            } catch (e) {
                console.log('Could not restore last active tab');
            }
            
            // Auto-save functionality
            if (dataManager.settingsData.autoSave) {
                setInterval(() => {
                    dataManager.saveData();
                }, dataManager.settingsData.autoSaveInterval * 60000);
            }

            // تحسين تجربة التحرير
            enhanceEditingExperience();
            
            // تحميل البيانات مسبقاً
            preloadDataForEditing();
            
            // إعداد البحث الشامل
            setupGlobalSearch();
            
            // التحقق من التزامن وإصلاح أي تضارب
            setTimeout(() => {
                verifyDataSyncIntegrity();
            }, 2000);
            
            console.log('تم تحميل تطبيق الإدارة القانونية بنجاح مع التحسينات الجديدة');
            showNotification('مرحباً', 'مرحباً بك في تطبيق الإدارة القانونية', 'success');
        }

        // دالة لإجبار تحديث بيانات الدردشة والإشعارات
        function forceRefreshChatAndNotifications() {
            console.log('🔄 إجبار تحديث بيانات الدردشة والإشعارات...');
            
            // Force reload chat data
            if (typeof refreshChatData === 'function') {
                refreshChatData();
            }
            
            // Update all badges
            dataManager.updateNotificationBadge();
            dataManager.updateChatBadge();
            
            // Refresh lawyers list to show new message indicators
            if (typeof renderLawyersList === 'function') {
                renderLawyersList();
            }
            
            console.log('✅ تم إجبار تحديث بيانات الدردشة والإشعارات');
        }

        // دالة لاختبار نظام الإشعارات والدردشة
        function testNotificationSystem() {
            console.log('🧪 اختبار نظام الإشعارات والدردشة...');
            
            // Test adding a chat message
            if (dataManager.lawyersData.length > 0) {
                const testLawyer = dataManager.lawyersData[0];
                console.log('📤 إضافة رسالة تجريبية من:', testLawyer.name);
                
                dataManager.addChatMessage(testLawyer.id, 'رسالة تجريبية للتأكد من أن النظام يعمل', true);
                
                console.log('📊 عدد الإشعارات بعد الاختبار:', dataManager.getUnreadNotificationsCount());
                console.log('📊 عدد رسائل الدردشة غير المقروءة:', dataManager.getUnreadChatCount());
                
                // Update UI
                dataManager.updateNotificationBadge();
                dataManager.updateChatBadge();
                
                if (typeof renderLawyersList === 'function') {
                    renderLawyersList();
                }
                
                console.log('✅ انتهى اختبار النظام');
            } else {
                console.log('⚠️ لا يوجد محامون لاختبار النظام');
            }
        }

        // Add test function to window for debugging
        window.testNotificationSystem = testNotificationSystem;
        window.forceRefreshChatAndNotifications = forceRefreshChatAndNotifications;

        // ============================================
        // Template Management System
        // ============================================

        // Template data storage
        let templatesData = JSON.parse(localStorage.getItem('templatesData') || '[]');
        let currentTemplateType = 'lawsuit';

        // Default template content
        const defaultTemplates = {
            lawsuit: {
                name: 'دعوى مطالبة بدين',
                content: `**المدعي / المهندس / المحاسب**
**{plaintiff_name}**
**المدعى عليه: حسين كاظم علوان يسكن النجف الأشرف**

**جهة الدعوى:**

لموكلي بذمة المدعى عليه مبلغ قدره **{debt_amount}** دينار ورغم المطالبة المستمرة بالتسديد إلا أنه ممتنع، لذا أطلب من محكمتكم الموقرة دعوة المدعى عليــــــه للمرافعة والحكم بإلزامه بتسديد المبلغ المذكور أعلاه وتحميله كافة الرسوم والمصاريف وأتــــعــــاب المحاماة.

ولكم فائق الشكر والتقدير

**الأدلة الثبوتية:**
{evidence}

**سائر البيانات القانونية**


**المحامي / {lawyer_name}**
**وكيل المدعي**
**{client_name}**`
            },
            appeal: {
                name: 'استئناف حكم',
                content: `**السيد رئيس محكمة الاستئناف المحترم**

**المستأنف / {plaintiff_name} / يسكن / {plaintiff_address}**
**المستأنف ضده / {defendant_name} / يسكن / {defendant_address}**

**جهة الاستئناف:**

بتاريخ _____ صدر الحكم رقم _____ لسنة _____ من محكمة البداءة والذي قضى _____
ولعدم اقتناع موكلي بالحكم المذكور لأسباب قانونية وواقعية تستدعي نقضه وإبطاله، لذا أتقدم بهذا الاستئناف طالباً من محكمتكم الموقرة نقض الحكم المستأنف وإصدار حكم جديد _____

**أسباب الاستئناف:**
{case_details}

**الأدلة:**
{evidence}

**المحامي / {lawyer_name}**
**وكيل المستأنف**
**{client_name}**`
            },
            execution: {
                name: 'طلب تنفيذ',
                content: `**السيد قاضي التنفيذ المحترم**

**طالب التنفيذ / {plaintiff_name} / يسكن / {plaintiff_address}**
**المطلوب تنفيذه ضده / {defendant_name} / يسكن / {defendant_address}**

**موضوع الطلب:**

بتاريخ _____ صدر الحكم رقم _____ لسنة _____ من محكمة _____ والذي أصبح باتاً ونهائياً وقضى بإلزام المطلوب تنفيذه ضده بدفع مبلغ **{debt_amount}** دينار لطالب التنفيذ.

وحيث أن المطلوب تنفيذه ضده امتنع عن تنفيذ الحكم طوعاً رغم انقضاء المدة القانونية، لذا أتقدم بهذا الطلب راجياً من محكمتكم الموقرة إصدار إنذار التنفيذ وفقاً للقانون واتخاذ الإجراءات القانونية اللازمة لتنفيذ الحكم.

**التفاصيل:**
{case_details}

**المحامي / {lawyer_name}**
**وكيل طالب التنفيذ**
**{client_name}**
وكيل طالب التنفيذ
{client_name}`
            },
            professional: {
                name: 'وثيقة قانونية احترافية',
                content: `**السيد قاضي بداءة**                                                          **المحترم**

**المدعي/ {{plaintiff_name}} / يسكن / {{plaintiff_address}}**

**المدعى عليه/ {{defendant_name}} / يسكن / {{defendant_address}}**

**جهة الدعوى:**

{{case_claim}}

**ولكم فائق الشكر والتقدير**
________________

**الأدلة الثبوتية:**
{{evidence}}

                                                    **المحامي/ {{lawyer_name}}**
                                                    **وكيل المدعي**
                                                    **{{client_representative}}**`
            }
        };

        // Show template modal
        function showTemplateModal(templateType = 'lawsuit') {
            console.log('🔄 فتح قالب:', templateType);
            currentTemplateType = templateType;
            document.getElementById('template-modal-title').textContent = defaultTemplates[templateType].name;
            document.getElementById('template-modal').style.display = 'flex';
            
            // Fill default values if available
            fillDefaultValues();
            
            // Auto-update preview
            setTimeout(updateTemplatePreview, 500);
        }

        // Show new template modal
        function showNewTemplateModal() {
            console.log('🔄 فتح قالب جديد');
            showTemplateModal('lawsuit');
        }

        // Close template modal
        function closeTemplateModal() {
            console.log('❌ إغلاق قالب');
            document.getElementById('template-modal').style.display = 'none';
        }

        // Close print modal
        function closePrintModal() {
            console.log('❌ إغلاق معاينة الطباعة');
            document.getElementById('print-modal').style.display = 'none';
        }

        // Fill default values from existing data
        function fillDefaultValues() {
            console.log('📝 ملء القيم الافتراضية...');
            
            // Fill with defaults that match the image if professional template
            if (currentTemplateType === 'professional') {
                const plaintiffInput = document.getElementById('plaintiff-name');
                const plaintiffAddressInput = document.getElementById('plaintiff-address');
                const defendantInput = document.getElementById('defendant-name');
                const defendantAddressInput = document.getElementById('defendant-address');
                const caseClaimInput = document.getElementById('case-claim');
                const evidenceInput = document.getElementById('evidence');
                const lawyerInput = document.getElementById('lawyer-name');
                const clientRepInput = document.getElementById('client-representative');
                
                if (plaintiffInput && !plaintiffInput.value) plaintiffInput.value = 'اسامة علي حسن';
                if (plaintiffAddressInput && !plaintiffAddressInput.value) plaintiffAddressInput.value = 'الهاشمية / البوسعبر';
                if (defendantInput && !defendantInput.value) defendantInput.value = 'حسن كاظم علوان';
                if (defendantAddressInput && !defendantAddressInput.value) defendantAddressInput.value = 'المدحتية / الزبار';
                if (caseClaimInput && !caseClaimInput.value) {
                    caseClaimInput.value = 'لموكلي بذمة المدعى عليه مبلغ قدره ثمانية عشر مليون وثلاثمائة وخمسة وخمسون الف دينار وتسعمائة الف دينار ورغم المطالبة المستمرة بالتسديد الا انه ممتنع، لذا أطلب من محكمتكم الموقرة دعوة المدعى عليه للمرافعة والحكم بإلزامه بتسديد المبلغ المذكور اعلاه وتحميله كافة الرسوم والمصاريف وأتعاب المحاماة.';
                }
                if (evidenceInput && !evidenceInput.value) evidenceInput.value = 'سائر البيانات القانونية';
                if (lawyerInput && !lawyerInput.value) lawyerInput.value = 'حيدر علي هادي';
                if (clientRepInput && !clientRepInput.value) clientRepInput.value = 'علي اباذر سالم';
            } else {
                // Try to get data from current case or defendant data for other templates
                if (dataManager && dataManager.casesData && dataManager.casesData.length > 0) {
                    const latestCase = dataManager.casesData[0];
                    const plaintiffInput = document.getElementById('plaintiff-name');
                    const defendantInput = document.getElementById('defendant-name');
                    
                    if (plaintiffInput) plaintiffInput.value = latestCase.plaintiffName || '';
                    if (defendantInput) defendantInput.value = latestCase.defendantName || '';
                    
                    if (latestCase.amount) {
                        const numericInput = document.getElementById('debt-amount-numeric');
                        const textInput = document.getElementById('debt-amount');
                        if (numericInput) numericInput.value = latestCase.amount;
                        if (textInput) textInput.value = convertNumberToWords(latestCase.amount) + ' دينار';
                    }
                }
                
                // Try to get lawyer data
                if (dataManager && dataManager.lawyersData && dataManager.lawyersData.length > 0) {
                    const lawyer = dataManager.lawyersData[0];
                    const lawyerInput = document.getElementById('lawyer-name');
                    if (lawyerInput) lawyerInput.value = lawyer.name || '';
                }
            }
        }

        // Update template preview
        function updateTemplatePreview() {
            console.log('🔄 تحديث معاينة القالب...');
            const template = defaultTemplates[currentTemplateType];
            let content = template.content;
            
            // Get form values
            const debtAmountText = document.getElementById('debt-amount')?.value || '';
            const debtAmountNumeric = document.getElementById('debt-amount-numeric')?.value || '';
            const caseClaimInput = document.getElementById('case-claim');

            // إذا لم يعدل المستخدم نص جهة الدعوى يدوياً، يتم توليد النص تلقائياً ويستخدم مبلغ الدين كتابة
            let autoCaseClaim = '';
            // تحديث جهة الدعوى دائماً عند تغيير مبلغ الدين
            if (caseClaimInput) {
                autoCaseClaim = `لموكلي بذمة المدعى عليه مبلغ قدره ${debtAmountText ? debtAmountText : '[مبلغ الدين كتابة]'}${debtAmountNumeric ? ' (' + debtAmountNumeric + ' دينار)' : ''} ورغم المطالبة المستمرة بالتسديد الا انه ممتنع، لذا أطلب من محكمتكم الموقرة دعوة المدعى عليه للمرافعة والحكم بإلزامه بتسديد المبلغ المذكور اعلاه وتحميله كافة الرسوم والمصاريف وأتعاب المحاماة.`;
                caseClaimInput.value = autoCaseClaim;
            }

            const values = {
                plaintiff_name: document.getElementById('plaintiff-name')?.value || '[اسم المدعي]',
                plaintiff_address: document.getElementById('plaintiff-address')?.value || '[عنوان المدعي]',
                defendant_name: document.getElementById('defendant-name')?.value || '[اسم المدعى عليه]',
                defendant_address: document.getElementById('defendant-address')?.value || '[عنوان المدعى عليه]',
                debt_amount: debtAmountText || '[مبلغ الدين]',
                debt_amount_numeric: debtAmountNumeric || '',
                lawyer_name: document.getElementById('lawyer-name')?.value || '[اسم المحامي]',
                client_name: document.getElementById('client-name')?.value || '[اسم الموكل]',
                case_claim: caseClaimInput?.value || '[جهة الدعوى]',
                client_representative: document.getElementById('client-representative')?.value || '[ممثل الموكل]',
                case_details: document.getElementById('case-details')?.value || '[تفاصيل القضية]',
                evidence: document.getElementById('evidence')?.value || '[الأدلة الثبوتية]'
            };

            // Replace placeholders
            for (const [key, value] of Object.entries(values)) {
                content = content.replace(new RegExp(`{{${key}}}`, 'g'), value);
            }
            
            // تحويل النص المكتوب بـ ** إلى نص غامق في المعاينة
            let formattedContent = content
                .replace(/\*\*(.*?)\*\*/g, '<strong style="font-weight: 900; color: #000; font-size: 18px;">$1</strong>')
                .replace(/\n/g, '<br>');
            
            const previewElement = document.getElementById('template-preview');
            if (previewElement) {
                previewElement.innerHTML = formattedContent;
                console.log('✅ تم تحديث المعاينة مع التنسيق الغامق');
            } else {
                console.error('❌ لم يتم العثور على عنصر المعاينة');
            }
        }

        // Convert number to Arabic words (simplified)
        function convertNumberToWords(number) {
            if (!number) return '';
            
            // This is a simplified version - you can expand this function
            const ones = ['', 'واحد', 'اثنان', 'ثلاثة', 'أربعة', 'خمسة', 'ستة', 'سبعة', 'ثمانية', 'تسعة'];
            const tens = ['', '', 'عشرون', 'ثلاثون', 'أربعون', 'خمسون', 'ستون', 'سبعون', 'ثمانون', 'تسعون'];
            const hundreds = ['', 'مائة', 'مائتان', 'ثلاثمائة', 'أربعمائة', 'خمسمائة', 'ستمائة', 'سبعمائة', 'ثمانمائة', 'تسعمائة'];
            
            number = parseInt(number);
            if (isNaN(number) || number === 0) return 'صفر';
            
            let result = '';
            
            // Millions
            if (number >= 1000000) {
                const millions = Math.floor(number / 1000000);
                if (millions === 1) {
                    result += 'مليون ';
                } else {
                    result += convertNumberToWords(millions) + ' مليون ';
                }
                number %= 1000000;
            }
            
            // Thousands
            if (number >= 1000) {
                const thousands = Math.floor(number / 1000);
                if (thousands === 1) {
                    result += 'ألف ';
                } else {
                    result += convertNumberToWords(thousands) + ' ألف ';
                }
                number %= 1000;
            }
            
            // Hundreds
            if (number >= 100) {
                const hundredsDigit = Math.floor(number / 100);
                result += hundreds[hundredsDigit] + ' ';
                number %= 100;
            }
            
            // Tens and ones
            if (number >= 20) {
                const tensDigit = Math.floor(number / 10);
                result += tens[tensDigit] + ' ';
                number %= 10;
            } else if (number >= 11) {
                const teens = ['', 'أحد عشر', 'اثنا عشر', 'ثلاثة عشر', 'أربعة عشر', 'خمسة عشر', 'ستة عشر', 'سبعة عشر', 'ثمانية عشر', 'تسعة عشر'];
                result += teens[number - 10] + ' ';
                number = 0;
            } else if (number === 10) {
                result += 'عشرة ';
                number = 0;
            }
            
            if (number > 0) {
                result += ones[number] + ' ';
            }
            
            return result.trim();
        }

        // Print template
        function printTemplate() {
            console.log('🖨️ طباعة القالب...');
            
            // Get form values for professional template
            const values = {
                plaintiff_name: document.getElementById('plaintiff-name')?.value || 'اسامة علي حسن',
                plaintiff_address: document.getElementById('plaintiff-address')?.value || 'الهاشمية / البوسعبر',
                defendant_name: document.getElementById('defendant-name')?.value || 'حسن كاظم علوان',
                defendant_address: document.getElementById('defendant-address')?.value || 'المدحتية / الزبار',
                case_claim: document.getElementById('case-claim')?.value || 'لموكلي بذمة المدعى عليه مبلغ قدره ثمانية عشر مليون وثلاثمائة وخمسة وخمسون الف دينار وتسعمائة الف دينار ورغم المطالبة المستمرة بالتسديد الا انه ممتنع، لذا أطلب من محكمتكم الموقرة دعوة المدعى عليه للمرافعة والحكم بإلزامه بتسديد المبلغ المذكور اعلاه وتحميله كافة الرسوم والمصاريف وأتعاب المحاماة.',
                evidence: document.getElementById('evidence')?.value || 'سائر البيانات القانونية',
                lawyer_name: document.getElementById('lawyer-name')?.value || 'حيدر علي هادي',
                client_representative: document.getElementById('client-representative')?.value || 'علي اباذر سالم'
            };
            
            let printContent;
            
            // تنسيق جديد للقالب الاحترافي ليطابق التصميم المطلوب
            if (currentTemplateType === 'professional') {
                printContent = `
                    <div class="professional-template" style="font-family: 'Times New Roman', serif; font-size: 14pt; line-height: 1.8; padding: 1.2cm 2.5cm 2cm 2.5cm; text-align: right; direction: rtl; color: #000; max-width: 21cm; min-height: 29.7cm; margin: auto; background: white; page-break-after: always;">
                        <div class="header-row" style="margin-bottom: 1.2cm;">
                            <div style="font-size: 14pt; font-weight: bold;">السيد قاضي بداءة</div>
                            <div style="font-size: 14pt; font-weight: normal;">المحترم</div>
                        </div>
                        <div class="plaintiff-info" style="margin-bottom: 0.7cm; font-size: 16pt; font-weight: bold;">
                            المدعي/ ${values.plaintiff_name} / يسكن / ${values.plaintiff_address}
                        </div>
                        <div class="defendant-info" style="margin-bottom: 1.2cm; font-size: 16pt; font-weight: bold;">
                            المدعى عليه/ ${values.defendant_name} / يسكن / ${values.defendant_address}
                        </div>
                        <div class="case-claim-title" style="font-size: 16pt; font-weight: bold; margin-bottom: 0.7cm;">جهة الدعوى:</div>
                        <div class="case-claim-content" style="font-size: 14pt; line-height: 2; text-align: justify; text-indent: 1cm; margin-bottom: 1.2cm;">${values.case_claim}</div>
                        <div class="thanks-section" style="text-align: center; margin: 1.2cm 0 0.7cm 0; font-size: 14pt;">
                            <div>ولكم فائق الشكر والتقدير</div>
                            <div style="margin: 0 auto; width: 200px; border-top: 2px solid #000;"></div>
                        </div>
                        <div class="evidence-section" style="text-align: right; margin-bottom: 1.2cm;">
                            <div class="evidence-title" style="font-weight: bold; font-size: 14pt; margin-bottom: 0.5cm;">الأدلة الثبوتية:</div>
                            <div style="font-size: 14pt;">${values.evidence}</div>
                        </div>
                        <div class="lawyer-section" style="text-align: left; margin-top: 1.2cm; font-size: 14pt; font-weight: bold;">
                            <div>المحامي/ ${values.lawyer_name}</div>
                            <div>وكيل المدعي</div>
                            <div>${values.client_representative}</div>
                        </div>
                    </div>
                `;
            } else {
                // التنسيق الافتراضي للقوالب الأخرى
                const content = document.getElementById('template-preview')?.textContent;
                if (!content) {
                    alert('يرجى تحديث المعاينة أولاً');
                    return;
                }
                
                let formattedContent = content
                    .replace(/\*\*(.*?)\*\*/g, '<strong style="font-weight: 900; font-size: 18px; color: #000;">$1</strong>')
                    .replace(/\n/g, '<br>');
                
                printContent = `
                    <div style="font-family: 'Times New Roman', serif; font-size: 16px; line-height: 1.8; padding: 2.5cm 2cm; text-align: right; direction: rtl; color: #000; max-width: 21cm; margin: auto; background: white;">
                        
                        <!-- العنوان الرئيسي -->
                        <div style="text-align: center; margin-bottom: 3cm;">
                            <h1 style="margin: 0; font-weight: 900; font-size: 22px; color: #000; font-family: 'Times New Roman', serif;">بسم الله الرحمن الرحيم</h1>
                        </div>
                        
                        <!-- توجيه الخطاب -->
                        <div style="text-align: center; margin-bottom: 2cm;">
                            <h2 style="margin: 0; font-weight: 900; font-size: 18px; color: #000; line-height: 1.5;">السيد قاضي محكمة البداءة المحترم</h2>
                        </div>
                        
                        <!-- المحتوى الرئيسي -->
                        <div style="line-height: 2.2; font-size: 16px; text-align: justify; margin-bottom: 3cm;">
                            ${formattedContent}
                        </div>
                        
                        <!-- المنطقة السفلى -->
                        <div style="margin-top: 4cm; position: relative;">
                            <!-- التاريخ -->
                            <div style="position: absolute; right: 0; bottom: 0;">
                                <p style="margin: 0; font-weight: 900; font-size: 16px; color: #000;">
                                    التاريخ: ${new Date().toLocaleDateString('ar-EG')}
                                </p>
                            </div>
                            
                            <!-- منطقة التوقيع -->
                            <div style="position: absolute; left: 0; bottom: 0; width: 180px; text-align: center;">
                                <div style="border-top: 2px solid #000; margin-bottom: 10px;"></div>
                                <p style="margin: 0; font-weight: 900; font-size: 16px; color: #000;">المحامي</p>
                            </div>
                            
                            <!-- مساحة فارغة لضمان عدم تداخل العناصر -->
                            <div style="height: 50px;"></div>
                        </div>
                    </div>
                `;
            }
            
            const printContentElement = document.getElementById('print-content');
            if (printContentElement) {
                printContentElement.innerHTML = printContent;
                document.getElementById('print-modal').style.display = 'flex';
                console.log('✅ تم فتح معاينة الطباعة');
            } else {
                console.error('❌ لم يتم العثور على عنصر الطباعة');
            }
        }

        // Save template
        function saveTemplate() {
            console.log('💾 حفظ القالب...');
            const templateData = {
                id: Date.now().toString(),
                type: currentTemplateType,
                name: defaultTemplates[currentTemplateType].name,
                createdAt: new Date().toISOString(),
                user: 'المستخدم الحالي',
                data: {
                    plaintiff_name: document.getElementById('plaintiff-name')?.value || '',
                    plaintiff_address: document.getElementById('plaintiff-address')?.value || '',
                    defendant_name: document.getElementById('defendant-name')?.value || '',
                    defendant_address: document.getElementById('defendant-address')?.value || '',
                    debt_amount: document.getElementById('debt-amount')?.value || '',
                    debt_amount_numeric: document.getElementById('debt-amount-numeric')?.value || '',
                    lawyer_name: document.getElementById('lawyer-name')?.value || '',
                    client_name: document.getElementById('client-name')?.value || '',
                    case_claim: document.getElementById('case-claim')?.value || '',
                    client_representative: document.getElementById('client-representative')?.value || '',
                    case_details: document.getElementById('case-details')?.value || '',
                    evidence: document.getElementById('evidence')?.value || ''
                },
                content: document.getElementById('template-preview')?.textContent || ''
            };
            
            templatesData.unshift(templateData);
            localStorage.setItem('templatesData', JSON.stringify(templatesData));
            
            // Update recent templates table
            renderRecentTemplates();
            
            showNotification('تم الحفظ', 'تم حفظ القالب بنجاح', 'success');
            closeTemplateModal();
            console.log('✅ تم حفظ القالب بنجاح');
        }

        // Render recent templates
        function renderRecentTemplates() {
            console.log('📋 عرض القوالب الحديثة...');
            const tableBody = document.getElementById('recent-templates-table');
            
            if (!tableBody) {
                console.error('❌ لم يتم العثور على جدول القوالب');
                return;
            }
            
            if (templatesData.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 2rem;">
                            <div style="color: var(--gray-500);">
                                <i class="fas fa-file-alt" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                                <p>لا توجد قوالب مستخدمة بعد</p>
                            </div>
                        </td>
                    </tr>
                `;
                console.log('📋 لا توجد قوالب محفوظة');
                return;
            }
            
            tableBody.innerHTML = templatesData.slice(0, 10).map(template => `
                <tr>
                    <td>${template.name}</td>
                    <td><span class="badge badge-primary">${template.type}</span></td>
                    <td>${new Date(template.createdAt).toLocaleDateString('ar-EG')}</td>
                    <td>${template.user}</td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="editTemplate('${template.id}')" title="تعديل">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="printSavedTemplate('${template.id}')" title="طباعة">
                            <i class="fas fa-print"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteTemplate('${template.id}')" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            console.log('✅ تم عرض', templatesData.length, 'قالب');
        }

        // Edit saved template
        function editTemplate(templateId) {
            console.log('✏️ تعديل القالب:', templateId);
            const template = templatesData.find(t => t.id === templateId);
            if (!template) {
                console.error('❌ لم يتم العثور على القالب');
                return;
            }
            
            // Fill form with saved data
            for (const [key, value] of Object.entries(template.data)) {
                const element = document.getElementById(key.replace('_', '-'));
                if (element) {
                    element.value = value;
                }
            }
            
            currentTemplateType = template.type;
            showTemplateModal(template.type);
            console.log('✅ تم فتح القالب للتعديل');
        }

        // Print saved template
        function printSavedTemplate(templateId) {
            console.log('🖨️ طباعة القالب المحفوظ:', templateId);
            const template = templatesData.find(t => t.id === templateId);
            if (!template) {
                console.error('❌ لم يتم العثور على القالب');
                return;
            }
            
            const printContent = `
                <div style="font-family: 'Times New Roman', serif; font-size: 16px; line-height: 2; padding: 2cm; text-align: right; direction: rtl;">
                    <div style="text-align: center; margin-bottom: 3cm;">
                        <h2 style="margin: 0;">بسم الله الرحمن الرحيم</h2>
                    </div>
                    <div style="white-space: pre-wrap;">${template.content}</div>
                    <div style="margin-top: 3cm; text-align: center;">
                        <p>التاريخ: ${new Date().toLocaleDateString('ar-EG')}</p>
                    </div>
                </div>
            `;
            
            const printContentElement = document.getElementById('print-content');
            if (printContentElement) {
                printContentElement.innerHTML = printContent;
                document.getElementById('print-modal').style.display = 'flex';
                console.log('✅ تم فتح معاينة طباعة القالب المحفوظ');
            }
        }

        // Delete template
        function deleteTemplate(templateId) {
            console.log('🗑️ حذف القالب:', templateId);
            if (!confirm('هل أنت متأكد من حذف هذا القالب؟')) return;
            
            templatesData = templatesData.filter(t => t.id !== templateId);
            localStorage.setItem('templatesData', JSON.stringify(templatesData));
            renderRecentTemplates();
            
            showNotification('تم الحذف', 'تم حذف القالب بنجاح', 'success');
            console.log('✅ تم حذف القالب');
        }

        // Auto-update preview when typing
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🔄 تهيئة نظام القوالب...');
            
            // Add event listeners for auto-update
            const inputs = [
                'plaintiff-name', 'plaintiff-address', 'defendant-name', 'defendant-address',
                'debt-amount', 'debt-amount-numeric', 'lawyer-name', 'client-name',
                'case-details', 'evidence'
            ];
            
            inputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', updateTemplatePreview);
                    
                    // Auto-convert numeric amount to words
                    if (id === 'debt-amount-numeric') {
                        element.addEventListener('input', function() {
                            const amount = this.value;
                            if (amount) {
                                const debtAmountElement = document.getElementById('debt-amount');
                                if (debtAmountElement) {
                                    debtAmountElement.value = convertNumberToWords(amount) + ' دينار';
                                    updateTemplatePreview();
                                }
                            }
                        });
                    }
                } else {
                    console.warn('⚠️ لم يتم العثور على العنصر:', id);
                }
            });
            
            // Load existing templates on page load
            renderRecentTemplates();
            
            console.log('✅ تم تهيئة نظام القوالب');
        });

        // Make functions available globally for onclick handlers
        window.showTemplateModal = showTemplateModal;
        window.showNewTemplateModal = showNewTemplateModal;
        window.closeTemplateModal = closeTemplateModal;
        window.closePrintModal = closePrintModal;
        window.updateTemplatePreview = updateTemplatePreview;
        window.printTemplate = printTemplate;
        window.saveTemplate = saveTemplate;
        window.editTemplate = editTemplate;
        window.printSavedTemplate = printSavedTemplate;
        window.deleteTemplate = deleteTemplate;
        window.renderRecentTemplates = renderRecentTemplates;

        // Test function for templates
        function testTemplateSystem() {
            console.log('🧪 اختبار نظام القوالب...');
            
            // Test modal opening
            console.log('1. اختبار فتح النافذة...');
            showTemplateModal('lawsuit');
            
            setTimeout(() => {
                console.log('2. اختبار تحديث المعاينة...');
                updateTemplatePreview();
                
                setTimeout(() => {
                    console.log('3. اختبار إغلاق النافذة...');
                    closeTemplateModal();
                    console.log('✅ انتهى اختبار نظام القوالب');
                }, 1000);
            }, 1000);
        }

        // Add test function to window for debugging
        window.testTemplateSystem = testTemplateSystem;

        // Handle clicks outside modals to close them
        document.addEventListener('click', function(e) {
            // Close template modal if clicking on overlay
            const templateModal = document.getElementById('template-modal');
            if (templateModal && e.target === templateModal) {
                closeTemplateModal();
            }
            
            // Close print modal if clicking on overlay
            const printModal = document.getElementById('print-modal');
            if (printModal && e.target === printModal) {
                closePrintModal();
            }
        });

        // Call force refresh every 10 seconds when chat tab is active
        setInterval(() => {
            const chatContent = document.getElementById('chat-content');
            if (chatContent && !chatContent.classList.contains('hidden')) {
                forceRefreshChatAndNotifications();
            }
        }, 10000);

        // دالة التحقق من تكامل البيانات والتزامن
        function verifyDataSyncIntegrity() {
            console.log('🔍 فحص تكامل البيانات والتزامن...');
            
            // فحص الدعاوى في Firebase والمقارنة مع البيانات المحلية
            database.ref('data/cases').once('value', (snapshot) => {
                const firebaseCases = snapshot.val();
                if (firebaseCases && Array.isArray(firebaseCases)) {
                    let syncCount = 0;
                    
                    firebaseCases.forEach((firebaseCase, index) => {
                        if (firebaseCase) {
                            const localCase = dataManager.casesData.find(c => 
                                c.id === firebaseCase.id || 
                                c.caseNumber === firebaseCase.caseNumber
                            );
                            
                            if (localCase) {
                                // التحقق من التحديثات المفقودة
                                const firebaseLastModified = new Date(firebaseCase.lastModified || 0);
                                const localLastModified = new Date(localCase.lastModified || 0);
                                
                                if (firebaseLastModified > localLastModified) {
                                    console.log(`🔄 تحديث مفقود للدعوى ${firebaseCase.caseNumber}، تطبيق التحديث...`);
                                    
                                    // تطبيق التحديث المفقود
                                    Object.assign(localCase, {
                                        status: firebaseCase.status,
                                        stage: firebaseCase.stage,
                                        lastModified: firebaseCase.lastModified,
                                        updatedBy: firebaseCase.updatedBy || 'Firebase',
                                        updatedFrom: firebaseCase.updatedFrom || 'sync'
                                    });
                                    
                                    syncCount++;
                                }
                            }
                        }
                    });
                    
                    if (syncCount > 0) {
                        // حفظ التحديثات
                        dataManager.saveData();
                        
                        // تحديث الواجهة بعد التزامن
                        renderCasesTable();
                        updateDashboardStats();
                        
                        showNotification(
                            '🔄 تم التزامن',
                            `تم تحديث ${syncCount} دعوى من البيانات المحفوظة في Firebase`,
                            'info'
                        );
                    }
                    
                    console.log(`✅ تم فحص التزامن بنجاح - ${syncCount} تحديث مطبق`);
                    
                    // Force update notifications after sync
                    dataManager.updateNotificationBadge();
                    dataManager.updateChatBadge();
                    
                    // Refresh chat data to check for new messages
                    if (typeof refreshChatData === 'function') {
                        refreshChatData();
                    }
                }
            }).catch(error => {
                console.error('خطأ في فحص التزامن:', error);
            });
        }

        // Global Search Functionality
        function setupGlobalSearch() {
            const searchInput = document.getElementById('global-search-input');
            const searchResults = document.getElementById('global-search-results');
            let searchTimeout;

            if (!searchInput || !searchResults) return;

            // Handle search input
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                const query = this.value.trim();
                
                if (query.length < 2) {
                    searchResults.classList.remove('show');
                    return;
                }

                searchTimeout = setTimeout(() => {
                    performGlobalSearch(query);
                }, 300);
            });

            // Hide results when clicking outside
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                    searchResults.classList.remove('show');
                }
            });

            // Handle escape key
            searchInput.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    searchResults.classList.remove('show');
                    this.blur();
                }
            });
        }

        function performGlobalSearch(query) {
            const searchResults = document.getElementById('global-search-results');
            const results = [];

            // Search in cases
            dataManager.casesData.forEach(item => {
                const searchText = `${item.caseNumber} ${item.plaintiffName} ${item.defendantName} ${item.lawyerName} ${item.courtName} ${item.status}`.toLowerCase();
                if (searchText.includes(query.toLowerCase())) {
                    results.push({
                        type: 'دعوى',
                        title: `${item.caseNumber} - ${item.defendantName}`,
                        description: `المحامي: ${item.lawyerName || 'غير محدد'} | الحالة: ${item.status}`,
                        action: () => {
                            showTab('cases');
                            // التمرير للعنصر بعد تأخير قصير
                            setTimeout(() => {
                                const table = document.getElementById('cases-table-body');
                                if (table) {
                                    const rows = table.querySelectorAll('tr');
                                    rows.forEach(row => {
                                        if (row.textContent.includes(item.caseNumber)) {
                                            row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                            row.style.backgroundColor = 'var(--primary-blue-light)';
                                            setTimeout(() => {
                                                row.style.backgroundColor = '';
                                            }, 3000);
                                        }
                                    });
                                }
                            }, 500);
                        }
                    });
                }
            });

            // Search in lawyers
            dataManager.lawyersData.forEach(item => {
                const searchText = `${item.name} ${item.license} ${item.specialization} ${item.phone}`.toLowerCase();
                if (searchText.includes(query.toLowerCase())) {
                    results.push({
                        type: 'محامي',
                        title: item.name,
                        description: `الترخيص: ${item.license} | التخصص: ${item.specialization}`,
                        action: () => {
                            showTab('lawyers');
                            setTimeout(() => {
                                const table = document.getElementById('lawyers-table-body');
                                if (table) {
                                    const rows = table.querySelectorAll('tr');
                                    rows.forEach(row => {
                                        if (row.textContent.includes(item.name)) {
                                            row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                            row.style.backgroundColor = 'var(--success-green-light)';
                                            setTimeout(() => {
                                                row.style.backgroundColor = '';
                                            }, 3000);
                                        }
                                    });
                                }
                            }, 500);
                        }
                    });
                }
            });

            // Search in defendants
            dataManager.defendantsData.forEach(item => {
                const searchText = `${item.name} ${item.phone} ${item.email} ${item.address}`.toLowerCase();
                if (searchText.includes(query.toLowerCase())) {
                    results.push({
                        type: 'مدعى عليه',
                        title: item.name,
                        description: `الهاتف: ${item.phone || 'غير محدد'} | العنوان: ${item.address || 'غير محدد'}`,
                        action: () => {
                            showTab('defendants');
                            setTimeout(() => {
                                const table = document.getElementById('defendants-table-body');
                                if (table) {
                                    const rows = table.querySelectorAll('tr');
                                    rows.forEach(row => {
                                        if (row.textContent.includes(item.name)) {
                                            row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                            row.style.backgroundColor = 'var(--warning-yellow-light)';
                                            setTimeout(() => {
                                                row.style.backgroundColor = '';
                                            }, 3000);
                                        }
                                    });
                                }
                            }, 500);
                        }
                    });
                }
            });

            // Search in deductions
            dataManager.deductionsData.forEach(item => {
                const searchText = `${item.caseNumber} ${item.deductionReason} ${item.notes}`.toLowerCase();
                if (searchText.includes(query.toLowerCase())) {
                    results.push({
                        type: 'استقطاع',
                        title: `استقطاع من دعوى ${item.caseNumber}`,
                        description: `المبلغ: ${dataManager.formatNumber(item.amount)} د.ع | السبب: ${item.deductionReason}`,
                        action: () => {
                            showTab('deductions');
                            setTimeout(() => {
                                const table = document.getElementById('deductions-table-body');
                                if (table) {
                                    const rows = table.querySelectorAll('tr');
                                    rows.forEach(row => {
                                        if (row.textContent.includes(item.caseNumber)) {
                                            row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                            row.style.backgroundColor = 'var(--purple-light)';
                                            setTimeout(() => {
                                                row.style.backgroundColor = '';
                                            }, 3000);
                                        }
                                    });
                                }
                            }, 500);
                        }
                    });
                }
            });

            displaySearchResults(results, query);
        }

        function displaySearchResults(results, query) {
            const searchResults = document.getElementById('global-search-results');
            
            if (results.length === 0) {
                searchResults.innerHTML = `
                    <div class="search-no-results">
                        <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 1rem; color: var(--gray-400);"></i>
                        <p>لم يتم العثور على نتائج للبحث "${query}"</p>
                    </div>
                `;
            } else {
                searchResults.innerHTML = results.slice(0, 10).map(result => `
                    <div class="search-result-item" onclick="selectSearchResult(this)" data-action="${results.indexOf(result)}">
                        <div class="search-result-type">${result.type}</div>
                        <div class="search-result-title">${result.title}</div>
                        <div class="search-result-description">${result.description}</div>
                    </div>
                `).join('');
            }
            
            searchResults.classList.add('show');
            
            // Store results for action handling
            window.searchResultsActions = results.map(r => r.action);
        }

        function selectSearchResult(element) {
            const actionIndex = parseInt(element.dataset.action);
            const action = window.searchResultsActions[actionIndex];
            
            if (action) {
                action();
                // Clear search and hide results
                document.getElementById('global-search-input').value = '';
                document.getElementById('global-search-results').classList.remove('show');
            }
        }

        function setupDesktopNotifications() {
            // إعداد معالج تغيير رؤية النافذة
            document.addEventListener('visibilitychange', () => {
                if (window.notificationManager) {
                    window.notificationManager.handleWindowVisibility();
                }
            });

            // إعداد معالج تركيز النافذة
            window.addEventListener('focus', () => {
                // عند العودة للتطبيق، تحديث الإشعارات
                if (window.notificationManager) {
                    updateNotificationCounts();
                    dataManager.updateNotificationBadge();
                }
            });

            // إعداد معالج إغلاق النافذة
            window.addEventListener('beforeunload', () => {
                // حفظ حالة الإشعارات قبل الإغلاق
                if (window.notificationManager) {
                    window.notificationManager.saveShownNotifications();
                }
            });

            // إعداد تحديث دوري للإشعارات كل 5 دقائق عند كون النافذة مرئية
            setInterval(() => {
                if (!document.hidden && window.notificationManager) {
                    updateNotificationCounts();
                }
            }, 5 * 60 * 1000);
        }

        function setupEventListeners() {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    const tabName = tab.getAttribute('data-tab');
                    if (tabName) {
                        showTab(tabName);
                    }
                });
            });

            const statusFilter = document.getElementById('filter-status');
            if (statusFilter) {
                statusFilter.addEventListener('change', searchCases);
            }

            // Setup search listeners
            const searchInputs = [
                { id: 'search-cases', func: searchCases },
                { id: 'search-defendants', func: searchDefendants },
                { id: 'search-lawyers', func: searchLawyers },
                { id: 'search-deductions', func: searchDeductions }
            ];

            searchInputs.forEach(input => {
                const element = document.getElementById(input.id);
                if (element) {
                    element.addEventListener('input', input.func);
                    element.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            input.func();
                        }
                    });
                }
            });

            // File drag and drop
            const uploadArea = document.getElementById('file-upload-area');
            if (uploadArea) {
                uploadArea.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.classList.add('active');
                });

                uploadArea.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    this.classList.remove('active');
                });

                uploadArea.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('active');
                    
                    const files = Array.from(e.dataTransfer.files);
                    files.forEach(file => {
                        dataManager.uploadedFiles.push({
                            id: Date.now() + Math.random(),
                            name: file.name,
                            size: dataManager.formatFileSize(file.size),
                            type: file.type,
                            file: file
                        });
                    });
                    
                    renderUploadedFiles();
                    showNotification('تم الرفع', `تم رفع ${files.length} ملف بنجاح`, 'success');
                });
            }

            // Notification bell double click for refresh
            const notificationBell = document.querySelector('.notification-bell');
            if (notificationBell) {
                // Double click to refresh notifications
                notificationBell.addEventListener('dblclick', () => {
                    if (window.notificationManager) {
                        // تحديث صامت بدون إشعارات مزعجة
                        window.notificationManager.checkAllNotifications();
                        console.log('🔄 تم تحديث الإشعارات بصمت');
                    }
                });
            }

            // Setup restore area for backup files
            setupRestoreArea();
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(initializeApp, 100);
        });

        // Error handling
        window.addEventListener('error', function(e) {
            // تجاهل الأخطاء الفارغة أو البسيطة
            if (!e.error || e.error === null || e.error === undefined) {
                console.warn('تجاهل خطأ فارغ:', e);
                return;
            }
            
            console.error('خطأ في النظام:', e.error);
            
            // عرض تفاصيل الخطأ إذا كان متاحاً
            const errorMessage = e.error?.message || e.message || 'حدث خطأ غير محدد في النظام';
            showNotification('خطأ', `خطأ في النظام: ${errorMessage}. تم حفظ البيانات تلقائياً.`, 'error');
            
            // حفظ البيانات في حالة الخطأ
            try {
                dataManager.saveData();
            } catch (saveError) {
                console.error('خطأ في حفظ البيانات عند معالجة الخطأ:', saveError);
            }
        });

        // Before unload - save data
        window.addEventListener('beforeunload', function(e) {
            dataManager.saveData();
        });

        // Periodic auto-save
        setInterval(() => {
            if (dataManager.settingsData.autoSave) {
                dataManager.saveData();
            }
        }, 5 * 60 * 1000); // Every 5 minutes

        // دالة فحص سلامة البيانات
        function testDataIntegrity() {
            dataManager.checkDataIntegrity();
            
            // عرض النتائج
            const deductionsCount = dataManager.deductionsData.length;
            showNotification('فحص البيانات', `عدد الاستقطاعات المحفوظة: ${deductionsCount}`, 'info');
        }

        // Firebase Status Bar Management
        class FirebaseStatusManager {
            constructor() {
                this.statusBar = document.getElementById('firebase-status-bar');
                this.statusIcon = document.getElementById('firebase-status-icon');
                this.statusText = document.getElementById('firebase-status-text');
                this.syncCountElement = document.getElementById('sync-pending-count');
                this.lastSyncElement = document.getElementById('last-sync-time');
                
                this.init();
            }

            init() {
                // تحديث الحالة كل 5 ثوان
                setInterval(() => this.updateStatus(), 5000);
                
                // تحديث فوري
                this.updateStatus();
            }

            updateStatus() {
                if (!firebaseSync) return;

                const stats = firebaseSync.getSyncStats();
                
                // تحديث حالة الاتصال
                if (stats.isFirebaseConnected) {
                    this.setConnectedStatus();
                } else if (stats.isOnline) {
                    this.setConnectingStatus();
                } else {
                    this.setDisconnectedStatus();
                }
                
                // تحديث عدد العمليات المعلقة
                this.updatePendingCount(stats.pendingOperationsCount);
                
                // تحديث وقت آخر مزامنة
                this.updateLastSyncTime(stats.lastSyncTime);
            }

            setConnectedStatus() {
                this.statusIcon.className = 'fas fa-circle';
                this.statusText.textContent = 'متصل بقاعدة البيانات | متزامن مع تطبيق المحامي';
                
                const indicator = this.statusIcon.parentElement;
                indicator.className = 'status-indicator connected';
            }

            setConnectingStatus() {
                this.statusIcon.className = 'fas fa-circle';
                this.statusText.textContent = 'جاري الاتصال بقاعدة البيانات...';
                
                const indicator = this.statusIcon.parentElement;
                indicator.className = 'status-indicator connecting';
            }

            setDisconnectedStatus() {
                this.statusIcon.className = 'fas fa-circle';
                this.statusText.textContent = 'غير متصل - العمل في وضع عدم الاتصال';
                
                const indicator = this.statusIcon.parentElement;
                indicator.className = 'status-indicator disconnected';
            }

            updatePendingCount(count) {
                if (count > 0) {
                    this.syncCountElement.textContent = count;
                    this.syncCountElement.classList.remove('hidden');
                    this.syncCountElement.title = `${count} عملية في انتظار المزامنة`;
                } else {
                    this.syncCountElement.classList.add('hidden');
                }
            }

            updateLastSyncTime(lastSyncTime) {
                if (lastSyncTime) {
                    const syncDate = new Date(lastSyncTime);
                    const now = new Date();
                    const diffMinutes = Math.floor((now - syncDate) / (1000 * 60));
                    
                    let timeText;
                    if (diffMinutes < 1) {
                        timeText = 'الآن';
                    } else if (diffMinutes < 60) {
                        timeText = `منذ ${diffMinutes} دقيقة`;
                    } else {
                        const diffHours = Math.floor(diffMinutes / 60);
                        timeText = `منذ ${diffHours} ساعة`;
                    }
                    
                    this.lastSyncElement.textContent = `آخر مزامنة: ${timeText}`;
                    this.lastSyncElement.classList.remove('hidden');
                } else {
                    this.lastSyncElement.textContent = 'آخر مزامنة: لا يوجد';
                    this.lastSyncElement.classList.remove('hidden');
                }
            }
        }

        // تهيئة مدير شريط الحالة عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', () => {
            // تحديث واجهة المستخدم
            updateUserInterface();
            
            setTimeout(() => {
                new FirebaseStatusManager();
            }, 1000);
        });

        console.log('تم تحميل تطبيق الإدارة القانونية مع Firebase بنجاح');


  // ======================================================================
        // إنشاء الجزيئات المتحركة في الخلفية
        // ======================================================================
        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            const particleCount = 50;

            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                
                // موضع عشوائي
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                
                // تأخير عشوائي للحركة
                particle.style.animationDelay = Math.random() * 15 + 's';
                
                // مدة حركة عشوائية
                particle.style.animationDuration = (Math.random() * 10 + 10) + 's';
                
                particlesContainer.appendChild(particle);
            }
        }

        // ======================================================================
        // منطق إخفاء شاشة الانتظار
        // ======================================================================
        document.addEventListener('DOMContentLoaded', () => {
            // إنشاء الجزيئات
            createParticles();

            // تنظيف الرسائل المحذوفة من Firebase عند التحميل
            setTimeout(() => {
                if (typeof cleanupDeletedMessages === 'function') {
                    cleanupDeletedMessages();
                }
            }, 3000);

            const splashScreen = document.getElementById('splash-screen');
            const HIDE_DELAY = 5000; // 5 ثوانٍ

            // إخفاء الشاشة بعد فترة زمنية
            setTimeout(() => {
                if (splashScreen) {
                    splashScreen.classList.add('hidden');
                    
                    // إزالة العنصر من DOM بعد انتهاء الانتقال
                    setTimeout(() => {
                        splashScreen.remove();
                    }, 800);
                }
            }, HIDE_DELAY);
        });
        
    </script>

    <!-- Template Modals -->
    
    <!-- Template Form Modal -->
    <div id="template-modal" class="modal-overlay" style="display: none;">
        <div class="template-modal">
            <div class="template-modal-header">
                <h3 id="template-modal-title">قالب قانوني جديد</h3>
                <button class="template-modal-close" onclick="closeTemplateModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="template-modal-body">
                <div class="template-form-grid">
                    <div class="template-form-group">
                        <label for="plaintiff-name">اسم المدعي:</label>
                        <input type="text" id="plaintiff-name" placeholder="اسامه علي حسن">
                    </div>
                    <div class="template-form-group">
                        <label for="plaintiff-address">عنوان المدعي:</label>
                        <input type="text" id="plaintiff-address" placeholder="الهاشمية / البوسعبر">
                    </div>
                    <div class="template-form-group">
                        <label for="defendant-name">اسم المدعى عليه:</label>
                        <input type="text" id="defendant-name" placeholder="حسن كاظم علوان">
                    </div>
                    <div class="template-form-group">
                        <label for="defendant-address">عنوان المدعى عليه:</label>
                        <input type="text" id="defendant-address" placeholder="المدحتية / الزبار">
                    </div>
                    <div class="template-form-group">
                        <label for="debt-amount">مبلغ الدين:</label>
                        <input type="text" id="debt-amount" placeholder="ثمانية عشرمليون وثلاثمائه وخمسه وخمسون الف دينار">
                    </div>
                    <div class="template-form-group">
                        <label for="debt-amount-numeric">المبلغ بالأرقام:</label>
                        <input type="number" id="debt-amount-numeric" placeholder="18355900">
                    </div>
                    <div class="template-form-group">
                        <label for="lawyer-name">اسم المحامي:</label>
                        <input type="text" id="lawyer-name" placeholder="حيدرعلي هادي">
                    </div>
                    <div class="template-form-group">
                        <label for="client-name">اسم الموكل:</label>
                        <input type="text" id="client-name" placeholder="علي اباذر سالم">
                    </div>
                    <div class="template-form-group full-width">
                        <label for="case-claim">جهة الدعوى:</label>
                        <textarea id="case-claim" rows="4" placeholder="لموكلي بذمة المدعى عليه مبلغ قدره ثمانية عشر مليون وثلاثمائة وخمسة وخمسون الف دينار وتسعمائة الف دينار ورغم المطالبة المستمرة بالتسديد الا انه ممتنع، لذا أطلب من محكمتكم الموقرة دعوة المدعى عليه للمرافعة والحكم بإلزامه بتسديد المبلغ المذكور اعلاه وتحميله كافة الرسوم والمصاريف وأتعاب المحاماة."></textarea>
                    </div>
                    <div class="template-form-group">
                        <label for="client-representative">ممثل الموكل:</label>
                        <input type="text" id="client-representative" placeholder="علي اباذر سالم">
                    </div>
                    <div class="template-form-group full-width">
                        <label for="case-details">تفاصيل إضافية:</label>
                        <textarea id="case-details" placeholder="أي تفاصيل إضافية للقضية..."></textarea>
                    </div>
                    <div class="template-form-group full-width">
                        <label for="evidence">الأدلة الثبوتية:</label>
                        <textarea id="evidence" placeholder="سائر البيانات القانونية والأدلة..."></textarea>
                    </div>
                </div>
                
                <h4 style="margin: 2rem 0 1rem; color: var(--primary);">
                    <i class="fas fa-eye"></i>
                    معاينة القالب
                </h4>
                <div class="template-preview" id="template-preview">
                    انقر على "تحديث المعاينة" لرؤية القالب...
                </div>
            </div>
            <div class="template-modal-footer">
                <button class="btn btn-secondary" onclick="updateTemplatePreview()">
                    <i class="fas fa-sync"></i>
                    تحديث المعاينة
                </button>
                <button class="btn btn-primary" onclick="printTemplate()">
                    <i class="fas fa-print"></i>
                    طباعة
                </button>
                <button class="btn btn-success" onclick="saveTemplate()">
                    <i class="fas fa-save"></i>
                    حفظ القالب
                </button>
            </div>
        </div>
    </div>

    <!-- Print Preview Modal -->
    <div id="print-modal" class="modal-overlay" style="display: none;">
        <div class="template-modal">
            <div class="template-modal-header">
                <h3>معاينة الطباعة</h3>
                <button class="template-modal-close" onclick="closePrintModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="template-modal-body">
                <div class="print-preview" id="print-content">
                    <!-- سيتم ملء المحتوى هنا -->
                </div>
            </div>
            <div class="template-modal-footer">
                <button class="btn btn-secondary" onclick="closePrintModal()">
                    <i class="fas fa-times"></i>
                    إلغاء
                </button>
                <button class="btn btn-primary" onclick="window.print()">
                    <i class="fas fa-print"></i>
                    طباعة الآن
                </button>
            </div>
        </div>
    </div>

 
    
</body>
</html>